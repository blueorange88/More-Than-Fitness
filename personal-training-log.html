<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>개인 / 트레이닝 일지</title>
  <style>
    :root{ --line:#d7d7d7; --ink:#1f2937; --muted:#6b7280; --accent:#f59e0b22; --hl:#ffa500; --danger:#dc2626; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--ink);margin:24px;background:#fff}
    h1{margin:0 0 8px;font-size:20px}
    .sheet{max-width:980px;margin:0 auto;border:1px solid var(--line);padding:16px;border-radius:10px;box-shadow:0 2px 14px rgba(0,0,0,.06)}

    .meta{display:grid;gap:6px 8px;margin-bottom:12px;grid-template-columns:repeat(8,1fr);font-size:13px}
    .meta label{display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 8px;border-radius:8px;background:#fff}
    .meta input{border:none;outline:none;width:100%;font-size:13px;background:transparent}
    .meta .span2{grid-column:span 2}.meta .span3{grid-column:span 3}.meta .span4{grid-column:span 4}
    .sign-note{align-self:center;font-size:14px;font-weight:700;color:var(--danger)}

    .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0}
    .toolbar button,.footer-actions button,.sig-tools button,.modal-foot button,.tabbar button{
      border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font-size:13px;cursor:pointer
    }

    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:780px}
    th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px;vertical-align:top}
    thead th{background:#f8fafc}
    .num{width:44px;text-align:center}.date{width:110px}.time{width:90px}
    .note textarea{width:100%;min-height:38px;border:none;resize:vertical;font-size:13px;line-height:1.35;outline:none}
    .sign-cell{position:relative;text-align:center;width:140px}
    .sign-btn{padding:4px 8px;font-size:12px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
    .signature{display:inline-flex;align-items:center;gap:6px;font-weight:600}
    .signature .pen{font-size:14px}

    /* 노쇼 버튼, 배지 */
    .ns-actions{ margin-top:6px; display:flex; gap:6px; justify-content:center; flex-wrap:wrap }
    .ns-actions .ns-btn{ border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer }
    .ns-badge{
      position:absolute; left:6px; bottom:4px; font-size:12px; font-weight:700;
      color:#991b1b; background:#ffe4e6; border:1px solid #fda4af; border-radius:999px; padding:2px 8px
    }

    /* 서명된 칸: 반투명 블럭 + '수정불가' 뱃지 */
    .signed{position:relative;pointer-events:none}
    .signed::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.06);border-radius:2px}
    .signed::after{
      content:"수정불가";position:absolute;right:6px;bottom:4px;font-size:12px;font-weight:700;
      color:var(--danger);background:rgba(255,255,255,.9);padding:2px 8px;border-radius:999px;border:1px solid var(--danger)
    }

    /* 행 잠금 & 노쇼 표시 */
    tr.row-locked{background:var(--accent)}
    tr.row-noshow{background:#fff2f2}
    tr.row-locked input, tr.row-locked textarea{background:transparent;color:#111}
    tr.row-locked .note textarea{pointer-events:none}

    /* 10번 20번 행 하이라이트 */
    tr[data-row="10"] td{border-bottom:2px solid var(--hl)}
    tr[data-row="20"] td{border-bottom:2px solid var(--hl)}

    .footer-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* 모달 */
    .hidden{display:none}
    .modal{position:fixed;inset:0;z-index:9999}
    .modal-dim{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .modal-card{
      position:relative;background:#fff;width:min(720px,96vw);margin:8vh auto;padding:14px;border-radius:12px;border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal-head h3{margin:0;font-size:16px}
    .close-btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .tabbar{display:flex;gap:8px;margin:8px 0 10px}
    .tabbar button{padding:6px 10px;border-radius:8px}
    .tabbar button.active{border-color:#111}
    .tab{display:none}
    .tab.active{display:block}

    .typed-pane input{width:100%;border:1px solid var(--line);border-radius:8px;padding:10px;font-size:16px}
    .drawn-pane .canvas-wrap{border:1px dashed var(--line);border-radius:10px;overflow:hidden;background:#fff}
    .drawn-pane canvas{display:block;width:100%;height:180px;touch-action:none;-ms-touch-action:none}

    .sig-tools{display:flex;gap:8px;justify-content:space-between;margin:8px 0}
    .sig-tools .hint{font-size:12px;color:var(--muted);align-self:center}
    .modal-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

    .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);
      background:rgba(17,17,17,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}

    /* 모바일 최적화 */
    @media (max-width: 900px){ .meta{grid-template-columns:repeat(4,1fr)} }
    @media (max-width: 640px){
      body{margin:12px}
      .sheet{padding:12px}
      .meta{grid-template-columns:repeat(2,1fr)}
      .meta label{padding:6px}
      .table-wrap{border-radius:8px}
    }
    @media (max-width: 420px){ .meta{grid-template-columns:1fr} h1{font-size:18px} }

    @media print{
      body{margin:0}
      .sheet{box-shadow:none;border:none;padding:0}
      .toolbar,.footer-actions,.modal,.toast{display:none !important}
      th,td{padding:4px 6px}
    }
  </style>
</head>
<body>
  <div class="sheet">
    <h1>개인 / 트레이닝 일지</h1>

    <div class="meta" aria-label="상단 정보">
      <label class="span3">회원 찾기
        <input id="m-search" list="memberOptions" placeholder="이름 · 연락처 검색" autocomplete="off">
        <datalist id="memberOptions"></datalist>
      </label>

      <label class="span2">이름 <input id="m-name" placeholder="회원명"></label>
      <label>생년월일
        <input id="m-birth" inputmode="numeric" pattern="[0-9\-]*" maxlength="10" placeholder="YYYY-MM-DD">
      </label>
      <label>연락처
        <input id="m-phone" inputmode="numeric" pattern="[0-9\-]*" maxlength="13" placeholder="010-0000-0000">
      </label>
      <label>레슨종류 <input id="m-lesson" placeholder="예: PT 50분"></label>
      <label>담당자 <input id="m-trainer" placeholder="트레이너명"></label>
      <label>시작일 <input id="m-start" type="date"></label>
      <label>페이지 <input id="m-page" placeholder="1"></label>
      <span class="sign-note">* 서명 후 수정 불가</span>
    </div>

    <div class="toolbar">
      <button type="button" onclick="window.print()">인쇄</button>
    </div>

    <div class="table-wrap">
      <table id="log">
        <thead>
          <tr>
            <th class="num">No</th>
            <th class="date">서비스일자</th>
            <th class="time">시간</th>
            <th>Teaching Point &amp; Check List</th>
            <th class="sign-cell">트레이너 서명</th>
            <th class="sign-cell">고객 서명</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer-actions">
      <button type="button" id="btnHome" onclick="goDashboard()">취소 / 메인으로</button>
      <button type="button" onclick="resetAll()">전체 초기화</button>
    </div>
  </div>

  <!-- 서명 모달 -->
  <div id="signModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="서명 입력">
    <div class="modal-dim" onclick="closeSignModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="signTitle">서명 입력</h3>
        <button type="button" class="close-btn" onclick="closeSignModal()">닫기</button>
      </div>

      <div class="tabbar">
        <button type="button" id="tabTyped" class="active" onclick="switchTab('typed')">타이핑</button>
        <button type="button" id="tabDrawn" onclick="switchTab('drawn')">손글씨</button>
      </div>

      <div id="paneTyped" class="tab typed-pane active">
        <input id="typedName" placeholder="이름(서명 표기)" />
      </div>

      <div id="paneDrawn" class="tab drawn-pane">
        <div class="canvas-wrap"><canvas id="sigCanvas"></canvas></div>
        <div class="sig-tools">
          <span class="hint">서명하세요. (두께: 2.5)</span>
          <div><button type="button" id="sigClear" onclick="clearCanvas()">지우기</button></div>
        </div>
      </div>

      <div class="modal-foot">
        <button type="button" onclick="closeSignModal()">취소</button>
        <button type="button" onclick="applySignature()">적용</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===== 앱 로직 (서명/로컬저장/노쇼 UI) ===== -->
  <script>
    "use strict";

    const DASHBOARD_URL = "dashboard.html";
    const RESET_PIN = "0000";

    const STORE_KEY = "mtf_pt_log_v4";
    let tbody, currentSign = null, lastTrainerTyped = "", lastCustomerTyped = "";
    let cvs, ctx, dpr=1, drawing=false, lastX=0, lastY=0;

    window.addEventListener('DOMContentLoaded', () => {
      try {
        tbody = document.getElementById('tbody');
        for (let i=1;i<=30;i++) tbody.appendChild(buildRow(i));
        loadFromStorage();
        bindAutoSave();
        initCanvas();
        initBirthAutoHyphen();
        initPhoneAutoHyphen();

        // 서명 버튼
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('.sign-btn');
          if (!btn) return;
          const td = btn.closest('td');
          if (!td || td.classList.contains('signed')) return;
          const role = btn.dataset.role || (td.cellIndex === 4 ? 'trainer' : 'customer');
          openSignModal(btn, role);
        });

        // 노쇼 버튼 (차감/미차감/취소)
        document.addEventListener('click', async (e)=>{
          const btn = e.target.closest('.ns-btn');
          if (!btn) return;
          const tr = btn.closest('tr');
          const mode = btn.dataset.mode; // 'deduct' | 'undeduct' | 'cancel'

          if (mode === 'cancel'){
            const prevType = tr?.dataset?.nsType;
            if (!prevType){ showToast('노쇼 처리된 행이 아닙니다'); return; }
            if (!verifyPin()) return;
            if (!confirm('이 행의 노쇼 처리를 취소할까요?')) return;

            removeNoshowUI(tr);
            saveToStorage();

            try{
              const ok = await cancelNoShowOnFirestore(prevType);
              if (ok === true) showToast('노쇼 취소 완료');
              else if (ok === 'no-member') showToast('회원 선택 시 집계 취소 반영');
            }catch{ showToast('집계 취소 실패'); }
            return;
          }

          const msg = mode==='deduct'
            ? '노쇼(차감) 처리할까요? (남은 회차 -1)'
            : '노쇼(미차감)으로 기록할까요?';
          if (!confirm(msg)) return;

          applyNoshowUI(tr, mode);
          saveToStorage();

          try{
            const ok = await applyNoShowOnFirestore(mode, tr);
            if (ok === true) showToast('노쇼 집계 반영 완료');
            else if (ok === 'no-member') showToast('회원 선택 시 집계가 반영됩니다');
          }catch{ showToast('집계 반영 실패'); }
        });

      } catch(err){
        showToast('초기화 오류: ' + (err?.message || err));
        console.error(err);
      }
    });

    window.addEventListener('error', (e)=>{
      showToast('오류: ' + (e.error?.message || e.message));
    });

    function buildRow(n){
      const tr = document.createElement('tr');
      tr.dataset.row = String(n);
      tr.innerHTML = `
        <td class="num">${n}</td>
        <td><input type="date" aria-label="날짜"></td>
        <td><input type="time" aria-label="시간" value="08:00"></td>
        <td class="note"><textarea placeholder="운동내용 / Teaching points"></textarea></td>
        <td class="sign-cell"><button type="button" class="sign-btn" data-role="trainer">서명</button></td>
        <td class="sign-cell">
          <button type="button" class="sign-btn" data-role="customer">서명</button>
          <div class="ns-actions">
            <button type="button" class="ns-btn" data-mode="deduct">노쇼(차감)</button>
            <button type="button" class="ns-btn" data-mode="undeduct">노쇼(미차감)</button>
            <button type="button" class="ns-btn" data-mode="cancel">노쇼 취소</button>
          </div>
        </td>
      `;
      return tr;
    }

    /* ===== 전화번호 자동 하이픈 ===== */
    function initPhoneAutoHyphen(){
      const el = document.getElementById('m-phone');
      if (!el) return;
      const handler = (e)=>{ e.target.value = formatPhone(e.target.value); };
      el.addEventListener('input', handler);
      el.addEventListener('blur', handler);
    }
    function formatPhone(raw){
      const v = String(raw).replace(/\D/g,'').slice(0,11);
      if (v.length <= 3) return v;
      if (v.length <= 7) return v.slice(0,3) + '-' + v.slice(3);
      return v.slice(0,3) + '-' + v.slice(3,7) + '-' + v.slice(7);
    }

    /* ===== 서명 모달 ===== */
    function openSignModal(btn, role){
      const cell = btn.closest('td');
      if (cell.classList.contains('signed')) return;
      currentSign = { cell, role };

      document.getElementById('signTitle').textContent =
        (role==='trainer'?'트레이너':'고객') + ' 서명 입력';
      document.getElementById('typedName').value =
        role==='trainer' ? lastTrainerTyped : lastCustomerTyped;

      switchTab('typed');

      const modal = document.getElementById('signModal');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=>resizeCanvas());
    }
    function closeSignModal(){
      currentSign = null;
      document.getElementById('signModal').classList.add('hidden');
    }
    function switchTab(which){
      document.getElementById('tabTyped').classList.toggle('active', which==='typed');
      document.getElementById('tabDrawn').classList.toggle('active', which==='drawn');
      document.getElementById('paneTyped').classList.toggle('active', which==='typed');
      document.getElementById('paneDrawn').classList.toggle('active', which==='drawn');
      if (which==='drawn') requestAnimationFrame(()=>resizeCanvas());
    }
    function applySignature(){
      if (!currentSign) return;
      const { cell, role } = currentSign;
      const usingTypedTab = document.getElementById('paneTyped').classList.contains('active');

      if (usingTypedTab){
        const name = (document.getElementById('typedName').value || "").trim();
        if (!name) return showToast('이름을 입력하세요');
        const prev = role==='trainer' ? lastTrainerTyped : lastCustomerTyped;
        if (prev && prev !== name) showToast('이 전 서명과 다릅니다');
        if (role==='trainer') lastTrainerTyped = name; else lastCustomerTyped = name;
        cell.innerHTML = `<div class="signature"><span class="pen">✍</span>${escapeHtml(name)}</div>`;
        cell.dataset.sigType = 'typed';
        cell.dataset.sigValue = name;
      } else {
        const dataURL = exportCanvas();
        if (!dataURL) return showToast('서명을 먼저 입력하세요');
        cell.innerHTML = `<div class="signature" style="flex-direction:column;gap:4px">
          <img src="${dataURL}" alt="서명 이미지" style="height:48px;max-width:120px;object-fit:contain"/>
          <small class="muted">손서명</small>
        </div>`;
        cell.dataset.sigType = 'drawn';
        cell.dataset.sigValue = dataURL;
      }

      cell.classList.add('signed');

      const tr = cell.parentElement;
      const both = [...tr.querySelectorAll('.sign-cell')].every(td=>td.classList.contains('signed'));
      if (both) lockRow(tr);

      saveToStorage();
      closeSignModal();
    }
    function lockRow(tr){
      tr.classList.add('row-locked');
      tr.querySelectorAll('input, textarea, button.sign-btn').forEach(el=>{
        if (el.tagName === 'BUTTON') el.disabled = true;
        else { el.readOnly = true; el.disabled = true; }
      });
    }

    /* ===== 노쇼 UI/검증 ===== */
    function verifyPin(){
      const pin = prompt('노쇼 취소 PIN을 입력하세요 (기본 0000)');
      if (pin !== RESET_PIN){ showToast('PIN이 올바르지 않습니다'); return false; }
      return true;
    }
    function applyNoshowUI(tr, mode){
      tr.classList.add('row-locked','row-noshow');
      tr.dataset.nsType = mode; // 'deduct' | 'undeduct'
      tr.querySelectorAll('input, textarea, button.sign-btn').forEach(el=>{
        if (el.tagName === 'BUTTON') el.disabled = true;
        else { el.readOnly = true; el.disabled = true; }
      });
      const lastCell = tr.querySelectorAll('td')[5];
      if (lastCell && !lastCell.querySelector('.ns-badge')){
        lastCell.insertAdjacentHTML('beforeend',
          `<div class="ns-badge">노쇼-${mode==='deduct'?'차감':'미차감'}</div>`);
      }
    }
    function removeNoshowUI(tr){
      const badge = tr.querySelector('.ns-badge'); if (badge) badge.remove();
      tr.classList.remove('row-noshow');
      delete tr.dataset.nsType;

      const signedBoth = [...tr.querySelectorAll('.sign-cell')]
        .every(td=>td.classList.contains('signed'));

      if (!signedBoth){
        tr.classList.remove('row-locked');
        tr.querySelectorAll('input, textarea, button').forEach(el=>{
          if (el.classList.contains('sign-btn')){
            if (!el.closest('td').classList.contains('signed')) el.disabled = false;
          } else {
            el.disabled = false;
            if (el.tagName !== 'BUTTON') el.readOnly = false;
          }
        });
      }
    }

    /* ===== 저장/복원 ===== */
    function bindAutoSave(){
      document.querySelectorAll('input, textarea').forEach(el=>{
        el.addEventListener('input', debounce(saveToStorage, 200));
      });
    }
    function collectData(){
      const meta = {
        name: val('#m-name'), birth: val('#m-birth'), phone: val('#m-phone'),
        lesson: val('#m-lesson'), trainer: val('#m-trainer'), start: val('#m-start'), page: val('#m-page')
      };
      const rows = [...tbody.children].map(tr=>{
        const tds = tr.querySelectorAll('td');
        const trainerCell = tds[4], customerCell = tds[5];
        const trainerType = trainerCell.dataset.sigType || (trainerCell.classList.contains('signed') ? 'typed' : '');
        const trainerVal  = trainerCell.dataset.sigValue || (trainerCell.classList.contains('signed') ? trainerCell.innerText.trim() : '');
        const customerType = customerCell.dataset.sigType || (customerCell.classList.contains('signed') ? 'typed' : '');
        const customerVal  = customerCell.dataset.sigValue || (customerCell.classList.contains('signed') ? customerCell.innerText.trim() : '');
        return {
          n: tr.dataset.row,
          date: tds[1].querySelector('input').value || "",
          time: tds[2].querySelector('input').value || "",
          note: tds[3].querySelector('textarea').value || "",
          trainerSigType: trainerType,
          trainerSigValue: trainerVal,
          customerSigType: customerType,
          customerSigValue: customerVal,
          trainerSig: trainerType==='typed' ? trainerVal : "",
          customerSig: customerType==='typed' ? customerVal : "",
          locked: tr.classList.contains('row-locked'),
          nsType: tr.dataset.nsType || ""   // ★ 노쇼 타입 저장
        };
      });
      return {meta, rows};
    }
    function saveToStorage(){
      try{ localStorage.setItem(STORE_KEY, JSON.stringify(collectData())); }
      catch(e){ showToast('저장 오류'); console.warn(e); }
    }
    function loadFromStorage(){
      let raw; try{ raw = localStorage.getItem(STORE_KEY); }catch(e){}
      if (!raw) return;
      let data; try{ data = JSON.parse(raw); }catch(e){ return; }
      const {meta, rows} = data;

      setVal('#m-name', meta.name);
      setVal('#m-birth', formatBirth(meta.birth || ""));
      setVal('#m-phone', formatPhone(meta.phone || ""));
      setVal('#m-lesson', meta.lesson);
      setVal('#m-trainer', meta.trainer);
      setVal('#m-start', meta.start);
      setVal('#m-page', meta.page);

      rows?.forEach(r=>{
        const tr = tbody.querySelector(`tr[data-row="${r.n}"]`);
        if (!tr) return;
        const tds = tr.querySelectorAll('td');
        tds[1].querySelector('input').value = r.date || "";
        tds[2].querySelector('input').value = r.time || "";
        tds[3].querySelector('textarea').value = r.note || "";

        restoreCell(tds[4], r.trainerSigType, r.trainerSigValue, r.trainerSig);
        restoreCell(tds[5], r.customerSigType, r.customerSigValue, r.customerSig);

        if (r.locked){ lockRow(tr); }
        if (r.nsType){ applyNoshowUI(tr, r.nsType); } // ★ 노쇼 복원
      });

      lastTrainerTyped = findLastTyped('trainer');
      lastCustomerTyped = findLastTyped('customer');
    }
    function restoreCell(td, type, value, legacyText){
      if (!type && !legacyText) return;
      if (type === 'drawn' && value){
        td.innerHTML = `<div class="signature" style="flex-direction:column;gap:4px">
          <img src="${value}" alt="서명 이미지" style="height:48px;max-width:120px;object-fit:contain"/>
          <small class="muted">손서명</small>
        </div>`;
        td.classList.add('signed');
        td.dataset.sigType = 'drawn';
        td.dataset.sigValue = value;
      } else {
        const text = value || legacyText || "";
        if (!text) return;
        td.innerHTML = `<div class="signature"><span class="pen">✍</span>${escapeHtml(text)}</div>`;
        td.classList.add('signed');
        td.dataset.sigType = 'typed';
        td.dataset.sigValue = text;
      }
    }
    function findLastTyped(role){
      const idx = role==='trainer' ? 4 : 5;
      let last = "";
      [...tbody.children].forEach(tr=>{
        const td = tr.querySelectorAll('td')[idx];
        if (td && td.dataset.sigType === 'typed' && td.dataset.sigValue){
          last = td.dataset.sigValue;
        }
      });
      return last;
    }

    /* ===== 생년월일 자동 하이픈 ===== */
    function initBirthAutoHyphen(){
      const el = document.getElementById('m-birth');
      el.addEventListener('input', (e)=>{
        const v = e.target.value.replace(/\D/g,'').slice(0,8);
        e.target.value = formatBirth(v);
      });
      el.addEventListener('blur', (e)=>{
        const v = e.target.value.replace(/\D/g,'');
        e.target.value = formatBirth(v);
      });
    }
    function formatBirth(raw){
      const v = String(raw).replace(/\D/g,'').slice(0,8);
      if (v.length <= 4) return v;
      if (v.length <= 6) return v.slice(0,4)+'-'+v.slice(4);
      return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);
    }

    function resetAll(){
      const pin = prompt('전체 초기화를 위해 PIN을 입력하세요 (기본 0000)');
      if (pin !== RESET_PIN){ showToast('비밀번호가 일치하지 않습니다'); return; }
      if (!confirm('모든 내용을 초기화할까요? (되돌릴 수 없음)')) return;
      try{ localStorage.removeItem(STORE_KEY); }catch(e){}
      location.reload();
    }
    function goDashboard(){ location.href = DASHBOARD_URL; }

    /* ===== Canvas 서명 ===== */
    function initCanvas(){
      cvs = document.getElementById('sigCanvas');
      ctx = cvs.getContext('2d', { willReadFrequently: true });
      resizeCanvas();

      const supportsPointer = 'PointerEvent' in window;
      if (supportsPointer){
        cvs.addEventListener('pointerdown', startDraw, {passive:false});
        cvs.addEventListener('pointermove', moveDraw,   {passive:false});
        window.addEventListener('pointerup', endDraw);
        cvs.addEventListener('pointerleave', endDraw);
      } else {
        cvs.addEventListener('mousedown', mouseDown);
        window.addEventListener('mousemove', mouseMove);
        window.addEventListener('mouseup', mouseUp);
        cvs.addEventListener('touchstart', touchStart, {passive:false});
        cvs.addEventListener('touchmove',  touchMove,  {passive:false});
        window.addEventListener('touchend', touchEnd);
        cvs.addEventListener('touchcancel', touchEnd);
      }
      window.addEventListener('resize', resizeCanvas);
    }
    function resizeCanvas(){
      const rect = cvs.getBoundingClientRect();
      dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = rect.width > 0 ? rect.width : 600;
      cvs.width  = Math.floor(w * dpr);
      cvs.height = Math.floor(180 * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      clearCanvas();
    }
    function beginStroke(x,y){ drawing = true; lastX=x; lastY=y; }
    function drawTo(x,y){
      if (!drawing) return;
      ctx.lineWidth = 2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111';
      ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
      lastX=x; lastY=y;
    }
    function endStroke(){ drawing = false; }
    function startDraw(e){ e.preventDefault(); if (e.pointerId && cvs.setPointerCapture) { try{ cvs.setPointerCapture(e.pointerId); }catch{} } const p=getPos(e); beginStroke(p.x,p.y); }
    function moveDraw(e){ if(!drawing) return; e.preventDefault(); const p=getPos(e); drawTo(p.x,p.y); }
    function endDraw(){ endStroke(); }
    function mouseDown(e){ const p=getMousePos(e); beginStroke(p.x,p.y); }
    function mouseMove(e){ const p=getMousePos(e); drawTo(p.x,p.y); }
    function mouseUp(){ endStroke(); }
    function touchStart(e){ if(!e.touches[0]) return; const p=getTouchPos(e.touches[0]); beginStroke(p.x,p.y); e.preventDefault(); }
    function touchMove(e){ if(!drawing || !e.touches[0]) return; const p=getTouchPos(e.touches[0]); drawTo(p.x,p.y); e.preventDefault(); }
    function touchEnd(){ endStroke(); }
    function getPos(e){ const r = cvs.getBoundingClientRect(); return { x:(e.clientX||0)-r.left, y:(e.clientY||0)-r.top }; }
    function getMousePos(e){ const r=cvs.getBoundingClientRect(); return { x:e.clientX-r.left, y:e.clientY-r.top }; }
    function getTouchPos(t){ const r=cvs.getBoundingClientRect(); return { x:t.clientX-r.left, y:t.clientY-r.top }; }
    function clearCanvas(){ ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,cvs.width,cvs.height); ctx.restore(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,cvs.width,cvs.height); }
    function isCanvasBlank(){ const { data } = ctx.getImageData(0,0,cvs.width,cvs.height); for (let i=0;i<data.length;i+=4){ const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3]; if (!(r===255 && g===255 && b===255 && a===255)) return false; } return true; }
    function exportCanvas(){ return isCanvasBlank() ? null : cvs.toDataURL('image/png'); }

    /* ===== 유틸 ===== */
    function val(sel){const el=document.querySelector(sel);return el?el.value:"";}
    function setVal(sel,v){const el=document.querySelector(sel); if(el) el.value=v||"";}
    function escapeHtml(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
    function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    function showToast(msg){ const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2000); }
  </script>

  <!-- ===== Firebase: 회원 선택/집계 반영/취소 ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc,
      updateDoc, increment, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
      authDomain: "more-than-fitness-f6adb.firebaseapp.com",
      projectId: "more-than-fitness-f6adb",
      storageBucket: "more-than-fitness-f6adb.appspot.com",
      messagingSenderId: "993248877411",
      appId: "1:993248877411:web:c0e6785162cf252fbcd156",
      measurementId: "G-MK0RVFG296"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const auth = getAuth(app);
    async function ensureAuthed(){
      return new Promise(resolve=>{
        onAuthStateChanged(auth, async (u)=>{
          if (u) return resolve(u);
          try{ const cred = await signInAnonymously(auth); resolve(cred.user); }
          catch(e){ console.warn(e); resolve(null); }
        });
      });
    }

    const searchInput = document.getElementById("m-search");
    const datalist    = document.getElementById("memberOptions");
    const indexMap = new Map();
    window.currentMemberId = null;

    await ensureAuthed();

    // ?id= 로 진입 시 자동 채움
    (async function initByQuery(){
      const id = new URLSearchParams(location.search).get("id");
      if (!id) return;
      try{
        const snap = await getDoc(doc(db, "members", id));
        if (snap.exists()){
          prefillFromMember(snap.data());
          const label = makeLabelFromDoc(snap.id, snap.data());
          searchInput.value = label;
          indexMap.set(label, snap.id);
          window.currentMemberId = id;
        }
      }catch(e){ console.warn(e); }
    })();

    // 멤버 목록 → datalist
    (async function loadMemberOptions(){
      try{
        const snap = await getDocs(collection(db, "members"));
        snap.forEach(docSnap=>{
          const x = docSnap.data();
          const label = makeLabelFromDoc(docSnap.id, x);
          const opt = document.createElement("option");
          opt.value = label;
          datalist.appendChild(opt);
          indexMap.set(label, docSnap.id);
        });
      }catch(e){ console.error(e); }
    })();

    function makeLabelFromDoc(id, x){
      const name  = x.name || "(무명)";
      const phone = x.phoneDisplay || formatPhone(x.phone||"");
      const type  = x.lessonType || "";
      const grade = x.level || "";
      return `${name} · ${phone}${type?` · ${type}`:""}${grade?` · ${grade}`:""} [${id}]`;
    }

    searchInput.addEventListener("change", async ()=>{
      const label = searchInput.value;
      const id = indexMap.get(label);
      if (!id) return;
      try{
        const snap = await getDoc(doc(db, "members", id));
        if (snap.exists()) prefillFromMember(snap.data());
        window.currentMemberId = id;
      }catch(e){ console.error(e); }
    });

    function prefillFromMember(x){
      const onlyDigits = (s)=> String(s||"").replace(/\D/g,"");
      const fmtBirth = (raw)=>{
        const v = onlyDigits(raw).slice(0,8);
        if (v.length<=4) return v;
        if (v.length<=6) return v.slice(0,4)+'-'+v.slice(4);
        return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);
      };
      const fmtPhone = (raw)=>{
        const v = onlyDigits(raw).slice(0,11);
        if (v.length<=3) return v;
        if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
        return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
      };
      const toDateValue = (v)=>{
        try{
          const d = v?.toDate ? v.toDate() : (v ? new Date(v) : null);
          return d ? new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10) : "";
        }catch{ return ""; }
      };

      document.getElementById('m-name').value    = x.name || '';
      document.getElementById('m-birth').value   = x.birthDisplay || fmtBirth(x.birth||'');
      document.getElementById('m-phone').value   = x.phoneDisplay || fmtPhone(x.phone||'');
      document.getElementById('m-lesson').value  = x.lessonType || '';
      document.getElementById('m-trainer').value = x.trainer || '';
      document.getElementById('m-start').value   = x.startDate || toDateValue(x.createdAt) || '';

      try{
        const raw = localStorage.getItem("mtf_pt_log_v4");
        const data = raw ? JSON.parse(raw) : {meta:{}, rows:[]};
        data.meta = {
          ...data.meta,
          name: document.getElementById('m-name').value,
          birth: document.getElementById('m-birth').value,
          phone: document.getElementById('m-phone').value,
          lesson: document.getElementById('m-lesson').value,
          trainer: document.getElementById('m-trainer').value,
          start: document.getElementById('m-start').value,
          page: document.getElementById('m-page').value || ""
        };
        localStorage.setItem("mtf_pt_log_v4", JSON.stringify(data));
      }catch(e){}
    }

    function formatPhone(raw){
      const v = String(raw||"").replace(/\D/g,'').slice(0,11);
      if (v.length<=3) return v;
      if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
      return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
    }

    /* ===== 노쇼 집계: 메인 스크립트가 호출 ===== */
    window.applyNoShowToMember = async (mode, meta)=>{
      const id = window.currentMemberId;
      if (!id) return { ok:false, reason:'no-member' };

      const payload = {
        updatedAt: serverTimestamp(),
        lastLogAt: meta?.jsDate || new Date()
      };
      if (mode==='deduct'){
        payload.noShowDeducted    = increment(1);
        payload.remainingSessions = increment(-1);
      } else {
        payload.noShowUndeducted  = increment(1);
      }
      await updateDoc(doc(db,"members",id), payload);
      return { ok:true };
    };

    window.cancelNoShowOnMember = async (prevType)=>{
      const id = window.currentMemberId;
      if (!id) return { ok:false, reason:'no-member' };

      const payload = { updatedAt: serverTimestamp() };
      if (prevType==='deduct'){
        payload.noShowDeducted    = increment(-1);
        payload.remainingSessions = increment(1);
      } else if (prevType==='undeduct'){
        payload.noShowUndeducted  = increment(-1);
      }
      await updateDoc(doc(db,"members",id), payload);
      return { ok:true };
    };
  </script>
</body>
</html>
