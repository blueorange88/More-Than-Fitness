<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>개인 / 트레이닝 일지 (통합·버튼형)</title>
<style>
  :root{--line:#d7d7d7;--ink:#1f2937;--muted:#6b7280;--accent:#f59e0b22;--hl:#ffa500;--danger:#dc2626;}
  *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--ink);margin:24px}
  h1{margin:0 0 8px;font-size:20px}
  .sheet{max-width:1100px;margin:0 auto;border:1px solid var(--line);padding:16px;border-radius:10px;box-shadow:0 2px 14px rgba(0,0,0,.06)}
  .topline{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .toolbar button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font-size:13px;cursor:pointer}
  .chip{font-size:12px;color:#111;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px}
  .meta{display:grid;gap:6px 8px;margin:8px 0 12px;grid-template-columns:repeat(8,1fr);font-size:13px}
  .meta label{display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 8px;border-radius:8px;background:#fff}
  .meta input{border:none;outline:none;width:100%;font-size:13px;background:transparent}
  .meta .span2{grid-column:span 2}.meta .span3{grid-column:span 3}
  .sign-note{align-self:center;font-size:14px;font-weight:700;color:var(--danger)}
  /* 입력방식 스위처 */
  .modebar{display:flex;gap:8px;align-items:center;margin:4px 0 10px}
  .modebar .btn{border:1px solid var(--line);border-radius:10px;background:#fff;padding:7px 10px;font-size:13px;cursor:pointer}
  .modebar .btn.active{border-color:#111;font-weight:800}
  .mode-panel{border:1px dashed var(--line);border-radius:10px;padding:10px;margin-bottom:12px;background:#fff}
  .tgt{font-size:12px;color:#334155;margin-left:auto}
  /* 카트리지 */
  .c-rows{display:grid;gap:8px}
  .c-row{display:grid;grid-template-columns:140px 1fr 2fr auto;gap:8px}
  .c-row select,.c-row input,.c-row textarea{border:1px solid var(--line);border-radius:8px;padding:8px;font-size:13px}
  .c-row textarea{min-height:40px;resize:vertical}
  .c-row .del{border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  /* 필기 */
  .note-area{width:100%;min-height:140px;border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;line-height:1.45;resize:vertical}
  /* 세분화표(간이) */
  .seg{display:grid;gap:6px}
  .seg-row{display:grid;grid-template-columns:1fr repeat(5,60px);gap:6px;align-items:center}
  .seg input[type="text"]{border:1px solid var(--line);border-radius:8px;padding:8px;font-size:13px}
  .seg .chk{display:flex;justify-content:center;align-items:center;border:1px solid var(--line);border-radius:8px;height:36px;cursor:pointer}
  .seg .chk.on{background:#f0f9ff;border-color:#93c5fd}
  /* 표 + 서명/노쇼 (기존) */
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;min-width:780px}
  th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px;vertical-align:top}
  thead th{background:#f8fafc}
  .num{width:44px;text-align:center}.date{width:110px}.time{width:90px}
  .note textarea{width:100%;min-height:38px;border:none;resize:vertical;font-size:13px;line-height:1.35;outline:none}
  .sign-cell{position:relative;text-align:center;width:180px}
  .sign-btn{padding:4px 8px;font-size:12px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
  .signature{display:inline-flex;align-items:center;gap:6px;font-weight:600}
  .signature .pen{font-size:14px}
  .more-btn{margin-top:6px;border:1px dashed var(--line);background:#fff;border-radius:8px;padding:3px 8px;font-size:12px;cursor:pointer}
  .ns-badge{position:absolute;left:6px;bottom:4px;font-size:12px;font-weight:700;color:#991b1b;background:#ffe4e6;border:1px solid #fda4af;border-radius:999px;padding:2px 8px}
  .signed{position:relative;pointer-events:none}
  .signed::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.06);border-radius:2px}
  .signed::after{content:"수정불가";position:absolute;right:6px;bottom:4px;font-size:12px;font-weight:700;color:var(--danger);background:rgba(255,255,255,.9);padding:2px 8px;border-radius:999px;border:1px solid var(--danger)}
  tr.row-locked{background:var(--accent)} tr.row-noshow{background:#fff2f2}
  .footer-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  /* 모달들 */
  .hidden{display:none}
  .modal{position:fixed;inset:0;z-index:9999}
  .dim{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .card{position:relative;background:#fff;width:min(720px,96vw);margin:8vh auto;padding:14px;border-radius:12px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h3{margin:0 0 8px;font-size:16px}
  .close{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .mp-list{max-height:50vh;overflow:auto;border:1px solid var(--line);border-radius:8px}
  .mp-item{padding:8px 10px;border-bottom:1px solid #eee;cursor:pointer}
  .mp-item:hover{background:#f8fafc}
  /* 드로어 */
  .drawer{position:fixed;inset:0;z-index:9998;display:none}
  .drawer.show{display:block}
  .drawer-dim{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .drawer-panel{position:absolute;right:0;top:0;height:100%;width:min(320px,90vw);background:#fff;border-left:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;flex-direction:column}
  .drawer-head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
  .drawer-body{padding:12px;display:flex;flex-direction:column;gap:10px}
  .drawer .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px;cursor:pointer;text-align:left;font-size:14px}
  .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:rgba(17,17,17,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
  @media (max-width:900px){.meta{grid-template-columns:repeat(4,1fr)} .c-row{grid-template-columns:120px 1fr 2fr auto}}
  @media (max-width:640px){body{margin:12px}.sheet{padding:12px}.meta{grid-template-columns:repeat(2,1fr)}.c-row{grid-template-columns:1fr 1fr 2fr auto}}
</style>
</head>
<body>
<div class="sheet">
  <div class="topline">
    <h1>개인 / 트레이닝 일지 (통합)</h1>
    <div class="toolbar">
      <span id="chip" class="chip">mid=?, sid=?</span>
      <button id="btnMemberPick">회원찾기</button>
      <button id="btnCloud">저장(클라우드)</button>
      <button onclick="window.print()">인쇄</button>
      <button id="btnHome">메인으로</button>
    </div>
  </div>

  <!-- 상단 메타 -->
  <div class="meta">
    <label class="span2">이름
      <input id="m-name" list="nameOptions" placeholder="회원명 (자동완성)">
      <datalist id="nameOptions"></datalist>
    </label>
    <label>생년월일 <input id="m-birth" inputmode="numeric" maxlength="10" placeholder="YYYY-MM-DD"></label>
    <label>연락처   <input id="m-phone" inputmode="numeric" maxlength="13" placeholder="010-0000-0000"></label>
    <label>레슨종류 <input id="m-lesson" placeholder="예: PT 50분"></label>
    <label>담당자   <input id="m-trainer" placeholder="트레이너명"></label>
    <label>시작일   <input id="m-start" type="date"></label>
    <label>페이지   <input id="m-page" placeholder="1"></label>
    <span class="sign-note">* 서명 후 수정 불가</span>
  </div>

  <!-- 입력 방식 버튼 + 패널 -->
  <div class="modebar">
    <strong>입력 방식</strong>
    <button class="btn active" data-mode="cartridge">카트리지(분류)</button>
    <button class="btn" data-mode="note">필기/타이핑</button>
    <button class="btn" data-mode="seg">세분화표</button>
    <span id="tgtRow" class="tgt">대상 행: 1</span>
  </div>

  <div id="panel-cartridge" class="mode-panel">
    <div class="c-rows" id="cRows"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="btnAddC">행 추가</button>
      <button id="btnApplyC">현재 행에 추가 →</button>
      <button id="btnClearC">패널 초기화</button>
    </div>
  </div>

  <div id="panel-note" class="mode-panel hidden">
    <textarea id="noteArea" class="note-area" placeholder="여기에 입력하고 ‘현재 행에 적용’ 클릭"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="btnApplyNote">현재 행에 적용 →</button>
      <button id="btnClearNote">내용 지우기</button>
    </div>
  </div>

  <div id="panel-seg" class="mode-panel hidden">
    <div class="seg" id="segBox"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="btnApplySeg">현재 행에 적용 →</button>
      <button id="btnClearSeg">표 초기화</button>
    </div>
  </div>

  <!-- 큰 틀(표 + 서명/노쇼) : 항상 노출 -->
  <div class="table-wrap">
    <table id="log">
      <thead>
        <tr>
          <th class="num">No</th>
          <th class="date">서비스일자</th>
          <th class="time">시간</th>
          <th>Teaching Point &amp; Check List</th>
          <th class="sign-cell">트레이너 서명</th>
          <th class="sign-cell">고객 서명 / 더보기</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer-actions">
    <button id="btnResetTable">표 전체 초기화</button>
  </div>
</div>

<!-- 회원찾기 모달 -->
<div id="memberModal" class="modal hidden">
  <div class="dim" data-close></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>회원 찾기</h3>
      <button class="close" data-close>닫기</button>
    </div>
    <div style="display:flex;gap:8px;margin:6px 0 8px">
      <input id="mp-q" list="nameOptions" placeholder="이름·연락처로 검색" style="flex:1;border:1px solid var(--line);border-radius:8px;padding:10px">
      <button id="mp-apply" class="close">선택 적용</button>
    </div>
    <div id="mp-list" class="mp-list"></div>
  </div>
</div>

<!-- 서명 모달 -->
<div id="signModal" class="modal hidden">
  <div class="dim" data-close></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="signTitle">서명 입력</h3>
      <button class="close" data-close>닫기</button>
    </div>
    <div style="display:flex;gap:8px;margin:8px 0">
      <button id="sigTypedBtn">타이핑</button>
      <button id="sigDrawBtn">손글씨</button>
    </div>
    <div id="paneTyped"><input id="typedName" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:10px" placeholder="이름(서명 표기)"/></div>
    <div id="paneDrawn" class="hidden">
      <div style="border:1px dashed var(--line);border-radius:10px;overflow:hidden;background:#fff"><canvas id="sigCanvas" style="display:block;width:100%;height:180px;touch-action:none"></canvas></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <span class="muted" style="font-size:12px">서명하세요. (두께:2.5)</span>
        <button id="sigClear">지우기</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button data-close>취소</button>
      <button id="sigApply">적용</button>
    </div>
  </div>
</div>

<!-- 노쇼 드로어 -->
<div id="nsDrawer" class="drawer" aria-hidden="true">
  <div class="drawer-dim" data-dim></div>
  <div class="drawer-panel">
    <div class="drawer-head">
      <strong>노쇼 / 기타</strong>
      <button class="close" data-close>닫기</button>
    </div>
    <div class="drawer-body">
      <button class="btn" data-action="deduct">노쇼(차감) 처리</button>
      <button class="btn" data-action="undeduct">노쇼(미차감) 처리</button>
      <button class="btn" data-action="cancel">노쇼 취소 (PIN)</button>
      <div class="muted" style="font-size:12px">TIP: 고객 서명 칸을 길게 누르면(0.6초) 이 패널이 열립니다.</div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ===== 메인 로직 (에디터 + 표 + 저장/복원) ===== -->
<script>
"use strict";

/* -------- URL / 공통 -------- */
const q = new URLSearchParams(location.search);
window.MID = q.get('mid') || '';
window.SID = q.get('sid') || '';
window.DOC_ID = (MID && SID)? `${MID}__${SID}` : 'local_only';
window.STORE_KEY = `mtf_pt_log_v6_${DOC_ID}`;
document.getElementById('chip').textContent = `mid=${MID||'?'} · sid=${SID||'?'} · doc=${DOC_ID}`;
document.getElementById('btnHome').addEventListener('click', ()=> location.href='dashboard.html');

/* -------- 표(큰틀) -------- */
let tbody, currentRow = 1;
function buildRow(n){
  const tr = document.createElement('tr');
  tr.dataset.row = String(n);
  tr.innerHTML = `
    <td class="num">${n}</td>
    <td><input type="date" aria-label="날짜"></td>
    <td><input type="time" aria-label="시간" value="08:00"></td>
    <td class="note"><textarea placeholder="운동내용 / Teaching points"></textarea></td>
    <td class="sign-cell"><button type="button" class="sign-btn" data-role="trainer">서명</button></td>
    <td class="sign-cell">
      <button type="button" class="sign-btn" data-role="customer">서명</button>
      <div><button type="button" class="more-btn" aria-label="더보기">⋯</button></div>
    </td>`;
  tr.querySelectorAll('input,textarea').forEach(el=>{
    el.addEventListener('input', debounce(saveLocal,150));
    el.addEventListener('focus', ()=> setTargetRow(n));
  });
  return tr;
}
function initTable(){
  tbody = document.getElementById('tbody'); tbody.innerHTML='';
  for(let i=1;i<=30;i++) tbody.appendChild(buildRow(i));
  setTargetRow(1);
}
function setTargetRow(n){ currentRow = n; document.getElementById('tgtRow').textContent = `대상 행: ${n}`; }
function noteTextareaOf(n){ return tbody.querySelector(`tr[data-row="${n}"] .note textarea`); }
document.getElementById('btnResetTable').addEventListener('click', ()=>{
  const pin = prompt('표 전체 초기화 PIN (기본 0000)'); if(pin!=='0000') return toast('취소됨');
  if(confirm('모든 행을 초기화할까요?')){ initTable(); saveLocal(); }
});

function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); }

/* -------- 입력 방식 버튼 & 패널 전환 -------- */
let mode='cartridge';
document.querySelector('.modebar').addEventListener('click',(e)=>{
  const b=e.target.closest('[data-mode]'); if(!b) return;
  mode=b.dataset.mode;
  document.querySelectorAll('.modebar .btn').forEach(x=>x.classList.toggle('active',x.dataset.mode===mode));
  ['cartridge','note','seg'].forEach(m=>{
    document.getElementById(`panel-${m}`).classList.toggle('hidden', m!==mode);
  });
});

/* -------- 카트리지 패널 -------- */
const DEFAULT_GROUPS=['A스트레칭','근력운동','기능성운동','교정재활','리커버리','셀프메뉴얼','기타'];
const cRows = document.getElementById('cRows');
function addCRow(pref){ const d=document.createElement('div'); d.className='c-row';
  d.innerHTML=`<select class="g1">${DEFAULT_GROUPS.map(g=>`<option>${g}</option>`).join('')}</select>
  <input class="g2" placeholder="중분류 (예: 상체/하지/흉근)">
  <textarea class="desc" placeholder="세부 내용"></textarea>
  <button class="del">삭제</button>`;
  if(pref){ d.querySelector('.g1').value=pref.g1||DEFAULT_GROUPS[0]; d.querySelector('.g2').value=pref.g2||''; d.querySelector('.desc').value=pref.desc||'';}
  d.addEventListener('input',debounce(saveLocal,150));
  d.querySelector('.del').addEventListener('click',()=>{ d.remove(); saveLocal();});
  cRows.appendChild(d);
}
document.getElementById('btnAddC').addEventListener('click',()=>addCRow());
document.getElementById('btnClearC').addEventListener('click',()=>{ cRows.innerHTML=''; addCRow(); saveLocal();});
document.getElementById('btnApplyC').addEventListener('click',()=>{
  const lines=[...cRows.children].map(r=>{
    const g1=r.querySelector('.g1').value, g2=r.querySelector('.g2').value.trim(), de=r.querySelector('.desc').value.trim();
    if(!g2 && !de) return null; return `${g1}${g2?` > ${g2}`:''}${de?` : ${de}`:''}`;
  }).filter(Boolean);
  const ta=noteTextareaOf(currentRow); if(!ta) return;
  ta.value = (ta.value? ta.value+'\n':'') + lines.join('\n');
  saveLocal(); toast('현재 행에 추가됨');
});

/* -------- 필기 패널 -------- */
document.getElementById('btnApplyNote').addEventListener('click',()=>{
  const v=document.getElementById('noteArea').value.trim(); const ta=noteTextareaOf(currentRow); if(!ta) return;
  ta.value = v; saveLocal(); toast('현재 행에 적용됨');
});
document.getElementById('btnClearNote').addEventListener('click',()=>{ document.getElementById('noteArea').value=''; });

/* -------- 세분화표(간이) 패널 -------- */
const segBox=document.getElementById('segBox');
function initSeg(){
  segBox.innerHTML='';
  for(let i=1;i<=8;i++){
    const row=document.createElement('div'); row.className='seg-row';
    row.innerHTML=`<input type="text" placeholder="${i}. 운동명">
      ${[1,2,3,4,5].map(()=>`<div class="chk" aria-label="set"></div>`).join('')}`;
    row.addEventListener('click',e=>{
      const c=e.target.closest('.chk'); if(c) c.classList.toggle('on');
    });
    segBox.appendChild(row);
  }
}
document.getElementById('btnClearSeg').addEventListener('click',initSeg);
document.getElementById('btnApplySeg').addEventListener('click',()=>{
  const lines=[...segBox.children].map((r,idx)=>{
    const name=r.querySelector('input').value.trim(); if(!name) return null;
    const sets=[...r.querySelectorAll('.chk')].map((c,i)=>c.classList.contains('on')?`${i+1}set✓`:null).filter(Boolean).join(' ');
    return `${idx+1}. ${name}${sets?` (${sets})`:''}`;
  }).filter(Boolean);
  const ta=noteTextareaOf(currentRow); if(!ta) return;
  ta.value = lines.join('\n'); saveLocal(); toast('현재 행에 적용됨');
});

/* -------- 서명/노쇼(기존 UX 유지, 요약) -------- */
let currentSign=null,lastTrainerTyped="",lastCustomerTyped="";
const nsDrawer=document.getElementById('nsDrawer'); let currentActionRow=null;
function openNsDrawer(tr){ currentActionRow=tr; nsDrawer.classList.add('show'); }
function closeNsDrawer(){ nsDrawer.classList.remove('show'); currentActionRow=null; }
nsDrawer.addEventListener('click',e=>{ if(e.target.dataset.dim!==undefined || e.target.dataset.close!==undefined) closeNsDrawer(); });
nsDrawer.addEventListener('click',async e=>{
  const b=e.target.closest('[data-action]'); if(!b) return;
  const mode=b.dataset.action; if(!currentActionRow) return;
  if(mode==='cancel'){ if(!confirm('노쇼 취소할까요?')) return; removeNoshowUI(currentActionRow); saveLocal(); try{ const r=await window.cancelNoShowOnMember(currentActionRow.dataset.nsType); if(r?.ok) toast('노쇼 취소'); }catch{}; closeNsDrawer(); return;}
  if(!confirm(mode==='deduct'?'노쇼(차감) 처리?':'노쇼(미차감) 처리?')) return;
  applyNoshowUI(currentActionRow,mode); saveLocal();
  try{ const d=currentActionRow.querySelector('input[type="date"]').value; const jsDate=d?new Date(d+'T00:00:00'):new Date(); await window.applyNoShowToMember(mode,{jsDate}); toast('노쇼 반영'); }catch{}
  closeNsDrawer();
});
function applyNoshowUI(tr,mode){
  tr.classList.add('row-locked','row-noshow'); tr.dataset.nsType=mode;
  tr.querySelectorAll('input,textarea,button.sign-btn').forEach(el=>{ if(el.tagName==='BUTTON') el.disabled=true; else {el.readOnly=true; el.disabled=true;} });
  const lastCell=tr.querySelectorAll('td')[5]; if(lastCell && !lastCell.querySelector('.ns-badge')) lastCell.insertAdjacentHTML('beforeend', `<div class="ns-badge">노쇼-${mode==='deduct'?'차감':'미차감'}</div>`);
}
function removeNoshowUI(tr){ tr.querySelector('.ns-badge')?.remove(); tr.classList.remove('row-noshow'); delete tr.dataset.nsType;
  const signed=[...tr.querySelectorAll('.sign-cell')].every(td=>td.classList.contains('signed')); if(!signed){ tr.classList.remove('row-locked'); tr.querySelectorAll('input,textarea,button').forEach(el=>{ el.disabled=false; if(el.tagName!=='BUTTON') el.readOnly=false; }); } }
document.addEventListener('click',e=>{
  const btn=e.target.closest('.sign-btn'); if(btn){ const td=btn.closest('td'); if(td.classList.contains('signed')) return;
    const role=btn.dataset.role || (td.cellIndex===4?'trainer':'customer'); openSignModal(td,role); }
  const more=e.target.closest('.more-btn'); if(more){ openNsDrawer(more.closest('tr')); }
});
let cvs,ctx,dpr=1,drawing=false,lx=0,ly=0;
function openSignModal(cell,role){
  currentSign={cell,role}; document.getElementById('signTitle').textContent=(role==='trainer'?'트레이너':'고객')+' 서명 입력';
  document.getElementById('typedName').value = role==='trainer'?lastTrainerTyped:lastCustomerTyped;
  document.getElementById('signModal').classList.remove('hidden'); switchSig('typed'); resizeCanvas();
}
function switchSig(t){ document.getElementById('paneTyped').classList.toggle('hidden',t!=='typed'); document.getElementById('paneDrawn').classList.toggle('hidden',t!=='drawn'); }
document.getElementById('sigTypedBtn').onclick=()=>switchSig('typed');
document.getElementById('sigDrawBtn').onclick=()=>{switchSig('drawn'); resizeCanvas();};
document.querySelectorAll('#signModal [data-close]').forEach(b=>b.addEventListener('click',()=>document.getElementById('signModal').classList.add('hidden')));
document.getElementById('sigApply').addEventListener('click',()=>{
  if(!currentSign) return; const {cell,role}=currentSign;
  if(!document.getElementById('paneTyped').classList.contains('hidden')){
    const name=(document.getElementById('typedName').value||'').trim(); if(!name) return toast('이름 입력');
    if(role==='trainer') lastTrainerTyped=name; else lastCustomerTyped=name;
    cell.innerHTML=`<div class="signature"><span class="pen">✍</span>${escapeHtml(name)}</div>`; cell.dataset.sigType='typed'; cell.dataset.sigValue=name;
  }else{
    const dataURL=exportCanvas(); if(!dataURL) return toast('손서명 먼저 입력');
    cell.innerHTML=`<div class="signature" style="flex-direction:column;gap:4px"><img src="${dataURL}" alt="서명" style="height:48px;max-width:120px;object-fit:contain"/><small class="muted">손서명</small></div>`;
    cell.dataset.sigType='drawn'; cell.dataset.sigValue=dataURL;
  }
  cell.classList.add('signed'); const tr=cell.parentElement; const both=[...tr.querySelectorAll('.sign-cell')].every(td=>td.classList.contains('signed')); if(both) tr.classList.add('row-locked');
  saveLocal(); document.getElementById('signModal').classList.add('hidden');
});
function initCanvas(){ cvs=document.getElementById('sigCanvas'); ctx=cvs.getContext('2d',{willReadFrequently:true});
  const sp='PointerEvent' in window; if(sp){ cvs.addEventListener('pointerdown',sd,{passive:false}); cvs.addEventListener('pointermove',mv,{passive:false}); window.addEventListener('pointerup',su); cvs.addEventListener('pointerleave',su); }
  else{ cvs.addEventListener('mousedown',md); window.addEventListener('mousemove',mm); window.addEventListener('mouseup',mu); }
  window.addEventListener('resize',resizeCanvas);
}
function resizeCanvas(){ if(!cvs) return; const r=cvs.getBoundingClientRect(); dpr=Math.max(1,window.devicePixelRatio||1); const w=r.width||600; cvs.width=Math.floor(w*dpr); cvs.height=Math.floor(180*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); clearCanvas(); }
function clearCanvas(){ ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,cvs.width,cvs.height); ctx.restore(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,cvs.width,cvs.height); }
function exportCanvas(){ const {data}=ctx.getImageData(0,0,cvs.width,cvs.height); for(let i=0;i<data.length;i+=4){ if(!(data[i]===255&&data[i+1]===255&&data[i+2]===255&&data[i+3]===255)) return cvs.toDataURL('image/png'); } return null; }
function sd(e){ e.preventDefault(); if(e.pointerId && cvs.setPointerCapture){ try{ cvs.setPointerCapture(e.pointerId);}catch{} } const p=gp(e); drawing=true; lx=p.x; ly=p.y; }
function mv(e){ if(!drawing) return; e.preventDefault(); const p=gp(e); drawTo(p.x,p.y); }
function su(){ drawing=false; }
function md(e){ const p=gm(e); drawing=true; lx=p.x; ly=p.y; }
function mm(e){ if(!drawing) return; const p=gm(e); drawTo(p.x,p.y); }
function mu(){ drawing=false; }
function drawTo(x,y){ ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111'; ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(x,y); ctx.stroke(); lx=x; ly=y; }
function gp(e){ const r=cvs.getBoundingClientRect(); return {x:(e.clientX||0)-r.left,y:(e.clientY||0)-r.top}; }
function gm(e){ const r=cvs.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top}; }

/* -------- 저장/복원(로컬) -------- */
function collectMeta(){ return {name:val('#m-name'),birth:val('#m-birth'),phone:val('#m-phone'),lesson:val('#m-lesson'),trainer:val('#m-trainer'),start:val('#m-start'),page:val('#m-page')}; }
function collectTable(){ return [...tbody.children].map(tr=>{
  const tds=tr.querySelectorAll('td'); const trc=tds[4], cc=tds[5];
  return { n:tr.dataset.row,
    date: tds[1].querySelector('input').value||"",
    time: tds[2].querySelector('input').value||"",
    note: tds[3].querySelector('textarea').value||"",
    trainerSigType: trc.dataset.sigType||"", trainerSigValue: trc.dataset.sigValue||"",
    customerSigType: cc.dataset.sigType||"", customerSigValue: cc.dataset.sigValue||"",
    locked: tr.classList.contains('row-locked'),
    nsType: tr.dataset.nsType||"" };
});}
function renderTable(rows){ initTable(); rows?.forEach(r=>{ const tr=tbody.querySelector(`tr[data-row="${r.n}"]`); if(!tr) return; const tds=tr.querySelectorAll('td');
  tds[1].querySelector('input').value=r.date||""; tds[2].querySelector('input').value=r.time||""; tds[3].querySelector('textarea').value=r.note||"";
  restoreSig(tds[4],r.trainerSigType,r.trainerSigValue); restoreSig(tds[5],r.customerSigType,r.customerSigValue);
  if(r.locked) tr.classList.add('row-locked'); if(r.nsType) applyNoshowUI(tr,r.nsType);
});}
function restoreSig(td,type,val){ if(!type||!val) return; if(type==='drawn'){ td.innerHTML=`<div class="signature" style="flex-direction:column;gap:4px"><img src="${val}" style="height:48px;max-width:120px;object-fit:contain"/><small class="muted">손서명</small></div>`; } else { td.innerHTML=`<div class="signature"><span class="pen">✍</span>${escapeHtml(val)}</div>`; }
  td.classList.add('signed'); td.dataset.sigType=type; td.dataset.sigValue=val; }
function collectAll(){ return {docId:DOC_ID,memberId:MID,scheduleId:SID, meta:collectMeta(), table:collectTable(), cartridge:[...document.querySelectorAll('#cRows .c-row')].map(r=>({g1:r.querySelector('.g1').value,g2:r.querySelector('.g2').value,desc:r.querySelector('.desc').value})), note:{text:val('#noteArea')}};}
function saveLocal(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(collectAll())); }catch{} }
function loadLocal(){ try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return; const d=JSON.parse(raw);
  // meta
  const m=d.meta||{}; setVal('#m-name', m.name); setVal('#m-birth', m.birth); setVal('#m-phone', m.phone); setVal('#m-lesson', m.lesson); setVal('#m-trainer', m.trainer); setVal('#m-start', m.start); setVal('#m-page', m.page);
  // table
  renderTable(d.table||[]);
  // cartridge
  cRows.innerHTML=''; (d.cartridge?.length?d.cartridge:[{g1:DEFAULT_GROUPS[0],g2:'',desc:''}]).forEach(addCRow);
  // note
  document.getElementById('noteArea').value = d.note?.text || '';
}catch{} }
function val(sel){ const el=document.querySelector(sel); return el?el.value:""; }
function setVal(sel,v){ const el=document.querySelector(sel); if(el) el.value=v||""; }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

/* -------- 이름/연락처 자동 포맷 -------- */
document.getElementById('m-phone').addEventListener('input',e=>{ const v=e.target.value.replace(/\D/g,'').slice(0,11); e.target.value = v.length<=3?v: v.length<=7? v.slice(0,3)+'-'+v.slice(3): v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7); saveLocal(); });
document.getElementById('m-birth').addEventListener('input',e=>{ const v=e.target.value.replace(/\D/g,'').slice(0,8); e.target.value = v.length<=4?v: v.length<=6? v.slice(0,4)+'-'+v.slice(4): v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6); saveLocal(); });

/* -------- 회원찾기 모달 열기 -------- */
const memberModal=document.getElementById('memberModal');
document.getElementById('btnMemberPick').addEventListener('click',()=> memberModal.classList.remove('hidden'));
memberModal.addEventListener('click',e=>{ if(e.target.dataset.close!==undefined) memberModal.classList.add('hidden'); });
</script>

<!-- ===== Firebase (회원 목록/자동완성 + 클라우드 저장 + 노쇼 집계) ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
  authDomain:"more-than-fitness-f6adb.firebaseapp.com",
  projectId:"more-than-fitness-f6adb",
  storageBucket:"more-than-fitness-f6adb.appspot.com",
  messagingSenderId:"993248877411",
  appId:"1:993248877411:web:c0e6785162cf252fbcd156",
  measurementId:"G-MK0RVFG296"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth= getAuth(app);
await new Promise(res=> onAuthStateChanged(auth, async (u)=>{ if(u) res(); else { try{ await signInAnonymously(auth); }catch{} res(); } }));

/* ---- 회원 목록 로드 → 자동완성 + 모달 리스트 ---- */
const nameDL=document.getElementById('nameOptions');
const mpList=document.getElementById('mp-list');
const qInput=document.getElementById('mp-q');
const list=[]; const idxByLabel=new Map();

function fmtPhone(v){ v=String(v||'').replace(/\D/g,''); if(v.length<=3) return v; if(v.length<=7) return v.slice(0,3)+'-'+v.slice(3); return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7); }
function makeLabel(id, x){
  const name=x.name||'(무명)'; const phone=x.phoneDisplay||fmtPhone(x.phone||''); const type=x.lessonType||''; const grade=x.level||'';
  return `${name} · ${phone}${type?` · ${type}`:""}${grade?` · ${grade}`:""} [${id}]`;
}
try{
  const snap=await getDocs(collection(db,'members'));
  snap.forEach(ds=>{
    const x=ds.data(); const label=makeLabel(ds.id,x);
    list.push({id:ds.id,label,data:x});
    const opt=document.createElement('option'); opt.value=label; nameDL.appendChild(opt);
    idxByLabel.set(label, ds.id);
  });
  renderMP(list);
}catch(e){ console.warn(e); }

function renderMP(items){
  mpList.innerHTML = items.map(i=>`<div class="mp-item" data-id="${i.id}">${i.label}</div>`).join('');
}
qInput.addEventListener('input',()=>{
  const kw=qInput.value.trim().toLowerCase();
  if(!kw) return renderMP(list);
  const f=list.filter(i=>i.label.toLowerCase().includes(kw));
  renderMP(f);
});
mpList.addEventListener('click',async (e)=>{
  const it=e.target.closest('.mp-item'); if(!it) return;
  await pickMember(it.dataset.id);
  document.getElementById('memberModal').classList.add('hidden');
});
document.getElementById('mp-apply').addEventListener('click',async ()=>{
  const id=idxByLabel.get(qInput.value); if(id) { await pickMember(id); document.getElementById('memberModal').classList.add('hidden'); }
});

/* ---- 이름 입력 자동완성 → 선택 시 채움 ---- */
document.getElementById('m-name').addEventListener('change',async (e)=>{
  const id=idxByLabel.get(e.target.value); if(id) await pickMember(id);
});

async function pickMember(id){
  try{
    const snap=await getDoc(doc(db,'members',id)); if(!snap.exists()) return;
    const x=snap.data();
    const onlyDigits=(s)=>String(s||'').replace(/\D/g,'');
    const birth=(()=>{const v=onlyDigits(x.birth||'').slice(0,8); if(v.length<=4) return v; if(v.length<=6) return v.slice(0,4)+'-'+v.slice(4); return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6);})();
    document.getElementById('m-name').value   = x.name||'';
    document.getElementById('m-birth').value  = x.birthDisplay || birth;
    document.getElementById('m-phone').value  = x.phoneDisplay || fmtPhone(x.phone||'');
    document.getElementById('m-lesson').value = x.lessonType || '';
    document.getElementById('m-trainer').value= x.trainer || '';
    document.getElementById('m-start').value  = x.startDate || (()=>{try{const d=x.createdAt?.toDate?x.createdAt.toDate():(x.createdAt?new Date(x.createdAt):null); return d? new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10):"";}catch{return ""}})();
    window.MID = id; window.DOC_ID = (window.MID && window.SID)? `${window.MID}__${window.SID}` : 'local_only';
    document.getElementById('chip').textContent = `mid=${window.MID||'?'} · sid=${window.SID||'?'} · doc=${window.DOC_ID}`;
    // 로컬 저장 갱신
    try{ const raw=localStorage.getItem(window.STORE_KEY); const data=raw?JSON.parse(raw):{meta:{},table:[]}; data.meta={...data.meta,name:document.getElementById('m-name').value,birth:document.getElementById('m-birth').value,phone:document.getElementById('m-phone').value,lesson:document.getElementById('m-lesson').value,trainer:document.getElementById('m-trainer').value,start:document.getElementById('m-start').value,page:document.getElementById('m-page').value||""}; localStorage.setItem(window.STORE_KEY, JSON.stringify(data)); }catch{}
  }catch(e){ console.warn(e); }
}

/* ---- 클라우드 저장/로드 ---- */
document.getElementById('btnCloud').addEventListener('click', saveCloud);
async function saveCloud(){
  if(!window.MID || !window.SID){ alert('memberId 또는 scheduleId가 없어 저장할 수 없습니다. 대시보드에서 스케줄 버튼으로 진입하세요.'); return; }
  const ref=doc(db,'logs', window.DOC_ID);
  const payload = window.collectAll ? window.collectAll() : null; if(!payload) return;
  payload.updatedAt = serverTimestamp();
  const ex=(await getDoc(ref)).exists();
  if(!ex){ payload.createdAt=serverTimestamp(); await setDoc(ref,payload); } else { await updateDoc(ref,payload); }
  window.toast?.('클라우드 저장 완료');
}
// 자동 로드(있으면)
(async function(){
  if(!window.MID || !window.SID) return;
  try{
    const snap=await getDoc(doc(db,'logs', window.DOC_ID));
    if(snap.exists()){
      const d=snap.data();
      // 표/메타/패널 데이터 로컬 및 화면 반영
      try{ localStorage.setItem(window.STORE_KEY, JSON.stringify(d)); }catch{}
      window.loadLocal?.();
      window.toast?.('클라우드 데이터 불러옴');
    }
  }catch(e){ console.warn(e); }
})();

/* ---- 노쇼 집계 ---- */
window.applyNoShowToMember = async (mode, meta)=>{
  const id = window.MID; if(!id) return {ok:false, reason:'no-member'};
  const payload={ updatedAt: serverTimestamp(), lastLogAt: meta?.jsDate || new Date() };
  if(mode==='deduct'){ payload.noShowDeducted=increment(1); payload.remainingSessions=increment(-1); }
  else{ payload.noShowUndeducted=increment(1); }
  await updateDoc(doc(db,'members',id), payload); return {ok:true};
};
window.cancelNoShowOnMember = async (prevType)=>{
  const id = window.MID; if(!id) return {ok:false, reason:'no-member'};
  const payload={ updatedAt: serverTimestamp() };
  if(prevType==='deduct'){ payload.noShowDeducted=increment(-1); payload.remainingSessions=increment(1); }
  else if(prevType==='undeduct'){ payload.noShowUndeducted=increment(-1); }
  await updateDoc(doc(db,'members',id), payload); return {ok:true};
};
</script>

<script>
/* ---- 초기화 ---- */
window.addEventListener('DOMContentLoaded', ()=>{
  initTable(); initSeg(); initCanvas(); addCRow(); loadLocal();
  // 표 포커스로 대상행 업데이트 & 드로어/모달 닫기 핸들러
  document.getElementById('tbody').addEventListener('pointerdown',e=>{
    const td=e.target.closest('td'); if(!td) return;
    const tr=td.closest('tr'); if(tr) setTargetRow(Number(tr.dataset.row));
  },{passive:true});
  document.getElementById('memberModal').addEventListener('click',(e)=>{ if(e.target.dataset.close!==undefined) e.currentTarget.classList.add('hidden'); });
});
</script>
</body>
</html>
