<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>개인 / 트레이닝 일지 (통합)</title>
  <style>
    :root{
      --line:#d7d7d7; --ink:#1f2937; --muted:#6b7280;
      --accent:#f59e0b22; --hl:#ffa500; --danger:#dc2626; --chip:#f8fafc;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--ink);margin:24px;background:#fff}
    h1{margin:0 0 8px;font-size:20px}
    .sheet{max-width:1100px;margin:0 auto;border:1px solid var(--line);padding:16px;border-radius:10px;box-shadow:0 2px 14px rgba(0,0,0,.06)}

    /* 상단 메타 */
  /* === 메타 한 줄 유지 & 모바일 대응 === */
.meta{
  display:flex;
  gap:8px;
  align-items:flex-end;
  flex-wrap:nowrap;            /* 줄바꿈 금지: 한 줄 고정 */
  overflow-x:auto;             /* 화면이 너무 좁을 때 메타 '만' 가로 스크롤 */
  -ms-overflow-style:none; scrollbar-width:none;
}
.meta::-webkit-scrollbar{display:none}  /* 모바일에서 스크롤바 숨김 */

.meta label{
  display:flex; flex-direction:column; gap:4px;
  border:1px solid var(--line); background:#fff;
  border-radius:8px; padding:6px 8px;
  min-width:0; flex:0 0 auto;      /* 폭이 너무 줄어 깨지지 않게 */
}
.meta input{
  border:1px solid var(--line);
  border-radius:6px;
  padding:6px 8px;
  font-size:13px; min-width:0;
}
.meta .cap{font-size:11px;color:var(--muted);line-height:1}

/* 필드 폭(모바일에서도 한 줄로 들어가도록 최소폭만 지정) */
.field--name{min-width:160px}
.field--birth{min-width:120px}
.field--phone{min-width:140px}
.field--lesson{min-width:130px}
.field--trainer{min-width:120px}
.field--start{min-width:130px}
.field--page{min-width:80px}

/* 회원찾기 버튼은 줄어들지 않게 */
#btnMemberSearch{flex:0 0 auto;height:100%;align-self:stretch}

/* === 표만 세로 스크롤 되게 === */
.sheet{
  display:flex; flex-direction:column;
  height:calc(100vh - 48px);        /* 화면 꽉 채움(위아래 24px 마진 보정) */
}
.table-wrap{flex:1; min-height:0; overflow:auto} /* 표 영역만 스크롤 */

/* 시간칸 00:00 다 보이도록 살짝 넓게 */
.time{width:90px}
    
    /* 툴바 */
    .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0}
    .toolbar button,.footer-actions button,.sig-tools button,.modal-foot button,.tabbar button{
      border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font-size:13px;cursor:pointer
    }

    /* 표 */
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:900px;table-layout:fixed}
    th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px;vertical-align:top}
    thead th{background:#f8fafc}
    .num{width:44px;text-align:center}
    .date{width:104px}
    .time{width:132px}              /* 오전 00:00까지 보이도록 여유폭 */
    .sign-cell{position:relative;text-align:center;width:100px}
    td>input[type="date"], td>input[type="time"]{width:100%;min-width:0}
    .note textarea{width:100%;min-height:38px;border:none;resize:vertical;font-size:13px;line-height:1.35;outline:none}

    /* 입력방식 버튼(헤더) */
    .modebar{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;white-space:nowrap}
    .modebar .label{font-weight:700;margin-right:6px}
    .modebar .mbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 8px;font-size:12px;cursor:pointer}
    .modebar .mbtn.active{border-color:#111;background:#fff}

    /* 서명 표시 */
    .signature{display:inline-flex;align-items:center;gap:6px;font-weight:600}
    .signature .pen{font-size:14px}
    .signed{position:relative;pointer-events:none}
    .signed::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.06);border-radius:2px}
    .signed::after{content:"수정불가";position:absolute;right:6px;bottom:4px;font-size:12px;font-weight:700;color:var(--danger);background:rgba(255,255,255,.9);padding:2px 8px;border-radius:999px;border:1px solid var(--danger)}

    /* 노쇼 */
    .ns-badge{position:absolute; left:6px; bottom:4px; font-size:12px; font-weight:700; color:#991b1b; background:#ffe4e6; border:1px solid #fda4af; border-radius:999px; padding:2px 8px}
    tr.row-locked{background:var(--accent)}
    tr.row-noshow{background:#fff2f2}

    /* 줄 구분 */
    tr[data-row="10"] td{border-bottom:2px solid var(--hl)}
    tr[data-row="20"] td{border-bottom:2px solid var(--hl)}

    .footer-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* 공통 모달 */
    .hidden{display:none}
    .modal{position:fixed;inset:0;z-index:9999}
    .modal-dim{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .modal-card{position:relative;background:#fff;width:min(820px,96vw);margin:6vh auto;padding:14px;border-radius:12px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal-head h3{margin:0;font-size:16px}
    .close-btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .modal-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

    .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:rgba(17,17,17,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}

    /* 카탈로그(카트리지) */
    .cat-grid{display:grid;gap:10px;grid-template-columns:200px 1fr}
    .cat-list{border:1px solid var(--line);border-radius:10px;overflow:auto;max-height:360px}
    .cat-list button{display:block;width:100%;text-align:left;padding:10px;border:none;background:#fff;border-bottom:1px solid var(--line);cursor:pointer}
    .cat-list button:hover{background:#f9fafb}
    .cat-pane{border:1px solid var(--line);border-radius:10px;padding:10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip-btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .chip-btn:hover{background:#f9fafb}

    /* 아나토미 간이표 */
    .anat-grid{display:grid;gap:10px;grid-template-columns:220px 1fr}
    .anat-list{border:1px solid var(--line);border-radius:10px;overflow:auto;max-height:360px}
    .anat-list button{display:block;width:100%;text-align:left;padding:8px 10px;border:none;background:#fff;border-bottom:1px solid var(--line);cursor:pointer}
    .anat-pnl{border:1px solid var(--line);border-radius:10px;padding:10px}
    .set-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .set-row input{width:60px;border:1px solid var(--line);border-radius:8px;padding:6px}

    /* 서명 모달 */
    .tabbar{display:flex;gap:8px;margin:8px 0 10px}
    .tabbar button{padding:6px 10px;border-radius:8px}
    .tabbar button.active{border-color:#111}
    .tab{display:none}
    .tab.active{display:block}
    .typed-pane input{width:100%;border:1px solid var(--line);border-radius:8px;padding:10px;font-size:16px}
    .drawn-pane .canvas-wrap{border:1px dashed var(--line);border-radius:10px;overflow:hidden;background:#fff}
    .drawn-pane canvas{display:block;width:100%;height:180px;touch-action:none;-ms-touch-action:none}
    .sig-tools{display:flex;gap:8px;justify-content:space-between;margin:8px 0}
    .sig-tools .hint{font-size:12px;color:var(--muted);align-self:center}

    /* 드로어(노쇼) */
    .drawer{position:fixed;inset:0;z-index:9998;display:none}
    .drawer.show{display:block}
    .drawer-dim{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .drawer-panel{position:absolute;right:0;top:0;height:100%;width:min(320px,90vw);background:#fff;border-left:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;flex-direction:column}
    .drawer-head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
    .drawer-body{padding:12px;display:flex;flex-direction:column;gap:10px}
    .drawer .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px;cursor:pointer;text-align:left;font-size:14px}

    /* 회원 찾기 모달 */
    .msearch-head{display:flex;gap:8px;margin-bottom:8px}
    .msearch-head input{flex:1;border:1px solid var(--line);border-radius:8px;padding:8px}
    .msearch-list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .msearch-item{padding:10px;border-bottom:1px solid var(--line);cursor:pointer}
    .msearch-item:hover{background:#f9fafb}

    /* 반응형 */
    @media (max-width: 1024px){ .meta{grid-template-columns:repeat(8,1fr)} }
    @media (max-width: 700px){
      body{margin:12px}
      .sheet{padding:12px}
      .meta{grid-template-columns:repeat(2,1fr)}
      .meta label{padding:6px}
      .modebar .label{display:none} /* 모바일에서 라벨 숨김 → 버튼 한 줄 유지 */
      th,td{font-size:12px;padding:4px 6px}
      .num{width:36px}.date{width:100px}.time{width:120px}.sign-cell{width:92px}
    }
    @media print{
      body{margin:0}
      .sheet{box-shadow:none;border:none;padding:0}
      .toolbar,.footer-actions,.modal,.toast,.drawer,.chip{display:none !important}
      th,td{padding:4px 6px}
    }
  </style>
</head>
<body>
  <div class="sheet">
    <h1>개인 / 트레이닝 일지 (통합)</h1>

    <!-- 메타 영역 -->
 <div class="meta" aria-label="상단 정보">
  <label class="field--name">
    <span class="cap">이름</span>
    <input id="m-name" placeholder="회원명" list="namesList" autocomplete="off">
    <datalist id="namesList"></datalist>
     <div class="sign-note" style="margin-top:2px;font-size:12px;color:#dc2626;font-weight:700">
      * 서명 후 수정 불가
    </div>
  </label>

  <label class="field--birth">
    <span class="cap">생년월일</span>
    <input id="m-birth" inputmode="numeric" maxlength="10" placeholder="YYYY-MM-DD">
  </label>

  <label class="field--phone">
    <span class="cap">연락처</span>
    <input id="m-phone" inputmode="numeric" maxlength="13" placeholder="010-0000-0000">
  </label>

  <label class="field--lesson">
    <span class="cap">레슨종류</span>
    <input id="m-lesson" placeholder="예: PT 50분">
  </label>

  <label class="field--trainer">
    <span class="cap">담당자</span>
    <input id="m-trainer" placeholder="트레이너명">
  </label>

  <label class="field--start">
    <span class="cap">시작일</span>
    <input id="m-start" type="date">
  </label>

  <label class="field--page">
    <span class="cap">페이지</span>
    <input id="m-page" placeholder="1">
  </label>

  <button id="btnMemberSearch" class="chip" title="회원 찾기">회원찾기</button>
</div>
     
    <div class="toolbar">
      <button type="button" onclick="window.print()">인쇄</button>
    </div>

    <!-- 표 -->
    <div class="table-wrap">
      <table id="log">
        <thead>
          <tr>
            <th class="num">No</th>
            <th class="date">레슨일자</th>
            <th class="time">시간</th>
            <th>
              <div class="modebar">
                <span class="label">Teaching Point &amp; Check List</span>
                <button id="btnModeC" class="mbtn" data-mode="catalog">운동카달로그</button>
                <button id="btnModeT" class="mbtn active" data-mode="typing">직접작성하기</button>
                <button id="btnModeA" class="mbtn" data-mode="anatomy">아나토미로그</button>
              </div>
            </th>
            <th class="sign-cell">트레이너 서명</th>
            <th class="sign-cell">고객 서명</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer-actions">
      <button type="button" id="btnHome" onclick="goDashboard()">취소 / 메인으로</button>
      <button type="button" onclick="resetAll()">전체 초기화</button>
    </div>
  </div>

  <!-- ===== 카탈로그(카트리지) 모달 ===== -->
  <div id="catalogModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="운동 카달로그">
    <div class="modal-dim" onclick="closeCatalog()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3>운동 카달로그</h3>
        <button type="button" class="close-btn" onclick="closeCatalog()">닫기</button>
      </div>
      <div class="cat-grid">
        <div class="cat-list" id="catList"></div>
        <div class="cat-pane">
          <div id="catChips" class="chips"></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="catCustom" placeholder="직접 추가 (예: 등 · 랫풀다운 12x3)" style="flex:1;border:1px solid var(--line);border-radius:8px;padding:8px">
            <button id="catAdd" class="chip-btn">현재 행에 추가</button>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" onclick="closeCatalog()">닫기</button>
      </div>
    </div>
  </div>

  <!-- ===== 아나토미(간이 세분화표) 모달 ===== -->
  <div id="anatModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="아나토미 로그">
    <div class="modal-dim" onclick="closeAnat()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3>아나토미 로그</h3>
        <button type="button" class="close-btn" onclick="closeAnat()">닫기</button>
      </div>
      <div class="anat-grid">
        <div class="anat-list" id="anatList"></div>
        <div class="anat-pnl">
          <div class="set-row">
            <label>운동명</label>
            <input id="anatMove" placeholder="예: 랫풀다운">
            <label>세트</label>
            <input id="anatSets" placeholder="3">
            <label>횟수</label>
            <input id="anatReps" placeholder="12">
          </div>
          <button id="anatApply" class="chip-btn">현재 행에 적용</button>
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" onclick="closeAnat()">닫기</button>
      </div>
    </div>
  </div>

  <!-- ===== 서명 모달 ===== -->
  <div id="signModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="서명 입력">
    <div class="modal-dim" onclick="closeSignModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="signTitle">서명 입력</h3>
      <button type="button" class="close-btn" onclick="closeSignModal()">닫기</button>
      </div>

      <div class="tabbar">
        <button type="button" id="tabTyped" class="active" onclick="switchTab('typed')">타이핑</button>
        <button type="button" id="tabDrawn" onclick="switchTab('drawn')">손글씨</button>
      </div>

      <div id="paneTyped" class="tab typed-pane active">
        <input id="typedName" placeholder="이름(서명 표기)" />
      </div>

      <div id="paneDrawn" class="tab drawn-pane">
        <div class="canvas-wrap"><canvas id="sigCanvas"></canvas></div>
        <div class="sig-tools">
          <span class="hint">서명하세요. (두께: 2.5)</span>
          <button type="button" id="sigClear">지우기</button>
        </div>
      </div>

      <div class="modal-foot">
        <button type="button" onclick="closeSignModal()">취소</button>
        <button type="button" onclick="applySignature()">적용</button>
      </div>
    </div>
  </div>

  <!-- ===== 노쇼 드로어 ===== -->
  <div id="nsDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-dim" data-dim></div>
    <div class="drawer-panel">
      <div class="drawer-head">
        <strong>노쇼 / 기타</strong>
        <button class="close-btn" data-close>닫기</button>
      </div>
      <div class="drawer-body">
        <button class="btn" data-action="deduct">노쇼(차감) 처리</button>
        <button class="btn" data-action="undeduct">노쇼(미차감) 처리</button>
        <button class="btn" data-action="cancel">노쇼 취소 (PIN)</button>
        <div class="muted" style="font-size:12px">TIP: 고객 서명칸을 길게 누르면(0.6초) 열립니다.</div>
      </div>
    </div>
  </div>

  <!-- ===== 회원 찾기 모달 ===== -->
  <div id="memberModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="회원 찾기">
    <div class="modal-dim" onclick="closeMemberModal()"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3>회원 찾기</h3>
        <button type="button" class="close-btn" onclick="closeMemberModal()">닫기</button>
      </div>
      <div class="msearch-head">
        <input id="mSearchBox" placeholder="이름, 연락처 검색">
      </div>
      <div id="mSearchList" class="msearch-list"></div>
      <div class="modal-foot">
        <button type="button" onclick="closeMemberModal()">닫기</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ===== 앱 로직 ===== -->
  <script>
    "use strict";

    const DASHBOARD_URL = "dashboard.html";
    const RESET_PIN = "0000";
    const STORE_KEY = "mtf_pt_log_v5";

    let tbody, entryMode = 'typing', currentEditRow = null;
    let currentSign = null, lastTrainerTyped = "", lastCustomerTyped = "";
    let cvs, ctx, dpr=1, drawing=false, lastX=0, lastY=0;
    let longTimer = null, nsDrawer, currentActionRow = null;

    // 간단 카탈로그(요청 포맷 기반)
    const CATALOG = {
      "스트레칭": {
        "상체스트레칭": ["목/승모근", "흉근", "광배", "삼두"],
        "하체스트레칭": ["둔근", "햄스트링", "대퇴사두", "종아리"],
        "셀프메뉴얼": ["상체 폼롤러", "하체 폼롤러"]
      },
      "근력운동": {
        "상체운동": ["흉근", "등", "어깨", "팔"],
        "하체운동": ["스쿼트", "런지", "데드리프트"]
      },
      "기능성운동": {
        "하지관련": ["발목/무릎 안정화", "힙힌지 교정"],
        "코어": ["플랭크", "데드버그"]
      },
      "교정재활": {
        "자세교정": ["거북목", "골반전/후방경사"]
      },
      "리커버리": {
        "P스트레칭": ["상체", "하체", "전신"]
      }
    };

    const ANATOMY = [
      "가슴","등","어깨","이두","삼두","전완","복근",
      "둔근","대퇴사두","햄스트링","내전근","종아리","코어"
    ];

    window.addEventListener('DOMContentLoaded', () => {
  tbody = document.getElementById('tbody');
  nsDrawer = document.getElementById('nsDrawer');

  // 행 생성
  for (let i=1;i<=30;i++) tbody.appendChild(buildRow(i));

  loadFromStorage();
  bindAutoSave();
  initCanvas();

  initBirthAutoHyphen();
  initPhoneAutoHyphen();
  initMetaValidation();

  initModes();
  buildCatalogUI();
  buildAnatomyUI();

  initNoShowDrawer();
});

    /* ===== 표/행 ===== */
    function buildRow(n){
      const tr = document.createElement('tr');
      tr.dataset.row = String(n);
      tr.innerHTML = `
        <td class="num">${n}</td>
        <td><input type="date" aria-label="레슨일자"></td>
        <td><input type="time" aria-label="시간" value="08:00"></td>
        <td class="note"><textarea placeholder="운동내용 / Teaching points"></textarea></td>
        <td class="sign-cell"><button type="button" class="sign-btn" data-role="trainer">서명</button></td>
        <td class="sign-cell"><button type="button" class="sign-btn" data-role="customer">서명</button></td>
      `;

      const ta = tr.querySelector('textarea');
      ta.addEventListener('focus', ()=>{ currentEditRow = tr; maybeOpenAssist(); });
      ta.addEventListener('click',  ()=>{ currentEditRow = tr; maybeOpenAssist(); });

      tr.addEventListener('click', (e)=>{
        const btn = e.target.closest('.sign-btn');
        if (!btn) return;
        const td = btn.closest('td');
        if (!td || td.classList.contains('signed')) return;
        const role = btn.dataset.role || (td.cellIndex === 4 ? 'trainer' : 'customer');
        openSignModal(btn, role);
      });

      const customerCell = tr.children[5];
      customerCell.addEventListener('pointerdown', (ev)=>{
        if (ev.target.closest('.sign-btn')) return;
        longTimer = setTimeout(()=> openNsDrawer(tr), 600);
      }, {passive:true});
      ['pointerup','pointerleave','pointercancel'].forEach(name=>{
        customerCell.addEventListener(name, ()=>{ if(longTimer){clearTimeout(longTimer); longTimer=null;} }, {passive:true});
      });

      return tr;
    }

    /* ===== 입력 모드 ===== */
    function initModes(){
      const btnC = document.getElementById('btnModeC');
      const btnT = document.getElementById('btnModeT');
      const btnA = document.getElementById('btnModeA');
      [btnC,btnT,btnA].forEach(b=>{
        b.addEventListener('click', ()=>{
          entryMode = b.dataset.mode; // catalog | typing | anatomy
          [btnC,btnT,btnA].forEach(x=>x.classList.toggle('active', x===b));
          if (entryMode==='catalog') { if(currentEditRow) openCatalog(); else showToast('행을 먼저 선택하세요'); }
          if (entryMode==='anatomy') { if(currentEditRow) openAnat();    else showToast('행을 먼저 선택하세요'); }
        });
      });
    }
    function maybeOpenAssist(){
      if (!currentEditRow) return;
      if (entryMode==='catalog') openCatalog();
      else if (entryMode==='anatomy') openAnat();
    }

    /* ===== 카탈로그 UI ===== */
    function buildCatalogUI(){
      const list = document.getElementById('catList');
      list.innerHTML = '';
      Object.keys(CATALOG).forEach(cat=>{
        const b = document.createElement('button');
        b.textContent = cat;
        b.addEventListener('click', ()=> renderSub(cat));
        list.appendChild(b);
      });
      renderSub(Object.keys(CATALOG)[0]);

      document.getElementById('catAdd').addEventListener('click', ()=>{
        const v = document.getElementById('catCustom').value.trim();
        if(!v){ showToast('내용을 입력하세요'); return; }
        appendToCurrent(v);
        document.getElementById('catCustom').value = '';
      });
    }
    function renderSub(cat){
      const wrap = document.getElementById('catChips');
      wrap.innerHTML = '';
      const groups = CATALOG[cat]||{};
      Object.keys(groups).forEach(g=>{
        const title = document.createElement('div');
        title.style.cssText = 'flex-basis:100%;font-weight:700;margin-top:2px';
        title.textContent = '• ' + g;
        wrap.appendChild(title);
        groups[g].forEach(item=>{
          const btn = document.createElement('button');
          btn.className='chip-btn';
          btn.textContent = item;
          btn.addEventListener('click', ()=> appendToCurrent(`${g} · ${item}`));
          wrap.appendChild(btn);
        });
      });
    }
    function openCatalog(){ document.getElementById('catalogModal').classList.remove('hidden'); }
    function closeCatalog(){ document.getElementById('catalogModal').classList.add('hidden'); }
    function appendToCurrent(text){
      if (!currentEditRow){ showToast('행을 먼저 선택하세요'); return; }
      const ta = currentEditRow.querySelector('textarea');
      const prefix = ta.value && !ta.value.endsWith('\n') ? '\n' : '';
      ta.value += `${prefix}- ${text}`;
      saveToStorage();
    }

    /* ===== 아나토미 UI ===== */
    function buildAnatomyUI(){
      const list = document.getElementById('anatList');
      list.innerHTML='';
      ANATOMY.forEach(p=>{
        const b = document.createElement('button');
        b.textContent = p;
        b.addEventListener('click', ()=> document.getElementById('anatMove').value = p);
        list.appendChild(b);
      });
      document.getElementById('anatApply').addEventListener('click', ()=>{
        if (!currentEditRow){ showToast('행을 먼저 선택하세요'); return; }
        const move = (document.getElementById('anatMove').value||'').trim();
        const sets = (document.getElementById('anatSets').value||'').trim();
        const reps = (document.getElementById('anatReps').value||'').trim();
        if (!move){ showToast('부위/운동명을 입력하세요'); return; }
        const text = `${move} : ${reps?reps+'회':''}${sets?` x ${sets}세트`:''}`.trim();
        appendToCurrent(text);
      });
    }
    function openAnat(){ document.getElementById('anatModal').classList.remove('hidden'); }
    function closeAnat(){ document.getElementById('anatModal').classList.add('hidden'); }

    /* ===== 노쇼 드로어 ===== */
    function initNoShowDrawer(){
      nsDrawer.addEventListener('click', (e)=>{
        if (e.target.dataset.dim !== undefined || e.target.dataset.close !== undefined) closeNsDrawer();
      });
      nsDrawer.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const mode = btn.dataset.action; // deduct | undeduct | cancel
        await handleNsAction(mode);
      });
    }
    function openNsDrawer(tr){
      currentActionRow = tr;
      nsDrawer.classList.add('show');
      nsDrawer.setAttribute('aria-hidden','false');
    }
    function closeNsDrawer(){
      nsDrawer.classList.remove('show');
      nsDrawer.setAttribute('aria-hidden','true');
      currentActionRow = null;
    }

    async function handleNsAction(mode){
      if (!currentActionRow){ closeNsDrawer(); return; }

      if (mode === 'cancel'){
        const prevType = currentActionRow?.dataset?.nsType;
        if (!prevType){ showToast('노쇼 처리된 행이 아닙니다'); return; }
        if (!verifyPin()) return;
        if (!confirm('이 행의 노쇼 처리를 취소할까요?')) return;

        removeNoshowUI(currentActionRow);
        saveToStorage();

        try{
          const res = await cancelNoShowOnMember(prevType);
          if (res?.ok) showToast('노쇼 취소 완료');
          else if (res?.reason==='no-member') showToast('회원 선택 시 집계 취소 반영');
        }catch{ showToast('집계 취소 실패'); }
        closeNsDrawer();
        return;
      }

      const msg = mode==='deduct'
        ? '노쇼(차감) 처리할까요? (남은 회차 -1)'
        : '노쇼(미차감)으로 기록할까요?';
      if (!confirm(msg)) return;

      applyNoshowUI(currentActionRow, mode);
      saveToStorage();

      try{
        const dateStr = currentActionRow.querySelector('input[type="date"]')?.value || '';
        const jsDate = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
        const res = await applyNoShowToMember(mode, { jsDate });
        if (res?.ok) showToast('노쇼 집계 반영 완료');
        else if (res?.reason==='no-member') showToast('회원 선택 시 집계가 반영됩니다');
      }catch{ showToast('집계 반영 실패'); }

      closeNsDrawer();
    }

    function verifyPin(){
      const pin = prompt('노쇼 취소 PIN을 입력하세요 (기본 0000)');
      if (pin !== RESET_PIN){ showToast('PIN이 올바르지 않습니다'); return false; }
      return true;
    }
    function applyNoshowUI(tr, mode){
      tr.classList.add('row-locked','row-noshow');
      tr.dataset.nsType = mode;
      tr.querySelectorAll('input, textarea, button.sign-btn').forEach(el=>{
        if (el.tagName === 'BUTTON') el.disabled = true;
        else { el.readOnly = true; el.disabled = true; }
      });
      const lastCell = tr.querySelectorAll('td')[5];
      if (lastCell && !lastCell.querySelector('.ns-badge')){
        lastCell.insertAdjacentHTML('beforeend', `<div class="ns-badge">노쇼-${mode==='deduct'?'차감':'미차감'}</div>`);
      }
    }
    function removeNoshowUI(tr){
      const badge = tr.querySelector('.ns-badge'); if (badge) badge.remove();
      tr.classList.remove('row-noshow');
      delete tr.dataset.nsType;

      const signedBoth = [...tr.querySelectorAll('.sign-cell')].every(td=>td.classList.contains('signed'));
      if (!signedBoth){
        tr.classList.remove('row-locked');
        tr.querySelectorAll('input, textarea, button').forEach(el=>{
          if (el.classList.contains('sign-btn')){
            if (!el.closest('td').classList.contains('signed')) el.disabled = false;
          } else {
            el.disabled = false;
            if (el.tagName !== 'BUTTON') el.readOnly = false;
          }
        });
      }
    }

    /* ===== 저장/복원 ===== */
    function bindAutoSave(){
      document.querySelectorAll('input, textarea').forEach(el=>{
        el.addEventListener('input', debounce(saveToStorage, 200));
      });
    }
    function collectData(){
      const meta = {
        name: val('#m-name'), birth: val('#m-birth'), phone: val('#m-phone'),
        lesson: val('#m-lesson'), trainer: val('#m-trainer'), start: val('#m-start'), page: val('#m-page')
      };
      const rows = [...tbody.children].map(tr=>{
        const tds = tr.querySelectorAll('td');
        const trainerCell = tds[4], customerCell = tds[5];
        const trainerType = trainerCell.dataset.sigType || (trainerCell.classList.contains('signed') ? 'typed' : '');
        const trainerVal  = trainerCell.dataset.sigValue || (trainerCell.classList.contains('signed') ? trainerCell.innerText.trim() : '');
        const customerType = customerCell.dataset.sigType || (customerCell.classList.contains('signed') ? 'typed' : '');
        const customerVal  = customerCell.dataset.sigValue || (customerCell.classList.contains('signed') ? customerCell.innerText.trim() : '');
        return {
          n: tr.dataset.row,
          date: tds[1].querySelector('input').value || "",
          time: tds[2].querySelector('input').value || "",
          note: tds[3].querySelector('textarea').value || "",
          trainerSigType: trainerType,
          trainerSigValue: trainerVal,
          customerSigType: customerType,
          customerSigValue: customerVal,
          trainerSig: trainerType==='typed' ? trainerVal : "",
          customerSig: customerType==='typed' ? customerVal : "",
          locked: tr.classList.contains('row-locked'),
          nsType: tr.dataset.nsType || ""
        };
      });
      return {meta, rows};
    }
    function saveToStorage(){
      try{ localStorage.setItem(STORE_KEY, JSON.stringify(collectData())); }
      catch(e){ showToast('저장 오류'); console.warn(e); }
    }
    function loadFromStorage(){
      let raw; try{ raw = localStorage.getItem(STORE_KEY); }catch(e){}
      if (!raw) return;
      let data; try{ data = JSON.parse(raw); }catch(e){ return; }
      const {meta, rows} = data;

      setVal('#m-name', meta.name);
      setVal('#m-birth', formatBirth(meta.birth || ""));
      setVal('#m-phone', formatPhone(meta.phone || ""));
      setVal('#m-lesson', meta.lesson);
      setVal('#m-trainer', meta.trainer);
      setVal('#m-start', meta.start);
      setVal('#m-page', meta.page);

      rows?.forEach(r=>{
        const tr = tbody.querySelector(`tr[data-row="${r.n}"]`);
        if (!tr) return;
        const tds = tr.querySelectorAll('td');
        tds[1].querySelector('input').value = r.date || "";
        tds[2].querySelector('input').value = r.time || "";
        tds[3].querySelector('textarea').value = r.note || "";

        restoreCell(tds[4], r.trainerSigType, r.trainerSigValue, r.trainerSig);
        restoreCell(tds[5], r.customerSigType, r.customerSigValue, r.customerSig);

        if (r.locked){ lockRow(tr); }
        if (r.nsType){ applyNoshowUI(tr, r.nsType); }
      });

      lastTrainerTyped = findLastTyped('trainer');
      lastCustomerTyped = findLastTyped('customer');
    }
    function restoreCell(td, type, value, legacyText){
      if (!type && !legacyText) return;
      if (type === 'drawn' && value){
        td.innerHTML = `<div class="signature" style="flex-direction:column;gap:4px">
          <img src="${value}" alt="서명 이미지" style="height:48px;max-width:120px;object-fit:contain"/>
          <small class="muted">손서명</small>
        </div>`;
        td.classList.add('signed');
        td.dataset.sigType = 'drawn';
        td.dataset.sigValue = value;
      } else {
        const text = value || legacyText || "";
        if (!text) return;
        td.innerHTML = `<div class="signature"><span class="pen">✍</span>${escapeHtml(text)}</div>`;
        td.classList.add('signed');
        td.dataset.sigType = 'typed';
        td.dataset.sigValue = text;
      }
    }
    function findLastTyped(role){
      const idx = role==='trainer' ? 4 : 5;
      let last = "";
      [...tbody.children].forEach(tr=>{
        const td = tr.querySelectorAll('td')[idx];
        if (td && td.dataset.sigType === 'typed' && td.dataset.sigValue){
          last = td.dataset.sigValue;
        }
      });
      return last;
    }

    /* ===== 입력 보조 유틸 ===== */
    function val(sel){const el=document.querySelector(sel);return el?el.value:"";}
    function setVal(sel,v){const el=document.querySelector(sel); if(el) el.value=v||"";}
    function escapeHtml(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
    function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    function showToast(msg){ const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2000); }

    /* ===== 전화/생일 포맷 ===== */
    function initPhoneAutoHyphen(){
      const el = document.getElementById('m-phone');
      if (!el) return;
      const handler = (e)=>{ e.target.value = formatPhone(e.target.value); };
      el.addEventListener('input', handler);
      el.addEventListener('blur', handler);
    }
    function formatPhone(raw){
      const v = String(raw||"").replace(/\D/g,'').slice(0,11);
      if (v.length<=3) return v;
      if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
      return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
    }
    function initBirthAutoHyphen(){
      const el = document.getElementById('m-birth');
      el.addEventListener('input', (e)=>{
        const v = e.target.value.replace(/\D/g,'').slice(0,8);
        e.target.value = formatBirth(v);
      });
      el.addEventListener('blur', (e)=>{
        const v = e.target.value.replace(/\D/g,'');
        e.target.value = formatBirth(v);
      });
    }
    function formatBirth(raw){
      const v = String(raw).replace(/\D/g,'').slice(0,8);
      if (v.length <= 4) return v;
      if (v.length <= 6) return v.slice(0,4)+'-'+v.slice(4);
      return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);
    }
function initMetaValidation(){
  const birth = document.getElementById('m-birth');
  const phone = document.getElementById('m-phone');

  const msgBirth = '양식에 맞지 않습니다. 예) 1993-05-09';
  const msgPhone = '양식에 맞지 않습니다. 예) 010-1234-5678';

  const isValidBirth = (v)=>{
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v);
    if(!m) return false;
    const y=+m[1], mo=+m[2]-1, d=+m[3];
    const dt = new Date(y,mo,d);
    return dt.getFullYear()===y && dt.getMonth()===mo && dt.getDate()===d;
  };
  
  const isValidPhone = (v)=> /^01[016-9]-\d{3,4}-\d{4}$/.test(v);

  const checkBirth = ()=>{
    const v = (birth.value||'').trim();
    birth.setCustomValidity('');
    if(v && !isValidBirth(v)) birth.setCustomValidity(msgBirth);
    birth.reportValidity();
  };
  const checkPhone = ()=>{
    const v = (phone.value||'').trim();
    phone.setCustomValidity('');
    if(v && !isValidPhone(v)) phone.setCustomValidity(msgPhone);
    phone.reportValidity();
  };

  birth.addEventListener('input', checkBirth);
  birth.addEventListener('blur',  checkBirth);
  phone.addEventListener('input', checkPhone);
  phone.addEventListener('blur',  checkPhone);

  // 숫자/하이픈 외 입력 방지
  [birth, phone].forEach(inp=>{
    inp.addEventListener('beforeinput',(e)=>{
      if(e.inputType==='insertText' && /[^\d-]/.test(e.data||'')) e.preventDefault();
    });
  });
}
    
    function resetAll(){
      const pin = prompt('전체 초기화를 위해 PIN을 입력하세요 (기본 0000)');
      if (pin !== RESET_PIN){ showToast('비밀번호가 일치하지 않습니다'); return; }
      if (!confirm('모든 내용을 초기화할까요? (되돌릴 수 없음)')) return;
      try{ localStorage.removeItem(STORE_KEY); }catch(e){}
      location.reload();
    }
    function goDashboard(){ location.href = DASHBOARD_URL; }

    /* ===== Canvas 서명 (정리버전) ===== */
    function initCanvas(){
      cvs = document.getElementById('sigCanvas');
      ctx = cvs.getContext('2d', { willReadFrequently: true });
      resizeCanvas();

      const clrBtn = document.getElementById('sigClear');
      if (clrBtn) clrBtn.addEventListener('click', (e)=>{ e.preventDefault(); clearCanvas(); endStroke(); });

      cvs.addEventListener('pointerdown', (e)=>{ e.preventDefault(); if (e.pointerId && cvs.setPointerCapture) { try{ cvs.setPointerCapture(e.pointerId); }catch{} } const p=getPos(e); beginStroke(p.x,p.y); }, {passive:false});
      cvs.addEventListener('pointermove', (e)=>{ if(!drawing) return; e.preventDefault(); const p=getPos(e); drawTo(p.x,p.y); }, {passive:false});
      window.addEventListener('pointerup', endStroke, {passive:true});
      cvs.addEventListener('pointerleave', endStroke, {passive:true});
      cvs.addEventListener('pointercancel', endStroke, {passive:true});
      cvs.addEventListener('lostpointercapture', endStroke, {passive:true});
      cvs.addEventListener('click', endStroke, {passive:true});

      window.addEventListener('resize', resizeCanvas);
    }
    function resizeCanvas(){
      const rect = cvs.getBoundingClientRect();
      dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = rect.width > 0 ? rect.width : 600;
      cvs.width  = Math.floor(w * dpr);
      cvs.height = Math.floor(180 * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      clearCanvas();
    }
    function clearCanvas(){
      const w=cvs.width, h=cvs.height;
      ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.restore();
      ctx.beginPath(); lastX=0; lastY=0; drawing=false;
    }
    function beginStroke(x,y){ drawing = true; lastX=x; lastY=y; }
    function drawTo(x,y){
      if (!drawing) return;
      ctx.lineWidth = 2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111';
      ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke();
      lastX=x; lastY=y;
    }
    function endStroke(){ drawing = false; }
    function getPos(e){ const r = cvs.getBoundingClientRect(); return { x:(e.clientX||0)-r.left, y:(e.clientY||0)-r.top }; }
    function isCanvasBlank(){
      const { data } = ctx.getImageData(0,0,cvs.width,cvs.height);
      for (let i=0;i<data.length;i+=4){ if (!(data[i]===255 && data[i+1]===255 && data[i+2]===255 && data[i+3]===255)) return false; }
      return true;
    }
    function exportCanvas(){ return isCanvasBlank() ? null : cvs.toDataURL('image/png'); }

    function openSignModal(btn, role){
      const cell = btn.closest('td');
      if (cell.classList.contains('signed')) return;
      currentSign = { cell, role };

      document.getElementById('signTitle').textContent = (role==='trainer'?'트레이너':'고객') + ' 서명 입력';
      document.getElementById('typedName').value = role==='trainer' ? lastTrainerTyped : lastCustomerTyped;

      switchTab('typed');

      const modal = document.getElementById('signModal');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=>resizeCanvas());
    }
    function closeSignModal(){ currentSign = null; document.getElementById('signModal').classList.add('hidden'); }
    function switchTab(which){
      document.getElementById('tabTyped').classList.toggle('active', which==='typed');
      document.getElementById('tabDrawn').classList.toggle('active', which==='drawn');
      document.getElementById('paneTyped').classList.toggle('active', which==='typed');
      document.getElementById('paneDrawn').classList.toggle('active', which==='drawn');
      if (which==='drawn') requestAnimationFrame(()=>{ resizeCanvas(); });
    }
    function applySignature(){
      if (!currentSign) return;
      const { cell, role } = currentSign;
      const usingTypedTab = document.getElementById('paneTyped').classList.contains('active');

      if (usingTypedTab){
        const name = (document.getElementById('typedName').value || "").trim();
        if (!name) return showToast('이름을 입력하세요');
        const prev = role==='trainer' ? lastTrainerTyped : lastCustomerTyped;
        if (prev && prev !== name) showToast('이 전 서명과 다릅니다');
        if (role==='trainer') lastTrainerTyped = name; else lastCustomerTyped = name;
        cell.innerHTML = `<div class="signature"><span class="pen">✍</span>${escapeHtml(name)}</div>`;
        cell.dataset.sigType = 'typed';
        cell.dataset.sigValue = name;
      } else {
        const dataURL = exportCanvas();
        if (!dataURL) return showToast('서명을 먼저 입력하세요');
        cell.innerHTML = `<div class="signature" style="flex-direction:column;gap:4px">
          <img src="${dataURL}" alt="서명 이미지" style="height:48px;max-width:120px;object-fit:contain"/>
          <small class="muted">손서명</small>
        </div>`;
        cell.dataset.sigType = 'drawn';
        cell.dataset.sigValue = dataURL;
      }

      cell.classList.add('signed');
      const tr = cell.parentElement;
      const both = [...tr.querySelectorAll('.sign-cell')].every(td=>td.classList.contains('signed'));
      if (both) lockRow(tr);

      saveToStorage();
      closeSignModal();
    }
    function lockRow(tr){
      tr.classList.add('row-locked');
      tr.querySelectorAll('input, textarea, button.sign-btn').forEach(el=>{
        if (el.tagName === 'BUTTON') el.disabled = true;
        else { el.readOnly = true; el.disabled = true; }
      });
    }

    /* ===== 회원 찾기 모달 ===== */
    function openMemberModal(){ document.getElementById('memberModal').classList.remove('hidden'); }
    function closeMemberModal(){ document.getElementById('memberModal').classList.add('hidden'); }

    document.getElementById('btnMemberSearch').addEventListener('click', openMemberModal);
  </script>

  <!-- ===== Firebase: 회원 불러오기/노쇼 집계 ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
      authDomain: "more-than-fitness-f6adb.firebaseapp.com",
      projectId: "more-than-fitness-f6adb",
      storageBucket: "more-than-fitness-f6adb.appspot.com",
      messagingSenderId: "993248877411",
      appId: "1:993248877411:web:c0e6785162cf252fbcd156",
      measurementId: "G-MK0RVFG296"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    async function ensureAuthed(){
      return new Promise(resolve=>{
        onAuthStateChanged(auth, async (u)=>{
          if (u) return resolve(u);
          try{ const cred = await signInAnonymously(auth); resolve(cred.user); }
          catch(e){ console.warn(e); resolve(null); }
        });
      });
    }
    await ensureAuthed();

    const namesList = document.getElementById('namesList');
    const searchBox = document.getElementById('mSearchBox');
    const searchList = document.getElementById('mSearchList');
    const nameInput = document.getElementById('m-name');

    const indexMap = new Map();
    window.currentMemberId = null;

    (async function initByQuery(){
      const id = new URLSearchParams(location.search).get("id");
      if (!id) return;
      try{
        const snap = await getDoc(doc(db, "members", id));
        if (snap.exists()){
          prefillFromMember(snap.data());
          nameInput.value = (snap.data().name||'');
          indexMap.set(snap.data().name||'', snap.id);
          window.currentMemberId = id;
        }
      }catch(e){ console.warn(e); }
    })();

    (async function loadMemberOptions(){
      try{
        const snap = await getDocs(collection(db, "members"));
        const items = [];
        snap.forEach(docSnap=>{
          const x = docSnap.data();
          const name  = x.name || "(무명)";
          const phone = x.phoneDisplay || formatPhone(x.phone||"");
          const opt = document.createElement("option");
          opt.value = name;
          namesList.appendChild(opt);
          indexMap.set(name, docSnap.id);
          items.push({id:docSnap.id, label:`${name} · ${phone}`, name, x});
        });
        renderSearch(items);
        searchBox.addEventListener('input', ()=>{
          const kw = (searchBox.value||'').toLowerCase();
          renderSearch(items.filter(it=> it.label.toLowerCase().includes(kw)));
        });
      }catch(e){ console.error(e); }
    })();

    function renderSearch(arr){
      searchList.innerHTML='';
      arr.forEach(it=>{
        const div = document.createElement('div');
        div.className='msearch-item';
        div.textContent = it.label;
        div.addEventListener('click', ()=>{
          prefillFromMember(it.x);
          nameInput.value = it.name;
          window.currentMemberId = it.id;
          closeMemberModal();
        });
        searchList.appendChild(div);
      });
    }

    nameInput.addEventListener('change', async ()=>{
      const id = indexMap.get(nameInput.value);
      if (!id) return;
      try{
        const snap = await getDoc(doc(db, "members", id));
        if (snap.exists()){
          prefillFromMember(snap.data());
          window.currentMemberId = id;
        }
      }catch(e){ console.error(e); }
    });

    function prefillFromMember(x){
      const onlyDigits = (s)=> String(s||"").replace(/\D/g,"");
      const fmtBirth = (raw)=>{
        const v = onlyDigits(raw).slice(0,8);
        if (v.length<=4) return v;
        if (v.length<=6) return v.slice(0,4)+'-'+v.slice(4);
        return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);
      };
      const fmtPhone = (raw)=>{
        const v = onlyDigits(raw).slice(0,11);
        if (v.length<=3) return v;
        if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
        return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
      };
      const toDateValue = (v)=>{
        try{
          const d = v?.toDate ? v.toDate() : (v ? new Date(v) : null);
          return d ? new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10) : "";
        }catch{ return ""; }
      };

      document.getElementById('m-birth').value   = x.birthDisplay || fmtBirth(x.birth||'');
      document.getElementById('m-phone').value   = x.phoneDisplay || fmtPhone(x.phone||'');
      document.getElementById('m-lesson').value  = x.lessonType || '';
      document.getElementById('m-trainer').value = x.trainer || '';
      document.getElementById('m-start').value   = x.startDate || toDateValue(x.createdAt) || '';

      try{
        const raw = localStorage.getItem("mtf_pt_log_v5");
        const data = raw ? JSON.parse(raw) : {meta:{}, rows:[]};
        data.meta = {
          ...data.meta,
          name: document.getElementById('m-name').value,
          birth: document.getElementById('m-birth').value,
          phone: document.getElementById('m-phone').value,
          lesson: document.getElementById('m-lesson').value,
          trainer: document.getElementById('m-trainer').value,
          start: document.getElementById('m-start').value,
          page: document.getElementById('m-page').value || ""
        };
        localStorage.setItem("mtf_pt_log_v5", JSON.stringify(data));
      }catch(e){}
    }

    function formatPhone(raw){
      const v = String(raw||"").replace(/\D/g,'').slice(0,11);
      if (v.length<=3) return v;
      if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
      return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
    }

    window.applyNoShowToMember = async (mode, meta)=>{
      const id = window.currentMemberId;
      if (!id) return { ok:false, reason:'no-member' };

      const payload = {
        updatedAt: serverTimestamp(),
        lastLogAt: meta?.jsDate || new Date()
      };
      if (mode==='deduct'){
        payload.noShowDeducted    = increment(1);
        payload.remainingSessions = increment(-1);
      } else {
        payload.noShowUndeducted  = increment(1);
      }
      await updateDoc(doc(db,"members",id), payload);
      return { ok:true };
    };

    window.cancelNoShowOnMember = async (prevType)=>{
      const id = window.currentMemberId;
      if (!id) return { ok:false, reason:'no-member' };

      const payload = { updatedAt: serverTimestamp() };
      if (prevType==='deduct'){
        payload.noShowDeducted    = increment(-1);
        payload.remainingSessions = increment(1);
      } else if (prevType==='undeduct'){
        payload.noShowUndeducted  = increment(-1);
      }
      await updateDoc(doc(db,"members",id), payload);
      return { ok:true };
    };
  </script>
</body>
</html>
