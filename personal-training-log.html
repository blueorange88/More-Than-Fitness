<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>개인 / 트레이닝 일지 (통합)</title>
<style>
  :root{
    --line:#d7d7d7; --ink:#1f2937; --muted:#6b7280;
    --accent:#f59e0b22; --hl:#ffa500; --danger:#dc2626; --chip:#f8fafc;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--ink);margin:24px;background:#fff}
  h1{margin:0 0 8px;font-size:20px}
  .sheet{max-width:1100px;margin:0 auto;border:1px solid var(--line);padding:16px;border-radius:10px;box-shadow:0 2px 14px rgba(0,0,0,.06)}

  /* 상단 메타 */
  .meta{display:grid;gap:6px 8px;margin-bottom:12px;grid-template-columns:repeat(12,1fr);font-size:13px;align-items:center}
  .meta label{display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 8px;border-radius:8px;background:#fff}
  .meta input{border:none;outline:none;width:100%;font-size:13px;background:transparent}
  .span2{grid-column:span 2}.span3{grid-column:span 3}.span4{grid-column:span 4}
  .sign-note{grid-column:span 2;color:var(--danger);font-weight:700}
  .chip{border:1px solid var(--line);background:var(--chip);border-radius:999px;padding:7px 10px;cursor:pointer}

  /* 툴바 */
  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0}
  .toolbar button,.footer-actions button,.sig-tools button,.modal-foot button,.tabbar button,.modebar .mbtn{
    border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-size:12px;cursor:pointer
  }

  /* 표 */
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px;vertical-align:top}
  thead th{background:#f8fafc}
  .col-no{width:36px}
  .col-date{width:100px}
  .col-time{width:68px}
  .col-sign{width:90px}
  .col-note{width:auto}
  .note textarea{width:100%;min-height:38px;border:none;resize:vertical;font-size:13px;line-height:1.35;outline:none}

  /* 헤더 버튼 */
  .modebar{display:flex;align-items:center;gap:6px;white-space:nowrap}
  .modebar .label{font-weight:700;margin-right:4px}

  /* 서명 칸 */
  .sign-cell{position:relative;text-align:center}
  .sign-btn{padding:4px 8px;font-size:12px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}
  .signature{display:inline-flex;align-items:center;gap:6px;font-weight:600}
  .signature .pen{font-size:14px}
  .signed{position:relative;pointer-events:none}
  .signed::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,.06);border-radius:2px}
  .signed::after{content:"수정불가";position:absolute;right:6px;bottom:4px;font-size:12px;font-weight:700;color:var(--danger);background:rgba(255,255,255,.9);padding:2px 8px;border-radius:999px;border:1px solid var(--danger)}

  /* 노쇼 표시 */
  .ns-badge{position:absolute; left:6px; bottom:4px; font-size:12px; font-weight:700; color:#991b1b; background:#ffe4e6; border:1px solid #fda4af; border-radius:999px; padding:2px 8px}
  tr.row-locked{background:var(--accent)}
  tr[data-row="10"] td, tr[data-row="20"] td{border-bottom:2px solid var(--hl)}

  .footer-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

  /* 공통 모달 */
  .hidden{display:none}
  .modal{position:fixed;inset:0;z-index:9999}
  .modal-dim{position:absolute;inset:0;background:rgba(0,0,0,.35)}
  .modal-card{position:relative;background:#fff;width:min(820px,96vw);margin:6vh auto;padding:14px;border-radius:12px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .modal-head h3{margin:0;font-size:16px}
  .close-btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .modal-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:rgba(17,17,17,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}

  /* 카탈로그 */
  .cat-grid{display:grid;gap:10px;grid-template-columns:200px 1fr}
  .cat-list{border:1px solid var(--line);border-radius:10px;overflow:auto;max-height:360px}
  .cat-list button{display:block;width:100%;text-align:left;padding:10px;border:none;background:#fff;border-bottom:1px solid var(--line);cursor:pointer}
  .cat-pane{border:1px solid var(--line);border-radius:10px;padding:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip-btn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}

  /* 아나토미 */
  .anat-grid{display:grid;gap:10px;grid-template-columns:220px 1fr}
  .anat-list{border:1px solid var(--line);border-radius:10px;overflow:auto;max-height:360px}
  .anat-list button{display:block;width:100%;text-align:left;padding:8px 10px;border:none;background:#fff;border-bottom:1px solid var(--line);cursor:pointer}
  .anat-pnl{border:1px solid var(--line);border-radius:10px;padding:10px}
  .set-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .set-row input{width:60px;border:1px solid var(--line);border-radius:8px;padding:6px}

  /* 서명 모달 */
  .tabbar{display:flex;gap:8px;margin:8px 0 10px}
  .tab{display:none}.tab.active{display:block}
  .typed-pane input{width:100%;border:1px solid var(--line);border-radius:8px;padding:10px;font-size:16px}
  .drawn-pane .canvas-wrap{border:1px dashed var(--line);border-radius:10px;overflow:hidden;background:#fff}
  .drawn-pane canvas{display:block;width:100%;height:180px;touch-action:none}
  .sig-tools{display:flex;gap:8px;justify-content:space-between;margin:8px 0}
  .sig-tools .hint{font-size:12px;color:var(--muted);align-self:center}

  /* 반응형 */
  @media (max-width:700px){
    body{margin:12px}
    .sheet{padding:12px}
    .meta{grid-template-columns:repeat(2,1fr)}
    .meta label{padding:6px}
    .col-no{width:28px}.col-date{width:94px}.col-time{width:62px}.col-sign{width:82px}
    th,td{font-size:12px;padding:4px 6px}
    .modebar .label{display:none}
  }
  @media print{
    body{margin:0}
    .sheet{box-shadow:none;border:none;padding:0}
    .toolbar,.footer-actions,.modal,.toast,.chip{display:none !important}
    th,td{padding:4px 6px}
  }
</style>
</head>
<body>
<div class="sheet">
  <h1>개인 / 트레이닝 일지 (통합)</h1>

  <!-- 메타 -->
  <div class="meta" aria-label="상단 정보">
    <label class="span4" id="nameField">이름
      <input id="m-name" placeholder="회원명" list="namesList" autocomplete="off">
      <datalist id="namesList"></datalist>
    </label>
    <span class="sign-note span2">* 서명 후 수정 불가</span>

    <label>생년월일 <input id="m-birth" inputmode="numeric" pattern="[0-9\-]*" maxlength="10" placeholder="YYYY-MM-DD"></label>
    <label>연락처 <input id="m-phone" inputmode="numeric" pattern="[0-9\-]*" maxlength="13" placeholder="010-0000-0000"></label>
    <label class="span2">레슨종류 <input id="m-lesson" placeholder="예: PT 50분"></label>
    <label class="span2">담당자 <input id="m-trainer" placeholder="트레이너명"></label>
    <label>시작일 <input id="m-start" type="date"></label>
    <label>페이지 <input id="m-page" placeholder="1"></label>
    <button id="btnMemberSearch" class="chip" title="회원 찾기">회원찾기</button>
  </div>

  <div class="toolbar">
    <button type="button" onclick="window.print()">인쇄</button>
  </div>

  <!-- 표 -->
  <div class="table-wrap">
    <table id="log">
      <colgroup>
        <col class="col-no"><col class="col-date"><col class="col-time"><col class="col-note"><col class="col-sign"><col class="col-sign">
      </colgroup>
      <thead>
        <tr>
          <th>No</th>
          <th>레슨일자</th>
          <th>시간</th>
          <th>
            <div class="modebar">
              <span class="label">Teaching Point &amp; Check List</span>
              <button id="btnModeC" class="mbtn" data-mode="catalog">운동카달로그</button>
              <button id="btnModeT" class="mbtn active" data-mode="typing">직접작성하기</button>
              <button id="btnModeA" class="mbtn" data-mode="anatomy">아나토미로그</button>
            </div>
          </th>
          <th class="sign-cell">트레이너 서명</th>
          <th class="sign-cell">고객 서명</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer-actions">
    <button type="button" id="btnHome" onclick="goDashboard()">취소 / 메인으로</button>
    <button type="button" onclick="resetAll()">전체 초기화</button>
  </div>
</div>

<!-- ===== 카탈로그 모달 ===== -->
<div id="catalogModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="운동 카달로그">
  <div class="modal-dim" onclick="closeCatalog()"></div>
  <div class="modal-card">
    <div class="modal-head">
      <h3>운동 카달로그</h3>
      <button type="button" class="close-btn" onclick="closeCatalog()">닫기</button>
    </div>
    <div class="cat-grid">
      <div class="cat-list" id="catList"></div>
      <div class="cat-pane">
        <div id="catChips" class="chips"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <input id="catCustom" placeholder="직접 추가 (예: 등 · 랫풀다운 12x3)" style="flex:1;border:1px solid var(--line);border-radius:8px;padding:8px">
          <button id="catAdd" class="chip-btn">현재 행에 추가</button>
        </div>
      </div>
    </div>
    <div class="modal-foot"><button type="button" onclick="closeCatalog()">닫기</button></div>
  </div>
</div>

<!-- ===== 아나토미 모달 ===== -->
<div id="anatModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="아나토미 로그">
  <div class="modal-dim" onclick="closeAnat()"></div>
  <div class="modal-card">
    <div class="modal-head">
      <h3>아나토미 로그</h3>
      <button type="button" class="close-btn" onclick="closeAnat()">닫기</button>
    </div>
    <div class="anat-grid">
      <div class="anat-list" id="anatList"></div>
      <div class="anat-pnl">
        <div class="set-row">
          <label>운동명</label><input id="anatMove" placeholder="예: 랫풀다운">
          <label>세트</label><input id="anatSets" placeholder="3">
          <label>횟수</label><input id="anatReps" placeholder="12">
        </div>
        <button id="anatApply" class="chip-btn">현재 행에 적용</button>
      </div>
    </div>
    <div class="modal-foot"><button type="button" onclick="closeAnat()">닫기</button></div>
  </div>
</div>

<!-- ===== 서명 모달 ===== -->
<div id="signModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="서명 입력">
  <div class="modal-dim" onclick="closeSignModal()"></div>
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="signTitle">서명 입력</h3>
      <button type="button" class="close-btn" onclick="closeSignModal()">닫기</button>
    </div>

    <div class="tabbar">
      <button type="button" id="tabTyped" class="active" onclick="switchTab('typed')">타이핑</button>
      <button type="button" id="tabDrawn" onclick="switchTab('drawn')">손글씨</button>
    </div>

    <div id="paneTyped" class="tab typed-pane active">
      <input id="typedName" placeholder="이름(서명 표기)" />
    </div>

    <div id="paneDrawn" class="tab drawn-pane">
      <div class="canvas-wrap"><canvas id="sigCanvas"></canvas></div>
      <div class="sig-tools">
        <span class="hint">서명하세요. (두께: 2.5)</span>
        <button type="button" id="sigClear">지우기</button>
      </div>
    </div>

    <div class="modal-foot">
      <button type="button" onclick="closeSignModal()">취소</button>
      <button type="button" onclick="applySignature()">적용</button>
    </div>
  </div>
</div>

<!-- ===== 회원 찾기 모달 ===== -->
<div id="memberModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="회원 찾기">
  <div class="modal-dim" onclick="closeMemberModal()"></div>
  <div class="modal-card">
    <div class="modal-head">
      <h3>회원 찾기</h3>
      <button type="button" class="close-btn" onclick="closeMemberModal()">닫기</button>
    </div>
    <div class="msearch-head"><input id="mSearchBox" placeholder="이름, 연락처 검색"></div>
    <div id="mSearchList" class="msearch-list"></div>
    <div class="modal-foot"><button type="button" onclick="closeMemberModal()">닫기</button></div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
"use strict";

const DASHBOARD_URL = "dashboard.html";
const RESET_PIN = "0000";
const STORE_KEY = "mtf_pt_log_v5";

let tbody, entryMode='typing', currentEditRow=null;
let currentSign=null, lastTrainerTyped="", lastCustomerTyped="";
let cvs, ctx, dpr=1, drawing=false, lastX=0, lastY=0;

// 간단 카탈로그
const CATALOG={
  "스트레칭":{"상체스트레칭":["목/승모근","흉근","광배","삼두"],"하체스트레칭":["둔근","햄스트링","대퇴사두","종아리"],"셀프메뉴얼":["상체 폼롤러","하체 폼롤러"]},
  "근력운동":{"상체운동":["흉근","등","어깨","팔"],"하체운동":["스쿼트","런지","데드리프트"]},
  "기능성운동":{"하지관련":["발목/무릎 안정화","힙힌지 교정"],"코어":["플랭크","데드버그"]},
  "교정재활":{"자세교정":["거북목","골반전/후방경사"]},
  "리커버리":{"P스트레칭":["상체","하체","전신"]}
};
const ANATOMY=["가슴","등","어깨","이두","삼두","전완","복근","둔근","대퇴사두","햄스트링","내전근","종아리","코어"];

window.addEventListener('DOMContentLoaded',()=>{
  tbody=document.getElementById('tbody');
  for(let i=1;i<=30;i++) tbody.appendChild(buildRow(i));   // ★ 행 생성

  loadFromStorage();
  bindAutoSave();
  initBirthAutoHyphen();
  initPhoneAutoHyphen();

  initModes();
  buildCatalogUI();
  buildAnatomyUI();
  initCanvas();
});

/* ===== 행 ===== */
function buildRow(n){
  const tr=document.createElement('tr');
  tr.dataset.row=String(n);
  tr.innerHTML=`
    <td>${n}</td>
    <td><input type="date" aria-label="레슨일자"></td>
    <td><input type="time" aria-label="시간" value="08:00"></td>
    <td class="note"><textarea placeholder="운동내용 / Teaching points"></textarea></td>
    <td class="sign-cell"><button type="button" class="sign-btn" data-role="trainer">서명</button></td>
    <td class="sign-cell"><button type="button" class="sign-btn" data-role="customer">서명</button></td>
  `;
  const ta=tr.querySelector('textarea');
  ta.addEventListener('focus',()=>{currentEditRow=tr;});
  ta.addEventListener('click',()=>{currentEditRow=tr;});

  tr.addEventListener('click',(e)=>{
    const btn=e.target.closest('.sign-btn'); if(!btn) return;
    const td=btn.closest('td'); if(td.classList.contains('signed')) return;
    const role=btn.dataset.role||(td.cellIndex===4?'trainer':'customer');
    openSignModal(btn,role);
  });
  return tr;
}

/* ===== 입력 모드 & 보조창 ===== */
function initModes(){
  const btnC=document.getElementById('btnModeC');
  const btnT=document.getElementById('btnModeT');
  const btnA=document.getElementById('btnModeA');
  [btnC,btnT,btnA].forEach(b=>{
    b.addEventListener('click',()=>{
      entryMode=b.dataset.mode;
      [btnC,btnT,btnA].forEach(x=>x.classList.toggle('active',x===b));
      if(entryMode==='catalog'){ if(currentEditRow) openCatalog(); else showToast('행을 먼저 선택하세요'); }
      if(entryMode==='anatomy'){ if(currentEditRow) openAnat();    else showToast('행을 먼저 선택하세요'); }
    });
  });
}
function openCatalog(){ document.getElementById('catalogModal').classList.remove('hidden'); }
function closeCatalog(){ document.getElementById('catalogModal').classList.add('hidden'); }
function buildCatalogUI(){
  const list=document.getElementById('catList'); list.innerHTML='';
  Object.keys(CATALOG).forEach(cat=>{
    const b=document.createElement('button'); b.textContent=cat;
    b.onclick=()=>renderSub(cat); list.appendChild(b);
  });
  renderSub(Object.keys(CATALOG)[0]);
  document.getElementById('catAdd').onclick=()=>{
    const v=document.getElementById('catCustom').value.trim();
    if(!v) return showToast('내용을 입력하세요');
    appendToCurrent(v); document.getElementById('catCustom').value='';
  };
}
function renderSub(cat){
  const wrap=document.getElementById('catChips'); wrap.innerHTML='';
  const groups=CATALOG[cat]||{};
  Object.keys(groups).forEach(g=>{
    const t=document.createElement('div'); t.style.cssText='flex-basis:100%;font-weight:700;margin-top:2px'; t.textContent='• '+g; wrap.appendChild(t);
    groups[g].forEach(item=>{
      const btn=document.createElement('button'); btn.className='chip-btn'; btn.textContent=item;
      btn.onclick=()=>appendToCurrent(`${g} · ${item}`); wrap.appendChild(btn);
    });
  });
}
function appendToCurrent(text){
  if(!currentEditRow) return showToast('행을 먼저 선택하세요');
  const ta=currentEditRow.querySelector('textarea');
  const prefix=ta.value && !ta.value.endsWith('\n') ? '\n':'';
  ta.value+=`${prefix}- ${text}`; saveToStorage();
}

/* 아나토미 */
function openAnat(){ document.getElementById('anatModal').classList.remove('hidden'); }
function closeAnat(){ document.getElementById('anatModal').classList.add('hidden'); }
function buildAnatomyUI(){
  const list=document.getElementById('anatList'); list.innerHTML='';
  ANATOMY.forEach(p=>{
    const b=document.createElement('button'); b.textContent=p; b.onclick=()=>document.getElementById('anatMove').value=p; list.appendChild(b);
  });
  document.getElementById('anatApply').onclick=()=>{
    if(!currentEditRow) return showToast('행을 먼저 선택하세요');
    const move=(document.getElementById('anatMove').value||'').trim();
    const sets=(document.getElementById('anatSets').value||'').trim();
    const reps=(document.getElementById('anatReps').value||'').trim();
    if(!move) return showToast('부위/운동명을 입력하세요');
    const text=`${move} : ${reps?reps+'회':''}${sets?` x ${sets}세트`:''}`.trim();
    appendToCurrent(text);
  };
}

/* ===== 저장/복원 ===== */
function bindAutoSave(){ document.querySelectorAll('input, textarea').forEach(el=>el.addEventListener('input',debounce(saveToStorage,200))); }
function collectData(){
  const meta={ name:val('#m-name'), birth:val('#m-birth'), phone:val('#m-phone'),
    lesson:val('#m-lesson'), trainer:val('#m-trainer'), start:val('#m-start'), page:val('#m-page') };
  const rows=[...tbody.children].map(tr=>{
    const tds=tr.querySelectorAll('td');
    const trainerCell=tds[4], customerCell=tds[5];
    const tType=trainerCell.dataset.sigType||''; const tVal=trainerCell.dataset.sigValue||'';
    const cType=customerCell.dataset.sigType||''; const cVal=customerCell.dataset.sigValue||'';
    return {
      n:tr.dataset.row,
      date:tds[1].querySelector('input').value||"",
      time:tds[2].querySelector('input').value||"",
      note:tds[3].querySelector('textarea').value||"",
      trainerSigType:tType, trainerSigValue:tVal,
      customerSigType:cType, customerSigValue:cVal,
      locked:tr.classList.contains('row-locked')
    };
  });
  return {meta,rows};
}
function saveToStorage(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(collectData())); }catch(e){} }
function loadFromStorage(){
  let raw; try{ raw=localStorage.getItem(STORE_KEY); }catch(e){}
  if(!raw) return; let data; try{ data=JSON.parse(raw); }catch(e){ return; }
  const {meta,rows}=data;
  setVal('#m-name',meta.name); setVal('#m-birth',formatBirth(meta.birth||"")); setVal('#m-phone',formatPhone(meta.phone||""));
  setVal('#m-lesson',meta.lesson); setVal('#m-trainer',meta.trainer); setVal('#m-start',meta.start); setVal('#m-page',meta.page);
  rows?.forEach(r=>{
    const tr=tbody.querySelector(`tr[data-row="${r.n}"]`); if(!tr) return;
    const tds=tr.querySelectorAll('td');
    tds[1].querySelector('input').value=r.date||""; tds[2].querySelector('input').value=r.time||""; tds[3].querySelector('textarea').value=r.note||"";
    if(r.trainerSigType) restoreSig(tds[4], r.trainerSigType, r.trainerSigValue);
    if(r.customerSigType) restoreSig(tds[5], r.customerSigType, r.customerSigValue);
  });
}
function restoreSig(td,type,val){
  if(type==='drawn'){
    td.innerHTML=`<div class="signature" style="flex-direction:column;gap:4px">
      <img src="${val}" alt="서명 이미지" style="height:48px;max-width:120px;object-fit:contain"/>
      <small class="muted">손서명</small>
    </div>`;
  }else{
    td.innerHTML=`<div class="signature"><span class="pen">✍</span>${escapeHtml(val)}</div>`;
  }
  td.classList.add('signed'); td.dataset.sigType=type; td.dataset.sigValue=val;
}

/* ===== 유틸 ===== */
function val(sel){const el=document.querySelector(sel); return el?el.value:"";}
function setVal(sel,v){const el=document.querySelector(sel); if(el) el.value=v||"";}
function escapeHtml(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function showToast(msg){const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800);}

/* ===== 전화/생일 포맷 ===== */
function initPhoneAutoHyphen(){
  const el=document.getElementById('m-phone'); if(!el) return;
  const h=(e)=>{e.target.value=formatPhone(e.target.value);};
  el.addEventListener('input',h); el.addEventListener('blur',h);
}
function formatPhone(raw){const v=String(raw||"").replace(/\D/g,'').slice(0,11); if(v.length<=3)return v; if(v.length<=7)return v.slice(0,3)+'-'+v.slice(3); return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);}
function initBirthAutoHyphen(){
  const el=document.getElementById('m-birth');
  el.addEventListener('input',e=>{const v=e.target.value.replace(/\D/g,'').slice(0,8); e.target.value=formatBirth(v);});
  el.addEventListener('blur',e=>{const v=e.target.value.replace(/\D/g,''); e.target.value=formatBirth(v);});
}
function formatBirth(raw){const v=String(raw).replace(/\D/g,'').slice(0,8); if(v.length<=4)return v; if(v.length<=6)return v.slice(0,4)+'-'+v.slice(4); return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);}

function resetAll(){
  const pin=prompt('전체 초기화를 위해 PIN을 입력하세요 (기본 0000)'); if(pin!==RESET_PIN){showToast('비밀번호가 일치하지 않습니다');return;}
  if(!confirm('모든 내용을 초기화할까요? (되돌릴 수 없음)')) return;
  try{localStorage.removeItem(STORE_KEY);}catch(e){} location.reload();
}
function goDashboard(){ location.href=DASHBOARD_URL; }

/* ===== 서명 캔버스 ===== */
function initCanvas(){
  cvs=document.getElementById('sigCanvas'); ctx=cvs.getContext('2d',{willReadFrequently:true});
  const clr=document.getElementById('sigClear'); if(clr) clr.addEventListener('click',(e)=>{e.preventDefault(); clearCanvas(); endStroke();});
  resizeCanvas();

  cvs.addEventListener('pointerdown', (e)=>{ e.preventDefault(); if(cvs.setPointerCapture && e.pointerId) try{cvs.setPointerCapture(e.pointerId);}catch{}; const p=getPos(e); beginStroke(p.x,p.y); }, {passive:false});
  cvs.addEventListener('pointermove', (e)=>{ if(!drawing) return; e.preventDefault(); const p=getPos(e); drawTo(p.x,p.y); }, {passive:false});
  window.addEventListener('pointerup', endStroke, {passive:true});
  cvs.addEventListener('pointerleave', endStroke, {passive:true});
  cvs.addEventListener('pointercancel', endStroke, {passive:true});
  cvs.addEventListener('lostpointercapture', endStroke, {passive:true});
  cvs.addEventListener('click', endStroke, {passive:true}); // 탭 후 계속 그려짐 방지

  window.addEventListener('resize', resizeCanvas);
}
function resizeCanvas(){
  const rect=cvs.getBoundingClientRect();
  dpr=Math.max(1,window.devicePixelRatio||1);
  const w=rect.width>0?rect.width:600;
  cvs.width=Math.floor(w*dpr);
  cvs.height=Math.floor(180*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  clearCanvas();
}
function clearCanvas(){
  const w=cvs.width, h=cvs.height;
  ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.restore();
  ctx.beginPath(); lastX=lastY=0; drawing=false;
}
function beginStroke(x,y){ drawing=true; lastX=x; lastY=y; }
function drawTo(x,y){ if(!drawing) return; ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke(); lastX=x; lastY=y; }
function endStroke(){ drawing=false; }
function getPos(e){ const r=cvs.getBoundingClientRect(); return {x:(e.clientX||0)-r.left, y:(e.clientY||0)-r.top}; }
function exportCanvas(){ const {data}=ctx.getImageData(0,0,cvs.width,cvs.height); for(let i=0;i<data.length;i+=4){ if(!(data[i]===255&&data[i+1]===255&&data[i+2]===255&&data[i+3]===255)) return cvs.toDataURL('image/png'); } return null; }

function switchTab(which){
  document.getElementById('tabTyped').classList.toggle('active',which==='typed');
  document.getElementById('tabDrawn').classList.toggle('active',which==='drawn');
  document.getElementById('paneTyped').classList.toggle('active',which==='typed');
  document.getElementById('paneDrawn').classList.toggle('active',which==='drawn');
  if(which==='drawn') requestAnimationFrame(()=>{ resizeCanvas(); });
}
function openSignModal(btn,role){
  const cell=btn.closest('td'); if(cell.classList.contains('signed')) return;
  currentSign={cell,role};
  document.getElementById('signTitle').textContent=(role==='trainer'?'트레이너':'고객')+' 서명 입력';
  document.getElementById('typedName').value=(role==='trainer'? lastTrainerTyped : lastCustomerTyped);
  switchTab('typed');
  document.getElementById('signModal').classList.remove('hidden');
  requestAnimationFrame(resizeCanvas);
}
function closeSignModal(){ currentSign=null; document.getElementById('signModal').classList.add('hidden'); }
function applySignature(){
  if(!currentSign) return;
  const {cell,role}=currentSign;
  const typedOn=document.getElementById('paneTyped').classList.contains('active');
  if(typedOn){
    const name=(document.getElementById('typedName').value||"").trim(); if(!name) return showToast('이름을 입력하세요');
    if(role==='trainer') lastTrainerTyped=name; else lastCustomerTyped=name;
    cell.innerHTML=`<div class="signature"><span class="pen">✍</span>${escapeHtml(name)}</div>`;
    cell.dataset.sigType='typed'; cell.dataset.sigValue=name;
  }else{
    const dataURL=exportCanvas(); if(!dataURL) return showToast('서명을 먼저 입력하세요');
    cell.innerHTML=`<div class="signature" style="flex-direction:column;gap:4px">
      <img src="${dataURL}" alt="서명 이미지" style="height:48px;max-width:120px;object-fit:contain"/>
      <small class="muted">손서명</small></div>`;
    cell.dataset.sigType='drawn'; cell.dataset.sigValue=dataURL;
  }
  cell.classList.add('signed');
  saveToStorage();
  closeSignModal();
}

/* ===== 회원 찾기 모달(열기/닫기만) ===== */
function openMemberModal(){ document.getElementById('memberModal').classList.remove('hidden'); }
function closeMemberModal(){ document.getElementById('memberModal').classList.add('hidden'); }
document.getElementById('btnMemberSearch').addEventListener('click', openMemberModal);
</script>

<!-- ===== Firebase 파트 (회원 자동완성/연동) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  const firebaseConfig={apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",authDomain:"more-than-fitness-f6adb.firebaseapp.com",projectId:"more-than-fitness-f6adb",storageBucket:"more-than-fitness-f6adb.appspot.com",messagingSenderId:"993248877411",appId:"1:993248877411:web:c0e6785162cf252fbcd156",measurementId:"G-MK0RVFG296"};
  const app=initializeApp(firebaseConfig); const db=getFirestore(app); const auth=getAuth(app);

  await new Promise(resolve=>{ onAuthStateChanged(auth, async u=>{ if(u) return resolve(u); try{const c=await signInAnonymously(auth); resolve(c.user);}catch{resolve(null);} }); });

  const namesList=document.getElementById('namesList');
  const searchBox=document.getElementById('mSearchBox');
  const searchList=document.getElementById('mSearchList');
  const nameInput=document.getElementById('m-name');
  const indexMap=new Map();

  // 목록 → datalist + 모달
  (async()=>{
    try{
      const snap=await getDocs(collection(db,"members"));
      const items=[];
      snap.forEach(ds=>{
        const x=ds.data(); const name=x.name||"(무명)"; const phone=(x.phoneDisplay||"").toString();
        const opt=document.createElement("option"); opt.value=name; namesList.appendChild(opt);
        indexMap.set(name, ds.id);
        items.push({id:ds.id, label:`${name} · ${phone}`, name, x});
      });
      // 모달 리스트
      if(searchList){
        const render=(arr)=>{ searchList.innerHTML=''; arr.forEach(it=>{ const d=document.createElement('div'); d.className='msearch-item'; d.textContent=it.label; d.onclick=async()=>{ await fillFromDoc(it.id); nameInput.value=it.name; closeMemberModal(); }; searchList.appendChild(d); }); };
        render(items); if(searchBox) searchBox.oninput=()=>{ const kw=(searchBox.value||'').toLowerCase(); render(items.filter(it=>it.label.toLowerCase().includes(kw))); };
      }
    }catch(e){}
  })();

  // datalist 선택 시 채움
  nameInput.addEventListener('change', async ()=>{ const id=indexMap.get(nameInput.value); if(id) await fillFromDoc(id); });

  async function fillFromDoc(id){
    try{
      const ds=await getDoc(doc(db,"members",id)); if(!ds.exists()) return;
      const x=ds.data();
      const onlyDigits=s=>String(s||"").replace(/\D/g,"");
      const fmtBirth=r=>{const v=onlyDigits(r).slice(0,8); if(v.length<=4)return v; if(v.length<=6)return v.slice(0,4)+'-'+v.slice(4); return v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);};
      const fmtPhone=r=>{const v=onlyDigits(r).slice(0,11); if(v.length<=3)return v; if(v.length<=7)return v.slice(0,3)+'-'+v.slice(3); return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);};
      document.getElementById('m-birth').value=x.birthDisplay||fmtBirth(x.birth||'');
      document.getElementById('m-phone').value=x.phoneDisplay||fmtPhone(x.phone||'');
      document.getElementById('m-lesson').value=x.lessonType||'';
      document.getElementById('m-trainer').value=x.trainer||'';
      document.getElementById('m-start').value=x.startDate||'';
      // 저장 동기화
      try{ const raw=localStorage.getItem("mtf_pt_log_v5"); const data=raw?JSON.parse(raw):{meta:{},rows:[]};
        data.meta={...data.meta, name:document.getElementById('m-name').value, birth:document.getElementById('m-birth').value, phone:document.getElementById('m-phone').value, lesson:document.getElementById('m-lesson').value, trainer:document.getElementById('m-trainer').value, start:document.getElementById('m-start').value, page:document.getElementById('m-page').value||""};
        localStorage.setItem("mtf_pt_log_v5", JSON.stringify(data)); }catch(e){}
    }catch(e){}
  }
</script>
</body>
</html>
