<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>고객 카드 – 파일 분류</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --gold-d:#9E8536; --underwhite:#F7F6F2;
    --silver:#C0C7D1; --bronze:#B08D57; --blue:#152A4A;
    --danger:#ef4444; --danger-bg:#fee2e2;
    --ink:#0b1220; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff; --recent-bg:#fff8e6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--underwhite);color:var(--ink);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,var(--underwhite));
         border-bottom:2px solid var(--gold);padding:14px 16px 12px}
  header h1{margin:0 0 10px;font-size:18px;color:var(--navy);letter-spacing:.2px}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff}
  .tools .select,.tools .check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--navy)}
  .tools select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}

  /* Grid + 3D 원근감 */
  .grid{padding:18px;display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
        perspective: 900px;}

  .file-card{
    position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;
    padding:16px 14px 48px; /* 아래 여백(액션버튼 공간) */
    box-shadow:0 2px 8px rgba(0,0,0,.05);cursor:pointer;
    outline:0; transform-origin: top center; transform-style: preserve-3d;
    transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    will-change: transform, box-shadow;
  }
  .file-card::before{
    content:"";position:absolute;top:-12px;left:14px;width:84px;height:18px;
    background:linear-gradient(90deg,var(--gold),var(--gold-d));
    border-radius:10px 10px 2px 2px;box-shadow:0 -1px 0 rgba(0,0,0,.04)
  }
  .file-card.recent::after{ /* 우측 골드 바 */
    content:"";position:absolute;inset:10px auto 10px 8px;width:4px;border-radius:4px;background:var(--gold)
  }

  /* 소프트 바닥 그림자 */
  .file-card>.shadow-floor{
    content:"";position:absolute;left:10px;right:10px;bottom:10px;height:18px;
    background: radial-gradient(ellipse at center, rgba(0,0,0,.18), rgba(0,0,0,0) 60%);
    filter: blur(10px);opacity:0;transform: translateY(6px) scale(.9);
    transition: opacity .18s ease, transform .18s ease; pointer-events:none;
  }

  /* 등급 색상 */
  .file-card.vip{border-color:var(--gold)}
  .file-card.vip::before{background:linear-gradient(90deg,var(--gold),var(--gold-d))}
  .file-card.silver{border-color:var(--silver)}
  .file-card.silver::before{background:linear-gradient(90deg,#e6ebf2,var(--silver))}
  .file-card.bronze{border-color:var(--bronze)}
  .file-card.bronze::before{background:linear-gradient(90deg,#d9c3a3,var(--bronze))}
  .file-card.blue{border-color:var(--blue)}
  .file-card.blue::before{background:linear-gradient(90deg,#1d3a66,var(--blue))}
  .file-card.expiring{border-color:var(--danger);box-shadow:0 12px 26px rgba(239,68,68,.25)}
  .file-card.expiring::before{background:linear-gradient(90deg,#fca5a5,var(--danger))}

  /* 호버(데스크톱) */
  @media (hover:hover) and (pointer:fine){
    .file-card:hover,.file-card:focus-visible{
      transform: translateY(-4px) rotateX(4deg);
      box-shadow: 0 18px 34px rgba(11,30,58,.22);
      border-color: var(--gold);
    }
    .file-card:hover>.shadow-floor,
    .file-card:focus-visible>.shadow-floor{
      opacity:1; transform: translateY(12px) scale(1);
    }
  }

  @media (prefers-reduced-motion: reduce){
    .file-card,.file-card>.shadow-floor{transition:none}
  }

  .file-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .name{font-weight:800;font-size:17px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;color:var(--navy)}
  .badges{display:flex;gap:6px;align-items:center}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--gold);background:var(--recent-bg);color:#8a6d1d}
  .badge.neutral{border-color:#e5e7eb;background:#fff;color:#475569}
  .badge.danger{background:var(--danger-bg);border-color:var(--danger);color:#991b1b}
  .badge.gray{border-color:#e5e7eb;background:#f8fafc;color:#475569}

  .row{display:flex;gap:6px;align-items:center;font-size:13px;color:var(--muted);margin:3px 0}
  .row .label{width:64px;color:#334155}
  .row .value{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  .actions{
    position:absolute;left:12px;right:12px;bottom:12px;display:flex;gap:8px;
  }
  .btn{flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
  .btn.primary{background:var(--navy);color:#fff;border-color:var(--navy)}
  .btn:hover{filter:brightness(.98)}
  .empty{padding:40px 16px;text-align:center;color:var(--muted)}
  .footer{padding:10px 16px 18px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 일지 – 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="회원 이름 / 연락처 / 담당 / 등급 검색" />
      <div class="select">
        정렬:
        <select id="sortBy" aria-label="정렬">
          <option value="recent" selected>최근 작성순</option>
          <option value="name">이름(가나다)</option>
          <option value="grade">등급</option>
          <option value="first">최초 등록일</option>
        </select>
      </div>
      <label class="check" style="gap:8px;display:flex;align-items:center">
        <input id="onlyRecent" type="checkbox"> 최근 작성만
      </label>
    </div>
  </header>

  <main class="grid" id="grid" aria-live="polite"></main>
  <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  <div class="footer">
    Tip: 카드를 클릭하면 해당 회원의 운동일지로 이동합니다. 최근 7일 이내 작성은 골드, 만료 임박은 빨간 배지로 표시돼요.
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  /* ===== Firestore 연결 ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // (권장) 익명 로그인 – 보안 규칙에 따라 필요
  const auth = getAuth(app);
  onAuthStateChanged(auth, (u)=>{ if(!u) signInAnonymously(auth).catch(console.error); });

  /* ===== 설정 ===== */
  const COL = "members";
  const PT_LOG_URL = "./personal-training-log.html";
  const SCHED_URL  = "./MTF-F.html"; // 스케줄러 페이지

  /* ===== DOM ===== */
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const sortSel = document.getElementById('sortBy');
  const onlyRecent = document.getElementById('onlyRecent');

  /* ===== Utils ===== */
  const escapeHtml = s => String(s??"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const formatPhone = raw => {
    const v = String(raw||"").replace(/\D/g,'').slice(0,11);
    if (v.length<=3) return v;
    if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
    return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  };
  const dateToISO = d => d instanceof Date ? d.toISOString().slice(0,10) : "";
  const asDateStr = v => {
    if (!v) return "";
    if (typeof v?.toDate === "function") return dateToISO(v.toDate());
    if (v instanceof Date) return dateToISO(v);
    if (typeof v === "string") return v.slice(0,10);
    return "";
  };
  const daysDiff = (dateStr) => { if(!dateStr) return null; const d = new Date(dateStr+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.floor((t - d)/86400000); };
  const daysUntil = (dateStr) => { if(!dateStr) return null; const d = new Date(dateStr+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.ceil((d - t)/86400000); };
  const isRecent = (dateStr) => { const dd = daysDiff(dateStr); return dd !== null && dd <= 7; };
  function gradeClass(grade){
    const g = String(grade||"").toLowerCase();
    if (g === "vip" || g.includes("마스터")) return "vip";
    if (g.includes("프로모션") || g === "promotion" || g.includes("브론즈")) return "bronze";
    if (g.includes("일반") || g === "normal" || g.includes("실버")) return "silver";
    return "blue";
  }

  /* ===== 상태 ===== */
  let state = { members: [] };

  /* ===== 렌더 ===== */
  function render(list){
    grid.innerHTML = "";
    if (!list.length){ empty.hidden = false; return; }
    empty.hidden = true;

    list.forEach(m=>{
      const recent = isRecent(m.lastLog);
      const dLeft  = daysUntil(m.expireAt);
      const cls = [
        'file-card',
        gradeClass(m.grade),
        (dLeft !== null && dLeft <= 7) ? 'expiring' : '',
        recent ? 'recent' : ''
      ].join(' ').trim();

      const card = document.createElement('article');
      card.className = cls;
      card.tabIndex = 0;
      card.setAttribute('role','button');
      card.setAttribute('aria-label', `${m.name} 일지 열기`);
      card.dataset.memberId = m.id;

      // 뱃지 조립: (우선순위) 만료 임박 > 최근 작성 > 잔여회차 > 등급
      const badges = [];
      if (dLeft !== null && dLeft <= 7) badges.push(`<span class="badge danger">만료 D-${Math.max(dLeft,0)}</span>`);
      else if (recent) badges.push(`<span class="badge">최근 ${m.lastLog}</span>`);
      if (typeof m.remaining === 'number') badges.push(`<span class="badge gray">잔여 ${m.remaining}회</span>`);
      badges.push(`<span class="badge neutral">${escapeHtml(m.grade||"")}</span>`);

      card.innerHTML = `
        <div class="file-head">
          <div class="name">${escapeHtml(m.name||"-")}</div>
          <div class="badges">${badges.join("")}</div>
        </div>

        <div class="row"><span class="label">연락처</span><span class="value">${formatPhone(m.phone)}</span></div>
        <div class="row"><span class="label">성별</span><span class="value">${escapeHtml(m.gender||"")}</span></div>
        <div class="row"><span class="label">담당</span><span class="value">${escapeHtml(m.trainer||"")}</span></div>
        <div class="row"><span class="label">등록일</span><span class="value">${m.first||""}</span></div>
        <div class="row"><span class="label">작성</span><span class="value">${m.logCount||0}회</span></div>
        <div class="row"><span class="label">만료일</span><span class="value">${m.expireAt||"-"}</span></div>

        <div class="actions">
          <button class="btn" data-act="schedule">스케줄에 배치</button>
          <button class="btn primary" data-act="log">일지 열기</button>
        </div>
        <div class="shadow-floor"></div>
      `;

      // 기본: 카드 클릭 → 일지
      const openLog = ()=>{ location.href = `${PT_LOG_URL}?id=${encodeURIComponent(m.id)}`; };
      card.addEventListener('click', e=>{
        // 버튼 클릭은 개별 액션으로
        const act = e.target?.dataset?.act;
        if (act === 'log') { openLog(); e.stopPropagation(); return; }
        if (act === 'schedule') {
          location.href = `${SCHED_URL}?memberId=${encodeURIComponent(m.id)}`;
          e.stopPropagation(); return;
        }
        openLog();
      });
      card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openLog(); }});
      grid.appendChild(card);
    });

    // (선택) 마우스 위치에 따라 미세 틸트
    attachCardTilt();
  }

  function filterSort(){
    const keyword = (q.value||"").trim().toLowerCase();
    const norm = s => String(s||"").toLowerCase();

    const list = state.members.filter(m=>{
      const phoneMatch = formatPhone(m.phone).replace(/\D/g,'')
                        .includes(keyword.replace(/\D/g,''));
      const match = !keyword
        || norm(m.name).includes(keyword)
        || phoneMatch
        || norm(m.trainer).includes(keyword)
        || norm(m.grade).includes(keyword);
      const recentOK = !onlyRecent.checked || isRecent(m.lastLog);
      return match && recentOK;
    });

    const by = sortSel.value;
    list.sort((a,b)=>{
      if (by==='recent') return (b.lastLog||'').localeCompare(a.lastLog||'');
      if (by==='name')   return (a.name||"").localeCompare(b.name||"",'ko');
      if (by==='grade')  return (a.grade||"").localeCompare(b.grade||"",'ko');
      if (by==='first')  return (b.first||'').localeCompare(a.first||'');
      return 0;
    });

    render(list);
  }

  /* ===== 실시간 구독: members ===== */
  onSnapshot(collection(db, COL), (snap)=>{
    const list = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data();

      const createdAt  = asDateStr(d.createdAt);
      const startStr   = d.startDate ? asDateStr(d.startDate) : (createdAt || "");
      const expireAt   = asDateStr(d.expireAt);
      const lastLog    = d.lastLogAt ? asDateStr(d.lastLogAt)
                        : (d.lastPurchaseAt ? asDateStr(d.lastPurchaseAt) : "");

      list.push({
        id: docSnap.id,
        name: d.name || "",
        phone: d.phone || d.phoneDisplay || "",
        gender: d.gender || "",
        trainer: d.trainer || "",
        grade: d.level || d.grade || "",
        first: startStr,
        expireAt,
        lastLog,
        logCount: d.logCount || 0,
        remaining: typeof d.remainingSessions === 'number' ? d.remainingSessions : null
      });
    });

    state.members = list;
    filterSort();
  });

  /* ===== 마우스 위치에 따른 미세 틸트(선택) ===== */
  function attachCardTilt(){
    if (!window.matchMedia('(hover:hover) and (pointer:fine)').matches) return;
    const max = 6; // 최대 기울기(deg)
    document.querySelectorAll('.file-card').forEach(card=>{
      const onMove = (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width;   // 0~1
        const y = (e.clientY - r.top)  / r.height;  // 0~1
        const rx = (0.5 - y) * max;                 // 위/아래
        const ry = (x - 0.5) * max;                 // 좌/우
        card.style.transform = `translateY(-4px) rotateX(${rx}deg) rotateY(${ry}deg)`;
        card.style.boxShadow = `0 18px 34px rgba(11,30,58,.22)`;
        card.style.borderColor = `var(--gold)`;
      };
      const onLeave = ()=>{
        card.style.transform = "";
        card.style.boxShadow = "";
        card.style.borderColor = "";
      };
      card.addEventListener('mousemove', onMove);
      card.addEventListener('mouseleave', onLeave);
      card.addEventListener('blur', onLeave);
    });
  }

  /* ===== UI 이벤트 ===== */
  q.addEventListener('input', filterSort);
  sortSel.addEventListener('change', filterSort);
  onlyRecent.addEventListener('change', filterSort);
  </script>
</body>
</html>
