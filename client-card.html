<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>고객 카드 – 세로 바인더</title>
<style>
  :root{
    --navy:#0b1e3a; --gold:#c8a848; --under:#f7f6f2; --ink:#0b1220;
    --muted:#6b7280; --line:#e5e7eb; --card:#ffffff;
    --danger:#ef4444; --recent:#f59e0b; --ok:#10b981;
    --shadow: 0 18px 40px rgba(11,30,58,.22);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--under);color:var(--ink);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}

  /* Header */
  header{position:sticky;top:0;z-index:20;background:linear-gradient(#fff,var(--under));
         border-bottom:2px solid var(--gold);padding:14px 16px 12px}
  .head-top{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .brand{font-size:18px;color:var(--navy);font-weight:800;margin:0}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  .tools input[type="search"]{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff}
  .tools .group{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--navy)}
  .tools select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--navy);color:#fff;border:none}
  .toggle{border:1px solid var(--line);border-radius:10px;overflow:hidden;display:inline-flex}
  .toggle button{padding:8px 10px;border:0;background:#fff;cursor:pointer}
  .toggle button.active{background:var(--navy);color:#fff}

  main{padding:18px}
  .shelf{display:flex;flex-direction:column;gap:56px; /* 선반 간격 넉넉히 */ }

  /* ── 서류 받침대(책꽂이) 비주얼 ───────────────────────── */
  .rowWrap{
    position:relative;
    display:flex;align-items:flex-end;gap:0;
    transform:perspective(1200px) rotateX(6deg);  /* 대각선 구도(선반 전체가 살짝 기울어짐) */
  }
  /* 받침대 본체 */
  .rowWrap::before{
    content:""; position:absolute; left:0; bottom:-6px; width:120px; height:300px;
    background:linear-gradient(180deg,#fff,#eef2f7);
    border:1px solid #e2e8f0; border-radius:16px 16px 10px 10px;
    box-shadow:0 8px 26px rgba(0,0,0,.12);
    transform:skewY(-4deg) rotateZ(-2deg);  /* 사선 느낌 */
  }
  /* 손잡이 구멍 */
  .rowWrap::after{
    content:""; position:absolute; left:22px; bottom:110px; width:68px; height:120px;
    background:var(--under); border-radius:40px/60px; box-shadow:inset 0 0 0 1px #e2e8f0;
    transform:skewY(-4deg) rotateZ(-2deg);
  }

  .empty{padding:40px 16px;text-align:center;color:var(--muted)}

  /* ── 바인더(세로 파일) ─────────────────────────────── */
  .file{
    width:280px; height:380px;
    margin-left:-170px;                  /* ★ 더 겹치게: 크게 음수 */
    position:relative; will-change:transform;
    transition:transform .18s ease, box-shadow .18s ease, z-index .18s ease, margin .18s ease;
    z-index:0;
    transform:rotateZ(-6deg);            /* ★ 기본도 살짝 기울임(대각선 구도) */
  }
  .file:first-child{margin-left:140px}   /* 받침대 공간만큼 띄우고 시작 */
  .file:focus-within,.file:hover{
    z-index:10;
    transform:translateX(70px) translateY(-10px) rotateY(-18deg) rotateZ(-1deg); /* ★ 더 세게 ‘쏙’ 뽑히기 */
  }

  .book{
    position:absolute;inset:0;border-radius:12px;
    background:linear-gradient(135deg,#f8fafc,#eef2f7);
    border:1px solid var(--line);
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    transform-style:preserve-3d;overflow:hidden;cursor:pointer;outline:0;
  }
  /* 상태별 색감 */
  .book.blue{background:linear-gradient(135deg,#eef2ff,#e2e8f0)}
  .book.yellow{background:linear-gradient(135deg,#fff7ed,#fde68a)}
  .book.pink{background:linear-gradient(135deg,#ffe4e6,#fecaca)}

  /* 두꺼운 등(spine) */
  .spine{
    position:absolute;left:-20px;top:0;bottom:0;width:28px;border-radius:8px 0 0 8px;
    background:linear-gradient(90deg,#e2e8f0,#cbd5e1);
    box-shadow:inset -3px 0 8px rgba(0,0,0,.12);
    transform:translateZ(-30px) rotateY(22deg);
  }

  /* 커버 내용 */
  .cover{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:18px 16px 14px}
  .name{font-weight:900;font-size:22px;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .label{font-size:12px;color:#334155}
  .bottom{display:flex;justify-content:space-between;align-items:flex-end}
  .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#334155}
  .badge.exp{border-color:var(--danger);color:#991b1b;background:#fee2e2}
  .badge.recent{border-color:var(--recent);color:#92400e;background:#fff7ed}
  .badge.ok{border-color:#10b981;color:#065f46;background:#ecfdf5}

  /* Hover info panel */
  .info{
    position:absolute;right:-2px;top:8px;width:260px;background:rgba(255,255,255,.96);
    border:1px solid #e2e8f0;border-radius:12px;padding:12px;box-shadow:var(--shadow);
    opacity:0;pointer-events:none;transform:translateX(-8px);transition:opacity .18s ease,transform .18s ease;
  }
  .file:hover .info,.file:focus-within .info{opacity:1;pointer-events:auto;transform:translateX(4px)}
  .rows{display:grid;gap:6px;font-size:13px;color:#334155}
  .row{display:flex;gap:8px}
  .row .k{width:80px;color:#64748b}
  .row .v{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .actions{display:flex;gap:8px;margin-top:10px}
  .actions .btn{flex:1}

  .footer{padding:10px 16px 18px;color:var(--muted);font-size:12px}
  .banner{position:fixed;left:50%;top:10px;transform:translateX(-50%);
          background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px;
          color:#334155;font-size:12px;box-shadow:0 6px 16px rgba(0,0,0,.12);display:none}

  /* 반응형: 화면 좁을 때 겹침 정도 완화 */
  @media (max-width: 840px){
    .file{width:230px;height:320px;margin-left:-120px}
    .file:first-child{margin-left:120px}
  }
  @media (max-width: 600px){
    .rowWrap{transform:none}
    .file{transform:none;margin-left:12px}
    .file:first-child{margin-left:12px}
  }
</style>
</head>
<body>
  <header>
    <div class="head-top">
      <h1 class="brand">개인 트레이닝 일지 – 세로 바인더</h1>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="location.href='dashboard.html'">메인으로</button>
        <button class="btn primary" onclick="location.href='member-registration.html'">+ 회원 등록</button>
      </div>
    </div>

    <div class="tools">
      <input id="q" type="search" placeholder="회원 이름 / 연락처 / 담당 / 메모 검색" />
      <div class="group">
        정렬:
        <select id="sortBy" aria-label="정렬 기준">
          <option value="recent" selected>최근 작성</option>
          <option value="name">이름 (가나다 → 영문 → 숫자)</option>
          <option value="first">최초 등록일</option>
          <option value="expire">만료일</option>
        </select>
      </div>
      <div class="group">
        방향:
        <div class="toggle" id="dirToggle" role="group" aria-label="정렬 방향">
          <button type="button" data-dir="desc" class="active">최근순/내림차</button>
          <button type="button" data-dir="asc">과거순/오름차</button>
        </div>
      </div>
      <label class="group"><input id="onlyRecent" type="checkbox"> 최근 7일 작성만</label>
    </div>
  </header>

  <main>
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  </main>
  <div class="footer">Tip: 파일에 마우스를 올리면 ‘세게’ 뽑혀 보입니다. 클릭하면 일지로 이동하고, 패널 버튼으로 스케줄러/메인 이동이 가능해요.</div>
  <div class="banner" id="fbStatus"></div>

  <script type="module">
  /* ===== Firebase ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain:"more-than-fitness-f6adb.firebaseapp.com",
    projectId:"more-than-fitness-f6adb",
    storageBucket:"more-than-fitness-f6adb.appspot.com",
    messagingSenderId:"993248877411",
    appId:"1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId:"G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const fbStatus = document.getElementById('fbStatus');
  function showStatus(msg, ok=true){
    fbStatus.textContent = msg;
    fbStatus.style.display = 'block';
    fbStatus.style.borderColor = ok ? '#c7d2fe' : '#fecaca';
    setTimeout(()=>{ fbStatus.style.display='none'; }, 2000);
  }

  onAuthStateChanged(auth, (u)=>{
    if(!u){
      signInAnonymously(auth)
        .then(()=>showStatus('Firebase 연결됨', true))
        .catch(err=>showStatus('로그인 실패: '+(err?.code||''), false));
    }else{
      showStatus('Firebase 연결됨', true);
      startSubscription();
    }
  });

  /* ===== DOM / Utils ===== */
  const shelf      = document.getElementById('shelf');
  const emptyEl    = document.getElementById('empty');
  const q          = document.getElementById('q');
  const sortSel    = document.getElementById('sortBy');
  const dirToggle  = document.getElementById('dirToggle');
  const onlyRecent = document.getElementById('onlyRecent');

  const escapeHtml = s => String(s??"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  function formatPhone(raw){
    const v = String(raw||"").replace(/\D/g,'').slice(0,11);
    if (v.length<=3) return v;
    if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
    return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  }
  const dateToISO = d => d instanceof Date ? d.toISOString().slice(0,10) : "";
  const daysDiff  = s => { if(!s) return null; const d=new Date(s+'T00:00:00'); const t=new Date(); t.setHours(0,0,0,0); return Math.floor((t-d)/86400000); };
  const daysUntil = s => { if(!s) return null; const d=new Date(s+'T00:00:00'); const t=new Date(); t.setHours(0,0,0,0); return Math.ceil((d-t)/86400000); };
  const isRecent  = s => { const dd = daysDiff(s); return dd !== null && dd <= 7; };

  function coverClassByStatus(m){
    const dLeft = daysUntil(m.expireAt);
    if (dLeft !== null && dLeft <= 7) return 'pink';     // 만료 임박
    if (isRecent(m.lastLog))          return 'yellow';   // 최근 작성
    return 'blue';
  }

  /* 이름 그룹: 가나다(0) → 영문(1) → 숫자(2) → 기타(3) */
  function nameGroup(name){
    const s=(name||"").trim(); const ch=s[0]||"";
    if (/[가-힣]/.test(ch)) return 0;
    if (/[A-Za-z]/.test(ch)) return 1;
    if (/[0-9]/.test(ch)) return 2;
    return 3;
  }
  function cmpDateAsc(a,b){
    if (!a && !b) return 0; if (!a) return -1; if (!b) return 1; return a.localeCompare(b);
  }

  let state = { members: [], dir: 'desc' };
  const PER_ROW = 4;

  function render(list){
    shelf.innerHTML = "";
    if (!list.length){ emptyEl.hidden = false; return; }
    emptyEl.hidden = true;

    for (let i=0; i<list.length; i+=PER_ROW){
      const row = document.createElement('div');
      row.className = 'rowWrap';

      list.slice(i, i+PER_ROW).forEach((m, idx)=>{
        const file = document.createElement('article');
        file.className = 'file';
        if (idx===0) file.style.marginLeft = '140px'; /* 첫 파일만 받침대 공간 */

        const book = document.createElement('div');
        book.className = `book ${coverClassByStatus(m)}`;
        book.setAttribute('role','button');
        book.setAttribute('aria-label', `${m.name} 파일 열기`);
        file.appendChild(book);

        const spine = document.createElement('div'); spine.className='spine'; book.appendChild(spine);

        const cover = document.createElement('div');
        cover.className = 'cover';
        cover.innerHTML = `
          <div>
            <div class="name">${escapeHtml(m.name)}</div>
            <div class="label">${formatPhone(m.phone)}</div>
          </div>
          <div class="bottom">
            <span class="badge">잔여 ${m.remainingSessions ?? 0}회</span>
            ${
              (d=>d!==null && d<=7 ? `<span class="badge exp">만료 D-${Math.max(0,d)}</span>` :
                 (isRecent(m.lastLog) ? `<span class="badge recent">최근 ${m.lastLog}</span>` :
                  `<span class="badge ok">정상</span>`))(daysUntil(m.expireAt))
            }
          </div>`;
        book.appendChild(cover);

        const info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `
          <div class="rows">
            <div class="row"><span class="k">연락처</span><span class="v">${formatPhone(m.phone)}</span></div>
            <div class="row"><span class="k">담당</span><span class="v">${escapeHtml(m.trainer||"-")}</span></div>
            <div class="row"><span class="k">최초 등록</span><span class="v">${m.first||"-"}</span></div>
            <div class="row"><span class="k">최근 작성</span><span class="v">${m.lastLog||"-"}</span></div>
            <div class="row"><span class="k">만료일</span><span class="v">${m.expireAt||"-"}</span></div>
            <div class="row"><span class="k">일지 수</span><span class="v">${m.logCount||0}회</span></div>
          </div>
          <div class="actions">
            <button class="btn" data-act="log">일지 열기</button>
            <button class="btn" data-act="sched">스케줄러</button>
            <button class="btn" data-act="main">메인으로</button>
          </div>`;
        book.appendChild(info);

        // 클릭 기본: 일지
        book.addEventListener('click', ()=>{
          location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
        });
        // 패널 버튼
        info.addEventListener('click', (e)=>{
          const act = e.target?.dataset?.act;
          if(!act) return;
          if (act==='log')   location.href=`personal-training-log.html?id=${encodeURIComponent(m.id)}`;
          if (act==='sched') location.href=`dashboard.html?memberId=${encodeURIComponent(m.id)}`;
          if (act==='main')  location.href='dashboard.html';
          e.stopPropagation();
        });

        row.appendChild(file);
      });

      shelf.appendChild(row);
    }
  }

  function filteredAndSorted(){
    const keyword = (q.value||"").trim().toLowerCase();
    const norm = s => String(s||"").toLowerCase();
    const dir  = state.dir === 'asc' ? 1 : -1;

    const list = state.members.filter(m=>{
      const phoneMatch = formatPhone(m.phone).replace(/\D/g,'').includes(keyword.replace(/\D/g,''));
      const match = !keyword
        || norm(m.name).includes(keyword)
        || phoneMatch
        || norm(m.trainer).includes(keyword)
        || norm(m.memo).includes(keyword);
      const recentOK = !onlyRecent.checked || isRecent(m.lastLog);
      return match && recentOK;
    });

    const by = sortSel.value;
    list.sort((a,b)=>{
      if (by==='recent') return dir * cmpDateAsc(b.lastLog||"", a.lastLog||"");
      if (by==='first')  return dir * cmpDateAsc(a.first||"", b.first||"");
      if (by==='expire') return dir * cmpDateAsc(a.expireAt||"", b.expireAt||"");
      if (by==='name'){
        const ga=nameGroup(a.name), gb=nameGroup(b.name);
        if (ga !== gb) return dir * (ga - gb);  // 가나다(0) → 영문(1) → 숫자(2)
        return dir * a.name.localeCompare(b.name,'ko',{numeric:true,sensitivity:'base'});
      }
      return 0;
    });
    return list;
  }
  const rerender = ()=> render(filteredAndSorted());

  /* ===== Firestore 구독 ===== */
  function startSubscription(){
    onSnapshot(collection(db, "members"), (snap)=>{
      const list=[];
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
        const first     = d.startDate || (createdAt ? dateToISO(createdAt) : "");
        const expireAt  = d.expireAt?.toDate ? dateToISO(d.expireAt.toDate()) : (d.expireAt || "");
        const lastLog   = d.lastLogAt?.toDate
                          ? dateToISO(d.lastLogAt.toDate())
                          : (d.lastPurchaseAt?.toDate ? dateToISO(d.lastPurchaseAt.toDate()) : "");
        list.push({
          id: docSnap.id,
          name: d.name || "",
          phone: d.phone || d.phoneDisplay || "",
          trainer: d.trainer || "",
          memo: d.memo || "",
          first,
          expireAt,
          lastLog,
          logCount: d.logCount || 0,
          remainingSessions: d.remainingSessions ?? 0
        });
      });
      state.members = list;
      rerender();
    }, (err)=> showStatus('Firestore 오류: '+(err?.code||err?.message||'알 수 없음'), false));
  }

  /* ===== UI 이벤트 ===== */
  q.addEventListener('input', rerender);
  sortSel.addEventListener('change', rerender);
  onlyRecent.addEventListener('change', rerender);
  dirToggle.addEventListener('click', (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    state.dir = btn.dataset.dir;
    [...dirToggle.children].forEach(x=>x.classList.toggle('active', x===btn));
    rerender();
  });
  </script>
</body>
</html>
