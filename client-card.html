<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>고객 카드 – 바인더 선반</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --ink:#0b1220; --muted:#6b7280;
    --line:#e5e7eb; --danger:#ef4444; --danger-bg:#fee2e2;
    --ok:#2563eb; --track:#e5e7eb;
    --shelf:#f3f4f6; --shelf-edge:#e5e7eb;

    /* 바인더 크기(모바일도 동일한 스타일 유지) */
    --binder-w: 320px;
    --binder-h: 520px;
    --binder-overlap: -180px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(#fff,#fbfbfb); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  }

  /* ===== Header / Tools ===== */
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(#fff,#f9fafb);
    border-bottom:2px solid var(--gold);
    padding:14px 16px 12px;
  }
  header h1{margin:0 0 10px; font-size:18px; color:var(--navy);}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{
    flex:1; min-width:220px; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; font-size:14px; background:#fff;
  }
  .tools .group{display:flex;gap:8px; align-items:center; font-size:13px; color:#0B1E3A}
  .tools select, .tools button{
    border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px; cursor:pointer;
  }
  .tools button.tgl{min-width:92px}
  .back{ margin-left:auto; background:#0B1E3A; color:#fff; font-weight:700; }

  /* ===== Shelf ===== */
  .shelf-wrap{position:relative; padding:18px 0 calc(28px + env(safe-area-inset-bottom,0))}
  .shelf{
    position:relative; display:flex; gap:0; padding:26px 22px;
    overflow-x:auto; overflow-y:visible; scrollbar-width:thin;
    perspective:1200px;
    border-top:1px solid var(--shelf-edge); border-bottom:1px solid var(--shelf-edge);
    background:var(--shelf);
    scroll-snap-type:x proximity;
  }
  .shelf::before, .shelf::after{
    content:""; position:sticky; width:40px; height:100%; flex:0 0 40px; pointer-events:none; z-index:1;
  }
  .shelf::before{ left:0; background:linear-gradient(90deg,#f9fafb,rgba(249,250,251,0)); }
  .shelf::after{ right:0; background:linear-gradient(270deg,#f9fafb,rgba(249,250,251,0)); }

  /* ===== Binder ===== */
  @keyframes breathe { 0%,100%{filter:saturate(1) brightness(1)} 50%{filter:saturate(1.08) brightness(1.05)} }
  @keyframes glowPulse {
    0%,100%{ box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22); }
    50%    { box-shadow:-12px 0 0 rgba(255,255,255,.24) inset, 0 28px 60px rgba(0,0,0,.28); }
  }
  .binder{
    position:relative;
    width:var(--binder-w); height:var(--binder-h); margin-left:var(--binder-overlap);
    border-radius:16px; cursor:pointer; user-select:none; outline:0;
    transform:translateZ(0) rotateY(-12deg) translateY(6px);
    transform-origin:left center; will-change:transform, filter;
    box-shadow:-8px 0 0 rgba(0,0,0,.06) inset, 0 8px 20px rgba(0,0,0,.08);
    transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s, filter .28s, z-index .28s;
    background:linear-gradient(160deg, #9ec5ff 0%, #6aa0ff 55%, #3a6ddf 100%);
    border:1px solid rgba(0,0,0,.06); color:#0b1220; scroll-snap-align:start;
  }
  .cFemale  { background:linear-gradient(160deg,#a7f3d0,#34d399,#059669);}
  .cMale    { background:linear-gradient(160deg,#bfdbfe,#60a5fa,#2563eb);}
  .cMale50  { background:linear-gradient(160deg,#1e293b,#0f172a,#0b1e3a);}
  .cFemale50{ background:linear-gradient(160deg,#fbcfe8,#f472b6,#db2777);}
  .cDefault { background:linear-gradient(160deg,#ddd6fe,#a78bfa,#7c3aed);}
  .binder:first-child{ margin-left:8px; }
  .binder:hover, .binder:focus-visible{
    z-index:9; transform:translateY(-14px) rotateY(-2deg) scale(1.04);
    box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22);
    animation:breathe 2.6s ease-in-out infinite;
  }
  .binder.expired{ filter:grayscale(.2) saturate(.9); }
  .binder::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:24px; border-radius:16px 0 0 16px;
    background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(0,0,0,.1));
    box-shadow:2px 0 6px rgba(0,0,0,.12) inset;
  }
  .binder::after{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px;
    background:
      radial-gradient(28px 28px at calc(100% - 10px) 10px, rgba(255,255,255,.6), rgba(255,255,255,0) 70%) top right / 40% 40% no-repeat,
      radial-gradient(22px 22px at 12px calc(100% - 12px), rgba(255,255,255,.35), rgba(255,255,255,0) 70%) bottom left / 35% 35% no-repeat;
    opacity:.0; transition:opacity .25s ease;
  }
  .binder:hover::after, .binder:focus-visible::after{ opacity:1; }
  .shine{ position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.28) 30%, rgba(255,255,255,0) 60%);
    transform: translateX(-130%); transition: transform .9s ease; mix-blend-mode: screen; }
  .binder:hover .shine, .binder:focus-visible .shine{ transform: translateX(130%); }
  .under{
    position:absolute; left:18%; right:12px; bottom:-10px; height:20px; pointer-events:none;
    background:radial-gradient(60% 100% at 50% 0, rgba(0,0,0,.28), rgba(0,0,0,0));
    filter: blur(3px); opacity:.65; transition:opacity .25s, transform .25s;
  }
  .binder:hover .under, .binder:focus-visible .under{ opacity:.9; transform: translateY(2px) scale(1.06); }
  .binder.pulse{ animation:glowPulse 1.1s ease-in-out 1; }

  /* 바인더 구멍 */
  .holes{ position:absolute; left:10px; top:110px; display:flex; flex-direction:column; gap:20px; pointer-events:none; }
  .hole{ width:10px; height:10px; border-radius:50%; background:rgba(0,0,0,.22);
         box-shadow: inset 0 1px 2px rgba(255,255,255,.25), 0 1px 2px rgba(0,0,0,.25);
         opacity:.55; }

  /* ===== “파일” 오버레이 ===== */
  .fileOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter: blur(2px);
    display:none; z-index:60;
  }
  .fileCard{
    position:fixed; right:12px; top:12px; bottom:12px; width:min(520px, 92vw);
    background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:16px; box-shadow:0 18px 48px rgba(0,0,0,.35);
    transform: translateX(16px) scale(.98); opacity:0; transition: transform .25s ease, opacity .25s ease;
    display:flex; flex-direction:column; overflow:hidden;
  }
  .fileOverlay.show{ display:block; }
  .fileOverlay.show .fileCard{ transform: translateX(0) scale(1); opacity:1; }

  .fileHead{
    display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid #eef2f7; background:linear-gradient(#fff,#fbfdff);
  }
  .fileName{ font-size:16px; font-weight:900; color:#0b1220; }
  .fileTag{ margin-left:auto; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; background:#fff; }
  .fileBody{ flex:1; overflow:auto; padding:12px 14px; background:#f9fafb; }
  .fileGrid{ display:grid; grid-template-columns: 100px 1fr; gap:10px; align-items:start; }
  .ring{
    --pct: 0;
    width:84px; height:84px; border-radius:50%;
    background: conic-gradient(var(--ok) calc(var(--pct)*1%), var(--track) 0);
    display:grid; place-items:center; margin:4px auto; border:6px solid rgba(255,255,255,.9);
    box-shadow:0 2px 10px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.08);
  }
  .ring.low{ --ok:#ef4444; }
  .ring .ring-label{background:#fff; border-radius:999px; padding:6px 8px; font-size:12px; font-weight:900; border:1px solid #e5e7eb}
  .rows{ font-size:13px; color:#374151; display:grid; gap:8px; }
  .row{ display:flex; gap:8px; }
  .row .label{ width:76px; color:#334155; font-weight:700; }
  .row .value{ flex:1; }

  .fileActions{ display:flex; gap:8px; padding:12px; border-top:1px solid #eef2f7; background:#fff; }
  .btn{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-weight:800; cursor:pointer; }
  .btn.primary{ background:#0B1E3A; color:#fff; border-color:#0B1E3A; }
  .btn.warn{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  .closeX{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; cursor:pointer; }

  /* 반응형: 폰에서도 바인더 스타일 유지 + 파일은 바텀시트 느낌 */
  @media (max-width: 860px){
    :root{ --binder-w: 280px; --binder-h: 460px; --binder-overlap: -130px; }
  }
  @media (max-width: 540px){
    :root{ --binder-w: 240px; --binder-h: 380px; --binder-overlap: -90px; }
    .holes{ top:98px; gap:18px; }
    .fileCard{
      left:0; right:0; bottom:0; top:auto; width:100%; border-radius:18px 18px 0 0;
      transform: translateY(14px) scale(1); /* 아래서 올라오는 느낌 */
    }
    .fileOverlay.show .fileCard{ transform: translateY(0); }
    .fileGrid{ grid-template-columns: 86px 1fr; }
  }
  @media (max-width: 400px){
    :root{ --binder-w: 210px; --binder-h: 340px; --binder-overlap: -70px; }
    .holes{ top:92px; gap:16px; }
  }

  /* 다크 모드 */
  @media (prefers-color-scheme: dark){
    body{ background:linear-gradient(#0b1220,#101826); color:#e5e7eb; }
    header{ background:linear-gradient(#0f172a,#0b1220); border-bottom-color:#475569; }
    .tools input[type="search"], .tools select, .tools button{ background:#0f172a; color:#e5e7eb; border-color:#374151; }
    .shelf{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
            border-top-color:#374151; border-bottom-color:#374151; }
    .fileCard{ background:#0f172a; border-color:#1f2937; }
    .fileHead{ background:#0f172a; border-bottom-color:#1f2937; }
    .fileBody{ background:#0b1220; }
    .row .label{ color:#cbd5e1; }
    .btn{ background:#0f172a; color:#e5e7eb; border-color:#334155; }
    .btn.primary{ background:#0B1E3A; border-color:#0B1E3A; }
  }
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 – 바인더 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="이름 / 담당 / 등급 검색" />
      <div class="group">
        정렬:
        <select id="sortBy" aria-label="정렬">
          <option value="name" selected>이름(가나다·영문·숫자)</option>
          <option value="recent">최근 작성</option>
          <option value="remain">잔여 세션</option>
          <option value="first">최초 등록일</option>
          <option value="expire">만료일</option>
        </select>
        <button id="orderBtn" class="tgl" aria-pressed="false">오름차순 ↑</button>
      </div>
      <button id="expiredToggle" class="tgl" aria-pressed="false">만료 회원만 보기 (0)</button>
      <button id="btnDash" class="back" onclick="location.href='dashboard.html'">대시보드로</button>
    </div>
  </header>

  <section class="shelf-wrap">
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  </section>

  <!-- 롱프레스 액션시트 -->
  <div id="overlay" class="overlay"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" style="display:none">
    <h3 id="sheetTitle">만료 고객 분류</h3>
    <p id="sheetDesc">이 고객을 만료 고객으로 분류할까요?</p>
    <div class="rowbtns">
      <button id="btnExpire" class="danger">만료로 분류</button>
      <button id="btnCancel" class="cancel">취소</button>
    </div>
  </div>

  <!-- 파일 오버레이 -->
  <div id="fileOverlay" class="fileOverlay" aria-hidden="true">
    <div class="fileCard" role="dialog" aria-modal="true" aria-labelledby="fileTitle">
      <div class="fileHead">
        <strong id="fileTitle" class="fileName">고객님</strong>
        <span id="fileLevel" class="fileTag">일반</span>
        <button id="fileClose" class="closeX" aria-label="닫기">닫기</button>
      </div>
      <div class="fileBody">
        <div class="fileGrid">
          <div>
            <div id="fileRing" class="ring" style="--pct:0"><div id="fileRingLabel" class="ring-label">0/0</div></div>
          </div>
          <div class="rows">
            <div class="row"><span class="label">담당</span><span id="fTrainer" class="value">-</span></div>
            <div class="row"><span class="label">등급</span><span id="fGrade" class="value">-</span></div>
            <div class="row"><span class="label">등록일</span><span id="fFirst" class="value">-</span></div>
            <div class="row"><span class="label">만료일</span><span id="fExpire" class="value">-</span></div>
            <div class="row"><span class="label">작성</span><span id="fLogCount" class="value">0회</span></div>
            <div class="row"><span class="label">다음예약</span><span id="fNext" class="value">조회 중…</span></div>
          </div>
        </div>
      </div>
      <div class="fileActions">
        <button id="fOpenLog" class="btn">📓 일지 열기</button>
        <button id="fExtend" class="btn">➕ 연장 등록</button>
        <button id="fConsume" class="btn primary">–1 소진</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, increment,
           query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  /* Firestore */
  const firebaseConfig = {
    apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain:"more-than-fitness-f6adb.firebaseapp.com",
    projectId:"more-than-fitness-f6adb",
    storageBucket:"more-than-fitness-f6adb.appspot.com",
    messagingSenderId:"993248877411",
    appId:"1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId:"G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* DOM */
  const shelf    = document.getElementById('shelf');
  const empty    = document.getElementById('empty');
  const qEl      = document.getElementById('q');
  const sortSel  = document.getElementById('sortBy');
  const orderBtn = document.getElementById('orderBtn');
  const expiredToggleBtn = document.getElementById('expiredToggle');

  const overlay  = document.getElementById('overlay');
  const sheet    = document.getElementById('sheet');
  const btnExpire= document.getElementById('btnExpire');
  const btnCancel= document.getElementById('btnCancel');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetDesc  = document.getElementById('sheetDesc');

  // File overlay refs
  const fileOverlay = document.getElementById('fileOverlay');
  const fileClose   = document.getElementById('fileClose');
  const fileTitle   = document.getElementById('fileTitle');
  const fileLevel   = document.getElementById('fileLevel');
  const fileRing    = document.getElementById('fileRing');
  const fileRingLabel = document.getElementById('fileRingLabel');
  const fTrainer    = document.getElementById('fTrainer');
  const fGrade      = document.getElementById('fGrade');
  const fFirst      = document.getElementById('fFirst');
  const fExpire     = document.getElementById('fExpire');
  const fLogCount   = document.getElementById('fLogCount');
  const fNext       = document.getElementById('fNext');
  const fOpenLog    = document.getElementById('fOpenLog');
  const fExtend     = document.getElementById('fExtend');
  const fConsume    = document.getElementById('fConsume');

  /* Utils */
  const collator = new Intl.Collator('ko-KR',{numeric:true,sensitivity:'base'});
  const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const p2 = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
  const nowHM = () => { const d=new Date(); return `${p2(d.getHours())}:${p2(d.getMinutes())}`; };
  const toISO = ts => ts?.toDate ? ts.toDate().toISOString().slice(0,10) : (typeof ts==='string' ? ts : "");
  const toTime = (str)=> (str ? new Date(str).getTime() : NaN);

  function daysUntilAnnual(dateStr){
    if(!dateStr) return null;
    const [y,m,d] = String(dateStr).split('-').map(Number); if(!m||!d) return null;
    const now = new Date();
    const tgt = new Date(now.getFullYear(), m-1, d);
    if (tgt < new Date(now.getFullYear(), now.getMonth(), now.getDate())) tgt.setFullYear(now.getFullYear()+1);
    const diff = Math.ceil((tgt - now)/86400000);
    return diff<=30 ? diff : null;
  }
  function colorClass(member){
    const g = (member.gender||"").toLowerCase();
    const now = new Date().getFullYear();
    const age = member.birthYear ? now - member.birthYear : null;
    if(g.startsWith('여')) return (age!==null && age>=50) ? 'cFemale50' : 'cFemale';
    if(g.startsWith('남')) return (age!==null && age>=50) ? 'cMale50'   : 'cMale';
    return 'cDefault';
  }

  /* 다음 예약 캐시 */
  const nextScheduleCache = new Map();
  async function fetchNextSchedule(memberId){
    if (nextScheduleCache.has(memberId)) return nextScheduleCache.get(memberId);
    try{
      const qy = query(collection(db,'schedules'), where('memberId','==', memberId));
      const snap = await getDocs(qy);
      const today = todayISO(), now = nowHM();
      const list = [];
      snap.forEach(ds=>{
        const s = ds.data();
        const d = String(s.date||''); const st = String(s.start||'00:00');
        if (d > today || (d===today && st >= now)) list.push({date:d,start:st});
      });
      list.sort((a,b)=> (a.date===b.date ? a.start.localeCompare(b.start) : a.date.localeCompare(b.date)));
      const val = list[0] ? `${list[0].date} ${list[0].start}` : '-';
      nextScheduleCache.set(memberId, val);
      return val;
    }catch(e){ console.error(e); nextScheduleCache.set(memberId,'-'); return '-'; }
  }

  /* State */
  let state = {
    orderAsc: true,
    showExpiredOnly: false,
    members: [],
  };
  let currentMemberForSheet = null;
  let longPressTimer = null;
  let longFired = false;
  let openedMember = null; // file overlay용

  /* Helper */
  function isExpired(m){
    const today = new Date(todayISO()).getTime();
    const expT  = toTime(m.expireAt);
    return Boolean(m.expiredFlag) || (Number.isFinite(expT) && expT < today);
  }

  /* 파일 열기/닫기 */
  function openFile(member){
    openedMember = member;
    fileTitle.textContent = `${member.name} 고객님`;
    fileLevel.textContent = member.grade || '일반';
    fTrainer.textContent  = member.trainer || '-';
    fGrade.textContent    = member.grade || '-';
    fFirst.textContent    = member.first || '-';
    fExpire.textContent   = member.expireAt || '-';
    fLogCount.textContent = `${member.logCount||0}회`;
    fNext.textContent     = '조회 중…';
    const total = member.total||0, remain = member.remaining||0;
    const pct = Math.max(0, Math.min(100, Math.round((remain/(total||1))*100)));
    fileRing.style.setProperty('--pct', pct);
    fileRing.classList.toggle('low', remain<=3);
    fileRingLabel.textContent = `${remain}/${total}`;

    // 버튼 동작
    fOpenLog.onclick = ()=> location.href = `personal-training-log.html?id=${encodeURIComponent(member.id)}`;
    fExtend.onclick  = ()=> location.href = `edit-member.html?id=${encodeURIComponent(member.id)}`;
    fConsume.onclick = async ()=>{
      if ((member.remaining||0) <= 0){ alert('잔여 세션이 없습니다'); return; }
      try{
        await updateDoc(doc(db,'members',member.id), { remainingSessions: increment(-1) });
      }catch(e){ console.error(e); alert('소진 처리 실패'); }
    };

    // 다음 예약
    fetchNextSchedule(member.id).then(v=>{ if(openedMember?.id===member.id) fNext.textContent=v; });

    fileOverlay.classList.add('show');
    fileOverlay.setAttribute('aria-hidden','false');
  }
  function closeFile(){
    fileOverlay.classList.remove('show');
    fileOverlay.setAttribute('aria-hidden','true');
    openedMember=null;
  }
  fileClose.addEventListener('click', closeFile);
  fileOverlay.addEventListener('click', (e)=>{ if(e.target===fileOverlay) closeFile(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeFile(); });

  /* Render */
  function render(list){
    shelf.innerHTML = '';
    if(!list.length){ empty.hidden = false; return; }
    empty.hidden = true;

    list.forEach(m=>{
      const expired = isExpired(m);
      const cls = ['binder', colorClass(m)];
      if ((m.remaining ?? 0) <= 0) cls.push('zero');
      if (expired) cls.push('expired');

      const art = document.createElement('article');
      art.className = cls.join(' ');
      art.tabIndex = 0;
      art.setAttribute('role','button');
      art.setAttribute('aria-label', `${m.name} 고객 카드`);

      const dLeft = m.expireAt ? Math.ceil((new Date(m.expireAt) - new Date(todayISO()))/86400000) : null;
      const stickerRecent = m.lastLog ? `<span class="sticker recent">최근 ${m.lastLog}</span>` : '';
      const stickerExpire = (expired || (dLeft !== null && dLeft <= 7)) ? `<span class="sticker expire">만료 D-${Math.max(dLeft??0,0)}</span>` : '';
      const stickerGrade  = m.grade ? `<span class="sticker">${escapeHtml(m.grade)}</span>` : '';

      art.innerHTML = `
        <span class="shine" aria-hidden="true"></span>
        <span class="under" aria-hidden="true"></span>
        <div class="head">
          <div class="name-wrap">
            <div class="name">${escapeHtml(m.name)} <span class="suffix">고객님</span></div>
            <div class="sub-sessions">(${m.total||0}/${m.remaining||0})</div>
          </div>
          <div class="stickers">${stickerGrade} ${stickerRecent} ${stickerExpire}</div>
        </div>
        <div class="holes"><div class="hole"></div><div class="hole"></div><div class="hole"></div></div>
      `;

      // 클릭 → 파일 열기 (롱프레스 직후 클릭 방지)
      art.addEventListener('click', ()=>{
        if (longFired){ longFired=false; return; }
        openFile(m);
      });

      // 반짝 효과
      const addPulse = ()=> art.classList.add('pulse');
      const removePulse = ()=> art.classList.remove('pulse');
      art.addEventListener('pointerdown', addPulse);
      art.addEventListener('pointerup', removePulse);
      art.addEventListener('pointerleave', removePulse);
      art.addEventListener('animationend', (e)=>{ if(e.animationName==='glowPulse') removePulse(); });

      // 롱프레스 → 만료 분류 시트
      art.addEventListener('pointerdown', ()=>{
        longFired=false;
        longPressTimer = setTimeout(()=>{ longFired=true; openExpireSheet(m); }, 600);
      }, {passive:true});
      ['pointerup','pointerleave','pointercancel'].forEach(evName=>{
        art.addEventListener(evName, ()=>{ clearTimeout(longPressTimer); longPressTimer=null; }, {passive:true});
      });

      shelf.appendChild(art);
    });
  }

  /* 액션시트 (만료 분류) */
  function openExpireSheet(member){
    currentMemberForSheet = member;
    const expired = isExpired(member);
    sheetTitle.textContent = expired ? '만료 표시 해제' : '만료 고객 분류';
    sheetDesc.textContent  = expired ? '이 고객의 만료 표시를 해제할까요?' : '이 고객을 만료 고객으로 분류할까요?';
    btnExpire.textContent  = expired ? '만료 표시 해제' : '만료로 분류';
    overlay.style.display = 'block';
    sheet.style.display   = 'block';
  }
  function closeSheet(){
    overlay.style.display = 'none';
    sheet.style.display   = 'none';
    currentMemberForSheet = null;
  }
  overlay.addEventListener('click', closeSheet);
  btnCancel.addEventListener('click', closeSheet);
  btnExpire.addEventListener('click', async ()=>{
    if(!currentMemberForSheet) return;
    try{
      const willUnset = isExpired(currentMemberForSheet);
      await updateDoc(doc(db,'members', currentMemberForSheet.id), {
        expiredFlag: willUnset ? false : true,
        expiredFlagAt: willUnset ? null : serverTimestamp()
      });
    }catch(e){ console.error(e); alert('처리 실패'); }
    closeSheet();
  });

  /* 정렬/필터 */
  function filterSort(){
    const kw = (qEl.value||'').trim().toLowerCase();
    const norm = s => String(s||'').toLowerCase();

    let list = state.members.filter(m=>{
      const match = !kw || norm(m.name).includes(kw) || norm(m.trainer).includes(kw) || norm(m.grade).includes(kw);
      const expired = isExpired(m);
      const pass = state.showExpiredOnly ? expired : true;
      return match && pass;
    });

    const by = sortSel.value;
    const dir = state.orderAsc ? 1 : -1;

    list.sort((a,b)=>{
      if(by==='name')   return dir * collator.compare(a.name, b.name);
      if(by==='recent'){
        const A = toTime(a.lastLog) || 0;
        const B = toTime(b.lastLog) || 0;
        return dir * (A - B);
      }
      if(by==='remain') return dir * ((a.remaining||0) - (b.remaining||0));
      if(by==='first'){
        const A = toTime(a.first) || 0;
        const B = toTime(b.first) || 0;
        return dir * (A - B);
      }
      if(by==='expire'){
        const A = toTime(a.expireAt) || Infinity;
        const B = toTime(b.expireAt) || Infinity;
        return dir * (A - B);
      }
      return 0;
    });

    render(list);

    // 만료 수 카운트 업데이트
    const expiredCount = state.members.filter(m=>isExpired(m)).length;
    expiredToggleBtn.textContent = `${state.showExpiredOnly ? '전체 보기' : '만료 회원만 보기'} (${expiredCount})`;
  }

  orderBtn.addEventListener('click', ()=>{
    state.orderAsc = !state.orderAsc;
    orderBtn.textContent = state.orderAsc ? '오름차순 ↑' : '내림차순 ↓';
    orderBtn.setAttribute('aria-pressed', String(!state.orderAsc));
    filterSort();
  });
  qEl.addEventListener('input', filterSort);
  sortSel.addEventListener('change', filterSort);
  expiredToggleBtn.addEventListener('click', ()=>{
    state.showExpiredOnly = !state.showExpiredOnly;
    expiredToggleBtn.setAttribute('aria-pressed', String(state.showExpiredOnly));
    filterSort();
  });

  /* 구독 */
  const auth = getAuth(app);
  onAuthStateChanged(auth, (u)=>{
    if (u) startMembers();
    else signInAnonymously(auth).catch((e)=>{ console.error(e); empty.textContent='로그인 실패로 데이터를 볼 수 없어요.'; empty.hidden=false; });
  });

  function startMembers(){
    onSnapshot(
      collection(db,'members'),
      (snap)=>{
        const list=[];
        snap.forEach(ds=>{
          const d=ds.data();
          list.push({
            id: ds.id,
            name: d.name || "",
            trainer: d.trainer || "",
            grade: d.level || d.grade || "",
            first: d.startDate || toISO(d.createdAt) || "",
            expireAt: toISO(d.expireAt),
            lastLog:  toISO(d.lastLogAt) || toISO(d.lastPurchaseAt),
            logCount: d.logCount || 0,
            remaining: d.remainingSessions ?? 0,
            total: d.totalSessionsPurchased ?? d.totalSessions ?? 0,
            birthday: toISO(d.birthday),
            anniversary: toISO(d.anniversary),
            gender: d.gender || "",
            birthYear: d.birth ? Number(String(d.birth).slice(0,4)) : null,
            expiredFlag: Boolean(d.expiredFlag)
          });
        });
        state.members=list;
        const expiredCount = state.members.filter(m=>isExpired(m)).length;
        expiredToggleBtn.textContent = `${state.showExpiredOnly ? '전체 보기' : '만료 회원만 보기'} (${expiredCount})`;
        filterSort();
      },
      (err)=>{ console.error(err); empty.textContent = '데이터를 불러오지 못했어요. (권한/네트워크 확인)'; empty.hidden = false; }
    );
  }
  </script>
</body>
</html>
