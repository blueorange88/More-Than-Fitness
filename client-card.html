<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>고객 카드 – 바인더 선반</title>
<style>
  :root{
    /* 모바일 기본값(폰 중심) */
    --binder-w: clamp(320px, 88vw, 460px);
    --binder-h: auto; /* aspect-ratio로 제어 */
    --binder-overlap: calc(var(--binder-w) * -0.46);

    --navy:#0B1E3A; --gold:#C8A848; --ink:#0b1220; --muted:#6b7280;
    --line:#e5e7eb; --danger:#ef4444; --danger-bg:#fee2e2;
    --ok:#2563eb; --track:#e5e7eb;
    --shelf:#f3f4f6; --shelf-edge:#e5e7eb;
  }

  /* 태블릿 이상 */
  @media (min-width: 600px){
    :root{
      --binder-w: clamp(360px, 64vw, 520px);
      --binder-overlap: calc(var(--binder-w) * -0.5);
    }
  }
  /* 데스크톱 이상 */
  @media (min-width: 1024px){
    :root{
      --binder-w: 440px;
      --binder-overlap: -180px;
    }
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(#fff,#fbfbfb); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  /* ===== Header / Tools ===== */
  header{ position:sticky; top:0; z-index:20; background:linear-gradient(#fff,#f9fafb);
    border-bottom:2px solid var(--gold); padding:14px 16px 12px; }
  header h1{margin:0 0 10px; font-size:18px; color:var(--navy);}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{ flex:1; min-width:220px; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; font-size:14px; background:#fff; }
  .tools .group{display:flex;gap:8px; align-items:center; font-size:13px; color:#0B1E3A}
  .tools select, .tools button{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px; cursor:pointer; }
  .tools button.tgl{min-width:92px}
  .back{ margin-left:auto; background:#0B1E3A; color:#fff; font-weight:700; }

  /* ===== Shelf / Shadows ===== */
  .shelf-wrap{position:relative; padding:18px 0 28px}
  .shelf-wrap::before{ content:""; position:absolute; left:0; right:0; top:6px; height:18px; pointer-events:none;
    background:radial-gradient(80% 14px at 50% 0, rgba(0,0,0,.18), rgba(0,0,0,0) 70%); filter: blur(2px); }
  .shelf-wrap::after{ content:""; position:absolute; left:0; right:0; bottom:2px; height:24px; pointer-events:none;
    background:radial-gradient(70% 18px at 50% 100%, rgba(0,0,0,.22), rgba(0,0,0,0) 70%); filter: blur(3px); }
  .shelf{
    position:relative; display:flex; gap:0; padding:26px 22px;
    overflow-x:auto; overflow-y:visible; scrollbar-width:thin;
    perspective:1200px;
    border-top:1px solid var(--shelf-edge); border-bottom:1px solid var(--shelf-edge);
    background:var(--shelf);
    scroll-snap-type:x proximity;
  }
  .shelf::before, .shelf::after{
    content:""; position:sticky; left:0; width:40px; flex:0 0 40px; height:100%; pointer-events:none;
    background:linear-gradient(90deg,#f9fafb,rgba(249,250,251,0));
  }
  .shelf::after{ left:auto; right:0; background:linear-gradient(270deg,#f9fafb,rgba(249,250,251,0)); }

  /* ===== Binder (cards) ===== */
  @keyframes breathe { 0%,100%{filter:saturate(1) brightness(1)} 50%{filter:saturate(1.06) brightness(1.04)} }
  @keyframes glowPulse { 0%,100%{ box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22); }
                        50%    { box-shadow:-12px 0 0 rgba(255,255,255,.24) inset, 0 28px 60px rgba(0,0,0,.28); } }
  .binder{
    position:relative; width:var(--binder-w); aspect-ratio:210/297; margin-left:var(--binder-overlap);
    border-radius:16px; cursor:pointer; user-select:none; outline:0;
    transform:translateZ(0) rotateY(-12deg) translateY(6px);
    transform-origin:left center; will-change:transform, filter;
    box-shadow:-8px 0 0 rgba(0,0,0,.06) inset, 0 8px 20px rgba(0,0,0,.08);
    transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s, filter .28s, z-index .28s;
    color:#0b1220; scroll-snap-align:start;

    /* 기본 색(파스텔블루) - 남성 기본 */
    --c-start:#d9ecff; --c-mid:#bfe0ff; --c-end:#8cc4ff;
    --tab-start:#bfe0ff; --tab-end:#8cc4ff;
    background:linear-gradient(160deg, var(--c-start), var(--c-mid), var(--c-end));
    border:1px solid rgba(0,0,0,.06);
  }
  /* 여성(핑크) */
  .cFemale{
    --c-start:#ffe0ee; --c-mid:#ffc2da; --c-end:#ff97bd;
    --tab-start:#ffc2da; --tab-end:#ff97bd;
    background:linear-gradient(160deg, var(--c-start), var(--c-mid), var(--c-end));
  }
  /* 만료(멜란지 그레이) */
  .cExpired{
    --c-start:#e6e7ea; --c-mid:#cfd2d6; --c-end:#a8acb1;
    --tab-start:#cfd2d6; --tab-end:#a8acb1;
    background:linear-gradient(160deg, var(--c-start), var(--c-mid), var(--c-end));
    filter:saturate(.9);
  }

  .binder:first-child{ margin-left:8px; }
  .binder:hover, .binder:focus-visible{
    z-index:9; transform:translateY(-14px) rotateY(-2deg) scale(1.04);
    box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22);
    animation:breathe 2.3s ease-in-out infinite;
  }
  .binder::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:24px; border-radius:16px 0 0 16px;
    background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(0,0,0,.1)); box-shadow:2px 0 6px rgba(0,0,0,.12) inset; }
  .binder::after{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px;
    background:
      radial-gradient(28px 28px at calc(100% - 10px) 10px, rgba(255,255,255,.55), rgba(255,255,255,0) 70%) top right / 40% 40% no-repeat,
      radial-gradient(22px 22px at 12px calc(100% - 12px), rgba(255,255,255,.32), rgba(255,255,255,0) 70%) bottom left / 35% 35% no-repeat;
    opacity:.0; transition:opacity .25s ease;
  }
  .binder:hover::after, .binder:focus-visible::after{ opacity:1; }
  .shine{ position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.28) 30%, rgba(255,255,255,0) 60%);
    transform: translateX(-130%); transition: transform .9s ease; mix-blend-mode: screen; }
  .binder:hover .shine, .binder:focus-visible .shine{ transform: translateX(130%); }
  .under{ position:absolute; left:18%; right:12px; bottom:-10px; height:20px; pointer-events:none;
    background:radial-gradient(60% 100% at 50% 0, rgba(0,0,0,.28), rgba(0,0,0,0)); filter: blur(3px); opacity:.65; transition:opacity .25s, transform .25s; }
  .binder:hover .under, .binder:focus-visible .under{ opacity:.9; transform: translateY(2px) scale(1.06); }
  .binder.pulse{ animation:glowPulse 1.1s ease-in-out 1; }

  /* 왼쪽 인덱스 탭 (바인더 색과 동기화) */
  .edge-tab{
    position:absolute; left:-16px; top:46px; width:22px; height:100px;
    background:linear-gradient(180deg,var(--tab-start), var(--tab-end));
    border:2px solid var(--tab-end); border-right:none;
    border-radius:10px 0 0 10px; writing-mode:vertical-rl; text-orientation:mixed;
    font-weight:900; font-size:11px; color:#ffffff; display:flex; align-items:center; justify-content:center;
    box-shadow:0 3px 8px rgba(0,0,0,.12); transform:rotate(-2deg); transition:transform .2s, filter .2s; user-select:none;
  }
  .binder:hover .edge-tab{ transform:rotate(0deg) translateX(-2px); filter:brightness(1.05); }
  .edge-tab:active{ transform:translateX(-3px); }

  /* 터치하면 잠깐 보이는 타이틀 스트립(검정) */
  .title-strip{
    position:absolute; top:10px; left:32px; right:10px;
    background:rgba(0,0,0,.78); color:#fff; border-radius:10px; padding:6px 10px; font-weight:900; font-size:12px;
    display:inline-flex; align-items:center; justify-content:center;
    opacity:0; transform:translateY(-6px); pointer-events:none; transition:.25s;
  }
  .title-strip.show{ opacity:1; transform:translateY(0); }

  /* 하단 최근 등록(모바일 유지) */
  .foot-date{
    position:absolute; left:36px; right:10px; bottom:10px;
    font-size:11px; font-weight:800; color:#334155;
    background:rgba(255,255,255,.86); padding:6px 10px; border-radius:10px; border:1px solid #e5e7eb;
    display:flex; align-items:center; gap:6px;
  }
  .foot-date .dot{ width:6px; height:6px; border-radius:50%; background:#22c55e; }

  /* ===== 중앙 오버레이(롱프레스) ===== */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:1100; }
  .overlay.open{ display:block; }
  .modal-wrap{
    position:absolute; inset:0; display:grid; place-items:center;
    padding:14px; overflow:auto;
  }
  .binder-modal{
    width:min(560px, 94vw); aspect-ratio:210/297; position:relative;
    opacity:0; transform:translateY(8%) scale(.94); transition:opacity .3s, transform .42s cubic-bezier(.2,.7,.2,1);
  }
  .overlay.open .binder-modal{ opacity:1; transform:translateY(0) scale(1); }

  .bm-folder{
    position:absolute; inset:0; border-radius:12px;
    /* 여기서도 바인더 색과 100% 동기화 */
    --m-start:#d9ecff; --m-mid:#bfe0ff; --m-end:#8cc4ff;
    --m-tab-start:#bfe0ff; --m-tab-end:#8cc4ff;
    background:linear-gradient(160deg,var(--m-start), var(--m-mid), var(--m-end));
    box-shadow:0 12px 28px rgba(0,0,0,.25);
    overflow:hidden; transform-style:preserve-3d;
  }
  .bm-tab{
    position:absolute; left:-18px; top:18px; width:26px; height:110px;
    background:linear-gradient(180deg,var(--m-tab-start), var(--m-tab-end));
    border:2px solid var(--m-tab-end); border-right:none; border-radius:10px 0 0 10px;
    writing-mode:vertical-rl; text-orientation:mixed; color:#fff; font-weight:900; font-size:11px;
    display:flex; align-items:center; justify-content:center; box-shadow:0 3px 8px rgba(0,0,0,.12);
  }
  /* 종이 */
  .bm-paper{ position:absolute; inset:10px; pointer-events:none; }
  .bm-sheet{ position:absolute; inset:0; background:#fff; border:1px solid #e5e7eb; border-radius:8px;
             box-shadow:0 1px 3px rgba(0,0,0,.12); transform-origin:left center; transition:transform .6s ease; }
  .bm-sheet:nth-child(1){ transform:translateX(2px); }
  .bm-sheet:nth-child(2){ transform:translateX(4px); }
  .bm-sheet:nth-child(3){ transform:translateX(6px); }
  .bm-sheet:nth-child(4){ transform:translateX(8px); }

  /* 덮개: 바인더와 같은 색 */
  .bm-cover{
    position:absolute; inset:0; border-radius:12px;
    background:linear-gradient(160deg,var(--m-start), var(--m-mid), var(--m-end));
    border-left:2px solid rgba(0,0,0,.08); transform-origin:left center;
    transform:translateX(0) rotateY(0); transition:transform .9s cubic-bezier(.175,.885,.32,1.275);
    box-shadow:-4px 0 14px rgba(0,0,0,.18) inset;
  }
  /* 열렸을 때 */
  .opened .bm-cover{ transform:translateX(-78%) rotateY(-16deg); }
  .opened .bm-sheet:nth-child(1){ transform:translateX(-2px) rotateY(3deg); }
  .opened .bm-sheet:nth-child(2){ transform:translateX(-1px) rotateY(2deg); }
  .opened .bm-sheet:nth-child(3){ transform:translateX(0) rotateY(1deg); }
  .opened .bm-sheet:nth-child(4){ transform:translateX(1px) rotateY(0); }

  /* 속지 내용 */
  .bm-body{
    position:absolute; left:14px; right:14px; top:18px; bottom:60px; /* 아래 버튼 영역 남김 */
    overflow:auto; padding:10px;
  }
  /* 내용 그리드: 좌우로 좀 넓게 해서 가로 스크롤 가능 */
  .doc-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; min-width: 640px; }
  @media (max-width:600px){ .doc-grid{ grid-template-columns: 1fr; min-width: 560px; } }
  .doc-card{ background:#fafafa; border:1px solid #e9edf3; border-radius:12px; padding:12px; }
  .doc-card h4{ margin:0 0 8px; font-size:14px; font-weight:900; color:#0b1220; }
  .kv{ display:grid; grid-template-columns:86px 1fr; gap:6px; font-size:12px; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .chip{ border:1px solid var(--line); background:#fff; border-radius:999px; padding:6px 10px; font-size:12px; }

  /* 진행 링 */
  .ring{ --pct:0; width:84px; height:84px; border-radius:50%;
    background:conic-gradient(var(--ok) calc(var(--pct)*1%), var(--track) 0);
    display:grid; place-items:center; margin-left:auto; border:6px solid rgba(255,255,255,.6);
    box-shadow:0 2px 10px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.08); }
  .ring.low{ --ok:#ef4444; }
  .ring .ring-label{background:#fff; border-radius:999px; padding:6px 8px; font-size:12px; font-weight:900; border:1px solid #e5e7eb}

  /* 하단 버튼 줄(속지 안쪽) */
  .bm-actions{
    position:absolute; left:12px; right:12px; bottom:12px;
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .btn{ flex:1 0 140px; padding:10px 12px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
    background:#0f172a; color:#fff; font-weight:800; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 8px 18px rgba(11,30,58,.18); cursor:pointer; }
  .btn.light{ background:#fff; color:#0B1E3A; }
  .btn.warn{ background:#ef4444; border-color:#ef4444; color:#fff; }
  .btn:active{ transform:translateY(1px); }

  /* Empty */
  .empty{padding:40px 16px; text-align:center; color:var(--muted)}

  /* 다크 */
  @media (prefers-color-scheme: dark){
    body{ background:linear-gradient(#0b1220,#101826); color:#e5e7eb; }
    header{ background:linear-gradient(#0f172a,#0b1220); border-bottom-color:#475569; }
    .tools input[type="search"], .tools select, .tools button{ background:#0f172a; color:#e5e7eb; border-color:#374151; }
    .shelf{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
            border-top-color:#374151; border-bottom-color:#374151; }
    .binder{ color:#eef2ff; border-color:rgba(255,255,255,.06);
             box-shadow:-8px 0 0 rgba(0,0,0,.45) inset, 0 12px 28px rgba(0,0,0,.65); }
    .edge-tab{ color:#fff; }
    .foot-date{ background:rgba(16,24,38,.86); color:#e5e7eb; border-color:#273044; }
    .overlay{ background:rgba(0,0,0,.55); }
    .bm-folder{ box-shadow:0 14px 36px rgba(0,0,0,.45); }
    .doc-card{ background:#121b2a; border-color:#273044; }
    .doc-card h4{ color:#e5e7eb; }
    .chip{ background:#101826; border-color:#273044; color:#e5e7eb; }
    .btn.light{ background:#0f172a; color:#e5e7eb; border-color:#273044; }
  }

  /* 모바일에서 헤더 이름영역 숨김(인덱스탭으로 식별) */
  @media (max-width: 600px){
    .name-wrap { display:none; }
  }
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 – 바인더 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="이름 / 담당 / 등급 검색" />
      <div class="group">
        정렬:
        <select id="sortBy" aria-label="정렬">
          <option value="name" selected>이름(가나다·영문·숫자)</option>
          <option value="recent">최근 작성</option>
          <option value="remain">잔여 세션</option>
          <option value="first">최초 등록일</option>
          <option value="expire">만료일</option>
        </select>
        <button id="orderBtn" class="tgl" aria-pressed="false">오름차순 ↑</button>
      </div>
      <button id="expiredToggle" class="expired-toggle" aria-pressed="false">만료 회원만 보기 (0)</button>
      <button id="btnDash" class="back" onclick="location.href='dashboard.html'">대시보드로</button>
    </div>
  </header>

  <section class="shelf-wrap">
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  </section>

  <!-- 롱프레스 시 중앙 오버레이 -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal-wrap">
      <div id="binderModal" class="binder-modal">
        <div id="bmFolder" class="bm-folder">
          <div id="bmTab" class="bm-tab">고객님</div>
          <div class="bm-paper">
            <div class="bm-sheet"></div><div class="bm-sheet"></div>
            <div class="bm-sheet"></div><div class="bm-sheet"></div>
          </div>
          <div id="bmCover" class="bm-cover"></div>

          <div class="bm-body">
            <div id="bmBodyGrid" class="doc-grid"></div>
          </div>

          <div class="bm-actions">
            <button id="btnJournal" class="btn light">📓 운동일지</button>
            <button id="btnExtend"  class="btn light">📝 연장/수정</button>
            <button id="btnConsume" class="btn warn">–1 소진</button>
            <button id="btnClose"   class="btn">닫기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, updateDoc, increment,
         query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
  authDomain:"more-than-fitness-f6adb.firebaseapp.com",
  projectId:"more-than-fitness-f6adb",
  storageBucket:"more-than-fitness-f6adb.appspot.com",
  messagingSenderId:"993248877411",
  appId:"1:993248877411:web:c0e6785162cf252fbcd156",
  measurementId:"G-MK0RVFG296"
};
const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);

/* ===== DOM ===== */
const shelf    = document.getElementById('shelf');
const empty    = document.getElementById('empty');
const qEl      = document.getElementById('q');
const sortSel  = document.getElementById('sortBy');
const orderBtn = document.getElementById('orderBtn');
const expiredToggleBtn = document.getElementById('expiredToggle');

/* Overlay */
const overlay   = document.getElementById('overlay');
const bmFolder  = document.getElementById('bmFolder');
const bmCover   = document.getElementById('bmCover');
const bmTab     = document.getElementById('bmTab');
const bmBodyGrid= document.getElementById('bmBodyGrid');
const btnJournal= document.getElementById('btnJournal');
const btnExtend = document.getElementById('btnExtend');
const btnConsume= document.getElementById('btnConsume');
const btnClose  = document.getElementById('btnClose');

/* ===== Utils ===== */
const collator = new Intl.Collator('ko-KR',{numeric:true,sensitivity:'base'});
const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
const p2 = n => String(n).padStart(2,'0');
const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
const nowHM = () => { const d=new Date(); return `${p2(d.getHours())}:${p2(d.getMinutes())}`; };
const toISO = ts => ts?.toDate ? ts.toDate().toISOString().slice(0,10) : (typeof ts==='string' ? ts : "");
const toTime = (str)=> (str ? new Date(str).getTime() : NaN);

/* Gender normalize */
function normGender(g){
  g = (g||'').toString().trim().toLowerCase();
  if(/^(f|여|female|woman|girl)/.test(g)) return 'female';
  if(/^(m|남|male|man|boy)/.test(g))     return 'male';
  return '';
}

/* 색상 동기화: 바인더 클래스 → 오버레이 변수 */
function applyModalColorsFromBinderClass(cls){
  // 임시 노드로 해당 클래스의 CSS 변수를 읽음
  const probe = document.createElement('div');
  probe.className = 'binder '+cls;
  probe.style.position='absolute'; probe.style.visibility='hidden';
  document.body.appendChild(probe);
  const cs = getComputedStyle(probe);
  const start = cs.getPropertyValue('--c-start').trim();
  const mid   = cs.getPropertyValue('--c-mid').trim();
  const end   = cs.getPropertyValue('--c-end').trim();
  const tstart= cs.getPropertyValue('--tab-start').trim();
  const tend  = cs.getPropertyValue('--tab-end').trim();
  document.body.removeChild(probe);

  bmFolder.style.setProperty('--m-start', start||'#d9ecff');
  bmFolder.style.setProperty('--m-mid'  , mid  ||'#bfe0ff');
  bmFolder.style.setProperty('--m-end'  , end  ||'#8cc4ff');
  bmFolder.style.setProperty('--m-tab-start', tstart||'#bfe0ff');
  bmFolder.style.setProperty('--m-tab-end'  , tend  ||'#8cc4ff');
}

/* 다음 예약 캐시 */
const nextScheduleCache = new Map();
async function fetchNextSchedule(memberId){
  if (nextScheduleCache.has(memberId)) return nextScheduleCache.get(memberId);
  try{
    const qy = query(collection(db,'schedules'), where('memberId','==', memberId));
    const snap = await getDocs(qy);
    const today = todayISO(), now = nowHM();
    const list = [];
    snap.forEach(ds=>{
      const s = ds.data();
      const d = String(s.date||''); const st = String(s.start||'00:00');
      if (d > today || (d===today && st >= now)) list.push({date:d,start:st});
    });
    list.sort((a,b)=> (a.date===b.date ? a.start.localeCompare(b.start) : a.date.localeCompare(b.date)));
    const val = list[0] ? `${list[0].date} ${list[0].start}` : '-';
    nextScheduleCache.set(memberId, val);
    return val;
  }catch(e){ console.error(e); nextScheduleCache.set(memberId,'-'); return '-'; }
}

/* ===== State ===== */
let state = { orderAsc: true, showExpiredOnly: false, members: [] };
let longPressTimer = null;
let openMember = null;  // 오버레이에 표시 중인 멤버

/* ===== Render ===== */
function isExpired(m){
  const today = new Date(todayISO()).getTime();
  const expT  = toTime(m.expireAt);
  return Boolean(m.expiredFlag) || (Number.isFinite(expT) && expT < today);
}

function render(list){
  shelf.innerHTML = '';
  if(!list.length){ empty.hidden = false; return; }
  empty.hidden = true;

  list.forEach(m=>{
    const expired = isExpired(m);
    const cls = expired ? 'cExpired' : (m.gender==='female' ? 'cFemale' : ''); // 기본(남성/기타)=파스텔블루
    const shortTab = `${m.name} 고객님`; // 인덱스탭에 고객님까지 표기
    const total = m.total||0, remain = m.remaining||0;

    const art = document.createElement('article');
    art.className = ['binder', cls].join(' ').trim();
    art.tabIndex = 0;
    art.setAttribute('role','button');
    art.setAttribute('aria-label', `${m.name} 고객 카드`);

    art.innerHTML = `
      <span class="shine" aria-hidden="true"></span>
      <span class="under" aria-hidden="true"></span>
      <div class="edge-tab" role="button">${escapeHtml(shortTab)}</div>

      <div class="title-strip" aria-hidden="true">${escapeHtml(m.name)} 고객님 (${total}/${remain})</div>

      <!-- (상단 이름 영역은 모바일에서 숨김, 데스크톱에서만 살짝 보이도록 남겨둠) -->
      <div class="name-wrap" style="position:absolute; top:8px; left:36px; right:10px; color:#0b1220;">
        <div style="font-weight:900;">${escapeHtml(m.name)} 고객님</div>
      </div>

      <div class="foot-date"><span class="dot"></span> 최근 등록: <strong>${m.recentReg || m.first || '-'}</strong></div>
    `;

    /* === 인터랙션 === */

    // 1) 짧게 터치 → 타이틀 스트립 잠깐 노출
    let hideTimer=null;
    art.addEventListener('click', ()=>{
      // 롱프레스 직후 클릭 방지
      if (art._lpJustFired){ art._lpJustFired=false; return; }
      const ts = art.querySelector('.title-strip');
      ts.classList.add('show');
      clearTimeout(hideTimer);
      hideTimer = setTimeout(()=> ts.classList.remove('show'), 2000);
      // 살짝 반짝
      art.classList.add('pulse'); setTimeout(()=>art.classList.remove('pulse'), 500);
    });

    // 2) 롱프레스 → 중앙 오버레이 열기
    const openOverlay = async ()=>{
      openMember = m;
      // 색상 동기화
      applyModalColorsFromBinderClass(cls);
      // 탭 텍스트
      bmTab.textContent = `${m.name} 고객님`;
      // 내용 구성
      const nx = await fetchNextSchedule(m.id);
      const pct = total>0 ? Math.round((remain/total)*100) : 0;
      const ringLow = remain<=3;

      bmBodyGrid.innerHTML = `
        <div class="doc-card">
          <h4>👤 고객정보</h4>
          <div class="kv">
            <div>이름</div><div>${escapeHtml(m.name)} 고객님</div>
            <div>담당</div><div>${escapeHtml(m.trainer||'-')}</div>
            <div>등급</div><div>${escapeHtml(m.level||m.grade||'-')}</div>
            <div>최근등록</div><div>${m.recentReg || '-'}</div>
            <div>만료일</div><div>${m.expireAt||'-'}</div>
            <div>작성</div><div>${m.logCount||0}회</div>
          </div>
          <div class="chips">
            <div class="chip">다음예약 <strong>${nx}</strong></div>
            <div class="chip">잔여 <strong>${remain}</strong></div>
            <div class="chip">총 <strong>${total}</strong></div>
          </div>
        </div>

        <div class="doc-card" style="display:flex; gap:10px; align-items:center">
          <div style="flex:1">
            <h4>📊 세션 진행</h4>
            <div style="font-size:12px; color:#374151; line-height:1.6">
              현재 잔여/총: <strong>${remain}/${total}</strong><br/>
              최근 작성: <strong>${m.lastLog || '-'}</strong><br/>
              비고: 필요한 메모를 여기에 표시할 수 있어요.
            </div>
          </div>
          <div class="ring ${ringLow?'low':''}" style="--pct:${Math.max(0,Math.min(100,pct))}">
            <div class="ring-label">${remain}/${total}</div>
          </div>
        </div>
      `;

      // 버튼 핸들러
      btnJournal.onclick = ()=> location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
      btnExtend.onclick  = ()=> location.href = `edit-member.html?id=${encodeURIComponent(m.id)}`;
      btnConsume.onclick = async ()=>{
        if (remain<=0){ alert('잔여 세션이 없습니다'); return; }
        try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); }
        catch(err){ console.error(err); alert('소진 처리 실패'); }
      };
      btnClose.onclick   = closeOverlay;

      // 열기
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
      // 덮개 오픈 모션
      bmFolder.classList.remove('opened');
      setTimeout(()=> bmFolder.classList.add('opened'), 160);
    };

    art.addEventListener('pointerdown', ()=>{
      art._lpJustFired = false;
      longPressTimer = setTimeout(()=>{
        art._lpJustFired = true;
        openOverlay();
      }, 550);
    }, {passive:true});
    ['pointerup','pointerleave','pointercancel'].forEach(evName=>{
      art.addEventListener(evName, ()=>{ clearTimeout(longPressTimer); longPressTimer=null; }, {passive:true});
    });

    // 인덱스 탭 탭 → 즉시 열기(접근성)
    art.querySelector('.edge-tab').addEventListener('click',(e)=>{ e.stopPropagation(); openOverlay(); });

    shelf.appendChild(art);
  });
}

function closeOverlay(){
  overlay.classList.remove('open');
  overlay.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
  bmFolder.classList.remove('opened');
  openMember=null;
}
// 배경 탭 시 닫기
overlay.addEventListener('click',(e)=>{ if(e.target===overlay) closeOverlay(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && overlay.classList.contains('open')) closeOverlay(); });

/* ===== Filter/Sort ===== */
function filterSort(){
  const kw = (qEl.value||'').trim().toLowerCase();
  const norm = s => String(s||'').toLowerCase();

  let list = state.members.filter(m=>{
    const match = !kw || norm(m.name).includes(kw) || norm(m.trainer).includes(kw) || norm(m.grade).includes(kw);
    const expired = isExpired(m);
    const pass = state.showExpiredOnly ? expired : true;
    return match && pass;
  });

  const by = sortSel.value;
  const dir = state.orderAsc ? 1 : -1;

  list.sort((a,b)=>{
    if(by==='name')   return dir * collator.compare(a.name, b.name);
    if(by==='recent'){
      const A = toTime(a.lastLog) || 0;
      const B = toTime(b.lastLog) || 0;
      return dir * (A - B);
    }
    if(by==='remain') return dir * ((a.remaining||0) - (b.remaining||0));
    if(by==='first'){
      const A = toTime(a.first) || 0;
      const B = toTime(b.first) || 0;
      return dir * (A - B);
    }
    if(by==='expire'){
      const A = toTime(a.expireAt) || Infinity;
      const B = toTime(b.expireAt) || Infinity;
      return dir * (A - B);
    }
    return 0;
  });

  render(list);

  const expiredCount = state.members.filter(m=>isExpired(m)).length;
  expiredToggleBtn.textContent = `${state.showExpiredOnly ? '전체 보기' : '만료 회원만 보기'} (${expiredCount})`;
}

orderBtn.addEventListener('click', ()=>{
  state.orderAsc = !state.orderAsc;
  orderBtn.textContent = state.orderAsc ? '오름차순 ↑' : '내림차순 ↓';
  orderBtn.setAttribute('aria-pressed', String(!state.orderAsc));
  filterSort();
});
qEl.addEventListener('input', filterSort);
sortSel.addEventListener('change', filterSort);

expiredToggleBtn.addEventListener('click', ()=>{
  state.showExpiredOnly = !state.showExpiredOnly;
  expiredToggleBtn.setAttribute('aria-pressed', String(state.showExpiredOnly));
  filterSort();
});

/* ===== Firestore 구독 ===== */
onAuthStateChanged(auth, (u)=>{
  if (u) startMembers();
  else signInAnonymously(auth).catch((e)=>{ console.error(e); empty.textContent='로그인 실패로 데이터를 볼 수 없어요.'; empty.hidden=false; });
});

function startMembers(){
  onSnapshot(
    collection(db,'members'),
    (snap)=>{
      const list=[];
      snap.forEach(ds=>{
        const d=ds.data();
        const recentReg =
          toISO(d.recentRegistrationAt) ||
          toISO(d.lastRegisterAt) ||
          toISO(d.lastReenrollAt) ||
          toISO(d.lastPurchaseAt) ||
          ""; // 폴백은 첫등록일
        list.push({
          id: ds.id,
          name: d.name || "",
          trainer: d.trainer || "",
          grade: d.level || d.grade || "",
          level: d.level || "",
          first: d.startDate || toISO(d.createdAt) || "",
          recentReg,
          expireAt: toISO(d.expireAt),
          lastLog:  toISO(d.lastLogAt) || toISO(d.lastPurchaseAt),
          logCount: d.logCount || 0,
          remaining: d.remainingSessions ?? 0,
          total: d.totalSessionsPurchased ?? d.totalSessions ?? 0,
          birthday: toISO(d.birthday),
          anniversary: toISO(d.anniversary),
          expiredFlag: Boolean(d.expiredFlag),
          gender: normGender(d.gender) /* ← 등록 데이터와 연동(여/Female/여자 모두 인식) */
        });
      });
      state.members=list;
      filterSort();
    },
    (err)=>{ console.error(err); empty.textContent = '데이터를 불러오지 못했어요. (권한/네트워크 확인)'; empty.hidden = false; }
  );
}
</script>
</body>
</html>
