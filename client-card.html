<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>고객 카드 – 바인더 선반</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --ink:#0b1220; --muted:#6b7280;
    --line:#e5e7eb; --danger:#ef4444; --danger-bg:#fee2e2;
    --ok:#2563eb; --track:#e5e7eb;
    --shelf:#f3f4f6; --shelf-edge:#e5e7eb;

    /* 바인더 크기(모바일에서 더 길고 큼) */
    --binder-w: 360px;
    --binder-h: 560px;
    --binder-overlap: -200px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(#fff,#fbfbfb); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  /* ===== Header / Tools ===== */
  header{ position:sticky; top:0; z-index:20; background:linear-gradient(#fff,#f9fafb);
    border-bottom:2px solid var(--gold); padding:14px 16px 12px; }
  header h1{margin:0 0 10px; font-size:18px; color:var(--navy);}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{ flex:1; min-width:220px; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; font-size:14px; background:#fff; }
  .tools .group{display:flex;gap:8px; align-items:center; font-size:13px; color:#0B1E3A}
  .tools select, .tools button{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px; cursor:pointer; }
  .tools button.tgl{min-width:92px}
  .back{ margin-left:auto; background:#0B1E3A; color:#fff; font-weight:700; }

  /* ===== Shelf / Shadows ===== */
  .shelf-wrap{position:relative; padding:18px 0 28px}
  .shelf-wrap::before{ content:""; position:absolute; left:0; right:0; top:6px; height:18px; pointer-events:none;
    background:radial-gradient(80% 14px at 50% 0, rgba(0,0,0,.18), rgba(0,0,0,0) 70%); filter: blur(2px); }
  .shelf-wrap::after{ content:""; position:absolute; left:0; right:0; bottom:2px; height:24px; pointer-events:none;
    background:radial-gradient(70% 18px at 50% 100%, rgba(0,0,0,.22), rgba(0,0,0,0) 70%); filter: blur(2px); }
  .shelf{
    position:relative; display:flex; gap:0; padding:26px 22px;
    overflow-x:auto; overflow-y:visible; scrollbar-width:thin;
    perspective:1200px;
    border-top:1px solid var(--shelf-edge); border-bottom:1px solid var(--shelf-edge);
    background:var(--shelf);
    scroll-snap-type:x proximity;
  }
  .shelf::before, .shelf::after{
    content:""; position:sticky; left:0; width:40px; flex:0 0 40px; height:100%; pointer-events:none;
    background:linear-gradient(90deg,#f9fafb,rgba(249,250,251,0));
  }
  .shelf::after{ left:auto; right:0; background:linear-gradient(270deg,#f9fafb,rgba(249,250,251,0)); }

  /* ===== Binder (cards) ===== */
  @keyframes breathe { 0%,100%{filter:saturate(1) brightness(1)} 50%{filter:saturate(1.08) brightness(1.05)} }
  @keyframes glowPulse { 0%,100%{ box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22); }
                        50%    { box-shadow:-12px 0 0 rgba(255,255,255,.24) inset, 0 28px 60px rgba(0,0,0,.28); } }
  .binder{
    position:relative; width:var(--binder-w); height:var(--binder-h); margin-left:var(--binder-overlap);
    border-radius:16px; cursor:pointer; user-select:none; outline:0;
    transform:translateZ(0) rotateY(-12deg) translateY(6px);
    transform-origin:left center; will-change:transform, filter;
    box-shadow:-8px 0 0 rgba(0,0,0,.06) inset, 0 8px 20px rgba(0,0,0,.08);
    transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s, filter .28s, z-index .28s;
    background:linear-gradient(160deg, #9ec5ff 0%, #6aa0ff 55%, #3a6ddf 100%);
    border:1px solid rgba(0,0,0,.06); color:#0b1220; scroll-snap-align:start;
  }
  /* 색상 분류: 남(블루), 여(핑크), 만료(멜란지 그레이) */
  .cMale { 
    --tab-bg-start:#a5c7ff; --tab-bg-end:#4c86ff;
    --cover-start:#a5c7ff; --cover-end:#4c86ff;
    background:linear-gradient(160deg,#cfe3ff,#9ec5ff,#4c86ff);
  }
  .cFemale { 
    --tab-bg-start:#ffc5e1; --tab-bg-end:#ff68ae;
    --cover-start:#ffc5e1; --cover-end:#ff68ae;
    background:linear-gradient(160deg,#ffd9ec,#ffb0d6,#ff68ae);
  }
  .cExpired {
    --tab-bg-start:#c9ccd1; --tab-bg-end:#8c9199;
    --cover-start:#c9ccd1; --cover-end:#8c9199;
    background:linear-gradient(160deg,#e3e5e8,#c9ccd1,#8c9199);
    filter:saturate(.9);
  }

  .binder:first-child{ margin-left:8px; }
  .binder:hover, .binder:focus-visible{
    z-index:9; transform:translateY(-14px) rotateY(-2deg) scale(1.04);
    box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22);
    animation:breathe 2.6s ease-in-out infinite;
  }
  .binder::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:24px; border-radius:16px 0 0 16px;
    background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(0,0,0,.1)); box-shadow:2px 0 6px rgba(0,0,0,.12) inset; }
  .binder::after{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px;
    background:
      radial-gradient(28px 28px at calc(100% - 10px) 10px, rgba(255,255,255,.6), rgba(255,255,255,0) 70%) top right / 40% 40% no-repeat,
      radial-gradient(22px 22px at 12px calc(100% - 12px), rgba(255,255,255,.35), rgba(255,255,255,0) 70%) bottom left / 35% 35% no-repeat;
    opacity:.0; transition:opacity .25s ease;
  }
  .binder:hover::after, .binder:focus-visible::after{ opacity:1; }
  .shine{ position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.28) 30%, rgba(255,255,255,0) 60%);
    transform: translateX(-130%); transition: transform .9s ease; mix-blend-mode: screen; }
  .binder:hover .shine, .binder:focus-visible .shine{ transform: translateX(130%); }
  .under{ position:absolute; left:18%; right:12px; bottom:-10px; height:20px; pointer-events:none;
    background:radial-gradient(60% 100% at 50% 0, rgba(0,0,0,.28), rgba(0,0,0,0)); filter: blur(3px); opacity:.65; transition:opacity .25s, transform .25s; }
  .binder:hover .under, .binder:focus-visible .under{ opacity:.9; transform: translateY(2px) scale(1.06); }
  .binder.pulse{ animation:glowPulse 1.1s ease-in-out 1; }

  /* 상단/패널 */
  .head{position:relative; display:flex; align-items:flex-start; justify-content:space-between; padding:16px 16px 8px 36px}
  .name{font-weight:900; font-size:20px; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.35)}
  .name .suffix{margin-left:4px; font-weight:800; color:#1f2937; font-size:15px}
  .name-wrap{display:flex; flex-direction:column; gap:2px}
  .sub-sessions{font-size:12px; font-weight:800; color:#334155; opacity:.9}

  .stickers{position:absolute; top:10px; right:10px; display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}
  .sticker{ font-size:11px; padding:4px 8px; border-radius:10px; background:rgba(255,255,255,.75); color:#1f2937;
    border:1px solid rgba(0,0,0,.08); backdrop-filter:blur(3px); }
  .sticker.recent{ background:#ecfeff; border-color:#a5f3fc; color:#0e7490; }
  .sticker.expire{ background:var(--danger-bg); border-color:var(--danger); color:#991b1b; }

  .panel{ position:absolute; right:10px; top:70px; bottom:52px; left:36px;
    background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; overflow:hidden;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    transform:translateZ(30px) translateX(8px) rotateY(6deg); opacity:.0;
    transition:opacity .25s, transform .28s; backdrop-filter: blur(6px); }
  .binder:hover .panel, .binder:focus-visible .panel{ opacity:1; transform:translateZ(60px) translateX(0) rotateY(0); }
  .rows{font-size:13px; color:#374151; display:grid; gap:6px; margin-top:10px}
  .row{display:flex; gap:6px}
  .row .label{width:66px; color:#334155; font-weight:700}
  .row .value{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* 모바일에서 상단 '등록일' 숨김 */
  @media (max-width:540px){
    .row.r-first{ display:none; }
  }

  /* 링/통계/액션 */
  .ring{ --pct:0; width:84px; height:84px; border-radius:50%;
    background:conic-gradient(var(--ok) calc(var(--pct)*1%), var(--track) 0);
    display:grid; place-items:center; margin:2px 8px 6px auto; border:6px solid rgba(255,255,255,.6);
    box-shadow:0 2px 10px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.08); }
  .ring.low{ --ok:#ef4444; }
  .ring .ring-label{background:#fff; border-radius:999px; padding:6px 8px; font-size:12px; font-weight:900; border:1px solid #e5e7eb}

  .stats{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .pill{border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff}
  .pill strong{font-weight:900}
  .pill.remain{border-color:#60a5fa; background:#eff6ff}
  .pill.remain.low{border-color:#ef4444; background:#fee2e2; color:#991b1b}
  .pill.total{border-color:#d1d5db; background:#f9fafb}

  /* 상단 검은 스트립(탭/클릭 시 정보) */
  .hint-strip{
    position:absolute; left:50%; top:8px; transform:translateX(-50%); 
    background:rgba(0,0,0,.82); color:#fff; padding:6px 10px; border-radius:999px;
    font-size:12px; font-weight:800; opacity:0; pointer-events:none; transition:opacity .2s;
    white-space:nowrap; z-index:3;
  }
  .hint-strip.show{ opacity:1; }

  /* 하단: 최근 등록 (모바일은 한 줄, 작게) */
  .foot-date{
    position:absolute; left:36px; right:10px; bottom:12px;
    font-size:11px; font-weight:800; color:#334155;
    background:rgba(255,255,255,.8); padding:6px 10px; border-radius:10px; border:1px solid #e5e7eb;
    display:flex; align-items:center; gap:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .foot-date .dot{ width:6px; height:6px; border-radius:50%; background:#22c55e; }
  @media (max-width:540px){
    .foot-date{ font-size:10px; padding:6px 8px; }
  }

  .actions{ position:absolute; left:36px; right:10px; bottom:54px; display:flex; gap:10px; opacity:0; transform:translateY(6px);
    transition:opacity .2s, transform .2s; }
  .binder:hover .actions, .binder:focus-visible .actions{ opacity:1; transform:translateY(0); }
  .btn{ flex:1; padding:10px 12px; border-radius:999px; background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08);
    backdrop-filter: blur(6px); color:#0B1E3A; font-weight:800; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 8px 18px rgba(11,30,58,.18); cursor:pointer; }
  .btn.strong{ background:#0B1E3A; color:#fff; }
  .btn:active{ transform:translateY(1px); }

  /* 왼쪽 인덱스 탭 (바인더 색과 동기화) */
  .edge-tab{
    position:absolute; left:-16px; top:46px; width:22px; height:100px;
    background:linear-gradient(180deg,var(--tab-bg-start), var(--tab-bg-end));
    border:2px solid var(--tab-bg-end); border-right:none;
    border-radius:10px 0 0 10px; writing-mode:vertical-rl; text-orientation:mixed;
    font-weight:900; font-size:11px; color:#ffffff; display:flex; align-items:center; justify-content:center;
    box-shadow:0 3px 8px rgba(0,0,0,.12); transform:rotate(-2deg); transition:transform .2s, filter .2s; user-select:none;
  }
  .binder:hover .edge-tab{ transform:rotate(0deg) translateX(-2px); filter:brightness(1.05); }
  .edge-tab:active{ transform:translateX(-3px); }

  /* ===== 오버레이: 바인더가 앞으로 나오고 덮개가 열림 ===== */
  .layer{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:1200; }
  .layer.open{ display:block; }

  .stage{
    position:absolute; inset:0; display:grid; place-items:center; overflow:hidden;
  }
  /* A4 비율 카드(모바일에서도 길게) */
  .open-binder{
    width:min(86vw,820px); aspect-ratio: 210 / 297; position:relative; perspective:1800px;
    transform:translateY(4%) scale(.94); opacity:.0; transition:transform .42s cubic-bezier(.2,.7,.2,1), opacity .25s;
  }
  .layer.open .open-binder{ transform:translateY(0) scale(1); opacity:1; }

  .ob-body{
    position:absolute; inset:0; border-radius:14px;
    background:linear-gradient(160deg,var(--cover-start,#cfe3ff),var(--cover-end,#4c86ff));
    box-shadow:0 16px 48px rgba(0,0,0,.35);
  }
  /* 덮개 */
  .ob-cover{
    position:absolute; inset:0; border-radius:14px;
    background:linear-gradient(160deg,var(--cover-start,#cfe3ff),var(--cover-end,#4c86ff));
    transform-origin:left center; transform:translateX(0) rotateY(0deg);
    transition:transform .9s cubic-bezier(.175,.885,.32,1.275);
    box-shadow:-4px 0 14px rgba(0,0,0,.22) inset, 0 10px 20px rgba(0,0,0,.18);
  }
  /* 속지(두 장 보기) */
  .ob-pages{
    position:absolute; inset:12px; border-radius:10px; overflow:hidden; display:flex; gap:10px; opacity:0; transition:opacity .35s;
  }
  .page{
    flex:1; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; 
    box-shadow:0 4px 12px rgba(0,0,0,.12);
  }
  .page h4{ margin:0 0 8px; font-size:14px; font-weight:900; color:#0b1220; }
  .kv{ display:grid; grid-template-columns:86px 1fr; gap:6px; font-size:12px; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .chip{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; background:#fff; }

  /* 버튼 바(속지 맨 아래) */
  .ob-actions{
    position:absolute; left:12px; right:12px; bottom:12px; display:flex; gap:8px;
  }

  /* 열림 상태 클래스 */
  .open-binder.unfold .ob-cover{ transform:translateX(-78%) rotateY(-18deg); }
  /* 70% 이상 열렸을 때 서서히 등장 → 90% 느낌 타이밍으로 딜레이 */
  .open-binder.reveal .ob-pages{ opacity:1; }

  /* 탭/클릭 힌트 토스트(전역) */
  #topToast{
    position:fixed; top:64px; left:50%; transform:translateX(-50%);
    background:#111; color:#fff; padding:8px 12px; border-radius:12px; font-size:12px; font-weight:800;
    opacity:0; transition:opacity .2s; z-index:1400;
  }
  #topToast.show{ opacity:1; }

  /* 반응형 튜닝 */
  @media (max-width: 900px){
    :root{ --binder-w: 320px; --binder-h: 520px; --binder-overlap: -180px; }
  }
  @media (max-width: 720px){
    :root{ --binder-w: 300px; --binder-h: 500px; --binder-overlap: -160px; }
  }
  @media (max-width: 540px){
    :root{ --binder-w: 260px; --binder-h: 460px; --binder-overlap: -140px; }
    .edge-tab{ height:88px; font-size:10px; left:-14px; }
  }
  @media (max-width: 390px){
    :root{ --binder-w: 240px; --binder-h: 420px; --binder-overlap: -120px; }
  }

  @media (prefers-color-scheme: dark){
    body{ background:linear-gradient(#0b1220,#101826); color:#e5e7eb; }
    header{ background:linear-gradient(#0f172a,#0b1220); border-bottom-color:#475569; }
    .tools input[type="search"], .tools select, .tools button{ background:#0f172a; color:#e5e7eb; border-color:#374151; }
    .shelf{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
            border-top-color:#374151; border-bottom-color:#374151; }
    .binder{ color:#eef2ff; border-color:rgba(255,255,255,.06);
             box-shadow:-8px 0 0 rgba(0,0,0,.45) inset, 0 12px 28px rgba(0,0,0,.65); }
    .panel{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.1); }
    .sticker{ background:rgba(255,255,255,.14); border-color:rgba(255,255,255,.2); color:#e5e7eb; }
    .sticker.recent{ background:rgba(14,116,144,.22); border-color:rgba(14,116,144,.45); color:#d1faff; }
    .btn{ background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.18); color:#e5e7eb; }
    .btn.strong{ background:#0B1E3A; }
    .row .label{ color:#cbd5e1; }
    .sub-sessions{ color:#cbd5e1; }

    .page{ background:#121b2a; border-color:#273044; }
    .page h4{ color:#e5e7eb; }
    .chip{ background:#101826; border-color:#273044; color:#e5e7eb; }
  }
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 – 바인더 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="이름 / 담당 / 등급 검색" />
      <div class="group">
        정렬:
        <select id="sortBy" aria-label="정렬">
          <option value="name" selected>이름(가나다·영문·숫자)</option>
          <option value="recent">최근 작성</option>
          <option value="remain">잔여 세션</option>
          <option value="first">최초 등록일</option>
          <option value="expire">만료일</option>
        </select>
        <button id="orderBtn" class="tgl" aria-pressed="false">오름차순 ↑</button>
      </div>
      <button id="expiredToggle" class="tgl" aria-pressed="false">만료 회원만 보기 (0)</button>
      <button id="btnDash" class="back" onclick="location.href='dashboard.html'">대시보드로</button>
    </div>
  </header>

  <section class="shelf-wrap">
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden style="padding:14px 16px; color:#991b1b; font-weight:700"></div>
  </section>

  <!-- 전역 토스트 -->
  <div id="topToast" role="status" aria-live="polite"></div>

  <!-- 만료 롱프레스 액션시트 -->
  <div id="overlay" class="layer" style="background:rgba(0,0,0,.35); display:none;">
    <div id="sheet" class="stage" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" style="place-items:center">
      <div style="background:#fff; border-radius:14px; padding:16px; width:320px; max-width:90%; box-shadow:0 18px 48px rgba(0,0,0,.35)">
        <h3 id="sheetTitle" style="margin:0 0 8px; font-size:16px; color:#0b1220">만료 고객 분류</h3>
        <p id="sheetDesc" style="margin:0 0 12px; color:#475569; font-size:13px">이 고객을 만료 고객으로 분류할까요?</p>
        <div style="display:flex; gap:8px">
          <button id="btnExpire" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ef4444; background:#ef4444; color:#fff; cursor:pointer">만료로 분류</button>
          <button id="btnCancel" style="flex:1; padding:10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 바인더 열림 오버레이 -->
  <div id="binderLayer" class="layer" aria-hidden="true">
    <div class="stage">
      <div id="ob" class="open-binder">
        <div class="ob-body"></div>
        <div class="ob-cover"></div>
        <div class="ob-pages">
          <div class="page" id="pageL">
            <h4>👤 고객정보</h4>
            <div class="kv" id="kvInfo"></div>
            <div class="chips" id="chipRow"></div>
          </div>
          <div class="page" id="pageR">
            <h4>📓 레슨/안내</h4>
            <div style="font-size:12px; line-height:1.6; color:#374151" id="guide"></div>
          </div>
          <div class="ob-actions">
            <button class="btn" id="btnJournal">📓 일지 열기</button>
            <button class="btn" id="btnExtend">📝 연장/수정</button>
            <button class="btn strong" id="btnConsume">–1 소진</button>
            <button class="btn" id="btnClose">닫기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 전역 에러 화면 표시 -->
  <script>
    window.addEventListener('error', (e)=>{
      const el = document.getElementById('empty');
      if(el){
        el.hidden = false;
        el.textContent = '오류: ' + (e.error?.message || e.message || '알 수 없는 오류');
      }
      console.error(e.error || e);
    });
    /* file://로 열었는지 표시 */
    if(location.protocol === 'file:'){
      const el = document.getElementById('empty');
      el.hidden = false;
      el.textContent = '파일로 열려 있어요. 반드시 http:// 로 실행해주세요 (ES 모듈/파이어베이스가 파일 모드에선 막힙니다).';
    }
  </script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, increment,
           query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  /* ===== 파이어베이스 ===== */
  const firebaseConfig = {
    apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain:"more-than-fitness-f6adb.firebaseapp.com",
    projectId:"more-than-fitness-f6adb",
    storageBucket:"more-than-fitness-f6adb.appspot.com",
    messagingSenderId:"993248877411",
    appId:"1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId:"G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ===== 목업 스위치 & 데이터 (연결 실패/빈 데이터 시 자동 표시) ===== */
  const DEV_FAKE_WHEN_EMPTY = true;
  const MOCK_MEMBERS = [
    { id:'m1', name:'황형민', trainer:'민트', grade:'A', level:'A',
      recentReg:'2025-02-01', first:'2024-10-12', expireAt:'2025-12-31',
      lastLog:'2025-02-15', logCount:12, remaining:16, total:20,
      birthday:'1990-03-10', anniversary:'', expiredFlag:false, gender:'male' },
    { id:'m2', name:'김영애', trainer:'소라', grade:'B', level:'B',
      recentReg:'2025-01-20', first:'2024-11-02', expireAt:'2025-05-20',
      lastLog:'2025-02-16', logCount:7, remaining:3, total:12,
      birthday:'1987-05-22', anniversary:'', expiredFlag:false, gender:'female' },
    { id:'m3', name:'이진수', trainer:'우디', grade:'C', level:'C',
      recentReg:'2024-12-28', first:'2024-07-01', expireAt:'2025-01-10',
      lastLog:'2024-12-30', logCount:4, remaining:0, total:10,
      birthday:'1976-02-28', anniversary:'', expiredFlag:true, gender:'male' },
  ];

  /* ===== DOM ===== */
  const shelf    = document.getElementById('shelf');
  const empty    = document.getElementById('empty');
  const qEl      = document.getElementById('q');
  const sortSel  = document.getElementById('sortBy');
  const orderBtn = document.getElementById('orderBtn');
  const expiredToggleBtn = document.getElementById('expiredToggle');

  // 만료 시트
  const overlay  = document.getElementById('overlay');
  const sheet    = document.getElementById('sheet');
  const btnExpire= document.getElementById('btnExpire');
  const btnCancel= document.getElementById('btnCancel');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetDesc  = document.getElementById('sheetDesc');

  // 열림 레이어
  const binderLayer = document.getElementById('binderLayer');
  const ob          = document.getElementById('ob');
  const kvInfo      = document.getElementById('kvInfo');
  const chipRow     = document.getElementById('chipRow');
  const guide       = document.getElementById('guide');
  const btnJournal  = document.getElementById('btnJournal');
  const btnExtend   = document.getElementById('btnExtend');
  const btnConsume  = document.getElementById('btnConsume');
  const btnClose    = document.getElementById('btnClose');

  const topToast = document.getElementById('topToast');

  /* ===== Utils ===== */
  const collator = new Intl.Collator('ko-KR',{numeric:true,sensitivity:'base'});
  const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const p2 = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
  const nowHM = () => { const d=new Date(); return `${p2(d.getHours())}:${p2(d.getMinutes())}`; };
  const toISO = ts => ts?.toDate ? ts.toDate().toISOString().slice(0,10) : (typeof ts==='string' ? ts : "");
  const toTime = (str)=> (str ? new Date(str).getTime() : NaN);
  const normGender = (g)=> (String(g||'').toLowerCase().startsWith('f') ? 'female' : (String(g||'').toLowerCase().startsWith('m') ? 'male' : null));

  function daysUntilAnnual(dateStr){
    if(!dateStr) return null;
    const [y,m,d] = String(dateStr).split('-').map(Number); if(!m||!d) return null;
    const now = new Date();
    const tgt = new Date(now.getFullYear(), m-1, d);
    if (tgt < new Date(now.getFullYear(), now.getMonth(), now.getDate())) tgt.setFullYear(now.getFullYear()+1);
    const diff = Math.ceil((tgt - now)/86400000);
    return diff<=30 ? diff : null;
  }

  function colorClass(m){
    if (isExpired(m)) return 'cExpired';
    if (normGender(m.gender) === 'female') return 'cFemale';
    return 'cMale';
  }

  const nextScheduleCache = new Map();
  async function fetchNextSchedule(memberId){
    if (nextScheduleCache.has(memberId)) return nextScheduleCache.get(memberId);
    try{
      const qy = query(collection(db,'schedules'), where('memberId','==', memberId));
      const snap = await getDocs(qy);
      const today = todayISO(), now = nowHM();
      const list = [];
      snap.forEach(ds=>{
        const s = ds.data();
        const d = String(s.date||''); const st = String(s.start||'00:00');
        if (d > today || (d===today && st >= now)) list.push({date:d,start:st});
      });
      list.sort((a,b)=> (a.date===b.date ? a.start.localeCompare(b.start) : a.date.localeCompare(b.date)));
      const val = list[0] ? `${list[0].date} ${list[0].start}` : '-';
      nextScheduleCache.set(memberId, val);
      return val;
    }catch(e){ console.error(e); nextScheduleCache.set(memberId,'-'); return '-'; }
  }

  function isExpired(m){
    const today = new Date(todayISO()).getTime();
    const expT  = toTime(m.expireAt);
    return Boolean(m.expiredFlag) || (Number.isFinite(expT) && expT < today);
  }

  function showTopToast(msg){
    topToast.textContent=msg;
    topToast.classList.add('show');
    setTimeout(()=> topToast.classList.remove('show'), 1600);
  }

  /* ===== 상태 ===== */
  let state = { orderAsc: true, showExpiredOnly: false, members: [] };
  let currentMemberForSheet = null;
  let longPressTimer = null;
  let longFired = false;
  let currentOpenMember = null;

  /* ===== 바인더 렌더 ===== */
  function render(list){
    shelf.innerHTML = '';
    if(!list.length){
      empty.hidden = false;
      empty.textContent = '검색 결과가 없어요.';
      return;
    }
    empty.hidden = true;

    list.forEach(m=>{
      const expired = isExpired(m);
      const cls = colorClass(m);
      const lowRemain = (m.remaining ?? 0) <= 3;
      const tabLabel = `${(m.name||'').slice(0,6)} 고객님`;

      const art = document.createElement('article');
      art.className = ['binder', cls].join(' ').trim();
      art.tabIndex = 0;
      art.setAttribute('role','button');
      art.setAttribute('aria-label', `${m.name} 고객 카드`);

      const dLeft = m.expireAt ? Math.ceil((new Date(m.expireAt) - new Date(todayISO()))/86400000) : null;
      let stickerHtml = m.grade ? `<span class="sticker">${escapeHtml(m.grade)}</span>` : '';
      if (m.lastLog) stickerHtml = `<span class="sticker recent">최근 ${m.lastLog}</span>`;
      if (expired || (dLeft !== null && dLeft <= 7)) stickerHtml = `<span class="sticker expire">만료 D-${Math.max(dLeft??0,0)}</span>`;

      art.innerHTML = `
        <span class="shine" aria-hidden="true"></span>
        <span class="under" aria-hidden="true"></span>
        <div class="edge-tab" role="button" aria-label="파일 열기 탭">${escapeHtml(tabLabel)}</div>

        <div class="head">
          <div class="name-wrap">
            <div class="name" style="visibility:hidden">${escapeHtml(m.name)} <span class="suffix">고객님</span></div>
            <div class="sub-sessions" style="visibility:hidden">(${m.total||0}/${m.remaining||0})</div>
          </div>
          <div class="stickers">${stickerHtml}
            ${(() => {
              const cakeDays = (daysUntilAnnual(m.birthday) ?? daysUntilAnnual(m.anniversary));
              return cakeDays!==null ? `<span class="sticker">🎂 D-${cakeDays}</span>` : '';
            })()}
          </div>
          <div class="hint-strip"> ${escapeHtml(m.name)} 고객님 (${m.total||0}/${m.remaining||0}) </div>
        </div>

        <div class="panel">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="ring ${lowRemain?'low':''}" style="--pct:${Math.max(0,Math.min(100, Math.round(((m.remaining||0)/(m.total||1))*100)))}">
              <div class="ring-label">${m.remaining||0}/${m.total||0}</div>
            </div>
            <div class="rows" style="flex:1">
              <div class="row"><span class="label">담당</span><span class="value">${escapeHtml(m.trainer||"-")}</span></div>
              <div class="row"><span class="label">등급</span><span class="value">${escapeHtml(m.level||m.grade||"-")}</span></div>
              <div class="row r-first"><span class="label">등록일</span><span class="value">${m.first||"-"}</span></div>
              <div class="row"><span class="label">만료일</span><span class="value">${m.expireAt||"-"}</span></div>
              <div class="row"><span class="label">작성</span><span class="value">${m.logCount||0}회</span></div>
              <div class="row"><span class="label">다음예약</span><span class="value" id="nx-${m.id}">조회 중…</span></div>
            </div>
          </div>

          <div class="stats" aria-label="세션 현황">
            <div class="pill remain ${lowRemain?'low':''}">잔여 <strong>${m.remaining||0}</strong></div>
            <div class="pill total">총 <strong>${m.total||0}</strong></div>
          </div>
        </div>

        <div class="actions" aria-label="빠른 작업">
          <button class="btn" aria-label="일지 열기" data-act="journal">📓 일지 열기</button>
          <button class="btn" aria-label="연장 등록" data-act="extend">📝 연장 등록</button>
          <button class="btn strong" aria-label="세션 소진" data-act="consume">–1 소진</button>
        </div>

        <div class="foot-date"><span class="dot"></span> 최근 등록: <strong>${m.recentReg || m.first || '-'}</strong></div>
      `;

      // 인덱스 탭: 클릭 → 열림
      art.querySelector('.edge-tab').addEventListener('click',(ev)=>{ ev.stopPropagation(); openOverlayFor(m); });

      // 한 번 탭하면 상단 검은 스트립(이름 고객님 (총/잔여)) 표시
      art.addEventListener('click', ()=>{
        if (longFired){ longFired=false; return; }
        const hint = art.querySelector('.hint-strip');
        hint.classList.add('show');
        setTimeout(()=> hint.classList.remove('show'), 1300);
      });

      // 빠른 액션
      art.querySelector('[data-act="journal"]').addEventListener('click', (e)=>{
        e.stopPropagation(); location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
      });
      art.querySelector('[data-act="extend"]').addEventListener('click', (e)=>{
        e.stopPropagation(); location.href = `edit-member.html?id=${encodeURIComponent(m.id)}`;
      });
      art.querySelector('[data-act="consume"]').addEventListener('click', async (e)=>{
        e.stopPropagation();
        if ((m.remaining||0) <= 0){ showTopToast('잔여 세션이 없습니다'); return; }
        try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); showTopToast('–1 소진 처리 완료'); }
        catch(err){ console.error(err); showTopToast('소진 처리 실패'); }
      });

      // 다음 예약은 호버/포커스 시 계산
      let fetched = false;
      const ensureNext = async ()=>{
        if (fetched) return; fetched = true;
        const nx = await fetchNextSchedule(m.id);
        const tgt = art.querySelector(`#nx-${m.id}`);
        if (tgt) tgt.textContent = nx;
      };
      art.addEventListener('mouseenter', ensureNext, {passive:true});
      art.addEventListener('focus', ensureNext, {passive:true});

      // 롱프레스 → 바인더 열림
      art.addEventListener('pointerdown', ()=>{
        longFired=false;
        longPressTimer = setTimeout(()=>{ longFired=true; openOverlayFor(m); }, 600);
      }, {passive:true});
      ['pointerup','pointerleave','pointercancel'].forEach(evName=>{
        art.addEventListener(evName, ()=>{
          clearTimeout(longPressTimer); longPressTimer=null;
        }, {passive:true});
      });

      shelf.appendChild(art);
    });
  }

  /* ===== 열림 오버레이 ===== */
  function syncOpenBinderColor(m){
    // body에 클래스-style로 색 변수 주입
    const probe = document.createElement('div');
    probe.className = 'binder ' + colorClass(m);
    probe.style.position='absolute'; probe.style.visibility='hidden';
    document.body.appendChild(probe);
    const cs = getComputedStyle(probe);
    const coverStart = cs.getPropertyValue('--cover-start')||'#cfe3ff';
    const coverEnd   = cs.getPropertyValue('--cover-end')||'#4c86ff';
    document.body.removeChild(probe);

    ob.style.setProperty('--cover-start', coverStart.trim());
    ob.style.setProperty('--cover-end', coverEnd.trim());
  }

  function openOverlayFor(m){
    currentOpenMember = m;
    syncOpenBinderColor(m);

    // 왼쪽 페이지 정보
    kvInfo.innerHTML = `
      <div>이름</div><div>${escapeHtml(m.name)} 고객님</div>
      <div>담당</div><div>${escapeHtml(m.trainer||'-')}</div>
      <div>등급</div><div>${escapeHtml(m.level||m.grade||'-')}</div>
      <div>최근등록</div><div>${m.recentReg || m.first || '-'}</div>
      <div>만료일</div><div>${m.expireAt||'-'}</div>
      <div>작성</div><div>${m.logCount||0}회</div>
    `;
    chipRow.innerHTML = `
      <div class="chip">잔여 <strong>${m.remaining||0}</strong></div>
      <div class="chip">총 <strong>${m.total||0}</strong></div>
      <div class="chip" id="nxChip">다음예약 조회중…</div>
    `;
    guide.innerHTML = `
      바인더가 화면 앞으로 나온 뒤 덮개가 열리면 내용이 서서히 나타납니다.<br/>
      아래 버튼으로 각 개인의 일지/연장/소진을 바로 실행할 수 있어요.
    `;

    btnJournal.onclick = ()=> location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
    btnExtend.onclick  = ()=> location.href = `edit-member.html?id=${encodeURIComponent(m.id)}`;
    btnConsume.onclick = async ()=>{
      if ((m.remaining||0) <= 0){ showTopToast('잔여 세션이 없습니다'); return; }
      try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); showTopToast('–1 소진 처리 완료'); }
      catch(err){ console.error(err); showTopToast('소진 처리 실패'); }
    };
    btnClose.onclick = closeOverlay;

    fetchNextSchedule(m.id).then(nx=>{
      const el=document.getElementById('nxChip'); if(el) el.textContent = `다음예약 ${nx}`;
    });

    binderLayer.classList.add('open');
    binderLayer.setAttribute('aria-hidden','false');

    // ① 오버레이 등장 → ② 덮개 펼침(unfold) → ③ 70~90% 시점에 내용(reveal)
    ob.classList.remove('unfold','reveal');
    requestAnimationFrame(()=> {
      setTimeout(()=> ob.classList.add('unfold'), 140);   // 덮개 오픈 시작
      setTimeout(()=> ob.classList.add('reveal'), 520);   // 내용 서서히(70~90%쯤)
    });
  }
  function closeOverlay(){
    currentOpenMember = null;
    binderLayer.classList.remove('open');
    binderLayer.setAttribute('aria-hidden','true');
  }
  // 배경 탭으로 닫기
  binderLayer.addEventListener('click', (e)=>{ if(e.target===binderLayer) closeOverlay(); });

  /* ===== 만료 시트 ===== */
  function openExpireSheet(member){
    currentMemberForSheet = member;
    const expired = isExpired(member);
    sheetTitle.textContent = expired ? '만료 표시 해제' : '만료 고객 분류';
    sheetDesc.textContent  = expired ? '이 고객의 만료 표시를 해제할까요?' : '이 고객을 만료 고객으로 분류할까요?';
    btnExpire.textContent  = expired ? '만료 표시 해제' : '만료로 분류';
    overlay.style.display = 'block';
  }
  function closeSheet(){
    overlay.style.display = 'none';
    currentMemberForSheet = null;
  }
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeSheet(); });
  btnCancel.addEventListener('click', closeSheet);
  btnExpire.addEventListener('click', async ()=>{
    if(!currentMemberForSheet) return;
    try{
      const willUnset = isExpired(currentMemberForSheet);
      await updateDoc(doc(db,'members', currentMemberForSheet.id), {
        expiredFlag: willUnset ? false : true,
        expiredFlagAt: willUnset ? null : serverTimestamp()
      });
    }catch(e){ console.error(e); showTopToast('처리 실패'); }
    closeSheet();
  });

  /* ===== 필터/정렬 ===== */
  function filterSort(){
    const kw = (qEl.value||'').trim().toLowerCase();
    const norm = s => String(s||'').toLowerCase();

    let list = state.members.filter(m=>{
      const match = !kw || norm(m.name).includes(kw) || norm(m.trainer).includes(kw) || norm(m.grade).includes(kw) || norm(m.level).includes(kw);
      const expired = isExpired(m);
      const pass = state.showExpiredOnly ? expired : true;
      return match && pass;
    });

    const by = sortSel.value;
    const dir = state.orderAsc ? 1 : -1;

    list.sort((a,b)=>{
      if(by==='name')   return dir * collator.compare(a.name, b.name);
      if(by==='recent'){
        const A = toTime(a.lastLog) || 0;
        const B = toTime(b.lastLog) || 0;
        return dir * (A - B);
      }
      if(by==='remain') return dir * ((a.remaining||0) - (b.remaining||0));
      if(by==='first'){
        const A = toTime(a.first) || 0;
        const B = toTime(b.first) || 0;
        return dir * (A - B);
      }
      if(by==='expire'){
        const A = toTime(a.expireAt) || Infinity;
        const B = toTime(b.expireAt) || Infinity;
        return dir * (A - B);
      }
      return 0;
    });

    render(list);
    const expiredCount = state.members.filter(m=>isExpired(m)).length;
    expiredToggleBtn.textContent = `${state.showExpiredOnly ? '전체 보기' : '만료 회원만 보기'} (${expiredCount})`;
  }

  orderBtn.addEventListener('click', ()=>{
    state.orderAsc = !state.orderAsc;
    orderBtn.textContent = state.orderAsc ? '오름차순 ↑' : '내림차순 ↓';
    orderBtn.setAttribute('aria-pressed', String(!state.orderAsc));
    filterSort();
  });
  qEl.addEventListener('input', filterSort);
  sortSel.addEventListener('change', filterSort);
  expiredToggleBtn.addEventListener('click', ()=>{
    state.showExpiredOnly = !state.showExpiredOnly;
    expiredToggleBtn.setAttribute('aria-pressed', String(state.showExpiredOnly));
    filterSort();
  });

  /* ===== 구독 ===== */
  const auth = getAuth(app);
  onAuthStateChanged(auth, async (u)=>{
    if (!u){
      try{ await signInAnonymously(auth); }
      catch(e){ console.error(e); empty.hidden=false; empty.textContent='로그인 실패로 데이터를 볼 수 없어요.'; }
      return;
    }
    startMembers();
  });

  function startMembers(){
    try{
      onSnapshot(
        collection(db,'members'),
        (snap)=>{
          const list=[];
          snap.forEach(ds=>{
            const d=ds.data();
            const recentReg =
              toISO(d.recentRegistrationAt) ||
              toISO(d.lastRegisterAt) ||
              toISO(d.lastReenrollAt) ||
              toISO(d.lastPurchaseAt) ||
              "";
            list.push({
              id: ds.id,
              name: d.name || "",
              trainer: d.trainer || "",
              grade: d.level || d.grade || "",
              level: d.level || "",
              first: d.startDate || toISO(d.createdAt) || "",
              recentReg,
              expireAt: toISO(d.expireAt),
              lastLog:  toISO(d.lastLogAt) || toISO(d.lastPurchaseAt),
              logCount: d.logCount || 0,
              remaining: d.remainingSessions ?? 0,
              total: d.totalSessionsPurchased ?? d.totalSessions ?? 0,
              birthday: toISO(d.birthday),
              anniversary: toISO(d.anniversary),
              expiredFlag: Boolean(d.expiredFlag),
              gender: d.gender || null
            });
          });
          state.members=list;

          // 데이터가 없으면 목업
          if (DEV_FAKE_WHEN_EMPTY && (!state.members.length)) {
            console.warn('Firestore 비어있어서 목업 데이터로 표시합니다.');
            state.members = MOCK_MEMBERS.map(x=> ({ ...x, gender: normGender(x.gender) }));
          }

          // 열려 있던 오버레이는 최신 데이터로 갱신
          if (currentOpenMember){
            const m = state.members.find(x=>x.id===currentOpenMember.id);
            if (m){ openOverlayFor(m); }
          }

          filterSort();
        },
        (err)=>{ 
          console.error(err);
          if (DEV_FAKE_WHEN_EMPTY){
            state.members = MOCK_MEMBERS.map(x=> ({ ...x, gender: normGender(x.gender) }));
            filterSort();
            empty.hidden=false; empty.textContent='실시간 구독 오류(목업 표시 중): '+(err.message||'');
          }else{
            empty.hidden=false; empty.textContent='데이터를 불러오지 못했어요. (권한/네트워크 확인)';
          }
        }
      );
    }catch(e){
      console.error(e);
      if (DEV_FAKE_WHEN_EMPTY){
        state.members = MOCK_MEMBERS.map(x=> ({ ...x, gender: normGender(x.gender) }));
        filterSort();
        empty.hidden=false; empty.textContent='초기화 오류(목업 표시 중): '+(e.message||'');
      }else{
        empty.hidden=false; empty.textContent='초기화 오류: '+(e.message||'');
      }
    }
  }
  </script>
</body>
</html>
