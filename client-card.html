<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ê³ ê° ì¹´ë“œ â€“ ë°”ì¸ë” ì„ ë°˜</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --ink:#0b1220; --muted:#6b7280;
    --line:#e5e7eb; --danger:#ef4444; --danger-bg:#fee2e2;
    --ok:#2563eb; --track:#e5e7eb;
    --shelf:#f3f4f6; --shelf-edge:#e5e7eb;

    /* ë°”ì¸ë” í¬ê¸°/ê²¹ì¹¨ (A4 ë¹„ìœ¨ ì ìš©) */
    --binder-w: 360px;       /* ë°ìŠ¤í¬í†± ê¸°ë³¸ í­ */
    --binder-overlap: -180px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(#fff,#fbfbfb); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  /* ===== Header / Tools ===== */
  header{ position:sticky; top:0; z-index:20; background:linear-gradient(#fff,#f9fafb);
    border-bottom:2px solid var(--gold); padding:14px 16px 12px; }
  header h1{margin:0 0 10px; font-size:18px; color:var(--navy);}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{ flex:1; min-width:220px; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; font-size:14px; background:#fff; }
  .tools .group{display:flex;gap:8px; align-items:center; font-size:13px; color:#0B1E3A}
  .tools select, .tools button{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px; cursor:pointer; }
  .tools button.tgl{min-width:92px}
  .back{ margin-left:auto; background:#0B1E3A; color:#fff; font-weight:700; }

  /* ===== Shelf / Shadows ===== */
  .shelf-wrap{position:relative; padding:18px 0 28px}
  .shelf-wrap::before{ content:""; position:absolute; left:0; right:0; top:6px; height:18px; pointer-events:none;
    background:radial-gradient(80% 14px at 50% 0, rgba(0,0,0,.18), rgba(0,0,0,0) 70%); filter: blur(2px); }
  .shelf-wrap::after{ content:""; position:absolute; left:0; right:0; bottom:2px; height:24px; pointer-events:none;
    background:radial-gradient(70% 18px at 50% 100%, rgba(0,0,0,.22), rgba(0,0,0,0) 70%); filter: blur(2px); }
  .shelf{
    position:relative; display:flex; gap:0; padding:26px 22px;
    overflow-x:auto; overflow-y:visible; scrollbar-width:thin;
    perspective:1200px;
    border-top:1px solid var(--shelf-edge); border-bottom:1px solid var(--shelf-edge);
    background:var(--shelf);
    scroll-snap-type:x proximity;
  }
  .shelf::before, .shelf::after{
    content:""; position:sticky; left:0; width:40px; flex:0 0 40px; height:100%; pointer-events:none;
    background:linear-gradient(90deg,#f9fafb,rgba(249,250,251,0));
  }
  .shelf::after{ left:auto; right:0; background:linear-gradient(270deg,#f9fafb,rgba(249,250,251,0)); }

  /* ===== Binder ===== */
  @keyframes breathe { 0%,100%{filter:saturate(1) brightness(1)} 50%{filter:saturate(1.08) brightness(1.05)} }
  @keyframes glowPulse { 0%,100%{ box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22); }
                        50%    { box-shadow:-12px 0 0 rgba(255,255,255,.24) inset, 0 28px 60px rgba(0,0,0,.28); } }
  .binder{
    position:relative;
    width:var(--binder-w);
    aspect-ratio: 210 / 297;            /* A4 ë¹„ìœ¨ ìœ ì§€: ê°€ë¡œ/ì„¸ë¡œ */
    margin-left:var(--binder-overlap);
    border-radius:16px; cursor:pointer; user-select:none; outline:0;
    transform:translateZ(0) rotateY(-12deg) translateY(6px);
    transform-origin:left center; will-change:transform, filter;
    box-shadow:-8px 0 0 rgba(0,0,0,.06) inset, 0 8px 20px rgba(0,0,0,.08);
    transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s, filter .28s, z-index .28s;
    background:linear-gradient(160deg, #9ec5ff 0%, #6aa0ff 55%, #3a6ddf 100%);
    border:1px solid rgba(0,0,0,.06); color:#0b1220; scroll-snap-align:start;
  }
  /* ìƒ‰ìƒ ë¶„ë¥˜ */
  .cMale   { --tab-bg-start:#a7c8ff; --tab-bg-end:#6aa0ff; background:linear-gradient(160deg,#dbe9ff,#a7c8ff,#6aa0ff); }
  .cFemale { --tab-bg-start:#ffc1d9; --tab-bg-end:#ff88b2; background:linear-gradient(160deg,#ffe6f0,#ffc1d9,#ff88b2); }
  .cExpired{ --tab-bg-start:#b9c0c7; --tab-bg-end:#9aa3ab; background:linear-gradient(160deg,#e6e9ec,#cfd4d9,#9aa3ab); filter:saturate(.9) contrast(.96); }

  .binder:first-child{ margin-left:8px; }
  .binder:hover, .binder:focus-visible{
    z-index:9; transform:translateY(-14px) rotateY(-2deg) scale(1.04);
    box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22);
    animation:breathe 2.6s ease-in-out infinite;
  }
  .binder::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:24px; border-radius:16px 0 0 16px;
    background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(0,0,0,.1)); box-shadow:2px 0 6px rgba(0,0,0,.12) inset; }
  .binder::after{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px;
    background:
      radial-gradient(28px 28px at calc(100% - 10px) 10px, rgba(255,255,255,.6), rgba(255,255,255,0) 70%) top right / 40% 40% no-repeat,
      radial-gradient(22px 22px at 12px calc(100% - 12px), rgba(255,255,255,.35), rgba(255,255,255,0) 70%) bottom left / 35% 35% no-repeat;
    opacity:.0; transition:opacity .25s ease;
  }
  .binder:hover::after, .binder:focus-visible::after{ opacity:1; }
  .shine{ position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.28) 30%, rgba(255,255,255,0) 60%);
    transform: translateX(-130%); transition: transform .9s ease; mix-blend-mode: screen; }
  .binder:hover .shine, .binder:focus-visible .shine{ transform: translateX(130%); }
  .under{ position:absolute; left:18%; right:12px; bottom:-10px; height:20px; pointer-events:none;
    background:radial-gradient(60% 100% at 50% 0, rgba(0,0,0,.28), rgba(0,0,0,0)); filter: blur(3px); opacity:.65; transition:opacity .25s, transform .25s; }
  .binder:hover .under, .binder:focus-visible .under{ opacity:.9; transform: translateY(2px) scale(1.06); }
  .binder.pulse{ animation:glowPulse 1.1s ease-in-out 1; }

  /* ì™¼ìª½ ì¸ë±ìŠ¤ íƒ­(ê³ ê°ë‹˜ í¬í•¨) */
  .edge-tab{
    position:absolute; left:-16px; top:46px; width:22px; height:98px;
    background:linear-gradient(180deg,var(--tab-bg-start), var(--tab-bg-end));
    border:2px solid var(--tab-bg-end); border-right:none;
    border-radius:10px 0 0 10px; writing-mode:vertical-rl; text-orientation:mixed;
    font-weight:900; font-size:11px; color:#ffffff; display:flex; align-items:center; justify-content:center;
    box-shadow:0 3px 8px rgba(0,0,0,.12); transform:rotate(-2deg); transition:transform .2s, filter .2s; user-select:none;
  }
  .binder:hover .edge-tab{ transform:rotate(0deg) translateX(-2px); filter:brightness(1.05); }
  .edge-tab:active{ transform:translateX(-3px); }

  /* ë°”ì¸ë” ì „ë©´ ìƒë‹¨ ìŠ¤íŠ¸ë¦½(ë‹¨ì¼ í„°ì¹˜ë¡œ í† ê¸€) */
  .title-strip{
    position:absolute; left:32px; right:12px; top:12px;
    background:rgba(255,255,255,.9); border:1px solid #e5e7eb; border-radius:12px;
    padding:8px 10px; font-weight:900; font-size:14px; color:#0b1220;
    display:none; align-items:center; justify-content:space-between; gap:8px;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
  }
  .title-strip .small{font-size:12px; color:#374151; font-weight:800}

  /* íŒ¨ë„/í–‰(hover ì „ìš©, ëª¨ë°”ì¼ì€ ì‚¬ì‹¤ìƒ ë³´ì¡° ìš”ì†Œ) */
  .panel{ position:absolute; right:10px; top:64px; bottom:54px; left:36px;
    background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; overflow:hidden;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    transform:translateZ(30px) translateX(8px) rotateY(6deg); opacity:.0;
    transition:opacity .25s, transform .28s; backdrop-filter: blur(6px); }
  .binder:hover .panel, .binder:focus-visible .panel{ opacity:1; transform:translateZ(60px) translateX(0) rotateY(0); }
  .rows{font-size:13px; color:#374151; display:grid; gap:6px; margin-top:10px}
  .row{display:flex; gap:6px}
  .row .label{width:66px; color:#334155; font-weight:700}
  .row .value{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .row.r-first{ display:none; } /* ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ëª¨ë‘ ìƒë‹¨ ë“±ë¡ì¼ ìˆ¨ê¹€ */

  /* ë§/í†µê³„/ì•¡ì…˜ */
  .ring{ --pct:0; width:74px; height:74px; border-radius:50%;
    background:conic-gradient(var(--ok) calc(var(--pct)*1%), var(--track) 0);
    display:grid; place-items:center; margin:2px 8px 6px auto; border:6px solid rgba(255,255,255,.6);
    box-shadow:0 2px 10px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.08); }
  .ring.low{ --ok:#ef4444; }
  .ring .ring-label{background:#fff; border-radius:999px; padding:6px 8px; font-size:12px; font-weight:900; border:1px solid #e5e7eb}
  .stats{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .pill{border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff}
  .pill strong{font-weight:900}
  .pill.remain{border-color:#60a5fa; background:#eff6ff}
  .pill.remain.low{border-color:#ef4444; background:#fee2e2; color:#991b1b}
  .pill.total{border-color:#d1d5db; background:#f9fafb}

  /* ë°”ë‹¥: ìµœê·¼ ë“±ë¡ì¼(í•˜ë‹¨ ê³ ì •) */
  .foot-date{
    position:absolute; left:36px; right:10px; bottom:12px;
    font-size:11px; font-weight:800; color:#334155;
    background:rgba(255,255,255,.88); padding:6px 10px; border-radius:10px; border:1px solid #e5e7eb;
    display:flex; align-items:center; gap:6px;
  }
  .foot-date .dot{ width:6px; height:6px; border-radius:50%; background:#22c55e; }

  .actions{ position:absolute; left:36px; right:10px; bottom:54px; display:flex; gap:10px; opacity:0; transform:translateY(6px);
    transition:opacity .2s, transform .2s; }
  .binder:hover .actions, .binder:focus-visible .actions{ opacity:1; transform:translateY(0); }
  .btn{ flex:1; padding:10px 12px; border-radius:999px; background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08);
    backdrop-filter: blur(6px); color:#0B1E3A; font-weight:800; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 8px 18px rgba(11,30,58,.18); cursor:pointer; }
  .btn.strong{ background:#0B1E3A; color:#fff; }
  .btn:active{ transform:translateY(1px); }

  /* ===== íŒŒì¼ ì˜¤ë²„ë ˆì´(ì¤‘ì•™ 3D) ===== */
  .file-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.48); display:none; z-index:1100; }
  .file-overlay.open{ display:block; }

  .file-stage{
    position:absolute; inset:0; display:grid; place-items:center; padding:18px;
  }
  /* ë°”ì¸ë” ë¹„ì£¼ì–¼: ì•ìœ¼ë¡œ íŠ€ì–´ë‚˜ì˜´ + ë®ê°œ ì—´ë¦¼ */
  .file-visual{
    position:relative; width:min(92vw, 740px); aspect-ratio:210/297; max-height:88vh;
    perspective:1600px; opacity:0; transform:translateY(6%) scale(.94) rotateY(-8deg);
    transition:opacity .35s, transform .5s cubic-bezier(.2,.7,.2,1);
  }
  .file-overlay.open .file-visual{ opacity:1; transform:translateY(0) scale(1) rotateY(0); }

  .fv-folder{
    position:absolute; inset:0; border-radius:14px; background:linear-gradient(160deg,#dbe9ff,#a7c8ff,#6aa0ff);
    box-shadow:0 14px 36px rgba(0,0,0,.26); transform-style:preserve-3d; overflow:hidden;
  }
  .fv-tab{
    position:absolute; left:-20px; top:20px; width:28px; height:108px;
    background:linear-gradient(180deg,var(--tab-bg-start), var(--tab-bg-end));
    border:2px solid var(--tab-bg-end); border-right:none; border-radius:10px 0 0 10px;
    writing-mode:vertical-rl; text-orientation:mixed; color:#fff; font-weight:900; font-size:12px;
    display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,.16);
  }
  .fv-cover{
    position:absolute; inset:0; border-radius:14px; background:linear-gradient(135deg,#f4f1de,#e9c46a);
    border-left:2px solid #d4a574; transform-origin:left center; transform:translateX(0) rotateY(0);
    transition:transform .8s cubic-bezier(.175,.885,.32,1.275);
    box-shadow:-2px 0 12px rgba(0,0,0,.16);
  }
  .fv-paper{ position:absolute; inset:10px; pointer-events:none; }
  .fv-sheet{ position:absolute; inset:0; background:#fff; border:1px solid #e5e7eb; border-radius:8px;
             box-shadow:0 1px 3px rgba(0,0,0,.08); transform-origin:left center; transition:transform .6s ease; }
  .fv-sheet:nth-child(1){ transform:translateX(2px); }
  .fv-sheet:nth-child(2){ transform:translateX(4px); }
  .fv-sheet:nth-child(3){ transform:translateX(6px); }
  .fv-sheet:nth-child(4){ transform:translateX(8px); }
  /* ë®ê°œ/ì¢…ì´ í¼ì¹¨ */
  .file-visual.open .fv-cover{ transform:translateX(-78%) rotateY(-16deg); }
  .file-visual.open .fv-sheet:nth-child(1){ transform:translateX(-2px) rotateY(3deg); }
  .file-visual.open .fv-sheet:nth-child(2){ transform:translateX(-1px) rotateY(2deg); }
  .file-visual.open .fv-sheet:nth-child(3){ transform:translateX(0) rotateY(1deg); }
  .file-visual.open .fv-sheet:nth-child(4){ transform:translateX(1px) rotateY(0deg); }

  /* ìŠ¤í”„ë ˆë“œ(2ìª½) */
  .spread{
    position:absolute; inset:16px 14px; display:grid; grid-template-columns:1fr 1fr; gap:12px;
    opacity:0; transform:translateY(6px); transition:opacity .3s .15s, transform .35s .15s;
  }
  .file-visual.open .spread{ opacity:1; transform:translateY(0); }
  .page{
    background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:14px 12px; overflow:auto;
    box-shadow:0 8px 20px rgba(0,0,0,.08);
    transform-origin: center left; backface-visibility:hidden;
  }
  .page.hinge-right{ transform-origin:center right; }
  /* í˜ì´ì§€ ë„˜ê¹€ ëª¨ì…˜ */
  .turn-right .left{ transform:rotateY(-170deg); transition:transform .6s ease; }
  .turn-left  .right{ transform:rotateY(170deg);  transition:transform .6s ease; }

  .spread-head{
    position:absolute; left:20px; right:20px; top:-12px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .ghost-btn{
    background:rgba(255,255,255,.9); border:1px solid #e5e7eb; border-radius:999px; padding:8px 10px; font-weight:800; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
  }

  /* ëª¨ë°”ì¼ íŠœë‹ */
  @media (max-width: 860px){
    :root{ --binder-w: 320px; --binder-overlap: -140px; }
    .btn{font-size:12px}
  }
  @media (max-width: 540px){
    :root{ --binder-w: min(88vw, 360px); --binder-overlap: -90px; } /* ëª¨ë°”ì¼: ë„“ê²Œ ë³´ì´ë„ë¡ í™•ëŒ€ */
    .edge-tab{ height:90px; font-size:10px; left:-14px; }
    .spread{ inset:14px 10px; gap:8px; }
    .page{ padding:12px 10px; }
  }

  /* ë‹¤í¬ ëª¨ë“œ */
  @media (prefers-color-scheme: dark){
    body{ background:linear-gradient(#0b1220,#101826); color:#e5e7eb; }
    header{ background:linear-gradient(#0f172a,#0b1220); border-bottom-color:#475569; }
    .tools input[type="search"], .tools select, .tools button{ background:#0f172a; color:#e5e7eb; border-color:#374151; }
    .shelf{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
            border-top-color:#374151; border-bottom-color:#374151; }
    .binder{ color:#eef2ff; border-color:rgba(255,255,255,.06);
             box-shadow:-8px 0 0 rgba(0,0,0,.45) inset, 0 12px 28px rgba(0,0,0,.65); }
    .panel{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.1); }
    .btn{ background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.18); color:#e5e7eb; }
    .btn.strong{ background:#0B1E3A; }
    .page{ background:#0f172a; border-color:#273044; }
    .fv-cover{ background:linear-gradient(135deg,#152036,#2a3a5a); border-left-color:#273044; }
  }
</style>
</head>
<body>
  <header>
    <h1>ê°œì¸ íŠ¸ë ˆì´ë‹ â€“ ë°”ì¸ë” ì„œë¥˜ì² </h1>
    <div class="tools">
      <input id="q" type="search" placeholder="ì´ë¦„ / ë‹´ë‹¹ / ë“±ê¸‰ ê²€ìƒ‰" />
      <div class="group">
        ì •ë ¬:
        <select id="sortBy" aria-label="ì •ë ¬">
          <option value="name" selected>ì´ë¦„(ê°€ë‚˜ë‹¤Â·ì˜ë¬¸Â·ìˆ«ì)</option>
          <option value="recent">ìµœê·¼ ì‘ì„±</option>
          <option value="remain">ì”ì—¬ ì„¸ì…˜</option>
          <option value="first">ìµœì´ˆ ë“±ë¡ì¼</option>
          <option value="expire">ë§Œë£Œì¼</option>
        </select>
        <button id="orderBtn" class="tgl" aria-pressed="false">ì˜¤ë¦„ì°¨ìˆœ â†‘</button>
      </div>
      <div class="group">
        ì†Œê·¸ë£¹:
        <select id="groupSel" aria-label="ì†Œê·¸ë£¹">
          <option value="">ì „ì²´</option>
        </select>
      </div>
      <button id="expiredToggle" class="expired-toggle" aria-pressed="false">ë§Œë£Œ íšŒì›ë§Œ ë³´ê¸° (0)</button>
      <button id="btnDash" class="back" onclick="location.href='dashboard.html'">ëŒ€ì‹œë³´ë“œë¡œ</button>
    </div>
  </header>

  <section class="shelf-wrap">
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”.</div>
  </section>

  <!-- ë¡±í”„ë ˆìŠ¤: ë§Œë£Œ ë¶„ë¥˜ ì‹œíŠ¸ -->
  <div id="overlay" class="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:1200"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" style="display:none">
    <h3 id="sheetTitle">ë§Œë£Œ ê³ ê° ë¶„ë¥˜</h3>
    <p id="sheetDesc">ì´ ê³ ê°ì„ ë§Œë£Œ ê³ ê°ìœ¼ë¡œ ë¶„ë¥˜í• ê¹Œìš”?</p>
    <div class="rowbtns" style="display:flex;gap:8px">
      <button id="btnExpire" class="danger" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#ef4444;color:#fff">ë§Œë£Œë¡œ ë¶„ë¥˜</button>
      <button id="btnCancel" class="cancel" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff">ì·¨ì†Œ</button>
    </div>
  </div>

  <!-- íŒŒì¼ ì˜¤ë²„ë ˆì´(ì¤‘ì•™ì—ì„œ ì—´ë¦¼) -->
  <div id="fileOverlay" class="file-overlay" aria-hidden="true">
    <div class="file-stage">
      <div id="fileVisual" class="file-visual">
        <div class="fv-folder" id="fvFolder">
          <div class="fv-tab" id="fvTab">ê³ ê°ë‹˜</div>
          <div class="fv-paper">
            <div class="fv-sheet"></div>
            <div class="fv-sheet"></div>
            <div class="fv-sheet"></div>
            <div class="fv-sheet"></div>
          </div>

          <!-- ìŠ¤í”„ë ˆë“œ(ì¢Œ/ìš° 2í˜ì´ì§€) -->
          <div id="spread" class="spread">
            <div class="spread-head">
              <button id="prevPg" class="ghost-btn">â—€ï¸</button>
              <div style="display:flex;gap:8px;align-items:center">
                <div id="overlayRing" class="ring"><div class="ring-label" id="ringLbl">0/0</div></div>
                <button id="goJournal" class="ghost-btn">ğŸ““ ì¼ì§€</button>
                <button id="goEdit" class="ghost-btn">ğŸ“ ì—°ì¥</button>
                <button id="doConsume" class="ghost-btn">â€“1 ì†Œì§„</button>
                <button id="fileClose" class="ghost-btn">ë‹«ê¸° âœ•</button>
              </div>
              <button id="nextPg" class="ghost-btn">â–¶ï¸</button>
            </div>

            <section class="page left" id="pageL">
              <h3 style="margin:0 0 8px;font-size:16px;font-weight:900" id="pgTitleL">ê³ ê°ì •ë³´</h3>
              <div style="font-size:13px;display:grid;grid-template-columns:92px 1fr;gap:6px" id="infoGrid">
                <!-- ë™ì  ì±„ì›€ -->
              </div>
              <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap" id="chipsL"></div>
            </section>

            <section class="page right hinge-right" id="pageR">
              <h3 style="margin:0 0 8px;font-size:16px;font-weight:900">ë ˆìŠ¨/ë©”ëª¨</h3>
              <div style="font-size:13px;line-height:1.6" id="memoBox">
                ê³ ê°ë³„ ë ˆìŠ¨ ê¸°ë¡/ë©”ëª¨ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
              </div>
              <div style="margin-top:10px;font-size:12px;color:#64748b" id="nextLine">ë‹¤ìŒì˜ˆì•½: ì¡°íšŒì¤‘â€¦</div>
            </section>
          </div>

          <div class="fv-cover"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, increment,
           query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  /* Firebase */
  const firebaseConfig = {
    apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain:"more-than-fitness-f6adb.firebaseapp.com",
    projectId:"more-than-fitness-f6adb",
    storageBucket:"more-than-fitness-f6adb.appspot.com",
    messagingSenderId:"993248877411",
    appId:"1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId:"G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  /* DOM ì°¸ì¡° */
  const shelf    = document.getElementById('shelf');
  const empty    = document.getElementById('empty');
  const qEl      = document.getElementById('q');
  const sortSel  = document.getElementById('sortBy');
  const orderBtn = document.getElementById('orderBtn');
  const expiredToggleBtn = document.getElementById('expiredToggle');
  const groupSel = document.getElementById('groupSel');

  const overlay  = document.getElementById('overlay');
  const sheet    = document.getElementById('sheet');
  const btnExpire= document.getElementById('btnExpire');
  const btnCancel= document.getElementById('btnCancel');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetDesc  = document.getElementById('sheetDesc');

  // íŒŒì¼ ì˜¤ë²„ë ˆì´(ì¤‘ì•™)
  const fileOverlay = document.getElementById('fileOverlay');
  const fileVisual  = document.getElementById('fileVisual');
  const fvTab       = document.getElementById('fvTab');
  const pageL       = document.getElementById('pageL');
  const pageR       = document.getElementById('pageR');
  const infoGrid    = document.getElementById('infoGrid');
  const chipsL      = document.getElementById('chipsL');
  const memoBox     = document.getElementById('memoBox');
  const nextLine    = document.getElementById('nextLine');
  const prevPg      = document.getElementById('prevPg');
  const nextPg      = document.getElementById('nextPg');
  const goJournal   = document.getElementById('goJournal');
  const goEdit      = document.getElementById('goEdit');
  const doConsume   = document.getElementById('doConsume');
  const fileClose   = document.getElementById('fileClose');
  const overlayRing = document.getElementById('overlayRing');
  const ringLbl     = document.getElementById('ringLbl');

  /* ìœ í‹¸ */
  const collator = new Intl.Collator('ko-KR',{numeric:true,sensitivity:'base'});
  const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const p2 = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
  const nowHM = () => { const d=new Date(); return `${p2(d.getHours())}:${p2(d.getMinutes())}`; };
  const toISO = ts => ts?.toDate ? ts.toDate().toISOString().slice(0,10) : (typeof ts==='string' ? ts : "");
  const toTime = (str)=> (str ? new Date(str).getTime() : NaN);

  function colorClass(m){
    if (isExpired(m)) return 'cExpired';
    if ((m.gender||'').toLowerCase()==='female') return 'cFemale';
    if ((m.gender||'').toLowerCase()==='male')   return 'cMale';
    return 'cMale'; // ê¸°ë³¸ íŒŒìŠ¤í…” ë¸”ë£¨
  }
  function calcPct(rem, total){
    const t = total || 0, r = rem || 0;
    return t>0 ? Math.max(0, Math.min(100, Math.round((r/t)*100))) : 0;
  }

  function isExpired(m){
    const today = new Date(todayISO()).getTime();
    const expT  = toTime(m.expireAt);
    return Boolean(m.expiredFlag) || (Number.isFinite(expT) && expT < today);
  }

  /* ë‹¤ìŒ ì˜ˆì•½ ìºì‹œ */
  const nextScheduleCache = new Map();
  async function fetchNextSchedule(memberId){
    if (nextScheduleCache.has(memberId)) return nextScheduleCache.get(memberId);
    try{
      const qy = query(collection(db,'schedules'), where('memberId','==', memberId));
      const snap = await getDocs(qy);
      const today = todayISO(), now = nowHM();
      const list = [];
      snap.forEach(ds=>{
        const s = ds.data();
        const d = String(s.date||''); const st = String(s.start||'00:00');
        if (d > today || (d===today && st >= now)) list.push({date:d,start:st});
      });
      list.sort((a,b)=> (a.date===b.date ? a.start.localeCompare(b.start) : a.date.localeCompare(b.date)));
      const val = list[0] ? `${list[0].date} ${list[0].start}` : '-';
      nextScheduleCache.set(memberId, val);
      return val;
    }catch(e){ console.error(e); nextScheduleCache.set(memberId,'-'); return '-'; }
  }

  /* ìƒíƒœ */
  let state = { orderAsc: true, showExpiredOnly: false, members: [], groupFilter:"" };
  let currentMemberForSheet = null;
  let longPressTimer = null;
  let longFired = false;
  let openOverlayId = null;
  let turning = 0; // 0 ê¸°ë³¸, 1 ì˜¤ë¥¸ìª½ ë„˜ê¹€, -1 ì™¼ìª½ ë„˜ê¹€

  /* ê·¸ë£¹ ë“œë¡­ë‹¤ìš´ ì±„ì›€ */
  function fillGroupOptions(members){
    const set = new Set();
    members.forEach(m=>{ if(m.group) set.add(String(m.group)); });
    const cur = groupSel.value;
    groupSel.innerHTML = `<option value="">ì „ì²´</option>` + [...set].sort().map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
    if ([...set].includes(cur)) groupSel.value = cur;
  }

  /* ì˜¤ë²„ë ˆì´ ì—´ê¸° */
  function openOverlay(m){
    openOverlayId = m.id;
    // íƒ­ ìƒ‰ ë™ê¸°í™”
    const cls = colorClass(m);
    // ì„ì‹œ ì—˜ë¦¬ë¨¼íŠ¸ë¡œ CSS ë³€ìˆ˜ ì½ì–´ì˜¤ê¸°
    const probe = document.createElement('div');
    probe.className = 'binder '+cls; probe.style.position='absolute'; probe.style.visibility='hidden';
    document.body.appendChild(probe);
    const cs = getComputedStyle(probe);
    const start = cs.getPropertyValue('--tab-bg-start') || '#a7c8ff';
    const end   = cs.getPropertyValue('--tab-bg-end')   || '#6aa0ff';
    document.body.removeChild(probe);
    fileVisual.style.setProperty('--tab-bg-start', start.trim());
    fileVisual.style.setProperty('--tab-bg-end', end.trim());

    // íƒ­ ë¼ë²¨(ê³ ê°ë‹˜ í¬í•¨)
    fvTab.textContent = `${m.name}ê³ ê°ë‹˜`;

    // ë§/ë²„íŠ¼ ìƒíƒœ
    const pct = calcPct(m.remaining, m.total);
    overlayRing.classList.toggle('low', (m.remaining||0)<=3);
    overlayRing.style.setProperty('--pct', pct);
    ringLbl.textContent = `${m.remaining||0}/${m.total||0}`;

    goJournal.onclick = ()=> location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
    goEdit.onclick    = ()=> location.href = `edit-member.html?id=${encodeURIComponent(m.id)}`;
    doConsume.onclick = async ()=>{
      if ((m.remaining||0) <= 0){ alert('ì”ì—¬ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
      try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); }
      catch(err){ console.error(err); alert('ì†Œì§„ ì²˜ë¦¬ ì‹¤íŒ¨'); }
    };

    // ì¢Œì¸¡ í˜ì´ì§€ ë‚´ìš©
    infoGrid.innerHTML = `
      <div>ì´ë¦„</div><div>${escapeHtml(m.name)} ê³ ê°ë‹˜</div>
      <div>ë‹´ë‹¹</div><div>${escapeHtml(m.trainer||'-')}</div>
      <div>ë“±ê¸‰</div><div>${escapeHtml(m.level||m.grade||'-')}</div>
      <div>ìµœê·¼ë“±ë¡</div><div>${m.recentReg || m.first || '-'}</div>
      <div>ë§Œë£Œì¼</div><div>${m.expireAt||'-'}</div>
      <div>ì‘ì„±</div><div>${m.logCount||0}íšŒ</div>
    `;
    chipsL.innerHTML = `
      <div class="pill">ì”ì—¬ <strong>${m.remaining||0}</strong></div>
      <div class="pill">ì´ <strong>${m.total||0}</strong></div>
      ${m.group ? `<div class="pill">ê·¸ë£¹ <strong>${escapeHtml(m.group)}</strong></div>` : ``}
    `;
    memoBox.textContent = (m.memo && String(m.memo).trim()) ? m.memo : 'ë ˆìŠ¨ ê¸°ë¡/ë©”ëª¨ê°€ ì•„ì§ ì—†ì–´ìš”. ì¼ì§€ì—ì„œ ì‘ì„±í•´ ì£¼ì„¸ìš”.';

    nextLine.textContent = 'ë‹¤ìŒì˜ˆì•½: ì¡°íšŒì¤‘â€¦';
    fetchNextSchedule(m.id).then(nx=> nextLine.textContent = `ë‹¤ìŒì˜ˆì•½: ${nx}`);

    // ì˜¤ë²„ë ˆì´ í‘œì‹œ + ë®ê°œ ì—´ê¸°
    fileOverlay.classList.add('open');
    fileOverlay.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
    fileVisual.classList.remove('open');
    turning = 0; spread.classList.remove('turn-left','turn-right');

    requestAnimationFrame(()=> setTimeout(()=> fileVisual.classList.add('open'), 140));
  }
  function closeOverlay(){
    openOverlayId = null;
    fileOverlay.classList.remove('open');
    fileOverlay.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
  fileOverlay.addEventListener('click',(e)=>{ if(e.target===fileOverlay) closeOverlay(); });
  fileClose.addEventListener('click', closeOverlay);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && fileOverlay.classList.contains('open')) closeOverlay(); });

  /* ì¢Œ/ìš° í˜ì´ì§€ ë„˜ê¹€ */
  const spread = document.getElementById('spread');
  prevPg.addEventListener('click', ()=>{ turning = -1; spread.classList.remove('turn-right'); spread.classList.add('turn-left'); });
  nextPg.addEventListener('click', ()=>{ turning = 1;  spread.classList.remove('turn-left');  spread.classList.add('turn-right'); });

  // ìŠ¤ì™€ì´í”„ ì§€ì›
  let sx=0, sy=0, swiping=false;
  fileVisual.addEventListener('pointerdown', (e)=>{ sx=e.clientX; sy=e.clientY; swiping=true; });
  window.addEventListener('pointerup', (e)=>{
    if(!swiping) return; swiping=false;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)){
      if(dx>0) prevPg.click(); else nextPg.click();
    }
  });

  /* ë Œë” */
  function render(list){
    shelf.innerHTML = '';
    if(!list.length){ empty.hidden = false; return; }
    empty.hidden = true;

    list.forEach(m=>{
      const expired = isExpired(m);
      const cls = colorClass(m);
      const lowRemain = (m.remaining ?? 0) <= 3;
      const tabText = `${(m.name||'')}ê³ ê°ë‹˜`;

      const art = document.createElement('article');
      art.className = ['binder', cls, expired?'expired':''].join(' ').trim();
      art.tabIndex = 0;
      art.setAttribute('role','button');
      art.setAttribute('aria-label', `${m.name} ê³ ê° ì¹´ë“œ`);

      // ìƒë‹¨ ìŠ¤íŠ¸ë¦½(ì²˜ìŒì—” ìˆ¨ê¹€: ë‹¨ì¼ í„°ì¹˜ë¡œ í† ê¸€)
      const titleStrip = document.createElement('div');
      titleStrip.className = 'title-strip';
      titleStrip.innerHTML = `
        <span>${escapeHtml(m.name)} ê³ ê°ë‹˜</span>
        <span class="small">(${m.total||0}/${m.remaining||0})</span>
      `;

      const dLeft = m.expireAt ? Math.ceil((new Date(m.expireAt) - new Date(todayISO()))/86400000) : null;
      let stickerHtml = m.grade ? `<span class="sticker">${escapeHtml(m.grade)}</span>` : '';
      if (m.lastLog) stickerHtml = `<span class="sticker">ìµœê·¼ ${m.lastLog}</span>`;
      if (expired || (dLeft !== null && dLeft <= 7)) stickerHtml = `<span class="sticker" style="background:var(--danger-bg);border-color:var(--danger);color:#991b1b">ë§Œë£Œ D-${Math.max(dLeft??0,0)}</span>`;

      art.innerHTML = `
        <span class="shine" aria-hidden="true"></span>
        <span class="under" aria-hidden="true"></span>
        <div class="edge-tab" role="button" aria-label="íŒŒì¼ ì—´ê¸° íƒ­">${escapeHtml(tabText)}</div>

        <div class="panel">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="ring ${lowRemain?'low':''}" style="--pct:${calcPct(m.remaining,m.total)}">
              <div class="ring-label">${m.remaining||0}/${m.total||0}</div>
            </div>
            <div class="rows" style="flex:1">
              <div class="row"><span class="label">ë‹´ë‹¹</span><span class="value">${escapeHtml(m.trainer||"-")}</span></div>
              <div class="row"><span class="label">ë“±ê¸‰</span><span class="value">${escapeHtml(m.level||m.grade||"-")}</span></div>
              <div class="row"><span class="label">ë§Œë£Œì¼</span><span class="value">${m.expireAt||"-"}</span></div>
              <div class="row"><span class="label">ì‘ì„±</span><span class="value">${m.logCount||0}íšŒ</span></div>
              <div class="row"><span class="label">ë‹¤ìŒì˜ˆì•½</span><span class="value" id="nx-${m.id}">ì¡°íšŒ ì¤‘â€¦</span></div>
            </div>
          </div>
          <div class="stats" aria-label="ì„¸ì…˜ í˜„í™©">
            <div class="pill remain ${lowRemain?'low':''}">ì”ì—¬ <strong>${m.remaining||0}</strong></div>
            <div class="pill total">ì´ <strong>${m.total||0}</strong></div>
            ${m.group ? `<div class="pill">ê·¸ë£¹ <strong>${escapeHtml(m.group)}</strong></div>` : ``}
          </div>
          <div class="stickers" style="position:absolute;top:10px;right:10px">${stickerHtml}</div>
        </div>

        <div class="actions" aria-label="ë¹ ë¥¸ ì‘ì—…">
          <button class="btn" aria-label="ì¼ì§€ ì—´ê¸°" data-act="journal">ğŸ““ ì¼ì§€</button>
          <button class="btn" aria-label="ì—°ì¥ ë“±ë¡" data-act="extend">ğŸ“ ì—°ì¥</button>
          <button class="btn strong" aria-label="ì„¸ì…˜ ì†Œì§„" data-act="consume">â€“1 ì†Œì§„</button>
        </div>

        <div class="foot-date"><span class="dot"></span> ìµœê·¼ ë“±ë¡: <strong>${m.recentReg || m.first || '-'}</strong></div>
      `;
      art.appendChild(titleStrip);

      /* ì•¡ì…˜ ë°”ì¸ë”© */
      art.querySelector('[data-act="journal"]').addEventListener('click', (e)=>{
        e.stopPropagation(); location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
      });
      art.querySelector('[data-act="extend"]').addEventListener('click', (e)=>{
        e.stopPropagation(); location.href = `edit-member.html?id=${encodeURIComponent(m.id)}`;
      });
      art.querySelector('[data-act="consume"]').addEventListener('click', async (e)=>{
        e.stopPropagation();
        if ((m.remaining||0) <= 0){ alert('ì”ì—¬ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤'); return; }
        try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); }
        catch(err){ console.error(err); alert('ì†Œì§„ ì²˜ë¦¬ ì‹¤íŒ¨'); }
      });

      // ë‹¨ì¼ í„°ì¹˜ â†’ ìƒë‹¨ ìŠ¤íŠ¸ë¦½ í† ê¸€(í† ìŠ¤íŠ¸ ì•„ë‹˜)
      art.addEventListener('click', ()=>{
        if (longFired){ longFired=false; return; }
        titleStrip.style.display = (titleStrip.style.display==='flex'?'none':'flex');
        art.classList.add('pulse'); setTimeout(()=>art.classList.remove('pulse'), 500);
      });

      // ì™¼ìª½ íƒ­: íƒ­ í´ë¦­ìœ¼ë¡œ ë°”ë¡œ ì—´ê¸°
      art.querySelector('.edge-tab').addEventListener('click',(ev)=>{ ev.stopPropagation(); openOverlay(m); });

      // ë¡±í”„ë ˆìŠ¤ â†’ ì˜¤ë²„ë ˆì´(ì¤‘ì•™) ì—´ê¸°
      art.addEventListener('pointerdown', ()=>{
        longFired=false;
        longPressTimer = setTimeout(()=>{ longFired=true; openOverlay(m); }, 600);
      }, {passive:true});
      ['pointerup','pointerleave','pointercancel'].forEach(evName=>{
        art.addEventListener(evName, ()=>{
          clearTimeout(longPressTimer); longPressTimer=null;
        }, {passive:true});
      });

      // ë‹¤ìŒì˜ˆì•½ì€ í˜¸ë²„/í¬ì»¤ìŠ¤ ì‹œ ê³„ì‚° (ëª¨ë°”ì¼ë„ ì²« í¬ì»¤ìŠ¤ì— ê³„ì‚°)
      let fetched = false;
      const ensureNext = async ()=>{
        if (fetched) return; fetched = true;
        const nx = await fetchNextSchedule(m.id);
        const tgt = art.querySelector(`#nx-${m.id}`);
        if (tgt) tgt.textContent = nx;
      };
      art.addEventListener('mouseenter', ensureNext, {passive:true});
      art.addEventListener('focus', ensureNext, {passive:true});
      art.addEventListener('pointerdown', ensureNext, {passive:true});

      shelf.appendChild(art);
    });
  }

  function filterSort(){
    const kw = (qEl.value||'').trim().toLowerCase();
    const norm = s => String(s||'').toLowerCase();

    let list = state.members.filter(m=>{
      const match = !kw || norm(m.name).includes(kw) || norm(m.trainer).includes(kw) || norm(m.grade).includes(kw) || norm(m.level).includes(kw);
      const expired = isExpired(m);
      const passExp = state.showExpiredOnly ? expired : true;
      const passGroup = state.groupFilter ? String(m.group||'')===state.groupFilter : true;
      return match && passExp && passGroup;
    });

    const by = sortSel.value;
    const dir = state.orderAsc ? 1 : -1;

    list.sort((a,b)=>{
      if(by==='name')   return dir * collator.compare(a.name, b.name);
      if(by==='recent'){
        const A = toTime(a.lastLog) || 0;
        const B = toTime(b.lastLog) || 0;
        return dir * (A - B);
      }
      if(by==='remain') return dir * ((a.remaining||0) - (b.remaining||0));
      if(by==='first'){
        const A = toTime(a.first) || 0;
        const B = toTime(b.first) || 0;
        return dir * (A - B);
      }
      if(by==='expire'){
        const A = toTime(a.expireAt) || Infinity;
        const B = toTime(b.expireAt) || Infinity;
        return dir * (A - B);
      }
      return 0;
    });

    render(list);

    const expiredCount = state.members.filter(m=>isExpired(m)).length;
    expiredToggleBtn.textContent = `${state.showExpiredOnly ? 'ì „ì²´ ë³´ê¸°' : 'ë§Œë£Œ íšŒì›ë§Œ ë³´ê¸°'} (${expiredCount})`;
  }

  orderBtn.addEventListener('click', ()=>{
    state.orderAsc = !state.orderAsc;
    orderBtn.textContent = state.orderAsc ? 'ì˜¤ë¦„ì°¨ìˆœ â†‘' : 'ë‚´ë¦¼ì°¨ìˆœ â†“';
    orderBtn.setAttribute('aria-pressed', String(!state.orderAsc));
    filterSort();
  });
  qEl.addEventListener('input', filterSort);
  sortSel.addEventListener('change', filterSort);
  groupSel.addEventListener('change', (e)=>{ state.groupFilter = e.target.value; filterSort(); });

  // ë§Œë£Œ íšŒì› í† ê¸€
  expiredToggleBtn.addEventListener('click', ()=>{
    state.showExpiredOnly = !state.showExpiredOnly;
    expiredToggleBtn.setAttribute('aria-pressed', String(state.showExpiredOnly));
    filterSort();
  });

  /* ë§Œë£Œ ë¶„ë¥˜ ì‹œíŠ¸ */
  function openExpireSheet(member){
    currentMemberForSheet = member;
    const expired = isExpired(member);
    sheetTitle.textContent = expired ? 'ë§Œë£Œ í‘œì‹œ í•´ì œ' : 'ë§Œë£Œ ê³ ê° ë¶„ë¥˜';
    sheetDesc.textContent  = expired ? 'ì´ ê³ ê°ì˜ ë§Œë£Œ í‘œì‹œë¥¼ í•´ì œí• ê¹Œìš”?' : 'ì´ ê³ ê°ì„ ë§Œë£Œ ê³ ê°ìœ¼ë¡œ ë¶„ë¥˜í• ê¹Œìš”?';
    btnExpire.textContent  = expired ? 'ë§Œë£Œ í‘œì‹œ í•´ì œ' : 'ë§Œë£Œë¡œ ë¶„ë¥˜';
    overlay.style.display = 'block';
    sheet.style.display   = 'block';
  }
  function closeSheet(){
    overlay.style.display = 'none';
    sheet.style.display   = 'none';
    currentMemberForSheet = null;
  }
  overlay.addEventListener('click', closeSheet);
  btnCancel.addEventListener('click', closeSheet);
  btnExpire.addEventListener('click', async ()=>{
    if(!currentMemberForSheet) return;
    try{
      const willUnset = isExpired(currentMemberForSheet);
      await updateDoc(doc(db,'members', currentMemberForSheet.id), {
        expiredFlag: willUnset ? false : true,
        expiredFlagAt: willUnset ? null : serverTimestamp()
      });
    }catch(e){ console.error(e); alert('ì²˜ë¦¬ ì‹¤íŒ¨'); }
    closeSheet();
  });

  /* êµ¬ë… */
  onAuthStateChanged(auth, (u)=>{
    if (u) startMembers();
    else signInAnonymously(auth).catch((e)=>{ console.error(e); empty.textContent='ë¡œê·¸ì¸ ì‹¤íŒ¨ë¡œ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ì—†ì–´ìš”.'; empty.hidden=false; });
  });

  function startMembers(){
    onSnapshot(
      collection(db,'members'),
      (snap)=>{
        const list=[];
        snap.forEach(ds=>{
          const d=ds.data();
          // ìµœê·¼ ë“±ë¡(ì¬ë“±ë¡/êµ¬ë§¤) â†’ ìµœì‹  í•„ë“œ ìš°ì„ 
          const recentReg =
            toISO(d.recentRegistrationAt) ||
            toISO(d.lastRegisterAt) ||
            toISO(d.lastReenrollAt) ||
            toISO(d.lastPurchaseAt) ||
            ""; // ì—†ìœ¼ë©´ ë¹ˆê°’ â†’ ì•„ë˜ì—ì„œ firstë¡œ í´ë°±
          list.push({
            id: ds.id,
            name: d.name || "",
            trainer: d.trainer || "",
            grade: d.level || d.grade || "",
            level: d.level || "",
            first: d.startDate || toISO(d.createdAt) || "",
            recentReg,
            expireAt: toISO(d.expireAt),
            lastLog:  toISO(d.lastLogAt) || toISO(d.lastPurchaseAt),
            logCount: d.logCount || 0,
            remaining: d.remainingSessions ?? 0,
            total: d.totalSessionsPurchased ?? d.totalSessions ?? 0,
            birthday: toISO(d.birthday),
            anniversary: toISO(d.anniversary),
            expiredFlag: Boolean(d.expiredFlag),
            gender: (d.gender || '').toLowerCase(),   // 'male' | 'female'
            group: d.group || ""
          });
        });
        state.members=list;
        fillGroupOptions(list);

        // ì—´ë ¤ìˆë˜ ì˜¤ë²„ë ˆì´ê°€ ìˆìœ¼ë©´ ìµœì‹  ë°ì´í„°ë¡œ ê°±ì‹ 
        if (openOverlayId){
          const m = state.members.find(x=>x.id===openOverlayId);
          if (m) openOverlay(m);
        }

        const expiredCount = state.members.filter(m=>isExpired(m)).length;
        expiredToggleBtn.textContent = `${state.showExpiredOnly ? 'ì „ì²´ ë³´ê¸°' : 'ë§Œë£Œ íšŒì›ë§Œ ë³´ê¸°'} (${expiredCount})`;
        filterSort();
      },
      (err)=>{ console.error(err); empty.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. (ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ í™•ì¸)'; empty.hidden = false; }
    );
  }
  </script>
</body>
</html>
