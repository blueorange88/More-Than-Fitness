<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>고객 카드 – 파일 분류</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --gold-d:#9E8536; --underwhite:#F7F6F2;
    --silver:#C0C7D1; --bronze:#B08D57; --blue:#152A4A;
    --danger:#ef4444; --danger-bg:#fee2e2;
    --ink:#0b1220; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff; --recent-bg:#fff8e6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--underwhite);color:var(--ink);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,var(--underwhite));
         border-bottom:2px solid var(--gold);padding:14px 16px 12px}
  header h1{margin:0 0 10px;font-size:18px;color:var(--navy);letter-spacing:.2px}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff}
  .tools .select,.tools .check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--navy)}
  .tools select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
  .grid{padding:18px;display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .file-card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px 14px 14px;
             box-shadow:0 2px 8px rgba(0,0,0,.05);cursor:pointer;transition:transform .15s,box-shadow .15s,border-color .15s;outline:0}
  .file-card::before{content:"";position:absolute;top:-12px;left:14px;width:84px;height:18px;
                     background:linear-gradient(90deg,var(--gold),var(--gold-d));
                     border-radius:10px 10px 2px 2px;box-shadow:0 -1px 0 rgba(0,0,0,.04)}
  .file-card:hover,.file-card:focus-visible{transform:translateY(-2px);box-shadow:0 14px 28px rgba(11,30,58,.18);border-color:var(--gold)}
  .file-card.recent::after{content:"";position:absolute;inset:10px auto 10px 8px;width:4px;border-radius:4px;background:var(--gold)}
  .file-card.vip{border-color:var(--gold)} .file-card.vip::before{background:linear-gradient(90deg,var(--gold),var(--gold-d))}
  .file-card.silver{border-color:var(--silver)} .file-card.silver::before{background:linear-gradient(90deg,#e6ebf2,var(--silver))}
  .file-card.bronze{border-color:var(--bronze)} .file-card.bronze::before{background:linear-gradient(90deg,#d9c3a3,var(--bronze))}
  .file-card.blue{border-color:var(--blue)} .file-card.blue::before{background:linear-gradient(90deg,#1d3a66,var(--blue))}
  .file-card.expiring{border-color:var(--danger);box-shadow:0 12px 26px rgba(239,68,68,.25)}
  .file-card.expiring::before{background:linear-gradient(90deg,#fca5a5,var(--danger))}
  .file-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .name{font-weight:800;font-size:17px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;color:var(--navy)}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--gold);background:var(--recent-bg);color:#8a6d1d}
  .badge.neutral{border-color:#e5e7eb;background:#fff;color:#475569}
  .badge.danger{background:var(--danger-bg);border-color:var(--danger);color:#991b1b}
  .row{display:flex;gap:6px;align-items:center;font-size:13px;color:var(--muted);margin:3px 0}
  .row .label{width:64px;color:#334155}
  .row .value{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .empty{padding:40px 16px;text-align:center;color:var(--muted)}
  .footer{padding:10px 16px 18px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 일지 – 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="회원 이름 / 연락처 / 담당 / 등급 검색" />
      <div class="select">
        정렬:
        <select id="sortBy" aria-label="정렬">
          <option value="recent" selected>최근 작성순</option>
          <option value="name">이름(가나다)</option>
          <option value="grade">등급</option>
          <option value="first">최초 등록일</option>
        </select>
      </div>
      <label class="check"><input id="onlyRecent" type="checkbox"> 최근 작성만 보기</label>
    </div>
  </header>

  <main class="grid" id="grid" aria-live="polite"></main>
  <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  <div class="footer">Tip: 카드를 클릭하면 해당 회원의 운동일지로 이동합니다. 최근 7일 이내 작성은 골드, 만료 임박은 빨간 배지로 표시돼요.</div>

  <!-- 하나의 모듈 스크립트만 사용 -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

  /* ===== Firestore 연결 ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ===== 설정 ===== */
  const COL = "members"; // ← 네가 정한 컬렉션 이름
  const PT_LOG_URL = "./personal-training-log.html"; // 경로 상황에 맞게 조정

  /* ===== DOM ===== */
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const sortSel = document.getElementById('sortBy');
  const onlyRecent = document.getElementById('onlyRecent');

  /* ===== Utils ===== */
  const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const formatPhone = raw => {
    const v = String(raw||"").replace(/\D/g,'').slice(0,11);
    if (v.length<=3) return v;
    if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
    return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  };
  const dateToISO = d => d instanceof Date ? d.toISOString().slice(0,10) : "";
  const daysDiff = (dateStr) => { if(!dateStr) return null; const d = new Date(dateStr+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.floor((t - d)/86400000); };
  const daysUntil = (dateStr) => { if(!dateStr) return null; const d = new Date(dateStr+'T00:00:00'); const t = new Date(); t.setHours(0,0,0,0); return Math.ceil((d - t)/86400000); };
  const isRecent = (dateStr) => { const dd = daysDiff(dateStr); return dd !== null && dd <= 7; };
  function gradeClass(grade){
    const g = String(grade||"").toLowerCase();
    if (g === "vip") return "vip";                                   // 골드
    if (g.includes("프로모션") || g === "promotion") return "bronze"; // 브론즈
    if (g.includes("일반") || g === "normal" || g === "silver") return "silver"; // 실버
    return "blue";                                                    // 기본
  }

  /* ===== 상태 & 렌더링 ===== */
  let state = { members: [] };

  function render(list){
    grid.innerHTML = "";
    if (!list.length){ empty.hidden = false; return; }
    empty.hidden = true;

    list.forEach(m=>{
      const recent = isRecent(m.lastLog);
      const dLeft  = daysUntil(m.expireAt);
      const cls = [
        'file-card',
        gradeClass(m.grade),
        (dLeft !== null && dLeft <= 7) ? 'expiring' : '',
        recent ? 'recent' : ''
      ].join(' ').trim();

      const card = document.createElement('article');
      card.className = cls;
      card.tabIndex = 0;
      card.setAttribute('role','button');
      card.setAttribute('aria-label', `${m.name} 일지 열기`);

      // 우측 배지: 만료 임박 > 최근 작성 > 등급
      let rightBadge = `<span class="badge neutral">${escapeHtml(m.grade||"")}</span>`;
      if (recent) rightBadge = `<span class="badge">최근 작성 ${m.lastLog}</span>`;
      if (dLeft !== null && dLeft <= 7) rightBadge = `<span class="badge danger">만료 D-${Math.max(dLeft,0)}</span>`;

      card.innerHTML = `
        <div class="file-head">
          <div class="name">${escapeHtml(m.name)}</div>
          ${rightBadge}
        </div>
        <div class="row"><span class="label">연락처</span><span class="value">${formatPhone(m.phone)}</span></div>
        <div class="row"><span class="label">성별</span><span class="value">${escapeHtml(m.gender||"")}</span></div>
        <div class="row"><span class="label">담당</span><span class="value">${escapeHtml(m.trainer||"")}</span></div>
        <div class="row"><span class="label">등록일</span><span class="value">${escapeHtml(m.first||"")}</span></div>
        <div class="row"><span class="label">작성</span><span class="value">${m.logCount||0}회</span></div>
        <div class="row"><span class="label">만료일</span><span class="value">${m.expireAt||"-"}</span></div>
      `;

      const openLog = ()=>{ location.href = `${PT_LOG_URL}?id=${encodeURIComponent(m.id)}`; };
      card.addEventListener('click', openLog);
      card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openLog(); }});
      grid.appendChild(card);
    });
  }

  function filterSort(){
    const keyword = (q.value||"").trim().toLowerCase();
    const norm = s => String(s||"").toLowerCase();

    const list = state.members.filter(m=>{
      const phoneMatch = formatPhone(m.phone).replace(/\D/g,'')
                        .includes(keyword.replace(/\D/g,''));
      const match = !keyword
        || norm(m.name).includes(keyword)
        || phoneMatch
        || norm(m.trainer).includes(keyword)
        || norm(m.grade).includes(keyword);
      const recentOK = !onlyRecent.checked || isRecent(m.lastLog);
      return match && recentOK;
    });

    const by = sortSel.value;
    list.sort((a,b)=>{
      if (by==='recent') return (b.lastLog||'').localeCompare(a.lastLog||'');
      if (by==='name')   return a.name.localeCompare(b.name,'ko');
      if (by==='grade')  return (a.grade||'').localeCompare(b.grade||'','ko');
      if (by==='first')  return (b.first||'').localeCompare(a.first||'');
      return 0;
    });

    render(list);
  }

  /* ===== Firestore 실시간 구독 ===== */
  onSnapshot(collection(db, COL), (snap)=>{
    const list = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data();

      const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
      const startStr  = d.startDate || (createdAt ? dateToISO(createdAt) : "");
      const expireAt  = d.expireAt?.toDate ? dateToISO(d.expireAt.toDate()) : (d.expireAt || "");
      const lastLog   = d.lastLogAt?.toDate
                          ? dateToISO(d.lastLogAt.toDate())
                          : (d.lastPurchaseAt?.toDate ? dateToISO(d.lastPurchaseAt.toDate()) : "");

      list.push({
        id: docSnap.id,
        name: d.name || "",
        phone: d.phone || d.phoneDisplay || "",
        gender: d.gender || "",
        trainer: d.trainer || "",
        grade: d.level || d.grade || "",
        first: startStr,
        expireAt,
        lastLog,
        logCount: d.logCount || 0
      });
    });

    state.members = list;
    filterSort();
  });

  /* ===== UI 이벤트 ===== */
  q.addEventListener('input', filterSort);
  sortSel.addEventListener('change', filterSort);
  onlyRecent.addEventListener('change', filterSort);
  </script>
</body>
</html>
