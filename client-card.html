<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>고객 카드 – 바인더 서류철</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --ink:#0b1220; --muted:#6b7280;
    --line:#e5e7eb; --danger:#ef4444; --danger-bg:#fee2e2;
    --ok:#2563eb; --track:#e5e7eb;
    --shelf:#f3f4f6; --shelf-edge:#e5e7eb;

    --binder-w: 320px;
    --binder-h: 520px;
    --binder-overlap: -180px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(#fff,#fbfbfb); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  header{ position:sticky; top:0; z-index:20; background:linear-gradient(#fff,#f9fafb);
    border-bottom:2px solid var(--gold); padding:14px 16px 12px; }
  header h1{margin:0 0 10px; font-size:18px; color:#0B1E3A;}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{ flex:1; min-width:220px; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; font-size:14px; background:#fff; }
  .tools select, .tools button{ border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px; cursor:pointer; }
  .tools button.tgl{min-width:92px}
  .back{ margin-left:auto; background:#0B1E3A; color:#fff; font-weight:700; }

  .shelf-wrap{position:relative; padding:18px 0 28px}
  .shelf{ position:relative; display:flex; gap:0; padding:26px 22px;
    overflow-x:auto; overflow-y:visible; scrollbar-width:thin;
    perspective:1200px; border-top:1px solid var(--shelf-edge); border-bottom:1px solid var(--shelf-edge);
    background:var(--shelf); scroll-snap-type:x proximity; }
  .shelf::before, .shelf::after{ content:""; position:sticky; width:40px; flex:0 0 40px; height:100%; pointer-events:none; }
  .shelf::before{ left:0; background:linear-gradient(90deg,#f9fafb,rgba(249,250,251,0)); }
  .shelf::after{ right:0; background:linear-gradient(270deg,#f9fafb,rgba(249,250,251,0)); }

  /* ===== Binder ===== */
  @keyframes breathe { 0%,100%{filter:saturate(1) brightness(1)} 50%{filter:saturate(1.08) brightness(1.05)} }
  @keyframes glowPulse { 0%,100%{ box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22); }
                        50%    { box-shadow:-12px 0 0 rgba(255,255,255,.24) inset, 0 28px 60px rgba(0,0,0,.28); } }
  .binder{
    position:relative; width:var(--binder-w); height:var(--binder-h); margin-left:var(--binder-overlap);
    border-radius:16px; cursor:pointer; user-select:none; outline:0;
    transform:translateZ(0) rotateY(-12deg) translateY(6px);
    transform-origin:left center; will-change:transform, filter;
    box-shadow:-8px 0 0 rgba(0,0,0,.06) inset, 0 8px 20px rgba(0,0,0,.08);
    transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s, filter .28s, z-index .28s;
    border:1px solid rgba(0,0,0,.06); color:#0b1220; scroll-snap-align:start;
    background:linear-gradient(160deg,#bfdbfe,#60a5fa,#2563eb);
  }
  .cFemale  { --tab-bg-start:#ffb9d0; --tab-bg-end:#ff7fb3; background:linear-gradient(160deg,#ffe8f3,#ffcfe3,#ffbad6); }
  .cMale    { --tab-bg-start:#9ac6ff; --tab-bg-end:#3676ff; background:linear-gradient(160deg,#eaf3ff,#cfe2ff,#b0d0ff); }
  .cGray    { --tab-bg-start:#c9ced6; --tab-bg-end:#a6acb6; background:linear-gradient(160deg,#eef0f3,#d9dde3,#c9ced6); }
  .binder:first-child{ margin-left:8px; }
  .binder:hover, .binder:focus-visible{
    z-index:9; transform:translateY(-14px) rotateY(-2deg) scale(1.04);
    box-shadow:-10px 0 0 rgba(255,255,255,.18) inset, 0 22px 40px rgba(0,0,0,.22);
    animation:breathe 2.6s ease-in-out infinite;
  }
  .binder.expired{ filter:grayscale(.2) saturate(.9); }

  .shine{ position:absolute; inset:-2px; border-radius:16px; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.28) 30%, rgba(255,255,255,0) 60%);
    transform: translateX(-130%); transition: transform .9s ease; mix-blend-mode: screen; }
  .binder:hover .shine, .binder:focus-visible .shine{ transform: translateX(130%); }
  .under{ position:absolute; left:18%; right:12px; bottom:-10px; height:20px; pointer-events:none;
    background:radial-gradient(60% 100% at 50% 0, rgba(0,0,0,.28), rgba(0,0,0,0)); filter: blur(3px); opacity:.65; transition:opacity .25s, transform .25s; }
  .binder:hover .under, .binder:focus-visible .under{ opacity:.9; transform: translateY(2px) scale(1.06); }
  .binder.pulse{ animation:glowPulse 1.1s ease-in-out 1; }

  .head{position:relative; display:flex; align-items:flex-start; justify-content:space-between; padding:16px 16px 8px 36px}
  .name{font-weight:900; font-size:20px; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.35)}
  .name .suffix{margin-left:4px; font-weight:800; color:#1f2937; font-size:15px}
  .name-wrap{display:flex; flex-direction:column; gap:2px}
  .sub-sessions{font-size:12px; font-weight:800; color:#334155; opacity:.9}

  .stickers{position:absolute; top:10px; right:10px; display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}
  .sticker{ font-size:11px; padding:4px 8px; border-radius:10px; background:rgba(255,255,255,.75); color:#1f2937;
    border:1px solid rgba(0,0,0,.08); backdrop-filter:blur(3px); }
  .sticker.recent{ background:#ecfeff; border-color:#a5f3fc; color:#0e7490; }
  .sticker.expire{ background:var(--danger-bg); border-color:var(--danger); color:#991b1b; }

  /* 왼쪽 인덱스 탭: 이름 + '고객님' */
  .edge-tab{
    position:absolute; left:-16px; top:46px; width:22px; height:92px;
    background:linear-gradient(180deg,var(--tab-bg-start), var(--tab-bg-end));
    border:2px solid var(--tab-bg-end); border-right:none;
    border-radius:10px 0 0 10px; writing-mode:vertical-rl; text-orientation:mixed;
    font-weight:900; font-size:11px; color:#ffffff; display:flex; align-items:center; justify-content:center;
    box-shadow:0 3px 8px rgba(0,0,0,.12); transform:rotate(-2deg); transition:transform .2s, filter .2s; user-select:none;
  }
  .binder:hover .edge-tab{ transform:rotate(0deg) translateX(-2px); filter:brightness(1.05); }

  .panel{ position:absolute; right:10px; top:70px; bottom:52px; left:36px;
    background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px; overflow:hidden;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    transform:translateZ(30px) translateX(8px) rotateY(6deg); opacity:.0;
    transition:opacity .25s, transform .28s; backdrop-filter: blur(6px); }
  .binder:hover .panel, .binder:focus-visible .panel{ opacity:1; transform:translateZ(60px) translateX(0) rotateY(0); }
  .rows{font-size:13px; color:#374151; display:grid; gap:6px; margin-top:10px}
  .row{display:flex; gap:6px}
  .row .label{width:66px; color:#334155; font-weight:700}
  .row .value{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* 모바일에서 상단 '등록일' 숨김 */
  @media (max-width:540px){ .row.r-first{ display:none; } }

  .ring{ --pct:0; width:84px; height:84px; border-radius:50%;
    background:conic-gradient(var(--ok) calc(var(--pct)*1%), var(--track) 0);
    display:grid; place-items:center; margin:2px 8px 6px auto; border:6px solid rgba(255,255,255,.6);
    box-shadow:0 2px 10px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.08); }
  .ring.low{ --ok:#ef4444; }
  .ring .ring-label{background:#fff; border-radius:999px; padding:6px 8px; font-size:12px; font-weight:900; border:1px solid #e5e7eb}

  .stats{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .pill{border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff}
  .pill strong{font-weight:900}
  .pill.remain{border-color:#60a5fa; background:#eff6ff}
  .pill.remain.low{border-color:#ef4444; background:#fee2e2; color:#991b1b}
  .pill.total{border-color:#d1d5db; background:#f9fafb}

  .foot-date{
    position:absolute; left:36px; right:10px; bottom:12px;
    font-size:11px; font-weight:800; color:#334155;
    background:rgba(255,255,255,.8); padding:6px 10px; border-radius:10px; border:1px solid #e5e7eb;
    display:flex; align-items:center; gap:6px;
  }
  .foot-date .dot{ width:6px; height:6px; border-radius:50%; background:#22c55e; }

  .actions{ position:absolute; left:36px; right:10px; bottom:54px; display:flex; gap:10px; opacity:0; transform:translateY(6px);
    transition:opacity .2s, transform .2s; }
  .binder:hover .actions, .binder:focus-visible .actions{ opacity:1; transform:translateY(0); }
  .btn{ flex:1; padding:10px 12px; border-radius:999px; background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08);
    backdrop-filter: blur(6px); color:#0B1E3A; font-weight:800; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 8px 18px rgba(11,30,58,.18); cursor:pointer; }
  .btn.strong{ background:#0B1E3A; color:#fff; }
  .btn:active{ transform:translateY(1px); }

  /* ===== 파일 오버레이 ===== */
  .file-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.38); display:none; z-index:1100; }
  .file-overlay.open{ display:block; }
  .file-sheet{
    position:absolute; top:0; right:0; bottom:0; width:min(620px,94vw);
    background:#fff; border-left:1px solid var(--line); border-radius:12px 0 0 12px;
    transform:translateX(100%); transition:transform .42s cubic-bezier(.2,.7,.2,1);
    overflow:auto;
  }
  .file-overlay.open .file-sheet{ transform:translateX(0); }

  .sheet-head{ display:flex; align-items:center; gap:10px; padding:12px 14px 0 14px; }
  .sheet-title{ margin:0; font-size:16px; font-weight:900; }
  .pagebtn{ margin-left:auto; display:flex; gap:6px }
  .pagebtn button{ border:1px solid var(--line); background:#fff; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer }

  /* 앞쪽 비주얼 */
  .file-visual{ position:relative; margin:10px auto 8px; width:min(520px,90vw); aspect-ratio: 210 / 297; perspective:1500px;
    opacity:0; transform:translateX(18%) scale(.92) rotateY(-8deg); transition:opacity .3s, transform .42s cubic-bezier(.2,.7,.2,1); }
  .file-overlay.open .file-visual{ opacity:1; transform:translateX(0) scale(1) rotateY(0); }

  .fv-folder{ position:absolute; inset:0; border-radius:10px; background:linear-gradient(160deg,#bfdbfe,#60a5fa,#2563eb);
    box-shadow:0 10px 26px rgba(0,0,0,.16); transform-style:preserve-3d; overflow:hidden; }
  .fv-tab{
    position:absolute; left:-18px; top:18px; width:26px; height:96px;
    background:linear-gradient(180deg,var(--tab-bg-start), var(--tab-bg-end));
    border:2px solid var(--tab-bg-end); border-right:none; border-radius:10px 0 0 10px;
    writing-mode:vertical-rl; text-orientation:mixed; color:#fff; font-weight:900; font-size:11px;
    display:flex; align-items:center; justify-content:center; box-shadow:0 3px 8px rgba(0,0,0,.12);
  }
  .fv-cover{
    position:absolute; inset:0; border-radius:10px; background:linear-gradient(135deg,#f4f1de,#e9c46a);
    border-left:2px solid #d4a574; transform-origin:left center; transform:translateX(0) rotateY(0);
    transition:transform .8s cubic-bezier(.175,.885,.32,1.275);
    box-shadow:-2px 0 10px rgba(0,0,0,.12); z-index:30;
  }
  .fv-paper{ position:absolute; inset:8px; pointer-events:none; }
  .fv-sheet{ position:absolute; inset:0; background:#fff; border:1px solid #e5e7eb; border-radius:6px;
             box-shadow:0 1px 3px rgba(0,0,0,.08); transform-origin:left center; transition:transform .6s ease; }
  .fv-sheet:nth-child(1){ transform:translateX(2px); }
  .fv-sheet:nth-child(2){ transform:translateX(4px); }
  .fv-sheet:nth-child(3){ transform:translateX(6px); }
  .fv-sheet:nth-child(4){ transform:translateX(8px); }

  /* 책(두 페이지) */
  .book{ position:absolute; inset:8px; z-index:40; perspective:1600px; }
  .book-inner{ position:absolute; inset:0; transform-style:preserve-3d; transition: transform .7s cubic-bezier(.2,.8,.2,1); }
  .book.flipped .book-inner{ transform: rotateY(180deg); }
  .page{
    position:absolute; inset:0; background:#fff; border:1px solid #e5e7eb; border-radius:8px;
    backface-visibility:hidden; overflow:auto; padding:14px;
  }
  .page.right{ transform: rotateY(180deg); }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; min-width: 760px; }
  .card{ background:#fafafa; border:1px solid #ebebeb; border-radius:12px; padding:12px; }
  .card h3{ margin:0 0 8px; font-size:14px; font-weight:900; color:#0b1220; }
  .row2{ display:flex; gap:8px; font-size:13px; margin:4px 0 }
  .row2 .label{ width:78px; color:#475569; font-weight:700 }
  .pill2{ display:inline-block; border:1px solid #d1d5db; background:#fff; border-radius:999px; padding:6px 10px; font-size:12px; }

  .sheet-body{ padding:6px 14px 22px; overflow-x:auto; }
  .doc-grid{ display:grid; grid-template-columns: 320px 360px; gap:12px; min-width: 720px; }
  .doc-card{ background:#fafafa; border:1px solid #ebebeb; border-radius:12px; padding:12px; }
  .doc-card h4{ margin:0 0 8px; font-size:14px; font-weight:900; color:#0b1220; }
  .doc-card .kv{ display:grid; grid-template-columns:86px 1fr; gap:6px; font-size:12px; }
  .doc-chiprow{ display:flex; gap:8px; flex-wrap:wrap }
  .doc-chip{ border:1px solid var(--line); background:#fff; border-radius:999px; padding:6px 10px; font-size:12px; }

  /* 덮개 펼침(태블릿은 더 크게 열어 가려짐 방지) */
  .file-visual.open .fv-cover{ transform:translateX(-76%) rotateY(-14deg); }
  @media (min-width: 768px){ .file-visual.open .fv-cover{ transform:translateX(-85%) rotateY(-18deg); } }

  @media (max-width: 860px){
    :root{ --binder-w: 260px; --binder-h: 440px; --binder-overlap: -120px; }
  }
  @media (max-width: 540px){
    :root{ --binder-w: 200px; --binder-h: 360px; --binder-overlap: -90px; }
    .edge-tab{ height:80px; font-size:10px; left:-14px; }
    .file-sheet{ width:96vw; }
    .file-visual{ width:92vw; }
    .doc-grid{ grid-template-columns: 1fr; min-width: 640px; }
  }

  @media (prefers-color-scheme: dark){
    body{ background:linear-gradient(#0b1220,#101826); color:#e5e7eb; }
    header{ background:linear-gradient(#0f172a,#0b1220); border-bottom-color:#475569; }
    .tools input[type="search"], .tools select, .tools button{ background:#0f172a; color:#e5e7eb; border-color:#374151; }
    .shelf{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
            border-top-color:#374151; border-bottom-color:#374151; }
    .binder{ color:#eef2ff; border-color:rgba(255,255,255,.06);
             box-shadow:-8px 0 0 rgba(0,0,0,.45) inset, 0 12px 28px rgba(0,0,0,.65); }
    .panel{ background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.1); }
    .sticker{ background:rgba(255,255,255,.14); border-color:rgba(255,255,255,.2); color:#e5e7eb; }
    .sticker.recent{ background:rgba(14,116,144,.22); border-color:rgba(14,116,144,.45); color:#d1faff; }
    .btn{ background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.18); color:#e5e7eb; }
    .btn.strong{ background:#0B1E3A; }
    .row .label{ color:#cbd5e1; }
    .sub-sessions{ color:#cbd5e1; }
    .file-sheet{ background:#0f172a; border-left-color:#273044; }
    .doc-card{ background:#121b2a; border-color:#273044; }
    .doc-card h4{ color:#e5e7eb; }
    .doc-chip{ background:#101826; border-color:#273044; color:#e5e7eb; }
    .fv-cover{ background:linear-gradient(135deg,#152036,#2a3a5a); border-left-color:#273044; }
  }
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 – 바인더 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="이름 / 담당 / 등급 검색" />
      <select id="sortBy" aria-label="정렬">
        <option value="name" selected>이름(가나다·영문·숫자)</option>
        <option value="recent">최근 작성</option>
        <option value="remain">잔여 세션</option>
        <option value="first">최초 등록일</option>
        <option value="expire">만료일</option>
      </select>
      <button id="orderBtn" class="tgl" aria-pressed="false">오름차순 ↑</button>
      <button id="expiredToggle" class="tgl" aria-pressed="false">만료 회원만 보기 (0)</button>
      <button id="btnDash" class="back" onclick="location.href='dashboard.html'">대시보드로</button>
    </div>
  </header>

  <section class="shelf-wrap">
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  </section>

  <!-- 파일 디테일 오버레이 -->
  <div id="fileOverlay" class="file-overlay" aria-hidden="true">
    <div class="file-sheet" role="dialog" aria-modal="true" aria-labelledby="fileTitle">
      <div class="sheet-head">
        <button id="fileClose" class="btn" style="flex:0 0 auto;">닫기</button>
        <h3 id="fileTitle" class="sheet-title"></h3>
        <div class="pagebtn">
          <button id="btnPrev">◀︎ 1페이지</button>
          <button id="btnNext">2페이지 ▶︎</button>
        </div>
      </div>

      <!-- 폴더 연출 + 내부 책 -->
      <div id="fileVisual" class="file-visual">
        <div class="fv-folder">
          <div class="fv-tab" id="fvTab">고객님</div>
          <div class="fv-paper">
            <div class="fv-sheet"></div><div class="fv-sheet"></div><div class="fv-sheet"></div><div class="fv-sheet"></div>
          </div>

          <!-- 두 페이지(앞/뒤) -->
          <div id="book" class="book">
            <div class="book-inner">
              <section class="page left">
                <h2 id="p1Title" style="margin:0 0 10px;font-size:16px;font-weight:900">고객 요약</h2>
                <div class="grid">
                  <div class="card" id="cardInfo"></div>
                  <div class="card" id="cardAction"></div>
                </div>
              </section>
              <section class="page right">
                <h2 style="margin:0 0 10px;font-size:16px;font-weight:900">레슨 현황 / 메모</h2>
                <div class="grid">
                  <div class="card" id="cardLesson"></div>
                  <div class="card" id="cardNotes"></div>
                </div>
              </section>
            </div>
          </div>

          <div class="fv-cover"></div>
        </div>
      </div>

      <div class="sheet-body">
        <div id="fileBody" class="doc-grid"></div>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, increment,
           query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain:"more-than-fitness-f6adb.firebaseapp.com",
    projectId:"more-than-fitness-f6adb",
    storageBucket:"more-than-fitness-f6adb.appspot.com",
    messagingSenderId:"993248877411",
    appId:"1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId:"G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth= getAuth(app);

  /* DOM */
  const shelf    = document.getElementById('shelf');
  const empty    = document.getElementById('empty');
  const qEl      = document.getElementById('q');
  const sortSel  = document.getElementById('sortBy');
  const orderBtn = document.getElementById('orderBtn');
  const expiredToggleBtn = document.getElementById('expiredToggle');

  // Overlay elements
  const fileOverlay = document.getElementById('fileOverlay');
  const fileTitle   = document.getElementById('fileTitle');
  const fileClose   = document.getElementById('fileClose');
  const fileVisual  = document.getElementById('fileVisual');
  const fvTab       = document.getElementById('fvTab');
  const book        = document.getElementById('book');
  const p1Title     = document.getElementById('p1Title');
  const cardInfo    = document.getElementById('cardInfo');
  const cardAction  = document.getElementById('cardAction');
  const cardLesson  = document.getElementById('cardLesson');
  const cardNotes   = document.getElementById('cardNotes');
  const btnPrev     = document.getElementById('btnPrev');
  const btnNext     = document.getElementById('btnNext');
  const fileBody    = document.getElementById('fileBody');

  /* Utils */
  const collator = new Intl.Collator('ko-KR',{numeric:true,sensitivity:'base'});
  const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const p2 = n => String(n).padStart(2,'0');
  const todayISO = () => { const d=new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
  const toISO = ts => ts?.toDate ? ts.toDate().toISOString().slice(0,10) : (typeof ts==='string'?ts:'');
  const toTime = (str)=> (str ? new Date(str).getTime() : NaN);

  function binderClass(m){
    if (isExpired(m)) return 'cGray';
    if ((m.gender||'').toLowerCase()==='female') return 'cFemale';
    return 'cMale';
  }

  /* 다음 예약 캐시 */
  const nextScheduleCache = new Map();
  async function fetchNextSchedule(memberId){
    if (nextScheduleCache.has(memberId)) return nextScheduleCache.get(memberId);
    try{
      const qy = query(collection(db,'schedules'), where('memberId','==', memberId));
      const snap = await getDocs(qy);
      const today = todayISO();
      const list = [];
      snap.forEach(ds=>{
        const s=ds.data(); const d=String(s.date||''); const st=String(s.start||'00:00');
        if (d>=today) list.push({date:d,start:st});
      });
      list.sort((a,b)=> (a.date===b.date ? a.start.localeCompare(b.start) : a.date.localeCompare(b.date)));
      const val = list[0] ? `${list[0].date} ${list[0].start}` : '-';
      nextScheduleCache.set(memberId,val); return val;
    }catch(e){ console.error(e); nextScheduleCache.set(memberId,'-'); return '-'; }
  }

  /* State */
  let state = { orderAsc: true, showExpiredOnly:false, members:[] };
  let openOverlayId = null;

  /* 색상 변수 동기화(덮개 탭) */
  function applyColorVars(elem, cls){
    const probe=document.createElement('div'); probe.className='binder '+cls;
    probe.style.position='absolute'; probe.style.visibility='hidden'; document.body.appendChild(probe);
    const cs=getComputedStyle(probe);
    const start = cs.getPropertyValue('--tab-bg-start')||'#9ac6ff';
    const end   = cs.getPropertyValue('--tab-bg-end')||'#3676ff';
    document.body.removeChild(probe);
    elem.style.setProperty('--tab-bg-start', start.trim());
    elem.style.setProperty('--tab-bg-end', end.trim());
  }

  /* Overlay open/close + 2page controls */
  function setPage(flipped){ if(flipped) book.classList.add('flipped'); else book.classList.remove('flipped'); }
  btnPrev.onclick = ()=> setPage(false);
  btnNext.onclick = ()=> setPage(true);

  // 스와이프도 지원
  (function bindSwipe(){
    let sx=0, dx=0;
    const start = (e)=>{ sx=(e.touches?e.touches[0].clientX:e.clientX); dx=0; };
    const move  = (e)=>{ if(!sx) return; const x=(e.touches?e.touches[0].clientX:e.clientX); dx=x-sx; };
    const end   = ()=>{ if(Math.abs(dx)>40){ if(dx<0) setPage(true); else setPage(false); } sx=0; dx=0; };
    ['touchstart','mousedown'].forEach(ev=> book.addEventListener(ev,start));
    ['touchmove','mousemove'].forEach(ev=> book.addEventListener(ev,move));
    ['touchend','mouseup','mouseleave'].forEach(ev=> book.addEventListener(ev,end));
  })();

  function openOverlay(m){
    openOverlayId = m.id;

    // 컬러/제목/탭
    const cls = binderClass(m);
    applyColorVars(fileVisual, cls);
    fileTitle.textContent = `${m.name} · ${m.level || m.grade || '일반'}`;
    fvTab.textContent = `${m.name}고객님`;
    p1Title.textContent = `${m.name} 고객님 요약`;

    // 페이지1
    cardInfo.innerHTML = `
      <h3>👤 고객정보</h3>
      <div class="row2"><span class="label">이름</span><span>${escapeHtml(m.name)} 고객님</span></div>
      <div class="row2"><span class="label">담당</span><span>${escapeHtml(m.trainer||'-')}</span></div>
      <div class="row2"><span class="label">등급</span><span>${escapeHtml(m.level||m.grade||'-')}</span></div>
      <div class="row2"><span class="label">최근등록</span><span>${m.recentReg || '-'}</span></div>
      <div class="row2"><span class="label">만료일</span><span>${m.expireAt||'-'}</span></div>
      <div class="row2"><span class="label">작성</span><span>${m.logCount||0}회</span></div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <span class="pill2">잔여 <strong>${m.remaining||0}</strong></span>
        <span class="pill2">총 <strong>${m.total||0}</strong></span>
      </div>
    `;
    cardAction.innerHTML = `
      <h3>빠른 작업</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" id="ovGoJournal">📓 일지 열기</button>
        <button class="btn" id="ovGoEdit">📝 연장 등록</button>
        <button class="btn strong" id="ovConsume">–1 소진</button>
      </div>
    `;

    // 페이지2
    cardLesson.innerHTML = `
      <h3>레슨 현황</h3>
      <div class="row2"><span class="label">최근작성</span><span>${escapeHtml(m.lastLog||'-')}</span></div>
      <div class="row2"><span class="label">다음예약</span><span id="ovNext">조회중…</span></div>
      <div class="row2"><span class="label">진행률</span><span>${m.total?Math.round(((m.total-(m.remaining||0))/m.total)*100):0}%</span></div>
    `;
    cardNotes.innerHTML = `<h3>메모</h3><div style="font-size:13px; color:#374151">${escapeHtml(m.memo||m.note||'메모가 없습니다.')}</div>`;

    // 버튼 연결(경로는 프로젝트에 맞게 교체)
    document.getElementById('ovGoJournal').onclick = ()=> location.href = `/personal-training-log.html?id=${encodeURIComponent(m.id)}`; // TODO: 실제 경로
    document.getElementById('ovGoEdit').onclick    = ()=> location.href = `/edit-member.html?id=${encodeURIComponent(m.id)}`;         // TODO: 실제 경로
    document.getElementById('ovConsume').onclick   = async ()=>{
      if ((m.remaining||0) <= 0){ alert('잔여 세션이 없습니다'); return; }
      try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); }
      catch(err){ console.error(err); alert('소진 처리 실패'); }
    };

    // 다음예약 채우기
    fetchNextSchedule(m.id).then(nx=>{ const el=document.getElementById('ovNext'); if(el) el.textContent = nx; });

    // 열기 애니메이션
    setPage(false);
    fileOverlay.classList.add('open');
    fileOverlay.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
    fileVisual.classList.remove('open');
    setTimeout(()=> fileVisual.classList.add('open'), 160); // 태블릿에서도 충분히 열리도록 약간 지연
  }
  function closeOverlay(){
    openOverlayId=null;
    fileOverlay.classList.remove('open');
    fileOverlay.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
  fileOverlay.addEventListener('click',(e)=>{ if(e.target===fileOverlay) closeOverlay(); });
  fileClose.addEventListener('click', closeOverlay);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && fileOverlay.classList.contains('open')) closeOverlay(); });

  /* 만료 여부 */
  function isExpired(m){
    const today = new Date(todayISO()).getTime();
    const expT = toTime(m.expireAt);
    return Boolean(m.expiredFlag) || (Number.isFinite(expT) && expT < today);
  }

  /* 렌더 */
  function render(list){
    shelf.innerHTML='';
    if(!list.length){ empty.hidden=false; return; }
    empty.hidden=true;

    list.forEach(m=>{
      const cls = binderClass(m);
      const lowRemain = (m.remaining ?? 0) <= 3;
      const art = document.createElement('article');
      art.className = `binder ${cls} ${isExpired(m)?'expired':''}`;
      art.tabIndex = 0;
      art.setAttribute('role','button');
      art.setAttribute('aria-label', `${m.name} 고객 카드`);

      const dLeft = m.expireAt ? Math.ceil((new Date(m.expireAt) - new Date(todayISO()))/86400000) : null;
      let stickerHtml = m.grade ? `<span class="sticker">${escapeHtml(m.grade)}</span>` : '';
      if (m.lastLog) stickerHtml = `<span class="sticker recent">최근 ${m.lastLog}</span>`;
      if (isExpired(m) || (dLeft !== null && dLeft <= 7)) stickerHtml = `<span class="sticker expire">만료 D-${Math.max(dLeft??0,0)}</span>`;

      art.innerHTML = `
        <span class="shine" aria-hidden="true"></span>
        <span class="under" aria-hidden="true"></span>
        <div class="edge-tab" role="button">${escapeHtml(m.name)}고객님</div>

        <div class="head">
          <div class="name-wrap">
            <div class="name">${escapeHtml(m.name)} <span class="suffix">고객님</span></div>
            <div class="sub-sessions">(${m.total||0}/${m.remaining||0})</div>
          </div>
          <div class="stickers">${stickerHtml}</div>
        </div>

        <div class="panel">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="ring ${lowRemain?'low':''}" style="--pct:${Math.max(0,Math.min(100, Math.round(((m.remaining||0)/(m.total||1))*100)))}">
              <div class="ring-label">${m.remaining||0}/${m.total||0}</div>
            </div>
            <div class="rows" style="flex:1">
              <div class="row"><span class="label">담당</span><span class="value">${escapeHtml(m.trainer||"-")}</span></div>
              <div class="row"><span class="label">등급</span><span class="value">${escapeHtml(m.level||m.grade||"-")}</span></div>
              <div class="row r-first"><span class="label">등록일</span><span class="value">${m.first||"-"}</span></div>
              <div class="row"><span class="label">만료일</span><span class="value">${m.expireAt||"-"}</span></div>
              <div class="row"><span class="label">작성</span><span class="value">${m.logCount||0}회</span></div>
              <div class="row"><span class="label">다음예약</span><span class="value" id="nx-${m.id}">조회 중…</span></div>
            </div>
          </div>

          <div class="stats" aria-label="세션 현황">
            <div class="pill remain ${lowRemain?'low':''}">잔여 <strong>${m.remaining||0}</strong></div>
            <div class="pill total">총 <strong>${m.total||0}</strong></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" data-act="journal">📓 일지 열기</button>
          <button class="btn" data-act="extend">📝 연장 등록</button>
          <button class="btn strong" data-act="consume">–1 소진</button>
        </div>

        <div class="foot-date"><span class="dot"></span> 최근 등록: <strong>${m.recentReg || m.first || '-'}</strong></div>
      `;

      // 액션
      art.querySelector('[data-act="journal"]').onclick = (e)=>{ e.stopPropagation(); location.href=`/personal-training-log.html?id=${encodeURIComponent(m.id)}`; }; // TODO 변경
      art.querySelector('[data-act="extend"]').onclick  = (e)=>{ e.stopPropagation(); location.href=`/edit-member.html?id=${encodeURIComponent(m.id)}`; }; // TODO 변경
      art.querySelector('[data-act="consume"]').onclick = async (e)=>{
        e.stopPropagation();
        if ((m.remaining||0) <= 0){ alert('잔여 세션이 없습니다'); return; }
        try{ await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) }); }
        catch(err){ console.error(err); alert('소진 처리 실패'); }
      };

      // 탭 클릭/더블클릭/롱프레스 모두 열기 지원
      const open = (ev)=>{ ev.stopPropagation(); openOverlay(m); };
      art.querySelector('.edge-tab').addEventListener('click', open);
      art.addEventListener('dblclick', open);
      // 롱프레스
      let t=null; art.addEventListener('pointerdown', ()=>{ t=setTimeout(()=>open(new Event('open')),600); }, {passive:true});
      ['pointerup','pointerleave','pointercancel'].forEach(ev=> art.addEventListener(ev, ()=>clearTimeout(t), {passive:true}));

      // 다음예약 지연 로딩
      let fetched=false;
      const ensureNext = async ()=>{
        if (fetched) return; fetched=true;
        const nx = await fetchNextSchedule(m.id);
        const tgt=art.querySelector(`#nx-${m.id}`); if(tgt) tgt.textContent=nx;
      };
      art.addEventListener('mouseenter', ensureNext, {passive:true});
      art.addEventListener('focus', ensureNext, {passive:true});

      // 미세 피드백
      art.addEventListener('click', ()=>{ art.classList.add('pulse'); setTimeout(()=>art.classList.remove('pulse'), 500); });

      shelf.appendChild(art);
    });
  }

  function filterSort(){
    const kw = (qEl.value||'').trim().toLowerCase();
    const norm = s => String(s||'').toLowerCase();

    let list = state.members.filter(m=>{
      const match = !kw || norm(m.name).includes(kw) || norm(m.trainer).includes(kw) || norm(m.grade).includes(kw);
      const expired = isExpired(m);
      return match && (state.showExpiredOnly ? expired : true);
    });

    const dir = state.orderAsc ? 1 : -1;
    const by = sortSel.value;
    list.sort((a,b)=>{
      if(by==='name')   return dir * collator.compare(a.name, b.name);
      if(by==='recent') return dir * ((toTime(a.lastLog)||0) - (toTime(b.lastLog)||0));
      if(by==='remain') return dir * ((a.remaining||0) - (b.remaining||0));
      if(by==='first')  return dir * ((toTime(a.first)||0) - (toTime(b.first)||0));
      if(by==='expire') return dir * ((toTime(a.expireAt)||Infinity) - (toTime(b.expireAt)||Infinity));
      return 0;
    });

    render(list);
    const expiredCount = state.members.filter(m=>isExpired(m)).length;
    expiredToggleBtn.textContent = `${state.showExpiredOnly ? '전체 보기' : '만료 회원만 보기'} (${expiredCount})`;
  }

  orderBtn.onclick = ()=>{ state.orderAsc=!state.orderAsc; orderBtn.textContent=state.orderAsc?'오름차순 ↑':'내림차순 ↓'; orderBtn.setAttribute('aria-pressed', String(!state.orderAsc)); filterSort(); };
  qEl.oninput = filterSort;
  sortSel.onchange = filterSort;
  expiredToggleBtn.onclick = ()=>{ state.showExpiredOnly=!state.showExpiredOnly; expiredToggleBtn.setAttribute('aria-pressed', String(state.showExpiredOnly)); filterSort(); };

  /* 구독 */
  onAuthStateChanged(auth, (u)=>{
    if (u) startMembers();
    else signInAnonymously(auth).catch((e)=>{ console.error(e); empty.hidden=false; empty.textContent='로그인 실패로 데이터를 볼 수 없어요.'; });
  });

  function startMembers(){
    onSnapshot(
      collection(db,'members'),
      (snap)=>{
        const list=[];
        snap.forEach(ds=>{
          const d=ds.data();
          const recentReg =
            toISO(d.recentRegistrationAt) ||
            toISO(d.lastRegisterAt) ||
            toISO(d.lastReenrollAt) ||
            toISO(d.lastPurchaseAt) || "";
          list.push({
            id: ds.id,
            name: d.name || "",
            trainer: d.trainer || "",
            grade: d.level || d.grade || "",
            level: d.level || "",
            first: d.startDate || toISO(d.createdAt) || "",
            recentReg,
            expireAt: toISO(d.expireAt),
            lastLog:  toISO(d.lastLogAt) || toISO(d.lastPurchaseAt),
            logCount: d.logCount || 0,
            remaining: d.remainingSessions ?? 0,
            total: d.totalSessionsPurchased ?? d.totalSessions ?? 0,
            expiredFlag: Boolean(d.expiredFlag),
            gender: d.gender || null
          });
        });
        state.members=list;

        if (openOverlayId){
          const m = state.members.find(x=>x.id===openOverlayId);
          if (m) openOverlay(m);
        }

        const expiredCount = state.members.filter(m=>isExpired(m)).length;
        expiredToggleBtn.textContent = `${state.showExpiredOnly ? '전체 보기' : '만료 회원만 보기'} (${expiredCount})`;
        filterSort();
      },
      (err)=>{ console.error(err); empty.hidden=false; empty.textContent='데이터를 불러오지 못했어요. (권한/네트워크 확인)'; }
    );
  }
  </script>
</body>
</html>
