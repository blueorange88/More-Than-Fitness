<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>고객 카드 – 바인더 선반</title>
<style>
  :root{
    --navy:#0B1E3A; --gold:#C8A848; --ink:#0b1220; --muted:#6b7280;
    --line:#e5e7eb; --card:#ffffff; --danger:#ef4444; --danger-bg:#fee2e2;
    --ok:#2563eb; --track:#e5e7eb;
    --shelf:#f3f4f6; --shelf-edge:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(#fff,#fbfbfb); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  }

  /* ===== Header / Tools ===== */
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(#fff,#f9fafb);
    border-bottom:2px solid var(--gold);
    padding:14px 16px 12px;
  }
  header h1{margin:0 0 10px; font-size:18px; color:var(--navy);}
  .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tools input[type="search"]{
    flex:1; min-width:220px; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; font-size:14px; background:#fff;
  }
  .tools .group{display:flex;gap:8px; align-items:center; font-size:13px; color:var(--navy)}
  .tools select, .tools button{
    border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px; cursor:pointer;
  }
  .tools button.tgl{min-width:84px}
  .back{
    margin-left:auto; border-color:#cbd5e1; background:#0B1E3A; color:#fff; font-weight:700;
  }

  /* ===== Shelf ===== */
  .shelf-wrap{padding:18px 0 28px}
  .shelf{
    position:relative; display:flex; gap:0; padding:26px 22px;
    overflow-x:auto; overflow-y:visible; scrollbar-width:thin;
    perspective:1200px; background:
      linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02)) padding-box,
      linear-gradient(#fff, #fff) border-box;
    border-top:1px solid var(--shelf-edge); border-bottom:1px solid var(--shelf-edge);
    background-color:var(--shelf);
  }
  .shelf::before, .shelf::after{
    content:""; position:sticky; left:0; width:40px; flex:0 0 40px; height:100%; pointer-events:none;
    background:linear-gradient(90deg,#f9fafb,rgba(249,250,251,0));
  }
  .shelf::after{ left:auto; right:0; background:linear-gradient(270deg,#f9fafb,rgba(249,250,251,0)); }

  /* ===== Binder (big, overlapped, 3D) ===== */
  .binder{
    position:relative; width:280px; height:460px;
    margin-left:-140px; /* 크게 겹치게 */
    border-radius:14px; cursor:pointer; user-select:none; outline:0;
    transform:translateZ(0) rotateY(-12deg) translateY(6px);
    transform-origin:left center;
    box-shadow:
      -8px 0 0 rgba(0,0,0,.06) inset,
      0 8px 20px rgba(0,0,0,.08);
    transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s, filter .28s, z-index .28s;
    background:linear-gradient(160deg, #9ec5ff 0%, #6aa0ff 55%, #3a6ddf 100%);
    border:1px solid rgba(0,0,0,.06);
    color:#0b1220;
  }
  .binder:first-child{ margin-left:8px; }
  .binder:hover, .binder:focus-visible{
    z-index:9;
    transform:translateY(-14px) rotateY(-2deg) scale(1.04);
    box-shadow:
      -10px 0 0 rgba(255,255,255,.18) inset,
      0 22px 40px rgba(0,0,0,.22);
    filter:saturate(1.05);
  }
  /* 스파인/구멍 */
  .binder::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:24px; border-radius:14px 0 0 14px;
    background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(0,0,0,.1));
    box-shadow:2px 0 6px rgba(0,0,0,.12) inset;
  }
  .holes{position:absolute; left:8px; bottom:18px; display:grid; gap:8px}
  .hole{width:8px; height:8px; border-radius:50%; background:rgba(0,0,0,.22); box-shadow:0 1px 0 rgba(255,255,255,.5) inset}

  /* 상단 이름/배지 */
  .head{display:flex; align-items:center; justify-content:space-between; padding:16px 16px 8px 36px}
  .name{font-weight:900; font-size:19px; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.35)}
  .name .suffix{margin-left:4px; font-weight:800; color:#1f2937; font-size:15px}
  .badges{display:flex; gap:6px; align-items:center}
  .badge{
    font-size:11px; padding:3px 8px; border-radius:999px; background:rgba(255,255,255,.65);
    border:1px solid rgba(0,0,0,.08); color:#1f2937; backdrop-filter:blur(2px);
  }
  .badge.danger{background:var(--danger-bg); border-color:var(--danger); color:#991b1b}
  .badge.cake{display:inline-flex; align-items:center; gap:4px}

  /* 내용 패널 (호버 시 앞으로 슬라이드) */
  .panel{
    position:absolute; right:10px; top:70px; bottom:12px; left:36px;
    background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.08);
    border-radius:12px; padding:12px; overflow:hidden;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    transform:translateZ(30px) translateX(8px) rotateY(6deg); opacity:.0;
    transition:opacity .25s, transform .28s;
    backdrop-filter: blur(6px);
  }
  .binder:hover .panel, .binder:focus-visible .panel{
    opacity:1; transform:translateZ(60px) translateX(0) rotateY(0deg);
  }
  .rows{font-size:13px; color:#374151; display:grid; gap:6px; margin-top:10px}
  .row{display:flex; gap:6px}
  .row .label{width:66px; color:#334155; font-weight:700}
  .row .value{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* 프로그레스 링 */
  .ring{
    --pct: 0; /* 0~100 */
    width:84px; height:84px; border-radius:50%;
    background:
      conic-gradient(var(--ok) calc(var(--pct)*1%), var(--track) 0);
    display:grid; place-items:center; margin:2px 8px 6px auto; border:6px solid rgba(255,255,255,.6);
    box-shadow:0 2px 10px rgba(0,0,0,.08) inset, 0 6px 14px rgba(0,0,0,.08);
  }
  .ring.low{ --ok:#ef4444; }
  .ring .ring-label{background:#fff; border-radius:999px; padding:6px 8px; font-size:12px; font-weight:900; border:1px solid #e5e7eb}

  .stats{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .pill{border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff}
  .pill strong{font-weight:900}
  .pill.remain{border-color:#60a5fa; background:#eff6ff}
  .pill.remain.low{border-color:#ef4444; background:#fee2e2; color:#991b1b}
  .pill.total{border-color:#d1d5db; background:#f9fafb}

  /* 빠른 액션(호버 시 등장) */
  .actions{
    position:absolute; left:36px; right:10px; bottom:14px;
    display:flex; gap:8px; opacity:0; transform:translateY(6px);
    transition:opacity .2s, transform .2s;
  }
  .binder:hover .actions, .binder:focus-visible .actions{ opacity:1; transform:translateY(0); }
  .actions button{
    flex:1; border:1px solid rgba(0,0,0,.08); background:#0B1E3A; color:#fff;
    border-radius:10px; padding:9px 10px; font-size:13px; cursor:pointer; font-weight:800;
    box-shadow:0 8px 18px rgba(11,30,58,.18);
  }
  .actions .light{ background:#fff; color:#0B1E3A; }

  /* 잔여 0 강조 + 전체 카드 경고 */
  .binder.zero{
    box-shadow:
      -12px 0 0 rgba(239,68,68,.15) inset,
      0 22px 40px rgba(239,68,68,.25);
    filter:saturate(1.05) contrast(1.03);
  }

  /* 색상 파레트 (이름 해시로 바인더 색 바뀜) */
  .c1{background:linear-gradient(160deg,#a7f3d0,#34d399,#059669)}
  .c2{background:linear-gradient(160deg,#fde68a,#fbbf24,#d97706)}
  .c3{background:linear-gradient(160deg,#bfdbfe,#60a5fa,#2563eb)}
  .c4{background:linear-gradient(160deg,#fbcfe8,#f472b6,#db2777)}
  .c5{background:linear-gradient(160deg,#ddd6fe,#a78bfa,#7c3aed)}
  .c6{background:linear-gradient(160deg,#fecaca,#f87171,#ef4444)}
  .c7{background:linear-gradient(160deg,#c7d2fe,#818cf8,#4f46e5)}

  /* Empty */
  .empty{padding:40px 16px; text-align:center; color:var(--muted)}
</style>
</head>
<body>
  <header>
    <h1>개인 트레이닝 – 바인더 서류철</h1>
    <div class="tools">
      <input id="q" type="search" placeholder="이름 / 담당 / 등급 검색" />
      <div class="group">
        정렬:
        <select id="sortBy" aria-label="정렬">
          <option value="name" selected>이름(가나다·영문·숫자)</option>
          <option value="recent">최근 작성</option>
          <option value="remain">잔여 세션</option>
          <option value="first">최초 등록일</option>
          <option value="expire">만료일</option>
        </select>
        <button id="orderBtn" class="tgl" aria-pressed="false">오름차순 ↑</button>
      </div>
      <button id="btnDash" class="back" onclick="location.href='dashboard.html'">대시보드로</button>
    </div>
  </header>

  <section class="shelf-wrap">
    <div id="shelf" class="shelf" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>
  </section>

  <script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, increment,
    query, where, /*orderBy, limit,*/ getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  /* ===== Firestore ===== */
  const firebaseConfig = {
    apiKey:"AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain:"more-than-fitness-f6adb.firebaseapp.com",
    projectId:"more-than-fitness-f6adb",
    storageBucket:"more-than-fitness-f6adb.appspot.com",
    messagingSenderId:"993248877411",
    appId:"1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId:"G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ===== DOM ===== */
  const shelf = document.getElementById('shelf');
  const empty = document.getElementById('empty');
  const qEl   = document.getElementById('q');
  const sortSel = document.getElementById('sortBy');
  const orderBtn = document.getElementById('orderBtn');

  /* ===== Utils ===== */
  const collator = new Intl.Collator('ko-KR',{numeric:true,sensitivity:'base'});
  const escapeHtml = s => String(s??"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const p2 = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
  const nowHM = () => { const d=new Date(); return `${p2(d.getHours())}:${p2(d.getMinutes())}`; };
  const toISO = ts => ts?.toDate ? ts.toDate().toISOString().slice(0,10) : (typeof ts==='string'? ts : "");
  // 다음 생일/기념일까지 D-day (<=30이면 숫자, 아니면 null)
  function daysUntilAnnual(dateStr){
    if(!dateStr) return null;
    const [y,m,d] = dateStr.split('-').map(Number); if(!m||!d) return null;
    const now = new Date();
    const tgt = new Date(now.getFullYear(), m-1, d);
    if (tgt < new Date(now.getFullYear(), now.getMonth(), now.getDate())) tgt.setFullYear(now.getFullYear()+1);
    const diff = Math.ceil((tgt - now)/86400000);
    return diff<=30 ? diff : null;
  }
  // 이름 해시 → 색상 클래스
  const COLORS = ['c1','c2','c3','c4','c5','c6','c7'];
  const colorClass = name => COLORS[Math.abs([...String(name||'')].reduce((a,c)=> (a*31 + c.charCodeAt(0))|0,7)) % COLORS.length];

  // 다음 예약 조회 (memberId 기준)
 async function fetchNextSchedule(memberId){
  try{
    // where만 사용 (orderBy/limit 제거 → 인덱스 필요 없음)
    const qy = query(collection(db,'schedules'), where('memberId','==', memberId));
    const snap = await getDocs(qy);

    const today = todayISO(), now = nowHM();
    const list = [];
    snap.forEach(ds=>{
      const s = ds.data();
      const d = String(s.date||''); const st = String(s.start||'00:00');
      if (d > today || (d===today && st >= now)) list.push({date:d,start:st});
    });
    list.sort((a,b)=> (a.date===b.date ? a.start.localeCompare(b.start) : a.date.localeCompare(b.date)));
    return list[0] ? `${list[0].date} ${list[0].start}` : null;
  }catch(e){
    console.error(e);
    return null;
  }
}

  /* ===== State ===== */
  let state = {
    orderAsc: true,
    members: []
  };

  /* ===== Render ===== */
  function render(list){
    shelf.innerHTML = '';
    if(!list.length){ empty.hidden = false; return; }
    empty.hidden = true;

    list.forEach(m=>{
      const cls = ['binder', colorClass(m.name)];
      const lowRemain = (m.remaining ?? 0) <= 3;
      if ((m.remaining ?? 0) <= 0) cls.push('zero');

      const art = document.createElement('article');
      art.className = cls.join(' ');
      art.tabIndex = 0;
      art.setAttribute('role','button');
      art.setAttribute('aria-label', `${m.name} 고객 카드`);

      // 상단 배지: 만료 임박, 최근작성, 생일/기념일
      const dLeft = m.expireAt ? Math.ceil((new Date(m.expireAt) - new Date(todayISO()))/86400000) : null;
      let rightBadge = `<span class="badge">${escapeHtml(m.grade||"")}</span>`;
      if (m.lastLog) rightBadge = `<span class="badge">최근 ${m.lastLog}</span>`;
      if (dLeft !== null && dLeft <= 7) rightBadge = `<span class="badge danger">만료 D-${Math.max(dLeft,0)}</span>`;

      // 생일/기념일 (30일 이내)
      const cakeDays = daysUntilAnnual(m.birthday) ?? daysUntilAnnual(m.anniversary);
      const cakeBadge = cakeDays!==null ? `<span class="badge cake">🎂 D-${cakeDays}</span>` : '';

      art.innerHTML = `
        <div class="head">
          <div class="name">${escapeHtml(m.name)} <span class="suffix">고객님</span></div>
          <div class="badges">
            ${cakeBadge}
            ${rightBadge}
          </div>
        </div>

        <div class="panel">
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="ring ${lowRemain?'low':''}" style="--pct:${Math.max(0,Math.min(100, Math.round(((m.remaining||0)/(m.total||1))*100)))}">
              <div class="ring-label">${m.remaining||0}/${m.total||0}</div>
            </div>
            <div class="rows" style="flex:1">
              <div class="row"><span class="label">담당</span><span class="value">${escapeHtml(m.trainer||"-")}</span></div>
              <div class="row"><span class="label">등급</span><span class="value">${escapeHtml(m.grade||"-")}</span></div>
              <div class="row"><span class="label">등록일</span><span class="value">${m.first||"-"}</span></div>
              <div class="row"><span class="label">만료일</span><span class="value">${m.expireAt||"-"}</span></div>
              <div class="row"><span class="label">작성</span><span class="value">${m.logCount||0}회</span></div>
              <div class="row"><span class="label">다음예약</span><span class="value" id="nx-${m.id}">조회 중…</span></div>
            </div>
          </div>

          <div class="stats" aria-label="세션 현황">
            <div class="pill remain ${lowRemain?'low':''}">잔여 <strong>${m.remaining||0}</strong></div>
            <div class="pill total">총 <strong>${m.total||0}</strong></div>
          </div>
        </div>

        <div class="actions">
          <button class="light" data-act="journal">일지 열기</button>
          <button class="light" data-act="extend">연장 등록</button>
          <button data-act="consume">소진 -1</button>
        </div>

        <div class="holes">
          <div class="hole"></div><div class="hole"></div><div class="hole"></div>
        </div>
      `;

      // 액션들
      art.querySelector('[data-act="journal"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
      });
      art.querySelector('[data-act="extend"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        location.href = `edit-member.html?id=${encodeURIComponent(m.id)}`;
      });
      art.querySelector('[data-act="consume"]').addEventListener('click', async (e)=>{
        e.stopPropagation();
        if ((m.remaining||0) <= 0){ alert('잔여 세션이 없습니다'); return; }
        try{
          await updateDoc(doc(db,'members',m.id), { remainingSessions: increment(-1) });
        }catch(err){ console.error(err); alert('소진 처리 실패'); }
      });

      // 카드 클릭 → 일지
      art.addEventListener('click', ()=>{
        location.href = `personal-training-log.html?id=${encodeURIComponent(m.id)}`;
      });

      // 다음 예약 비동기 로드 (호버할 때만 조회 → 가볍게)
      let fetched = false;
      const ensureNext = async ()=>{
        if (fetched) return;
        fetched = true;
        const nx = await fetchNextSchedule(m.id);
        const tgt = art.querySelector(`#nx-${m.id}`);
        if (tgt) tgt.textContent = nx || '-';
      };
      art.addEventListener('mouseenter', ensureNext, {passive:true});
      art.addEventListener('focus', ensureNext, {passive:true});

      shelf.appendChild(art);
    });
  }

  function filterSort(){
    const kw = (qEl.value||'').trim().toLowerCase();
    const norm = s => String(s||'').toLowerCase();

    let list = state.members.filter(m=>{
      return !kw
        || norm(m.name).includes(kw)
        || norm(m.trainer).includes(kw)
        || norm(m.grade).includes(kw);
    });

    const by = sortSel.value;
    const dir = state.orderAsc ? 1 : -1;

    list.sort((a,b)=>{
      if(by==='name')   return dir * collator.compare(a.name, b.name);
      if(by==='recent') return dir * ( (b.lastLog||'').localeCompare(a.lastLog||'') );
      if(by==='remain') return dir * ( (a.remaining||0) - (b.remaining||0) );
      if(by==='first')  return dir * ( (a.first||'').localeCompare(b.first||'') );
      if(by==='expire') return dir * ( (a.expireAt||'').localeCompare(b.expireAt||'') );
      return 0;
    });

    render(list);
  }

  orderBtn.addEventListener('click', ()=>{
    state.orderAsc = !state.orderAsc;
    orderBtn.textContent = state.orderAsc ? '오름차순 ↑' : '내림차순 ↓';
    orderBtn.setAttribute('aria-pressed', String(!state.orderAsc));
    filterSort();
  });
  qEl.addEventListener('input', filterSort);
  sortSel.addEventListener('change', filterSort);

  /* ===== Subscribe members ===== */

  // ---- Firestore 구독을 시작하는 함수 ----
  function subscribeMembers(){
    onSnapshot(
      collection(db,'members'),
      (snap)=>{
        const list=[];
        snap.forEach(ds=>{
          const d=ds.data();
          const toISO=ts=>ts?.toDate?ts.toDate().toISOString().slice(0,10):(typeof ts==='string'?ts:"");
          list.push({
            id: ds.id,
            name: d.name || "",
            trainer: d.trainer || "",
            grade: d.level || d.grade || "",
            first: d.startDate || toISO(d.createdAt) || "",
            expireAt: toISO(d.expireAt),
            lastLog:  toISO(d.lastLogAt) || toISO(d.lastPurchaseAt),
            logCount: d.logCount || 0,
            remaining: d.remainingSessions ?? 0,
            total: d.totalSessionsPurchased ?? d.totalSessions ?? 0,
            birthday: toISO(d.birthday),
            anniversary: toISO(d.anniversary)
          });
        });
        state.members=list;
        filterSort();
      },
      (err)=>{
        console.error(err);
        const empty=document.getElementById('empty');
        empty.textContent = '데이터를 불러오지 못했어요. (권한/네트워크 확인)';
        empty.hidden = false;
      }
    );
  }

  // ---- 익명 로그인 후 구독 시작 ----
  const auth = getAuth(app);
  onAuthStateChanged(auth, (u)=>{
    if (u) {
      subscribeMembers();
    } else {
      signInAnonymously(auth).catch((e)=>{
        console.error(e);
        const empty=document.getElementById('empty');
        empty.textContent='로그인 실패로 데이터를 볼 수 없어요.';
        empty.hidden=false;
      });
    }
  });
  </script>
</body>
</html>
