<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>회원 목록 · 수정</title>
<style>
  :root{ --ink:#0d1b2a; --bg:#f5f0e8; --card:#fff; --line:#e5e7eb; --brand:#0d1b2a; --gold:#cfa35e; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,var(--bg));border-bottom:2px solid var(--gold);padding:12px 14px}
  h1{margin:0 0 8px;font-size:18px}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tools input[type="search"]{flex:1;min-width:180px;border:1px solid var(--line);border-radius:10px;padding:9px 10px;background:#fff}
  .tools select{border:1px solid var(--line);border-radius:10px;padding:9px 10px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn-primary{border-color:var(--brand);color:var(--brand);font-weight:700}
  main{padding:12px}
  /* 리스트 */
  .list{display:flex;flex-direction:column;gap:10px}
  .row{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
  .edit{flex:0 0 auto;border:1px solid var(--line);border-radius:999px;background:#fff;padding:6px 9px;cursor:pointer}
  .meta{flex:1 1 auto;min-width:0}
  .name{font-weight:800;display:flex;align-items:center;gap:6px}
  .badge{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 7px}
  .badge.vip{border-color:var(--gold);color:#8a6d1d;background:#fff8e6}
  .sub{font-size:13px;color:#64748b;display:flex;gap:10px;flex-wrap:wrap}
  .right{flex:0 0 auto;text-align:right;font-size:12px;color:#475569}
  .danger{color:var(--danger)}
  .empty{padding:40px 8px;text-align:center;color:#64748b}
</style>
</head>
<body>
<header>
  <h1>회원 목록 · 수정</h1>
  <div class="tools">
    <input id="q" type="search" placeholder="이름/연락처/담당/등급 검색" />
    <select id="sortBy" aria-label="정렬">
      <option value="recent" selected>최근 작성순</option>
      <option value="name">이름(가나다)</option>
      <option value="grade">등급</option>
      <option value="first">최초 등록일</option>
    </select>
    <button class="btn btn-primary" id="btnNew">+ 신규 등록</button>
  </div>
</header>

<main>
  <div id="list" class="list" aria-live="polite"></div>
  <div id="empty" class="empty" hidden>등록된 회원이 없습니다.</div>
</main>

<script type="module">
  /* ========== Firebase ========== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  onAuthStateChanged(auth, u => { if(!u) signInAnonymously(auth).catch(console.error); });

  /* ========== DOM refs ========== */
  const listEl  = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const qEl     = document.getElementById('q');
  const sortSel = document.getElementById('sortBy');
  document.getElementById('btnNew').onclick = ()=> location.href = "/member-registration.html";

  /* ========== Utils ========== */
  const onlyDigits = s => String(s||"").replace(/\D/g,"");
  const fmtPhone = raw => {
    const v = onlyDigits(raw).slice(0,11);
    if (v.length<=3) return v;
    if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
    return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  };
  const toISO = d => d instanceof Date
    ? new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10)
    : "";
  const toDateStr = v => {
    try { const d = v?.toDate ? v.toDate() : (v ? new Date(v) : null); return d ? toISO(d) : ""; }
    catch { return ""; }
  };
  const daysUntil = (dateStr) => {
    if(!dateStr) return null;
    const d = new Date(dateStr+'T00:00:00');
    const today = new Date(); today.setHours(0,0,0,0);
    return Math.ceil((d - today)/86400000);
  };

  /* ========== State ========== */
  let members = [];

  function render(){
    listEl.innerHTML = "";
    // 검색 & 정렬
    const keyword = (qEl.value||"").trim().toLowerCase();
    const norm = s => String(s||"").toLowerCase();

    let rows = members.filter(m=>{
      if(!keyword) return true;
      const phoneMatch = onlyDigits(m.phone||m.phoneDisplay||"").includes(onlyDigits(keyword));
      return norm(m.name).includes(keyword)
          || norm(m.trainer).includes(keyword)
          || norm(m.level).includes(keyword)
          || phoneMatch;
    });

    const by = sortSel.value;
    rows.sort((a,b)=>{
      if(by==='recent') return (b.lastLog || '').localeCompare(a.lastLog || '');
      if(by==='name')   return a.name.localeCompare(b.name, 'ko');
      if(by==='grade')  return (a.level||'').localeCompare(b.level||'', 'ko');
      if(by==='first')  return (b.first || '').localeCompare(a.first || '');
      return 0;
    });

    if (!rows.length){ emptyEl.hidden = false; return; }
    emptyEl.hidden = true;

    rows.forEach(m=>{
      const dLeft = daysUntil(m.expireAt);
      const badgeCls = (m.level||"").toLowerCase()==='vip' ? 'badge vip' : 'badge';
      const right = dLeft!==null && dLeft<=7
        ? `<div class="right"><div class="danger">만료 D-${Math.max(0,dLeft)}</div><div>${m.expireAt||""}</div></div>`
        : `<div class="right"><div>남은 회차 ${m.remaining||0}</div><div>${m.expireAt||""}</div></div>`;

      const row = document.createElement('div');
      row.className = 'row';

      // ✏️ 수정 버튼 (이름 앞)
      const btn = document.createElement('button');
      btn.className = 'edit';
      btn.setAttribute('aria-label', `${m.name} 수정`);
      btn.textContent = '✏️';
      btn.onclick = (e)=>{ e.stopPropagation(); goEdit(m.id); };

      // 중앙 메타
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <div class="name">
          <span>${m.name}</span>
          ${m.level ? `<span class="${badgeCls}">${m.level}</span>` : ""}
        </div>
        <div class="sub">
          <span>${fmtPhone(m.phone || m.phoneDisplay || "")}</span>
          <span>${m.trainer || "-"}</span>
          <span>${m.lessonType || "-"}</span>
          ${m.first ? `<span>등록 ${m.first}</span>` : ""}
          ${m.lastLog ? `<span>최근작성 ${m.lastLog}</span>` : ""}
        </div>
      `;

      // 우측
      const rightBox = document.createElement('div');
      rightBox.innerHTML = right;

      // 행 클릭해도 수정으로
      row.onclick = ()=> goEdit(m.id);

      row.append(btn, meta, rightBox);
      listEl.appendChild(row);
    });
  }

  function goEdit(id){
    localStorage.setItem("editMemberId", id);
    location.href = `/edit-member.html?mid=${encodeURIComponent(id)}`;
  }

  // 실시간 구독
  onSnapshot(collection(db, "members"), (snap)=>{
    const arr = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
      const startStr  = d.startDate || (createdAt ? toISO(createdAt) : "");
      const expireStr = d.expireAt?.toDate ? toISO(d.expireAt.toDate()) : (d.expireAt || "");
      const lastLog   = d.lastLogAt?.toDate ? toISO(d.lastLogAt.toDate()) : (d.lastPurchaseAt?.toDate ? toISO(d.lastPurchaseAt.toDate()) : "");

      arr.push({
        id: docSnap.id,
        name: d.name || "",
        phone: d.phone || d.phoneDisplay || "",
        trainer: d.trainer || "",
        lessonType: d.lessonType || d.type || "",
        level: d.level || d.grade || "",
        first: startStr,
        expireAt: expireStr,
        lastLog,
        remaining: Number(d.remainingSessions||0)
      });
    });
    members = arr;
    render();
  });

  qEl.addEventListener('input', render);
  sortSel.addEventListener('change', render);
</script>
</body>
</html>
