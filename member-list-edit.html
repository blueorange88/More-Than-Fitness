<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>회원 목록 · 수정</title>
<style>
  :root{--ink:#0d1b2a;--bg:#f5f0e8;--card:#fff;--line:#e5e7eb;--brand:#0d1b2a;--brand2:#cfa35e;--danger:#ef4444;--danger-bg:#fee2e2}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  .wrap{max-width:980px;margin:14px auto;padding:0 10px}
  .bar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .bar .title{font-weight:800;font-size:18px;margin-right:auto}
  .bar input[type="search"]{flex:1;min-width:180px;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .bar select,.bar button{padding:9px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .bar .primary{border-color:var(--brand);color:var(--brand);font-weight:700}
  .banner{display:none;margin:6px 0;padding:10px 12px;border-radius:10px}
  .banner.error{display:block;background:var(--danger-bg);border:1px solid var(--danger);color:#991b1b}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;gap:10px;align-items:center;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
  .edit-btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:#374151}
  .name{font-weight:800}
  .empty{padding:40px 0;color:#6b7280;text-align:center}
  @media (max-width:560px){
    .item{padding:10px}
    .meta{gap:6px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="title">회원 목록 · 수정</div>
    <input id="q" type="search" placeholder="이름·전화·트레이너 검색" />
    <select id="sort">
      <option value="recent">최근 작성순</option>
      <option value="name">이름순</option>
      <option value="remain">남은 회차 많은순</option>
    </select>
    <button id="btnNew" class="primary">+ 신규 등록</button>
  </div>

  <div id="banner" class="banner error"></div>
  <div id="status" class="empty">불러오는 중…</div>
  <div id="list" class="list" hidden></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  const $ = s=>document.querySelector(s);
  const banner = $("#banner");
  const statusEl = $("#status");
  const listEl = $("#list");
  const qEl = $("#q");
  const sortEl = $("#sort");
  $("#btnNew").onclick = ()=> location.href = "/member-registration.html";

  const onlyDigits = s=> String(s||"").replace(/\D/g,"");
  const fmtPhone = raw=>{
    const v=onlyDigits(raw).slice(0,11);
    if(v.length<=3) return v;
    if(v.length<=7) return v.slice(0,3)+"-"+v.slice(3);
    return v.slice(0,3)+"-"+v.slice(3,7)+"-"+v.slice(7);
  };
  const toDateValue = (v)=>{
    try{
      const d = v?.toDate ? v.toDate() : (v ? new Date(v) : null);
      return d ? new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10) : "";
    }catch{ return ""; }
  };

  let ALL = [];  // 전체 캐시

  // ✅ 익명 로그인 '완료'를 기다렸다가 로드
  await ensureAuthed();
  await loadMembers();
  render();

  async function ensureAuthed(){
    const ready = new Promise(resolve=>{
      onAuthStateChanged(auth, async (u)=>{
        if (u) return resolve(u);
        try{
          const cred = await signInAnonymously(auth);
          resolve(cred.user);
        }catch(e){
          console.error(e);
          resolve(null);
        }
      });
    });
    return ready;
  }

  async function loadMembers(){
    banner.style.display = "none";
    statusEl.textContent = "불러오는 중…";
    listEl.hidden = true;

    try{
      const snap = await getDocs(collection(db, "members")); // 서버 정렬 대신 전부 읽고 클라에서 정렬
      ALL = [];
      snap.forEach(docSnap=>{
        const x = docSnap.data();
        ALL.push({
          id: docSnap.id,
          name: x.name || "(이름없음)",
          phone: x.phoneDisplay || fmtPhone(x.phone||docSnap.id),
          gender: x.gender || "",
          trainer: x.trainer || "",
          lessonType: x.lessonType || "",
          level: x.level || "",
          remaining: Number(x.remainingSessions||0),
          total: Number(x.totalSessionsPurchased||0),
          createdAt: x.createdAt || null,
          lastPurchaseAt: x.lastPurchaseAt || null,
        });
      });
      if (ALL.length===0){
        statusEl.textContent = "등록된 회원이 없습니다.";
        return;
      }
      statusEl.textContent = "";
      listEl.hidden = false;
    }catch(e){
      console.error(e);
      banner.textContent = (e.code==="permission-denied")
        ? "읽기 권한 오류: Firebase Authentication(익명 로그인)과 보안 규칙을 확인하세요."
        : ("로드 실패: " + e.message);
      banner.style.display = "block";
      statusEl.textContent = "불러오기 실패";
    }
  }

  function render(){
    const q = (qEl.value || "").trim().toLowerCase();
    const sortBy = sortEl.value;

    let rows = ALL.filter(m=>{
      if (!q) return true;
      return (
        (m.name||"").toLowerCase().includes(q) ||
        (m.phone||"").replaceAll("-","").includes(q.replaceAll("-","")) ||
        (m.trainer||"").toLowerCase().includes(q) ||
        (m.lessonType||"").toLowerCase().includes(q)
      );
    });

    // 정렬 (클라이언트)
    if (sortBy==="name"){
      rows.sort((a,b)=>a.name.localeCompare(b.name));
    } else if (sortBy==="remain"){
      rows.sort((a,b)=> (b.remaining||0) - (a.remaining||0));
    } else { // recent
      rows.sort((a,b)=>{
        const ad = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
        const bd = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
        return bd - ad;
      });
    }

    listEl.innerHTML = "";
    if (rows.length===0){
      statusEl.textContent = "검색 결과가 없습니다.";
      listEl.hidden = true;
      return;
    }
    statusEl.textContent = "";
    listEl.hidden = false;

    for (const m of rows){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <button class="edit-btn" data-id="${m.id}" aria-label="수정">✏️</button>
        <div>
          <div class="name">${escape(m.name)} <small style="color:#6b7280">(${escape(m.level||"")})</small></div>
          <div class="meta">
            <span>${escape(m.phone)}</span>
            ${m.trainer?`<span>담당: ${escape(m.trainer)}</span>`:""}
            ${m.lessonType?`<span>유형: ${escape(m.lessonType)}</span>`:""}
            <span>남은회차 ${m.remaining}/${m.total}</span>
            ${m.createdAt?`<span>등록 ${escape(toDateValue(m.createdAt))}</span>`:""}
          </div>
        </div>
      `;
      div.querySelector(".edit-btn").onclick = ()=>{
        // edit-member.html 로 이동
        const id = m.id;
        // URL 파라미터 + 로컬 스토리지(백업) 둘 다 지원
        localStorage.setItem("editMemberId", id);
        location.href = `/edit-member.html?mid=${encodeURIComponent(id)}`;
      };
      listEl.appendChild(div);
    }
  }

  qEl.addEventListener("input", ()=>render());
  sortEl.addEventListener("change", ()=>render());

  function escape(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
</script>
</body>
</html>
