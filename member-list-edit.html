<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>회원 목록 · 수정</title>
<style>
  :root{ --ink:#0d1b2a; --bg:#f5f0e8; --card:#fff; --line:#e5e7eb; --brand:#0d1b2a; --brand2:#cfa35e; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(#fff, var(--bg));padding:12px;border-bottom:2px solid var(--brand2);z-index:5}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="search"]{flex:1;min-width:160px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn-primary{border-color:var(--brand);color:var(--brand);font-weight:700}
  .btn-primary:hover{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
  main{max-width:960px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);overflow:hidden}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{position:sticky;top:0;background:#0d1b2a;color:#fff;padding:10px}
  td,th{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:middle}
  tbody tr:hover{background:#faf7ef}
  .edit-btn{background:#fff;border:1px solid var(--line);border-radius:8px;padding:6px 8px;cursor:pointer}
  .edit-btn:active{transform:scale(.98)}
  .muted{color:#6b7280}
  .meta{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid var(--line);background:#fff}
  /* 모바일: 첫 칸(수정 버튼) 고정 폭 */
  col.editcol{width:52px}
  @media (max-width:640px){
    table{font-size:13px}
    td.phone{white-space:nowrap}
    td.badge{white-space:nowrap}
  }
</style>
</head>
<body>
<header>
  <div class="row">
    <input id="q" type="search" placeholder="이름/연락처/담당/등급 검색" />
    <select id="sortBy" class="btn" aria-label="정렬">
      <option value="recent">최근 수정순</option>
      <option value="name">이름(가나다)</option>
      <option value="level">등급</option>
      <option value="created">등록일 최신</option>
    </select>
    <button class="btn btn-primary" onclick="location.href='/member-registration.html'">+ 신규 등록</button>
  </div>
</header>

<main>
  <div class="card">
    <table id="tbl">
      <colgroup>
        <col class="editcol" />
        <col /><col /><col /><col /><col />
      </colgroup>
      <thead>
        <tr>
          <th>수정</th>
          <th>이름</th>
          <th>연락처</th>
          <th>담당</th>
          <th>레슨</th>
          <th>등급</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <!-- rows -->
      </tbody>
    </table>
    <div class="meta"><span id="count" class="muted">0명</span><span class="muted">문서ID = 숫자만 전화번호</span></div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  onAuthStateChanged(auth, u=>{ if(!u) signInAnonymously(auth).catch(console.error); });

  const $ = s=>document.querySelector(s);
  const qinp = $("#q");
  const sortSel = $("#sortBy");
  const tbody = $("#tbody");
  const countEl = $("#count");

  let all = [];

  const fmtPhone = raw=>{
    const v = String(raw||"").replace(/\D/g,"").slice(0,11);
    if(v.length<=3) return v;
    if(v.length<=7) return v.slice(0,3)+"-"+v.slice(3);
    return v.slice(0,3)+"-"+v.slice(3,7)+"-"+v.slice(7);
  };

  function render(){
    const keyword = (qinp.value||"").trim().toLowerCase();
    const norm = s=>String(s||"").toLowerCase();
    let list = all.filter(m=>{
      const phoneHit = fmtPhone(m.phoneDisplay||m.phone).replace(/\D/g,"").includes(keyword.replace(/\D/g,""));
      return !keyword
        || norm(m.name).includes(keyword)
        || phoneHit
        || norm(m.trainer).includes(keyword)
        || norm(m.lessonType).includes(keyword)
        || norm(m.level).includes(keyword);
    });

    const by = sortSel.value;
    list.sort((a,b)=>{
      if(by==='name')   return a.name.localeCompare(b.name,'ko');
      if(by==='level')  return (a.level||"").localeCompare(b.level||"",'ko');
      if(by==='created')return (b.createdAt||"").localeCompare(a.createdAt||"");
      // recent: updatedAt desc
      return (b.updatedAt||"").localeCompare(a.updatedAt||"");
    });

    tbody.innerHTML = "";
    list.forEach(x=>{
      const tr = document.createElement("tr");

      const btn = document.createElement("button");
      btn.className = "edit-btn"; btn.title = "수정";
      btn.textContent = "✏️";
      btn.onclick = (e)=>{ e.stopPropagation(); goEdit(x.id); };

      const td0 = document.createElement("td"); td0.append(btn);
      const td1 = document.createElement("td"); td1.textContent = x.name||"";
      const td2 = document.createElement("td"); td2.className="phone"; td2.textContent = fmtPhone(x.phoneDisplay||x.phone||"");
      const td3 = document.createElement("td"); td3.textContent = x.trainer||"";
      const td4 = document.createElement("td"); td4.textContent = x.lessonType||"";
      const td5 = document.createElement("td"); td5.textContent = x.level||"";

      tr.append(td0,td1,td2,td3,td4,td5);
      tr.style.cursor = "pointer";
      tr.onclick = ()=> goEdit(x.id);
      tbody.appendChild(tr);
    });
    countEl.textContent = `${list.length}명`;
  }

  function goEdit(id){
    // 쿼리스트링 + fallback(localStorage)
    localStorage.setItem("editMemberId", id);
    location.href = `/member-registration.html?mid=${encodeURIComponent(id)}`;
  }

  qinp.addEventListener("input", render);
  sortSel.addEventListener("change", render);

  // realtime fetch
  onSnapshot(query(collection(db,"members")), (snap)=>{
    const rows = [];
    snap.forEach(d=>{
      const x = d.data();
      const toISO = v=>{ try{ return v?.toDate ? v.toDate().toISOString() : "" }catch{return ""} };
      rows.push({
        id: d.id,
        name: x.name||"",
        phone: x.phone||"",
        phoneDisplay: x.phoneDisplay||"",
        trainer: x.trainer||"",
        lessonType: x.lessonType||"",
        level: x.level||"",
        createdAt: toISO(x.createdAt),
        updatedAt: toISO(x.updatedAt),
      });
    });
    all = rows;
    render();
  });
</script>
</body>
</html>
