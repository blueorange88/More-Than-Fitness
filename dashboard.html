<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>More Than Fitness - Dashboard</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{display:flex;flex-direction:column;height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:#f5f0e8;overflow:hidden}
  .topbar{position:fixed;top:0;left:0;right:0;height:50px;background:#f5f0e8;display:flex;align-items:center;justify-content:space-between;padding:0 15px;box-shadow:0 2px 4px rgba(0,0,0,.1);z-index:1001}
  .topbar h1{font-size:18px;color:#0d1b2a}
  .hamburger,.logout-btn{background:none;border:none;cursor:pointer;font-size:20px;color:#0d1b2a}
  .sidebar{position:fixed;top:50px;left:0;bottom:0;width:180px;background:#0d1b2a;color:#fff;padding:15px;transform:translateX(-100%);transition:transform .3s ease;z-index:1002}
  .sidebar.active{transform:translateX(0)}
  .sidebar button{display:block;background:none;border:none;color:#fff;width:100%;text-align:left;margin:8px 0;cursor:pointer;font-size:14px}
  .submenu button{background:none;border:none;color:#ccc;width:100%;text-align:left;margin:4px 0;padding-left:16px;font-size:13px;cursor:pointer}
  .main{margin-top:50px;flex:1;overflow-y:auto;padding:8px 8px 60px}
  .today-lessons{background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:8px}
  .today-lessons h2{font-size:16px;color:#0d1b2a;margin-bottom:4px}
  .today-lessons ul{padding-left:16px}
  .today-lessons li{overflow-wrap:break-word;word-break:break-all;margin-bottom:4px}
  .section-title{margin:8px 0 4px;font-size:14px;color:#0d1b2a}
  .schedule-wrapper{background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:16px;overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:12px}
  @media (min-width:768px){table{min-width:600px}}
  @media (max-width:767px){
    .schedule-wrapper{overflow-x:auto}
    .schedule-wrapper table{table-layout:fixed;min-width:unset}
    .schedule-wrapper th,.schedule-wrapper td{word-wrap:break-word;white-space:normal}
    #quickRegisterCard{width:90%!important;right:5%!important;top:60px!important}
  }
  th,td{border:1px solid #ccc;padding:4px;text-align:center;position:relative;vertical-align:top}
  th{background:#0d1b2a;color:#fff}
  th:first-child{background:#0d3b5a;cursor:pointer}
  .time-cell{background:#f1f1f1;cursor:pointer}
  .status-chip{display:inline-block;margin-top:2px;padding:2px 6px;border-radius:999px;font-size:11px}
  .status-scheduled{background:#eef2ff;color:#374151;border:1px solid #c7d2fe}
  .status-attended{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  .status-noshow{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  .status-canceled{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
  .current-time-line{position:absolute;left:0;right:0;height:2px;background:#FF3B30;animation:pulse 5s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
  .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000}
  .popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:8px;z-index:1001;width:320px;max-width:92%;max-height:80vh;overflow:auto}
  .popup h3{font-size:15px;margin-bottom:8px}
  .popup label{display:block;font-size:12px;color:#334155;margin:6px 0 2px}
  .popup input,.popup select{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
  .button-group{display:flex;gap:8px;margin-top:10px}
  .button-group button{flex:1;padding:8px;background:#f5f0e8;border:1px solid #ddd;border-radius:6px;cursor:pointer}
  .bottom-right{position:fixed;bottom:12px;right:12px;z-index:999;display:flex;gap:6px}
  .btn-primary{background:#0d1b2a;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer}
  .gold{background:#d4af37;color:#0d1b2a;border:none;border-radius:6px;padding:8px 12px;cursor:pointer}

  /* 빠른등록 카드 */
  #quickRegisterCard{position:fixed;top:70px;right:20px;width:300px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.15);padding:16px;z-index:1000;display:none}
  #quickRegisterCard h3{font-size:16px;color:#0d1b2a;margin-bottom:12px}
  #quickRegisterCard label{font-size:12px;color:#334155}
  #quickRegisterCard input,#quickRegisterCard select{width:100%;margin:6px 0 10px;padding:8px;border:1px solid #ccc;border-radius:6px}

  /* 토스트(+Undo 버튼) */
  #toast{position:fixed;top:56px;left:50%;transform:translateX(-50%);background:#0d1b2a;color:#fff;padding:8px 12px;border-radius:14px;opacity:0;transition:opacity .2s;z-index:1100;font-size:12px;display:flex;align-items:center;gap:8px}
  #toast button{background:#fff;color:#0d1b2a;border:none;border-radius:10px;padding:4px 8px;cursor:pointer;font-size:11px}
</style>
</head>
<body>
  <div class="topbar">
    <button class="hamburger" id="hamburger">☰</button>
    <h1>More Than Fitness</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="gold" onclick="toggleQuickCard()">+ 빠른 등록</button>
      <button class="logout-btn" id="btnLogout">로그아웃</button>
    </div>
  </div>

  <div class="sidebar" id="sidebar" aria-label="사이드바 내비게이션">
    <button onclick="location.href='MTF-F.html'" style="padding:10px 20px;font-weight:bold;background:#222;color:#fff;border:none;border-radius:8px">MORE THAN FITNESS</button>
    <button>내 정보 관리</button>

    <button onclick="toggleSubmenu('member')" aria-expanded="false" aria-controls="submenu-member">회원 관리</button>
    <div id="submenu-member" class="submenu" style="display:none;padding-left:12px">
      <button onclick="location.href='/member-registration.html'">회원 신규 등록</button>
      <button onclick="location.href='/member-list-edit.html'">회원 확인 및 정보 수정</button>
      <button onclick="alert('삭제는 콘솔/별도 화면에서 처리 예정')">회원 삭제</button>
      <button onclick="location.href='personal-training-log.html'">고객 트레이닝 일지</button>
    </div>

    <button onclick="location.href='client-card.html'">고객 카드</button>
   
    <button>스케줄 관리</button>
    <button>기록 관리</button>
    <button>상품 구매</button>
  </div>

  <div class="main" id="main">
    <div class="today-lessons">
      <h2 id="todayTitle">오늘 다음 레슨</h2>
      <ul id="todayLessonList"></ul>
    </div>

    <div class="section-title" contenteditable>이번 주 스케줄</div>
    <div class="schedule-wrapper">
      <table id="scheduleTableCurr" aria-label="이번 주 스케줄">
        <thead>
          <tr>
            <th id="headerCurr" title="클릭해 시간범위 설정">시간</th>
            <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title">다음 주 스케줄</div>
    <div class="schedule-wrapper">
      <table id="scheduleTableNext" aria-label="다음 주 스케줄">
        <thead>
          <tr><th>시간</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title">지난 주 스케줄</div>
    <div class="schedule-wrapper">
      <table id="scheduleTableLast" aria-label="지난 주 스케줄">
        <thead>
          <tr><th>시간</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 오버레이 & 팝업 -->
  <div class="overlay" id="popupOverlay" tabindex="-1" aria-hidden="true"></div>
  <div class="overlay" id="sidebarOverlay"></div>

  <!-- 시간 범위 -->
  <div class="popup" id="popupRange" role="dialog" aria-modal="true" aria-labelledby="popupRangeTitle">
    <h3 id="popupRangeTitle">시간 범위 설정</h3>
    <label>시작: <input type="time" id="rangeStart" value="06:00"></label><br/>
    <label>종료: <input type="time" id="rangeEnd" value="15:00"></label>
    <div class="button-group">
      <button class="btn-primary" onclick="applyRangeCurr()">적용</button>
      <button onclick="hidePopup()">취소</button>
    </div>
  </div>

  <!-- 분 설정 -->
  <div class="popup" id="popupMinute" role="dialog" aria-modal="true" aria-labelledby="popupMinuteTitle">
    <h3 id="popupMinuteTitle">분 단위 설정</h3>
    <select id="minuteSelect">
      <option>00</option><option>10</option><option>20</option>
      <option>30</option><option>40</option><option>50</option>
    </select>
    <div class="button-group">
      <button class="btn-primary" onclick="saveMinute()">저장</button>
      <button onclick="hidePopup()">취소</button>
    </div>
  </div>

  <!-- 레슨 입력/상태 -->
  <div class="popup" id="popupLesson" role="dialog" aria-modal="true" aria-labelledby="popupLessonTitle">
    <h3 id="popupLessonTitle">레슨 정보</h3>
    <label>이름</label>
    <input id="nameInput" placeholder="이름" />
    <div style="display:flex;gap:8px">
      <input id="enrolledInput" type="number" placeholder="회차(표시용)" />
      <input id="capacityInput" type="number" placeholder="총(표시용)" />
    </div>
    <label>담당 트레이너</label>
    <input id="trainerInput" placeholder="예: 트레이너A" />
    <label>상태</label>
    <select id="statusInput">
      <option value="scheduled">예약됨</option>
      <option value="attended">출석</option>
      <option value="no-show">노쇼</option>
      <option value="canceled">취소</option>
    </select>
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="consumedInput" /> 소진 처리(출석/노쇼 시)
    </label>
    <div class="button-group">
      <button class="btn-primary" onclick="saveLesson()">저장</button>
      <button onclick="deleteLesson()">삭제</button>
    </div>
  </div>

  <!-- 빠른 회원 등록 카드 -->
  <div id="quickRegisterCard" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
    <div style="position:absolute;top:8px;right:8px">
      <button onclick="goToRegister()" style="font-size:11px;background:#f5f0e8;border:1px solid #ccc;border-radius:4px;padding:4px 6px;color:#0d1b2a;cursor:pointer">+자세한<br/>정보등록</button>
    </div>
    <h3 id="qrTitle">빠른 회원 등록</h3>

    <label>이름</label>
    <input type="text" id="quickName" autocomplete="name">

    <label>성별</label>
    <select id="quickGender">
      <option>선택</option><option>여성</option><option>남성</option>
    </select>

    <label>휴대폰번호</label>
    <input type="text" id="quickPhone" inputmode="numeric" placeholder="010-0000-0000" autocomplete="tel">

    <label>희망 시간대</label>
    <input type="text" id="quickTime" placeholder="예: 오전 10시~12시">

    <label>담당 트레이너</label>
    <select id="quickTrainer">
      <option>선택</option>
      <option>트레이너 A</option>
      <option>트레이너 B</option>
    </select>

    <label>레슨 유형</label>
    <select id="quickLessonType">
      <option>PT</option><option>GOLF</option><option>PILATES</option>
    </select>

    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="quickAgree"> 개인정보 이용 동의</label>

    <button id="btnQuickSubmit" class="btn-primary" style="width:100%;margin-top:10px" onclick="submitQuickMember()">등록</button>
  </div>

  <!-- 고정 버튼들 -->
  <div class="bottom-right">
    <button id="toggleQuickBtn" class="gold" onclick="toggleQuickCard()">+ 빠른 등록</button>
    <button id="saveScheduleBtn" class="btn-primary" style="display:none">이번 주 스케줄 저장</button>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
/* ====== UI 공통 ====== */
let currentCell=null, scheduleStart=6, scheduleEnd=15;
const popupOverlay=document.getElementById('popupOverlay');
const sidebarOverlay=document.getElementById('sidebarOverlay');

const DAY_KO=['일','월','화','수','목','금','토'];
document.getElementById('todayTitle').textContent=`오늘(${DAY_KO[new Date().getDay()]}) 다음 레슨`;

document.getElementById('btnLogout').onclick=()=>{ alert('로그아웃되었습니다!'); location.href='/login.html'; };
document.getElementById('headerCurr').onclick=()=> showPopup(document.getElementById('popupRange'));
document.getElementById('hamburger').onclick=()=>{
  const sb=document.getElementById('sidebar');
  const btn=document.querySelector('[onclick^="toggleSubmenu"]');
  sb.classList.toggle('active');
  sidebarOverlay.style.display=sb.classList.contains('active')?'block':'none';
  btn?.setAttribute('aria-expanded', sb.classList.contains('active'));
};
sidebarOverlay.onclick=()=>{ document.getElementById('sidebar').classList.remove('active'); sidebarOverlay.style.display='none'; };
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') { hidePopup(); document.getElementById('quickRegisterCard').style.display='none'; }});

function toggleSubmenu(id){
  document.querySelectorAll('.submenu').forEach(el=>{
    if(el.id!=='submenu-'+id) el.style.display='none';
  });
  const t=document.getElementById('submenu-'+id);
  if(t){
    t.style.display=(t.style.display==='block')?'none':'block';
    const btn=document.querySelector(`[onclick="toggleSubmenu('${id}')"]`);
    btn?.setAttribute('aria-expanded', t.style.display==='block');
  }
}

function showPopup(el){
  document.body.style.overflow='hidden';
  popupOverlay.style.display='block';
  el.style.display='block';
  el.setAttribute('tabindex','-1');
  el.focus();
}
function hidePopup(){
  popupOverlay.style.display='none';
  document.body.style.overflow='';
  document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
}
function toast(msg, withUndo=false, undoHandler=null){
  const t=document.getElementById('toast');
  t.innerHTML='';
  const span=document.createElement('span'); span.textContent=msg; t.appendChild(span);
  if(withUndo){
    const b=document.createElement('button'); b.textContent='실행 취소'; b.onclick=()=>{ undoHandler?.(); t.style.opacity=0; };
    t.appendChild(b);
  }
  t.style.opacity=1;
  if(!withUndo) setTimeout(()=>t.style.opacity=0,1800);
}
function toggleQuickCard(){
  const card=document.getElementById('quickRegisterCard');
  card.style.display=(card.style.display==='none'||!card.style.display)?'block':'none';
}

/* ====== 스케줄 표 ====== */
window.addEventListener('DOMContentLoaded', initTables);
function initTables(){
  const saved=JSON.parse(localStorage.getItem('scheduleRange')||'{}');
  if(saved.start && saved.end){ scheduleStart=saved.start; scheduleEnd=saved.end; }
  buildCurr(); buildNext(); buildLast(); highlightToday(); initTimeLine(); setInterval(updateTimeLine,60000);
}

function buildCurr(){
  const tb=document.querySelector('#scheduleTableCurr tbody'); tb.innerHTML='';
  for(let h=scheduleStart; h<scheduleEnd; h++){
    const hh=(h%24).toString().padStart(2,'0');
    const r=document.createElement('tr');
    const minute=localStorage.getItem(`minute-${hh}`)||'00';
    const c0=document.createElement('td'); c0.textContent=`${hh}:${minute}`; c0.className='time-cell'; c0.onclick=()=>openMinute(c0); r.append(c0);
    for(let i=0;i<7;i++){ const c=document.createElement('td'); c.onclick=()=>openLesson(c); r.append(c); }
    tb.append(r);
  }
  updateTimeLine();
}
function buildNext(){
  const tb=document.querySelector('#scheduleTableNext tbody'); tb.innerHTML='';
  for(let h=scheduleStart; h<scheduleEnd; h++){
    const r=document.createElement('tr'); const c0=document.createElement('td'); c0.textContent=`${(h%24).toString().padStart(2,'0')}:00`; r.append(c0);
    for(let i=0;i<7;i++) r.append(document.createElement('td')); tb.append(r);
  }
}
function buildLast(){ buildNext(); }

function openMinute(cell){ currentCell=cell; showPopup(document.getElementById('popupMinute')); }
function saveMinute(){
  const m=document.getElementById('minuteSelect').value;
  const h=currentCell.textContent.split(':')[0];
  currentCell.textContent=`${h}:${m}`;
  localStorage.setItem(`minute-${h}`,m);
  updateTimeLine(); hidePopup();
}
function openLesson(cell){
  currentCell=cell;
  const meta = readCellMeta(cell); // {date, di, time}
  const info = cell.dataset.info ? JSON.parse(cell.dataset.info) : {};
  document.getElementById('nameInput').value = info.name||'';
  document.getElementById('enrolledInput').value = info.enrolled||'';
  document.getElementById('capacityInput').value = info.cap||'';
  document.getElementById('trainerInput').value = info.trainer|| (localStorage.getItem('qr_defaults_trainer')||'');
  document.getElementById('statusInput').value = info.status || 'scheduled';
  document.getElementById('consumedInput').checked = !!info.consumed;
  showPopup(document.getElementById('popupLesson'));
}

function cellStatusChip(status){
  const map = {
    'scheduled': 'status-scheduled',
    'attended' : 'status-attended',
    'no-show'  : 'status-noshow',
    'canceled' : 'status-canceled'
  };
  const cls = map[status] || map['scheduled'];
  const label = status==='scheduled'?'예약됨':status==='attended'?'출석':status==='no-show'?'노쇼':'취소';
  return `<span class="status-chip ${cls}">${label}</span>`;
}

/* 시간선 & 오늘 표기 */
function initTimeLine(){ updateTimeLine(); }
function updateTimeLine(){
  document.querySelectorAll('.current-time-line').forEach(e=>e.remove());
  const now=new Date(); const di=now.getDay(); const nv=now.getHours()*60+now.getMinutes();
  document.querySelectorAll('#scheduleTableCurr tbody tr').forEach(r=>{
    const [hh,mm]=r.firstChild.textContent.split(':').map(Number);
    const rowTime=hh*60+(mm||0); const next=rowTime+60;
    if(nv>=rowTime && nv<next){
      const pct=((nv-rowTime)/60)*100; const line=document.createElement('div');
      line.className='current-time-line'; line.style.top=`${pct}%`;
      r.children[di===0?7:di].appendChild(line);
    }
  });
}
function highlightToday(){
  const di=new Date().getDay(); const ths=document.querySelectorAll('#scheduleTableCurr th');
  const idx=di===0?7:di; if(ths[idx]){ ths[idx].style.backgroundColor='#d4af37'; ths[idx].style.color='#0d1b2a'; }
}

/* 오늘 다음 레슨 두 개 */
function updateTodayFromCells(){
  const now=new Date(); const todayIndex=now.getDay(); const columnIndex=todayIndex===0?7:todayIndex; const nowMin=now.getHours()*60+now.getMinutes(); const list=[];
  document.querySelectorAll('#scheduleTableCurr tbody tr').forEach(r=>{
    const [h,m]=r.firstChild.textContent.split(':').map(Number);
    const total=h*60+(m||0); const cell=r.children[columnIndex];
    if(cell && cell.dataset.info && total>=nowMin){
      const v=JSON.parse(cell.dataset.info);
      list.push({t:total,text:`${v.start} ${v.name} (${v.enrolled||0}/${v.cap||0})`});
    }
  });
  list.sort((a,b)=>a.t-b.t);
  const ul=document.getElementById('todayLessonList'); ul.innerHTML='';
  list.slice(0,2).forEach(i=>{ const li=document.createElement('li'); li.textContent=i.text; ul.appendChild(li); });
}
</script>

<script type="module">
  /* ===== Firebase ===== */
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import {
  getFirestore, collection, addDoc, setDoc, deleteDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };

  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ===== 인증(익명 로그인) ===== */
  const auth = getAuth(app);
  onAuthStateChanged(auth, (user) => { 
    if (!user) signInAnonymously(auth).catch(console.error);
  });

  /* ===== 유틸 ===== */
  const p2 = n => String(n).padStart(2,'0');
  const todayLocalISO = () => { const d=new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`; };
  const fmtPhoneDisplay = (raw)=>{
    const v = String(raw||"").replace(/\D/g,'').slice(0,11);
    if(v.length<=3) return v;
    if(v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
    return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  };
  const onlyDigits = (s)=> String(s||"").replace(/\D/g,'');

  /* ===== 빠른등록: 기본값 기억/복원 ===== */
  const quickDefaults = {
    load(){
      const g = localStorage.getItem('qr_defaults_gender') || '선택';
      const t = localStorage.getItem('qr_defaults_trainer') || '선택';
      const l = localStorage.getItem('qr_defaults_lesson')  || 'PT';
      document.getElementById('quickGender').value = g;
      document.getElementById('quickTrainer').value = t;
      document.getElementById('quickLessonType').value = l;
    },
    save(){
      const g = document.getElementById('quickGender').value;
      const t = document.getElementById('quickTrainer').value;
      const l = document.getElementById('quickLessonType').value;
      if(g && g!=='선택') localStorage.setItem('qr_defaults_gender', g);
      if(t && t!=='선택') localStorage.setItem('qr_defaults_trainer', t);
      if(l) localStorage.setItem('qr_defaults_lesson', l);
    }
  };
  window.toggleQuickCard = window.toggleQuickCard || (()=>{});
  window.goToRegister = ()=> location.href='/member-registration.html';
  window.submitQuickMember = submitQuickMember;
  window.addEventListener('DOMContentLoaded', ()=> quickDefaults.load());

  async function submitQuickMember(){
    const name = document.getElementById('quickName').value.trim();
    const phoneDigits = onlyDigits(document.getElementById('quickPhone').value);
    const gender = document.getElementById('quickGender').value;
    const trainer= document.getElementById('quickTrainer').value;
    const lesson = document.getElementById('quickLessonType').value;

    if(!name) return showToast('이름을 입력하세요.');
    if(phoneDigits.length < 10) return showToast('휴대폰번호(숫자 10~11자리)를 입력하세요.');

    const id = phoneDigits; // 문서ID를 전화번호 숫자만으로
    const ref = doc(db,'members', id);
    let existed = false;
    try{
      const snap = await getDoc(ref);
      existed = snap.exists();

      await setDoc(ref, {
        name,
        phone: phoneDigits,
        phoneDisplay: fmtPhoneDisplay(phoneDigits),
        gender: (gender && gender!=='선택') ? gender : null,
        trainer: (trainer && trainer!=='선택') ? trainer : null,
        lessonType: lesson || 'PT',
        lastQuickTimePref: (document.getElementById('quickTime').value||'') || null,
        updatedAt: serverTimestamp(),
        ...(existed ? {} : { createdAt: serverTimestamp() })
      }, { merge:true });

      quickDefaults.save();
      showToast(existed ? '회원 정보가 업데이트되었습니다.' : '회원이 등록되었습니다.');
      document.getElementById('quickRegisterCard').style.display='none';
    }catch(e){
      console.error(e);
      showToast('등록 실패: ' + (e.message||e.code||e));
    }
  }

  /* ===== 토스트 (로드 피드백 포함) ===== */
  function showToast(msg, withUndo=false, undoHandler=null){
    const t=document.getElementById('toast');
    t.innerHTML='';
    const span=document.createElement('span'); span.textContent=msg; t.appendChild(span);
    if(withUndo){
      const b=document.createElement('button'); b.textContent='실행 취소'; b.onclick=()=>{ undoHandler?.(); t.style.opacity=0; };
      t.appendChild(b);
    }
    t.style.opacity=1;
    if(!withUndo) setTimeout(()=>t.style.opacity=0,1800);
  }
  window.toast = showToast; // 재사용

  /* ====== 주(week) 계산 ====== */
  function getWeekDates(offset=0){ // 월~일
    const d=new Date(); // 오늘
    const day=d.getDay(); // 일(0)~토(6)
    const diffToMon = (day===0? -6 : 1 - day); // 월요일로
    const mon = new Date(d.getFullYear(), d.getMonth(), d.getDate() + diffToMon + offset*7);
    const arr=[];
    for(let i=0;i<7;i++){
      const x = new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()+i);
      arr.push(`${x.getFullYear()}-${p2(x.getMonth()+1)}-${p2(x.getDate())}`);
    }
    return arr; // [월,화,수,목,금,토,일]
  }

  /* ====== 이번 주 스케줄 실시간 구독 ====== */
  let unsub = null;
  let firstLoadShown = false;
  const scheduleIndex = new Map(); // key: date|start|di -> {id,data}
  const weekDates = getWeekDates(0); // 이번주

  subscribeWeek();

  function subscribeWeek(){
    // Firestore: where('date','in',[월~일]) 로 이번 주만 구독
    if(unsub) { try{unsub();}catch{} }
    firstLoadShown = false;
    showToast('동기화 중…');
    const q = query(collection(db,'schedules'), where('date','in', weekDates));
    unsub = onSnapshot(q, (snap)=>{
      // 반영
      scheduleIndex.clear();
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const key = `${d.date}|${d.start}|${d.di}`;
        scheduleIndex.set(key, { id: docSnap.id, data: d });
      });
      paintCurrFromIndex();
      updateTodayFromCells();
      if(!firstLoadShown){ firstLoadShown=true; showToast('동기화 완료'); }
    }, (err)=>{
      console.error(err);
      showToast('동기화 실패: ' + (err.message||err.code||err));
    });
  }

  function paintCurrFromIndex(){
    // 테이블 리셋 후 Index로 채움
    const rows = Array.from(document.querySelectorAll('#scheduleTableCurr tbody tr'));
    rows.forEach(r=>{
      // 시간셀 제외한 7칸 초기화
      for(let i=1;i<=7;i++){ const td=r.children[i]; td.innerHTML=''; td.removeAttribute('data-info'); }
    });
    // index → dom
    for(const {data} of scheduleIndex.values()){
      // 시간 행 찾기
      const rows = Array.from(document.querySelectorAll('#scheduleTableCurr tbody tr'));
      const row = rows.find(r=> r.firstChild.textContent === `${data.start}`);
      if(!row) continue;
      const col = data.di; // 1~7 (월~일)
      const cell = row.children[col];
      if(!cell) continue;
      cell.innerHTML = `${data.start}<br>${escapeHtml(data.name||'')} ${data.enrolled?`(${data.enrolled}/${data.cap||data.enrolled})`:''}<br>${statusChip(data.status)}`;
      cell.dataset.info = JSON.stringify(data);
    }
  }

  function statusChip(st){ 
    const cls = st==='attended'?'status-attended':st==='no-show'?'status-noshow':st==='canceled'?'status-canceled':'status-scheduled';
    const label = st==='attended'?'출석':st==='no-show'?'노쇼':st==='canceled'?'취소':'예약됨';
    return `<span class="status-chip ${cls}">${label}</span>`;
  }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

  /* ===== 셀 메타 계산 (date/di/time) ===== */
  function readCellMeta(cell){
    const di = cell.cellIndex; // 1~7 (월~일) / 0은 시간
    const rows = cell.parentElement.parentElement.children;
    const time = cell.parentElement.firstChild.textContent; // "HH:mm"
    const date = weekDates[di-1]; // 월~일 배열
    return { date, di, time, start: time };
  }
  window.readCellMeta = readCellMeta;

  /* ===== 저장/충돌 감지/Undo ===== */
  let lastAction = null; // {type:'create'|'update'|'delete', id, prevData}

  async function saveLesson(){
    if(!window.currentCell) return;
    const meta = readCellMeta(window.currentCell); // {date,di,time,start}
    const name = document.getElementById('nameInput').value.trim();
    const enrolled = +document.getElementById('enrolledInput').value || 0;
    const cap = +document.getElementById('capacityInput').value || 0;
    const trainer = (document.getElementById('trainerInput').value || '').trim();
    const status = document.getElementById('statusInput').value || 'scheduled';
    const consumed = !!document.getElementById('consumedInput').checked;

    if(!name){ showToast('이름을 입력하세요.'); return; }
    if(!trainer){ showToast('담당 트레이너를 입력하세요.'); return; }

    // 충돌 감지: 같은 date+start+trainer 가 이미 있는지
    const key = `${meta.date}|${meta.start}|${meta.di}`;
    const existed = scheduleIndex.get(key);
    const willOverwrite = existed && existed.data.trainer === trainer;

    if(willOverwrite){
      const ok = confirm('같은 시간/트레이너 예약이 있습니다. 덮어쓸까요?');
      if(!ok) return;
    }

    const payload = {
      date: meta.date,
      start: meta.start,
      di: meta.di,              // 월=1 ... 일=7
      name,
      enrolled,
      cap,
      trainer,
      status,                   // scheduled | attended | no-show | canceled
      consumed: !!consumed,     // true면 소진 처리됨(표시/연동용)
      updatedAt: serverTimestamp(),
      createdAt: serverTimestamp()
    };

    try{
      if(willOverwrite){
        const id = existed.id;
        const prev = existed.data;
        await updateDoc(doc(db,'schedules', id), payload);
        lastAction = { type:'update', id, prevData: prev };
        showToast('스케줄이 저장되었습니다.', true, async ()=>{
          try{ await setDoc(doc(db,'schedules',id), prev); }catch(e){ console.error(e); }
        });
      }else{
        const res = await addDoc(collection(db,'schedules'), payload);
        lastAction = { type:'create', id: res.id, prevData: null };
        showToast('스케줄이 저장되었습니다.', true, async ()=>{
          try{ await deleteDoc(doc(db,'schedules',res.id)); }catch(e){ console.error(e); }
        });
      }
      window.hidePopup();
    }catch(e){
      console.error(e);
      showToast('저장 실패: ' + (e.message||e.code||e));
    }
  }
  async function deleteLesson(){
    if(!window.currentCell) return;
    const meta = readCellMeta(window.currentCell);
    const key = `${meta.date}|${meta.start}|${meta.di}`;
    const existed = scheduleIndex.get(key);
    if(!existed){ showToast('삭제할 항목이 없습니다.'); window.hidePopup(); return; }
    const prev = existed.data;
    try{
      await deleteDoc(doc(db,'schedules', existed.id));
      lastAction = { type:'delete', id: existed.id, prevData: prev };
      showToast('삭제되었습니다.', true, async ()=>{
        try{ await setDoc(doc(db,'schedules',existed.id), prev); }catch(e){ console.error(e); }
      });
      window.hidePopup();
    }catch(e){
      console.error(e);
      showToast('삭제 실패: ' + (e.message||e.code||e));
    }
  }
  window.saveLesson = saveLesson;
  window.deleteLesson = deleteLesson;

  /* ===== 분설정/범위 설정 바인딩 ===== */
  window.applyRangeCurr = ()=>{
    const rawS=document.getElementById('rangeStart').value;
    const rawE=document.getElementById('rangeEnd').value;
    let sH=parseInt(rawS.split(':')[0],10);
    let eH=parseInt(rawE.split(':')[0],10);
    if(rawE.startsWith('00')) eH=24;
    if(eH<=sH) eH+=24;
    if(eH-sH<3){ alert('최소 3시간 이상 설정해야 합니다.'); hidePopup(); return; }
    scheduleStart=sH; scheduleEnd=eH;
    localStorage.setItem('scheduleRange',JSON.stringify({start:scheduleStart,end:scheduleEnd}));
    // 표 재구성 후 index 재도색
    buildCurr(); buildNext(); buildLast(); paintCurrFromIndex();
    updateTimeLine(); hidePopup();
  };

  /* ===== 오늘 다음 레슨 업데이트 트리거 ===== */
  window.updateTodayFromCells = window.updateTodayFromCells || (()=>{});

</script>
</body>
</html>
