<script>
/* ===== 공용 유틸/토스트/레이어 ===== */
let currentCell=null, scheduleStart=6, scheduleEnd=15;
const overlayEl=()=>document.getElementById('popupOverlay');

const $ = (id)=>document.getElementById(id);
const p2 = (n)=>String(n).padStart(2,'0');

function toast(msg){
  const t=$('toast'); t.textContent=msg; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,1700);
}
function showOverlay(){ const o=overlayEl(); if(o) o.style.display='block'; }
function hideOverlay(){ const o=overlayEl(); if(o) o.style.display='none'; }
function showPopup(el){ if(!el) return; showOverlay(); el.style.display='block'; }
function hidePopups(){ document.querySelectorAll('.popup').forEach(p=>p.style.display='none'); }
function hideAllLayers(){ hidePopups(); $('cellSheet').style.display='none'; $('quickRegisterCard').style.display='none'; hideOverlay(); }

/* ===== 빠른 등록 카드 ===== */
function openQuickCard(){ $('quickRegisterCard').style.display='block'; showOverlay(); }
function closeQuickCard(){ $('quickRegisterCard').style.display='none'; if (![...document.querySelectorAll('.popup')].some(p=>p.style.display==='block')) hideOverlay(); }

/* ===== 안전 초기화: 어떤 상태에서도 한 번은 실행 ===== */
(function startSafely(){
  const startOnce = (()=>{ let done=false; return ()=>{ if(done) return; done=true; startApp(); };})();
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', startOnce, {once:true});
  else startOnce();
  // 혹시 몰라서 보강
  window.addEventListener('load', startOnce, {once:true});
  setTimeout(startOnce, 0);
})();

/* ===== 메인 스타트업 ===== */
function startApp(){
  try{
    // 기본 버튼
    $('btnLogout').onclick=()=>{ alert('로그아웃되었습니다'); location.href='/login.html'; };
    $('hamburger').onclick=()=>{ $('sidebar').classList.toggle('active'); };
    overlayEl()?.addEventListener('click', hideAllLayers);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideAllLayers(); });

    $('btnApplyRange').onclick=applyRangeCurr;
    $('btnCancelRange').onclick=hideAllLayers;
    $('btnSaveMinute').onclick=saveMinute;
    $('btnCancelMinute').onclick=hideAllLayers;

    $('btnSaveLesson').onclick=saveLesson;
    $('btnDeleteLesson').onclick=deleteLesson;

    $('sheetClose').onclick=()=>{ $('cellSheet').style.display='none'; };

    $('toggleQuickBtn').onclick=openQuickCard;
    $('quickOpenBtn').onclick=openQuickCard;
    $('btnGoRegister').onclick=()=>location.href='/member-registration.html';

    // 다음/지난 주 토글
    $('titleNext').addEventListener('click', ()=> toggleWrap('wrapNext'));
    $('titleLast').addEventListener('click', ()=> toggleWrap('wrapLast'));

    // 시간 범위 로드 & 표 생성
    const saved=JSON.parse(localStorage.getItem('scheduleRange')||'{}');
    if(saved.start!=null && saved.end!=null){ scheduleStart=+saved.start; scheduleEnd=+saved.end; }

    buildTables();
    attachScheduleDelegation();       // 클릭/롱프레스 위임
    loadCurrFromLocal();
    highlightToday();
    updateTodayList();
    initTimeLine(); setInterval(updateTimeLine,60000);

    $('headerCurr').onclick=()=> showPopup($('popupRange'));

    // 자동 소진 토글/배너
    $('autoConsumeToggle').checked = localStorage.getItem('autoConsume')==='1';
    $('btnEnableAuto').onclick = enableAutoConsume;
    $('btnLaterAuto').onclick  = dismissAutoAsk;
    $('autoConsumeToggle').addEventListener('change',(e)=>{
      localStorage.setItem('autoConsume', e.target.checked?'1':'0');
      if(e.target.checked) runAutoConsumeIfNeeded(true);
    });
    maybeAskAuto();

    // 일괄 저장
    $('saveScheduleBtn').addEventListener('click', bulkSave);

    // 디버그 토스트
    window.addEventListener('error', (e)=> toast('오류: '+(e.message||'unknown')));
  }catch(err){
    console.error(err);
    toast('초기화 오류: '+(err.message||err));
  }
}

/* ===== 섹션 래퍼 토글 ===== */
function toggleWrap(id){
  const el=$(id);
  el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
}

/* ===== 표 생성 ===== */
function buildTables(){
  buildOne('#scheduleTableCurr tbody', true);
  buildOne('#scheduleTableNext tbody', false);
  buildOne('#scheduleTableLast tbody', false);
}
function buildOne(sel, isMain){
  const tb=document.querySelector(sel); if(!tb) return;
  tb.innerHTML='';
  for(let h=scheduleStart; h<scheduleEnd; h++){
    const hh=(h%24).toString().padStart(2,'0');
    const tr=document.createElement('tr');

    const minute=localStorage.getItem(`minute-${hh}`)||'00';
    const td0=document.createElement('td');
    td0.textContent=`${hh}:${minute}`;
    td0.className='time-cell';
    if(isMain) td0.addEventListener('click', ()=>openMinute(td0));
    tr.appendChild(td0);

    for(let i=0;i<7;i++){
      const td=document.createElement('td');
      td.dataset.weekcol = String(i+1); // 월=1 … 일=7
      tr.appendChild(td);
    }
    tb.appendChild(tr);
  }
}

/* ===== 이벤트 위임 (셀 클릭/롱프레스) ===== */
function attachScheduleDelegation(){
  const tb=document.querySelector('#scheduleTableCurr tbody');
  if(!tb) return;

  // 클릭 → 레슨 팝업
  tb.addEventListener('click', (e)=>{
    const td=e.target.closest('td'); if(!td || td.cellIndex===0) return;
    $('cellSheet').style.display='none';
    openLesson(td);
  }, {passive:true});

  // 롱프레스 → 액션시트
  let lpTimer=null;
  tb.addEventListener('pointerdown', (e)=>{
    const td=e.target.closest('td'); if(!td || td.cellIndex===0) return;
    lpTimer=setTimeout(()=>openCellSheet(td), 600);
  }, {passive:true});
  ['pointerup','pointerleave','pointercancel'].forEach(evt=>{
    tb.addEventListener(evt, ()=>{ clearTimeout(lpTimer); lpTimer=null; }, {passive:true});
  });
  tb.addEventListener('contextmenu', (e)=>e.preventDefault());
}

function openCellSheet(td){
  if(!td.dataset.info){ toast('먼저 레슨을 저장하세요'); return; }
  const sheet=$('cellSheet');
  const r=td.getBoundingClientRect();
  sheet.style.left = Math.min(window.innerWidth-220, Math.max(8, r.left)) + 'px';
  sheet.style.top  = Math.min(window.innerHeight-10, r.bottom+6) + 'px';
  sheet.style.display='block';
  bindSheetHandlers(td);
}
function bindSheetHandlers(td){
  const info=JSON.parse(td.dataset.info||'{}');
  const memberId=info.memberId||null;
  $('sheetConsume').onclick     = async()=>{ await consumeAdjust(memberId,-1, {flag:'consumed', value:true}, td); };
  $('sheetUndoConsume').onclick = async()=>{ await consumeAdjust(memberId,+1, {flag:'consumed', value:false}, td); };
  $('sheetNoShow').onclick      = async()=>{ await consumeAdjust(memberId,-1, {flag:'noShowDeducted', value:true}, td); };
  $('sheetUndoNoShow').onclick  = async()=>{ await consumeAdjust(memberId,+1, {flag:'noShowDeducted', value:false}, td); };
  $('sheetClose').onclick       = ()=>{ $('cellSheet').style.display='none'; };
}

/* ===== 시간/분/레슨 팝업 ===== */
function openMinute(cell){ currentCell=cell; showPopup($('popupMinute')); }
function saveMinute(){
  const m=$('minuteSelect').value;
  const h=currentCell.textContent.split(':')[0];
  currentCell.textContent=`${h}:${m}`; localStorage.setItem(`minute-${h}`,m);
  updateTimeLine(); hideAllLayers();
}

function openLesson(cell){
  currentCell=cell;
  const d=cell.dataset.info?JSON.parse(cell.dataset.info):{};
  $('nameInput').value     = d.name||'';
  $('enrolledInput').value = d.enrolled||'';
  $('capacityInput').value = d.cap||'';
  $('memberIdInput').value = d.memberId||'';
  showPopup($('popupLesson'));
}
function rowHour(cell){ return cell.parentElement.firstChild.textContent; }

function saveLesson(){
  if(!currentCell) return;
  const name     = ($('nameInput').value || '').trim();
  const enrolled = +($('enrolledInput').value || 0);
  const cap      = +($('capacityInput').value || 0);
  const memberId = ($('memberIdInput').value || '').replace(/\D/g,'');

  if(!name && !memberId && !enrolled && !cap){ toast('내용을 입력해주세요'); return; }

  const time = rowHour(currentCell);
  const di   = +currentCell.dataset.weekcol;
  const displayName = name || (memberId ? `[${memberId}]` : '—');

  currentCell.textContent = `${time}\n${displayName} (${enrolled}/${cap})`;
  const info = { name, enrolled, cap, time, di, memberId: memberId || null };
  currentCell.dataset.info = JSON.stringify(info);

  let arr = JSON.parse(localStorage.getItem('scheduleData') || '[]');
  arr = arr.filter(x => !(x.time === info.time && x.di === info.di));
  arr.push(info);
  localStorage.setItem('scheduleData', JSON.stringify(arr));

  if (window.upsertScheduleFromCell) {
    window.upsertScheduleFromCell(currentCell)
      .then(()=> toast('스케줄 저장 완료'))
      .catch(e => toast('저장 실패: ' + (e.message || e.code)));
  }

  updateTodayList();
  updateTimeLine();
  hideAllLayers();
}
function deleteLesson(){
  if(!currentCell) return;
  const info=currentCell.dataset.info ? JSON.parse(currentCell.dataset.info) : null;
  if (window.deleteScheduleByCell) {
    window.deleteScheduleByCell(currentCell).catch(e=>toast("삭제 실패: "+(e.message||e.code)));
  }
  currentCell.innerHTML=''; delete currentCell.dataset.info; delete currentCell.dataset.docId;
  if(info){
    let data=JSON.parse(localStorage.getItem('scheduleData')||'[]');
    data=data.filter(x=>!(x.time===info.time && x.di===info.di));
    localStorage.setItem('scheduleData',JSON.stringify(data));
  }
  toast("삭제 완료");
  updateTodayList(); updateTimeLine(); hideAllLayers();
}

/* ===== 오늘 다음 레슨/타임라인 ===== */
function loadCurrFromLocal(){
  const data=JSON.parse(localStorage.getItem('scheduleData')||'[]');
  const rows=Array.from(document.querySelectorAll('#scheduleTableCurr tbody tr'));
  data.forEach(i=>{
    const [hour]=i.time.split(':');
    const row=rows.find(r=> {
      const [rowHour,rowMin] = r.firstChild.textContent.split(':');
      return rowHour===hour && rowMin===(localStorage.getItem(`minute-${rowHour}`)||'00');
    });
    if(row){
      const c=row.children[i.di];
      if(c){
        const displayName = i.name || (i.memberId ? `[${i.memberId}]` : '—');
        c.textContent=`${i.time}\n${displayName} (${i.enrolled}/${i.cap})`;
        c.dataset.info=JSON.stringify(i);
      }
    }
  });
}
function highlightToday(){
  const di=new Date().getDay(); const ths=document.querySelectorAll('#scheduleTableCurr th');
  const idx=di===0?7:di; if(ths[idx]){ ths[idx].style.backgroundColor='#d4af37'; ths[idx].style.color='#0d1b2a'; }
}
function updateTodayList(){
  const now=new Date(); const todayIndex=now.getDay(); const columnIndex=todayIndex===0?7:todayIndex; const nowMin=now.getHours()*60+now.getMinutes(); const list=[];
  document.querySelectorAll('#scheduleTableCurr tbody tr').forEach(r=>{
    const [h,m]=r.firstChild.textContent.split(':').map(Number);
    const total=h*60+(m||0); const cell=r.children[columnIndex];
    if(cell && cell.dataset.info){
      const v=JSON.parse(cell.dataset.info);
      const displayName = v.name || (v.memberId ? `[${v.memberId}]` : '—');
      if(total>=nowMin){ list.push({t:total,text:`${v.time} ${displayName} (${v.enrolled}/${v.cap})`}); }
    }
  });
  list.sort((a,b)=>a.t-b.t);
  const ul=$('todayLessonList'); ul.innerHTML='';
  list.slice(0,2).forEach(i=>{ const li=document.createElement('li'); li.textContent=i.text; ul.appendChild(li); });
}
function initTimeLine(){ updateTimeLine(); }
function updateTimeLine(){
  document.querySelectorAll('.current-time-line').forEach(e=>e.remove());
  const now=new Date(); const di=now.getDay();
  document.querySelectorAll('#scheduleTableCurr tbody tr').forEach(r=>{
    const [hh,mm]=r.firstChild.textContent.split(':').map(Number);
    const rowTime=hh*60+(mm||0), nv=now.getHours()*60+now.getMinutes();
    if(nv>=rowTime && nv<rowTime+60){
      const pct=((nv-rowTime)/60)*100; const line=document.createElement('div');
      line.className='current-time-line'; line.style.top=`${pct}%`;
      r.children[di===0?7:di].appendChild(line);
    }
  });
}

/* ===== 일괄 저장 ===== */
async function bulkSave(){
  const cells=[...document.querySelectorAll('#scheduleTableCurr tbody td')].filter(td=>td.cellIndex>0 && td.dataset.info);
  try{
    await Promise.all(cells.map(c=>window.upsertScheduleFromCell(c)));
    toast("스케줄 저장 완료");
  }catch(e){
    console.error(e); toast("저장 실패: "+(e.message||e.code));
  }
}
</script>
