<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>More Than Fitness - Dashboard</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{display:flex;flex-direction:column;height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:#f5f0e8;overflow:hidden}
  .topbar{position:fixed;top:0;left:0;right:0;height:50px;background:#f5f0e8;display:flex;align-items:center;justify-content:space-between;padding:0 15px;box-shadow:0 2px 4px rgba(0,0,0,.1);z-index:1001}
  .topbar h1{font-size:18px;color:#0d1b2a}
  .hamburger,.logout-btn{background:none;border:none;cursor:pointer;font-size:20px;color:#0d1b2a}
  .sidebar{position:fixed;top:50px;left:0;bottom:0;width:180px;background:#0d1b2a;color:#fff;padding:15px;transform:translateX(-100%);transition:transform .3s ease;z-index:1002}
  .sidebar.active{transform:translateX(0)}
  .sidebar button{display:block;background:none;border:none;color:#fff;width:100%;text-align:left;margin:8px 0;cursor:pointer;font-size:14px}
  .submenu button{background:none;border:none;color:#ccc;width:100%;text-align:left;margin:4px 0;padding-left:16px;font-size:13px;cursor:pointer}
  .main{margin-top:50px;flex:1;overflow-y:auto;padding:8px 8px 60px}
  .today-lessons{background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:8px}
  .today-lessons h2{font-size:16px;color:#0d1b2a;margin-bottom:4px}
  .today-lessons ul{padding-left:16px}
  .today-lessons li{overflow-wrap:break-word;word-break:break-all;margin-bottom:4px}
  .section-title{margin:8px 0 4px;font-size:14px;color:#0d1b2a}
  .schedule-wrapper{background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:16px;overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:12px}
  @media (min-width:768px){table{min-width:600px}}
  @media (max-width:767px){
    .schedule-wrapper{overflow-x:auto}
    .schedule-wrapper table{table-layout:fixed;min-width:unset}
    .schedule-wrapper th,.schedule-wrapper td{word-wrap:break-word;white-space:normal}
    #quickRegisterCard{width:90%!important;right:5%!important;top:60px!important}
  }
  th,td{border:1px solid #ccc;padding:4px;text-align:center;position:relative;vertical-align:top}
  th{background:#0d1b2a;color:#fff}
  th:first-child{background:#0d3b5a;cursor:pointer}
  .time-cell{background:#f1f1f1;cursor:pointer}
  .current-time-line{position:absolute;left:0;right:0;height:2px;background:#FF3B30;animation:pulse 5s ease-in-out infinite}
  @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
  .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000}
  .popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:8px;z-index:1001;width:280px;max-width:90%;max-height:80vh;overflow:auto}
  .button-group{display:flex;gap:8px;margin-top:8px}
  .button-group button{flex:1;padding:8px;background:#f5f0e8;border:1px solid #ddd;border-radius:6px;cursor:pointer}
  .bottom-right{position:fixed;bottom:12px;right:12px;z-index:999}
  .btn-primary{background:#0d1b2a;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer}
  .gold{background:#d4af37;color:#0d1b2a}

  /* 빠른등록 카드 */
  #quickRegisterCard{position:fixed;top:70px;right:20px;width:300px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.15);padding:16px;z-index:1000;display:none}
  #quickRegisterCard h3{font-size:16px;color:#0d1b2a;margin-bottom:12px}
  #quickRegisterCard label{font-size:12px;color:#334155}
  #quickRegisterCard input,#quickRegisterCard select{width:100%;margin:6px 0 10px;padding:8px;border:1px solid #ccc;border-radius:6px}
  #toast{position:fixed;top:56px;left:50%;transform:translateX(-50%);background:#0d1b2a;color:#fff;padding:8px 12px;border-radius:14px;opacity:0;transition:opacity .2s;z-index:1100;font-size:12px}
</style>
</head>
<body>
  <div class="topbar">
    <button class="hamburger" id="hamburger">☰</button>
    <h1>More Than Fitness</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="gold" onclick="toggleQuickCard()">+ 빠른 등록</button>
      <button class="logout-btn" id="btnLogout">로그아웃</button>
    </div>
  </div>

  <div class="sidebar" id="sidebar" aria-label="사이드바 내비게이션">
    <button onclick="location.href='MTF-F.html'" style="padding:10px 20px;font-weight:bold;background:#222;color:#fff;border:none;border-radius:8px">MORE THAN FITNESS</button>
    <button>내 정보 관리</button>

    <button onclick="toggleSubmenu('member')" aria-expanded="false" aria-controls="submenu-member">회원 관리</button>
    <div id="submenu-member" class="submenu" style="display:none;padding-left:12px">
      <button onclick="location.href='/member-registration.html'">회원 신규 등록</button>
      <button onclick="location.href='/member-list-edit.html'">회원 확인 및 정보 수정</button>
      <button onclick="alert('삭제는 콘솔/별도 화면에서 처리 예정')">회원 삭제</button>
    </div>

    <button onclick="location.href='client-card.html'">고객 카드</button>
    <button>스케줄 관리</button>
    <button>기록 관리</button>
    <button>상품 구매</button>
  </div>

  <div class="main" id="main">
    <div class="today-lessons">
      <h2 id="todayTitle">오늘 다음 레슨</h2>
      <ul id="todayLessonList"></ul>
    </div>

    <div class="section-title" contenteditable>이번 주 스케줄</div>
    <div class="schedule-wrapper">
      <table id="scheduleTableCurr" aria-label="이번 주 스케줄">
        <thead>
          <tr>
            <th id="headerCurr" title="클릭해 시간범위 설정">시간</th>
            <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title">다음 주 스케줄</div>
    <div class="schedule-wrapper">
      <table id="scheduleTableNext" aria-label="다음 주 스케줄">
        <thead>
          <tr><th>시간</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title">지난 주 스케줄</div>
    <div class="schedule-wrapper">
      <table id="scheduleTableLast" aria-label="지난 주 스케줄">
        <thead>
          <tr><th>시간</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 오버레이 & 팝업 -->
  <div class="overlay" id="popupOverlay" tabindex="-1" aria-hidden="true"></div>
  <div class="overlay" id="sidebarOverlay"></div>

  <div class="popup" id="popupRange" role="dialog" aria-modal="true" aria-labelledby="popupRangeTitle">
    <h3 id="popupRangeTitle">시간 범위 설정</h3>
    <label>시작: <input type="time" id="rangeStart" value="06:00"></label><br/>
    <label>종료: <input type="time" id="rangeEnd" value="15:00"></label>
    <div class="button-group">
      <button class="btn-primary" onclick="applyRangeCurr()">적용</button>
      <button onclick="hidePopup()">취소</button>
    </div>
  </div>

  <div class="popup" id="popupMinute" role="dialog" aria-modal="true" aria-labelledby="popupMinuteTitle">
    <h3 id="popupMinuteTitle">분 단위 설정</h3>
    <select id="minuteSelect">
      <option>00</option><option>10</option><option>20</option>
      <option>30</option><option>40</option><option>50</option>
    </select>
    <div class="button-group">
      <button class="btn-primary" onclick="saveMinute()">저장</button>
      <button onclick="hidePopup()">취소</button>
    </div>
  </div>

  <div class="popup" id="popupLesson" role="dialog" aria-modal="true" aria-labelledby="popupLessonTitle">
    <h3 id="popupLessonTitle">레슨 정보</h3>
    <input id="nameInput" placeholder="이름" />
    <div style="display:flex;gap:8px">
      <input id="enrolledInput" type="number" placeholder="회차" />
      <input id="capacityInput" type="number" placeholder="총" />
    </div>
    <div class="button-group">
      <button class="btn-primary" onclick="saveLesson()">저장</button>
      <button onclick="deleteLesson()">삭제</button>
    </div>
  </div>

  <!-- 빠른 회원 등록 카드 -->
  <div id="quickRegisterCard" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
    <div style="position:absolute;top:8px;right:8px">
      <button onclick="goToRegister()" style="font-size:11px;background:#f5f0e8;border:1px solid #ccc;border-radius:4px;padding:4px 6px;color:#0d1b2a;cursor:pointer">+자세한<br/>정보등록</button>
    </div>
    <h3 id="qrTitle">빠른 회원 등록</h3>

    <label>이름</label>
    <input type="text" id="quickName" autocomplete="name">

    <label>성별</label>
    <select id="quickGender">
      <option>선택</option><option>여성</option><option>남성</option>
    </select>

    <label>휴대폰번호</label>
    <input type="text" id="quickPhone" inputmode="numeric" placeholder="010-0000-0000" autocomplete="tel">

    <label>희망 시간대</label>
    <input type="text" id="quickTime" placeholder="예: 오전 10시~12시">

    <label>담당 트레이너</label>
    <select id="quickTrainer">
      <option>선택</option>
      <option>남명구Master</option>
      <option>트레이너 B</option>
    </select>

    <label>레슨 유형</label>
    <select id="quickLessonType">
      <option>PT</option><option>GOLF</option><option>PILATES</option>
    </select>

    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="quickAgree"> 개인정보 이용 동의</label>

    <button id="btnQuickSubmit" class="btn-primary" style="width:100%;margin-top:10px" onclick="submitQuickMember()">등록</button>
  </div>

  <!-- 고정 버튼들 -->
  <div class="bottom-right">
    <button id="toggleQuickBtn" class="gold" onclick="toggleQuickCard()">+ 빠른 등록</button>
    <button id="saveScheduleBtn" class="btn-primary" style="margin-left:6px">이번 주 스케줄 저장</button>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
/* ====== UI 공통 ====== */
let currentCell=null, scheduleStart=6, scheduleEnd=15;
const popupOverlay=document.getElementById('popupOverlay');
const sidebarOverlay=document.getElementById('sidebarOverlay');

const DAY_KO=['일','월','화','수','목','금','토'];
document.getElementById('todayTitle').textContent=`오늘(${DAY_KO[new Date().getDay()]}) 다음 레슨`;

document.getElementById('btnLogout').onclick=()=>{ alert('로그아웃되었습니다!'); location.href='/login.html'; };
document.getElementById('headerCurr').onclick=()=> showPopup(document.getElementById('popupRange'));
document.getElementById('hamburger').onclick=()=>{
  const sb=document.getElementById('sidebar');
  const btn=document.querySelector('[onclick^="toggleSubmenu"]');
  sb.classList.toggle('active');
  sidebarOverlay.style.display=sb.classList.contains('active')?'block':'none';
  btn?.setAttribute('aria-expanded', sb.classList.contains('active'));
};
sidebarOverlay.onclick=()=>{ document.getElementById('sidebar').classList.remove('active'); sidebarOverlay.style.display='none'; };
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') { hidePopup(); document.getElementById('quickRegisterCard').style.display='none'; }});

function toggleSubmenu(id){
  document.querySelectorAll('.submenu').forEach(el=>{
    if(el.id!=='submenu-'+id) el.style.display='none';
  });
  const t=document.getElementById('submenu-'+id);
  if(t){
    t.style.display=(t.style.display==='block')?'none':'block';
    const btn=document.querySelector(`[onclick="toggleSubmenu('${id}')"]`);
    btn?.setAttribute('aria-expanded', t.style.display==='block');
  }
}

function showPopup(el){
  document.body.style.overflow='hidden';
  popupOverlay.style.display='block';
  el.style.display='block';
  el.setAttribute('tabindex','-1');
  el.focus();
}
function hidePopup(){
  popupOverlay.style.display='none';
  document.body.style.overflow='';
  document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
}
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,1800);
}

function toggleQuickCard(){
  const card=document.getElementById('quickRegisterCard');
  card.style.display=(card.style.display==='none'||!card.style.display)?'block':'none';
}

/* ====== 스케줄 표 ====== */
window.addEventListener('DOMContentLoaded', init);
function init(){
  const saved=JSON.parse(localStorage.getItem('scheduleRange')||'{}');
  if(saved.start && saved.end){ scheduleStart=saved.start; scheduleEnd=saved.end; }
  buildCurr(); buildNext(); buildLast(); loadCurr(); highlightToday(); updateToday(); initTimeLine(); setInterval(updateTimeLine,60000);
}

function buildCurr(){
  const tb=document.querySelector('#scheduleTableCurr tbody'); tb.innerHTML='';
  for(let h=scheduleStart; h<scheduleEnd; h++){
    const hh=(h%24).toString().padStart(2,'0');
    const r=document.createElement('tr');
    const minute=localStorage.getItem(`minute-${hh}`)||'00';
    const c0=document.createElement('td'); c0.textContent=`${hh}:${minute}`; c0.className='time-cell'; c0.onclick=()=>openMinute(c0); r.append(c0);
    for(let i=0;i<7;i++){ const c=document.createElement('td'); c.onclick=()=>openLesson(c); r.append(c); }
    tb.append(r);
  }
  highlightToday();
}
function buildNext(){
  const tb=document.querySelector('#scheduleTableNext tbody'); tb.innerHTML='';
  for(let h=scheduleStart; h<scheduleEnd; h++){
    const r=document.createElement('tr'); const c0=document.createElement('td'); c0.textContent=`${(h%24).toString().padStart(2,'0')}:00`; r.append(c0);
    for(let i=0;i<7;i++) r.append(document.createElement('td')); tb.append(r);
  }
}
function buildLast(){ buildNext(); } // 단순 동일한 구조

function openMinute(cell){ currentCell=cell; showPopup(document.getElementById('popupMinute')); }
function saveMinute(){
  const m=document.getElementById('minuteSelect').value;
  const h=currentCell.textContent.split(':')[0];
  currentCell.textContent=`${h}:${m}`;
  localStorage.setItem(`minute-${h}`,m);
  updateTimeLine(); hidePopup();
}
function openLesson(cell){
  currentCell=cell;
  const d=cell.dataset.info?JSON.parse(cell.dataset.info):{};
  document.getElementById('nameInput').value=d.name||'';
  document.getElementById('enrolledInput').value=d.enrolled||'';
  document.getElementById('capacityInput').value=d.cap||'';
  showPopup(document.getElementById('popupLesson'));
}
function saveLesson(){
  const name=document.getElementById('nameInput').value.trim();
  const enrolled=+document.getElementById('enrolledInput').value||0;
  const cap=+document.getElementById('capacityInput').value||0;
  const time=currentCell.parentElement.firstChild.textContent;
  const di=currentCell.cellIndex;
  const i={name,enrolled,cap,time,di};
  currentCell.textContent=`${time}\n${name} (${enrolled}/${cap})`;
  currentCell.dataset.info=JSON.stringify(i);
  let arr=JSON.parse(localStorage.getItem('scheduleData')||'[]');
  arr=arr.filter(x=>!(x.time===i.time && x.di===i.di)); arr.push(i);
  localStorage.setItem('scheduleData',JSON.stringify(arr));
  updateToday(); updateTimeLine(); hidePopup();
}
function deleteLesson(){
  if(!currentCell) return;
  const info=currentCell.dataset.info?JSON.parse(currentCell.dataset.info):null;
  if(info){
    let data=JSON.parse(localStorage.getItem('scheduleData')||'[]');
    data=data.filter(x=>!(x.time===info.time && x.di===info.di));
    localStorage.setItem('scheduleData',JSON.stringify(data));
  }
  currentCell.innerHTML=''; delete currentCell.dataset.info;
  updateToday(); updateTimeLine(); hidePopup();
}

function applyRangeCurr(){
  const rawS=document.getElementById('rangeStart').value;
  const rawE=document.getElementById('rangeEnd').value;
  let sH=parseInt(rawS.split(':')[0],10);
  let eH=parseInt(rawE.split(':')[0],10);
  if(rawE.startsWith('00')) eH=24;   // 자정 표시 허용
  if(eH<=sH) eH+=24;                 // 다음날 넘어감
  if(eH-sH<3){ alert('최소 3시간 이상 설정해야 합니다.'); hidePopup(); return; }
  scheduleStart=sH; scheduleEnd=eH;
  localStorage.setItem('scheduleRange',JSON.stringify({start:scheduleStart,end:scheduleEnd}));
  buildCurr(); buildNext(); buildLast(); loadCurr(); highlightToday(); updateToday(); initTimeLine(); hidePopup();
}
function loadCurr(){
  const data=JSON.parse(localStorage.getItem('scheduleData')||'[]');
  const rows=Array.from(document.querySelectorAll('#scheduleTableCurr tbody tr'));
  data.forEach(i=>{
    const [hour]=i.time.split(':');
    const row=rows.find(r=>{
      const [rowHour,rowMin]=r.firstChild.textContent.split(':');
      return rowHour===hour && rowMin===(localStorage.getItem(`minute-${rowHour}`)||'00');
    });
    if(row){ const c=row.children[i.di]; if(c){ c.textContent=`${i.time}\n${i.name} (${i.enrolled}/${i.cap})`; c.dataset.info=JSON.stringify(i);} }
  });
}
function updateToday(){
  const now=new Date(); const todayIndex=now.getDay(); const columnIndex=todayIndex===0?7:todayIndex; const nowMin=now.getHours()*60+now.getMinutes(); const list=[];
  document.querySelectorAll('#scheduleTableCurr tbody tr').forEach(r=>{
    const [h,m]=r.firstChild.textContent.split(':').map(Number);
    const total=h*60+(m||0); const cell=r.children[columnIndex];
    if(cell && cell.dataset.info && total>=nowMin){
      const v=JSON.parse(cell.dataset.info);
      list.push({t:total,text:`${v.time} ${v.name} (${v.enrolled}/${v.cap})`});
    }
  });
  list.sort((a,b)=>a.t-b.t);
  const ul=document.getElementById('todayLessonList'); ul.innerHTML='';
  list.slice(0,2).forEach(i=>{ const li=document.createElement('li'); li.textContent=i.text; ul.appendChild(li); });
}
function initTimeLine(){ updateTimeLine(); }
function updateTimeLine(){
  document.querySelectorAll('.current-time-line').forEach(e=>e.remove());
  const now=new Date(); const di=now.getDay(); const nv=now.getHours()*60+now.getMinutes();
  document.querySelectorAll('#scheduleTableCurr tbody tr').forEach(r=>{
    const [hh,mm]=r.firstChild.textContent.split(':').map(Number);
    const rowTime=hh*60+(mm||0); const next=rowTime+60;
    if(nv>=rowTime && nv<next){
      const pct=((nv-rowTime)/60)*100; const line=document.createElement('div');
      line.className='current-time-line'; line.style.top=`${pct}%`;
      r.children[di===0?7:di].appendChild(line);
    }
  });
}
function highlightToday(){
  const di=new Date().getDay(); const ths=document.querySelectorAll('#scheduleTableCurr th');
  const idx=di===0?7:di; if(ths[idx]){ ths[idx].style.backgroundColor='#d4af37'; ths[idx].style.color='#0d1b2a'; }
}
</script>

<!-- ===== Firebase & 기능들 ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

  /* Firebase 설정 */
  const firebaseConfig = {
    apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
    authDomain: "more-than-fitness-f6adb.firebaseapp.com",
    projectId: "more-than-fitness-f6adb",
    storageBucket: "more-than-fitness-f6adb.appspot.com",
    messagingSenderId: "993248877411",
    appId: "1:993248877411:web:c0e6785162cf252fbcd156",
    measurementId: "G-MK0RVFG296"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  window.db = db; // 디버깅용

  /* 유틸 */
  const onlyDigits = s => String(s||"").replace(/\D/g,"");
  const fmtPhone = raw => {
    const v = onlyDigits(raw).slice(0,11);
    if (v.length<=3) return v;
    if (v.length<=7) return v.slice(0,3)+'-'+v.slice(3);
    return v.slice(0,3)+'-'+v.slice(3,7)+'-'+v.slice(7);
  };
  const dateToISO = d => d instanceof Date ? d.toISOString().slice(0,10) : (d ? new Date(d).toISOString().slice(0,10) : "");

  /* 빠른등록: 폰 입력 즉시 포맷 */
  const qp = document.getElementById('quickPhone');
  qp.addEventListener('input', e => e.target.value = fmtPhone(e.target.value));

  /* 빠른등록: 파이어스토어 저장 + 중복검사 + 버튼중복 방지 */
  window.submitQuickMember = async function () {
    const btn = document.getElementById('btnQuickSubmit');
    const name = document.getElementById('quickName').value.trim();
    const gender = document.getElementById('quickGender').value;
    const phoneDisplay = document.getElementById('quickPhone').value.trim();
    const phone = onlyDigits(phoneDisplay);
    const preferred = document.getElementById('quickTime').value.trim();
    const trainer = document.getElementById('quickTrainer').value;
    const lessonType = document.getElementById('quickLessonType').value;
    const agreed = document.getElementById('quickAgree').checked;

    if (!name || !phone || trainer === '선택' || gender === '선택' || !agreed) { alert('필수 항목을 입력하고 동의해 주세요.'); return; }
    btn.disabled = true;

    try {
      const ref = doc(db, "members", phone);         // 문서ID = 숫자폰
      const snap = await getDoc(ref);
      if (snap.exists() && snap.data().name && snap.data().name !== name) {
        alert(`이미 다른 이름으로 등록된 번호입니다: ${snap.data().name}`);
        return;
      }

      const payload = {
        name,
        gender,
        phone,
        phoneDisplay: fmtPhone(phone),
        trainer,
        lessonType,
        level: snap.exists() ? (snap.data().level || '일반') : '일반',
        preferredTime: preferred || null,
        createdAt: snap.exists() ? (snap.data().createdAt || serverTimestamp()) : serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      await setDoc(ref, payload, { merge: true });
      document.getElementById('quickRegisterCard').style.display='none';
      toast('빠른등록 완료!');
      // 방금 등록한 회원 하이라이트용 포커스 파라미터
      // location.href = `/member-list-edit.html?focus=${phone}`;
    } catch (e) {
      console.error(e); alert('등록 실패: ' + e.message);
    } finally {
      btn.disabled = false;
    }
  };

  /* 멤버 목록 출력(대시보드에서 간단 확인용: 필요시 버튼으로 호출) */
  window.showMemberList = async function(){
    const tableBody = document.querySelector("#memberTable tbody");
    if (!tableBody) return;
    tableBody.innerHTML = "";
    const snap = await getDocs(collection(db, "members"));
    snap.forEach(docu=>{
      const m = docu.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.name||''}</td><td>${m.phoneDisplay||m.phone||''}</td><td>${m.trainer||''}</td><td>${m.lessonType||''}</td><td>${m.level||''}</td><td>${m.createdAt?.toDate? m.createdAt.toDate().toLocaleDateString() : ''}</td>`;
      tableBody.appendChild(tr);
    });
  };

  /* 이번 주(현재 표시된 표) → Firestore 동기화 */
  function mondayISO(d=new Date()){
    const t=new Date(d); const day=(t.getDay()+6)%7; t.setHours(0,0,0,0); t.setDate(t.getDate()-day); return t.toISOString().slice(0,10);
  }
  function addDaysISO(iso, n){ const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }

  async function syncCurrentWeekToFirestore(weekStartISO){
    const tb = document.querySelector('#scheduleTableCurr tbody');
    const rows = Array.from(tb.querySelectorAll('tr'));
    const col = collection(db, 'schedules_week', weekStartISO, 'slots');
    const batch = writeBatch(db);

    rows.forEach(r=>{
      const time = r.firstChild.textContent; // "HH:mm"
      for(let di=1; di<=7; di++){
        const c = r.children[di];
        if(c && c.dataset.info){
          const d = JSON.parse(c.dataset.info);
          batch.set(doc(col), {
            date: addDaysISO(weekStartISO, di-1),
            time,
            member: d.name,
            enrolled: d.enrolled,
            cap: d.cap,
            di,
            createdAt: serverTimestamp()
          });
        }
      }
    });
    await batch.commit();
    toast('이번 주 스케줄이 저장되었습니다.');
  }
  document.getElementById('saveScheduleBtn').addEventListener('click', ()=>{
    const iso = mondayISO(new Date());
    syncCurrentWeekToFirestore(iso);
  });

  // 외부에서 쓰는 네비
  window.goToRegister = ()=> location.href='member-registration.html';
</script>
</body>
</html>
