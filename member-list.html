<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>회원 정보 확인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ink:#0d1b2a; --bg:#f5f0e8; --card:#fff; --line:#e5e7eb;
      --brand:#0d1b2a; --brand2:#cfa35e;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
         background:var(--bg); color:var(--ink); margin:0; padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px; margin-bottom:12px}
    .title{font-size:20px;font-weight:700}
    .close{font-size:20px;border:none;background:none;cursor:pointer}
    .tools{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .search{width:260px;max-width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px}
    .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;
                box-shadow:0 2px 8px rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#0d1b2a;color:#fff;font-weight:600;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:center;font-size:13px}
    tbody tr{background:#fff}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody tr:hover{background:#eef2ff}
    .name{font-weight:600;text-decoration:underline; color:#0b4aa2}
    .muted{color:#6b7280}
    .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn:hover{border-color:#bbb}
    .edit-btn{background:linear-gradient(0deg,#fff,#fff),linear-gradient(90deg,var(--brand),var(--brand2));border:1px solid var(--brand);color:var(--brand);font-weight:600}
    .edit-btn:hover{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .pill.ok{background:#ecfdf5;border-color:#10b981;color:#065f46}
    .pill.exp{background:#fff7ed;border-color:#f59e0b;color:#92400e}
    .sortable{cursor:pointer;user-select:none}
    .sortable .arrow{opacity:.6;margin-left:4px}
  </style>
</head>
<body>
  <div class="header">
    <div class="title">회원 목록</div>
    <button id="closeMemberView" class="close" title="닫기">✕</button>
  </div>

  <div class="tools">
    <input id="searchInput" class="search" type="text" placeholder="이름/전화번호 검색" />
    <span class="muted">정렬: 헤더 클릭</span>
  </div>

  <div class="table-wrap">
    <table id="memberTable">
      <thead>
        <tr>
          <th class="sortable" data-key="name">이름 <span class="arrow">↕</span></th>
          <th class="sortable" data-key="gender">성별 <span class="arrow">↕</span></th>
          <th class="sortable" data-key="phoneDisplay">휴대폰번호 <span class="arrow">↕</span></th>
          <th class="sortable" data-key="totalSessionsPurchased">등록 회차 <span class="arrow">↕</span></th>
          <th class="sortable" data-key="remainingSessions">남은 회차 <span class="arrow">↕</span></th>
          <th class="sortable" data-key="expireAt">만료기한 <span class="arrow">↕</span></th>
          <th>수정</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    // ★ 컬렉션명 통일 (프로젝트에 맞게 'members' 또는 'fitness_members'로)
    const COL = "members";

    const firebaseConfig = {
      apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
      authDomain: "more-than-fitness-f6adb.firebaseapp.com",
      projectId: "more-than-fitness-f6adb",
      storageBucket: "more-than-fitness-f6adb.appspot.com",
      messagingSenderId: "993248877411",
      appId: "1:993248877411:web:c0e6785162cf252fbcd156",
      measurementId: "G-MK0RVFG296"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== helpers
    const $ = (s)=>document.querySelector(s);
    const toDate = (v)=>{ try{ return v?.toDate ? v.toDate() : (v ? new Date(v) : null);}catch{return null;} };
    const fmtDate = (d)=> d ? new Date(d).toISOString().slice(0,10) : "-";
    const onlyDigits = (s)=> String(s||"").replace(/\D/g,"");
    const fmtPhone = (raw)=> {
      const v = onlyDigits(raw).slice(0,11);
      if (v.length<=3) return v;
      if (v.length<=7) return v.slice(0,3)+"-"+v.slice(3);
      return v.slice(0,3)+"-"+v.slice(3,7)+"-"+v.slice(7);
    };

    let memberList = [];
    let sortKey = "createdAt";
    let sortAsc = false;

    async function loadMembers() {
      const snap = await getDocs(collection(db, COL));
      memberList = [];
      snap.forEach(doc => {
        const x = doc.data();
        const createdAt = toDate(x.createdAt);
        const expireAt  = toDate(x.expireAt);
        memberList.push({
          id: doc.id,
          name: x.name || "",
          gender: x.gender || "",
          phone: x.phone || x.phoneDisplay || "",
          phoneDisplay: x.phoneDisplay || fmtPhone(x.phone || ""),
          trainer: x.trainer || "",
          lessonType: x.lessonType || "",
          level: x.level || "",
          totalSessionsPurchased: Number(x.totalSessionsPurchased || 0),
          remainingSessions: Number(x.remainingSessions || 0),
          expireAt,
          createdAt
        });
      });
      render();
    }

    function render(list = memberList){
      // 정렬
      const data = [...list].sort((a,b)=>{
        const k = sortKey;
        let A = a[k], B = b[k];
        // 날짜/숫자 처리
        if (k === "createdAt" || k === "expireAt") {
          A = A ? new Date(A).getTime() : 0;
          B = B ? new Date(B).getTime() : 0;
        } else if (k === "totalSessionsPurchased" || k === "remainingSessions") {
          A = Number(A||0); B = Number(B||0);
        } else {
          A = (A||"").toString().toLowerCase();
          B = (B||"").toString().toLowerCase();
        }
        return sortAsc ? (A>B?1:A<B?-1:0) : (A<B?1:A>B?-1:0);
      });

      const tbody = $("#memberTable tbody");
      tbody.innerHTML = "";
      data.forEach(m=>{
        const tr = document.createElement("tr");
        const today = new Date(); today.setHours(0,0,0,0);
        const isExpired = m.expireAt ? (m.expireAt < today) : false;
        tr.innerHTML = `
          <td><span class="name">${m.name||"-"}</span></td>
          <td>${m.gender||"-"}</td>
          <td>${m.phoneDisplay||fmtPhone(m.phone)||"-"}</td>
          <td>${m.totalSessionsPurchased}</td>
          <td>${m.remainingSessions}</td>
          <td>
            ${fmtDate(m.expireAt)}
            ${m.expireAt ? `<span class="pill ${isExpired?'exp':'ok'}" style="margin-left:6px">${isExpired?'만료':'유효'}</span>` : ""}
          </td>
          <td><button class="btn edit-btn" data-id="${m.id}">수정</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 검색
    $("#searchInput").addEventListener("input", (e)=>{
      const q = e.target.value.trim().toLowerCase();
      const filtered = memberList.filter(m =>
        (m.name||"").toLowerCase().includes(q) ||
        (m.phoneDisplay||"").toLowerCase().includes(q) ||
        (m.phone||"").toLowerCase().includes(q)
      );
      render(filtered);
    });

    // 정렬(헤더 클릭)
    document.querySelectorAll("thead th.sortable").forEach(th=>{
      th.addEventListener("click", ()=>{
        const key = th.dataset.key;
        sortAsc = (sortKey === key) ? !sortAsc : true;
        sortKey = key;
        render();
      });
    });

    // 수정 버튼 → 편집 페이지 이동 (쿼리스트링 사용)
    document.addEventListener("click",(e)=>{
      const btn = e.target.closest(".edit-btn");
      if (!btn) return;
      const id = btn.dataset.id;
      // edit-member.html에서 ?mid=... 로 읽어 쓰도록
      location.href = `/edit-member.html?mid=${encodeURIComponent(id)}`;
    });

    // 닫기
    $("#closeMemberView").addEventListener("click", ()=> location.href="/dashboard.html");

    loadMembers();
  </script>
</body>
</html>
