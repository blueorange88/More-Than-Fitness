const { useEffect, useMemo, useRef, useState } = React;

// Dual‑Theme Timetable App // - One self‑contained React component // - TailwindCSS styling (no imports needed in this environment) // - Two visual themes: "Sleek" and "Cute" (toggle at top‑right) // - Features: add/edit/delete class blocks, span multiple hours, localStorage persistence, //             weekend toggle, time‑range control, export/import JSON, print, today highlight, //             current‑time indicator line, mobile friendly horizontal scroll. // - All labels are KR‑first for your context.

export default function TimetableApp() { // ---------- THEME ---------- const THEMES = { sleek: { name: "Sleek", bg: "bg-[#f5f0e8]", ink: "text-[#0d1b2a]", panel: "bg-white", header: "from-[#0d1b2a] to-[#1b263b] text-white", headerGradient: "bg-gradient-to-r", subtext: "text-[#4b5563]", grid: "border-[#e5e7eb]", card: "bg-[#0d1b2a] text-white", accent: "text-[#d4af37]", chip: "bg-[#eae7df] text-[#0d1b2a]", ring: "ring-[#d4af37]", }, cute: { name: "Cute", bg: "bg-[#fffafc]", ink: "text-[#3a2f2f]", panel: "bg-white", header: "from-[#ffc6d9] to-[#c7f0ff] text-[#3a2f2f]", headerGradient: "bg-gradient-to-r", subtext: "text-[#6b7280]", grid: "border-[#f3e8ff]", card: "bg-[#ffdfe9] text-[#3a2f2f]", accent: "text-[#ff7aa2]", chip: "bg-[#fff0f6] text-[#3a2f2f]", ring: "ring-[#ff9ec1]", }, } as const;

const [themeKey, setThemeKey] = useState<keyof typeof THEMES>("sleek"); const T = THEMES[themeKey];

// ---------- SETTINGS ---------- const ALL_DAYS = ["월", "화", "수", "목", "금", "토", "일"]; const [showWeekend, setShowWeekend] = useState(true); const [startHour, setStartHour] = useState(8); // 08:00 const [endHour, setEndHour] = useState(20); // 20:00 (exclusive line)

// ---------- DATA ---------- type TimetableEvent = { id: string; title: string; memo?: string; day: number; // 0 = Mon(월) start: number; // 24h integer hour end: number; // exclusive hour color?: string; // CSS color for background emoji?: string; // optional icon };

const STORAGE_KEY = "timetable.v1"; const [events, setEvents] = useState<TimetableEvent[]>(() => { try { const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return []; const parsed = JSON.parse(raw); if (Array.isArray(parsed)) return parsed; return []; } catch { return []; } });

useEffect(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }, [events]);

// ---------- TIME / TODAY ---------- const now = useNowMinuteTick(); const todayIndex = (new Date().getDay() + 6) % 7; // make Monday=0

// ---------- DERIVED ---------- const visibleDays = useMemo(() => (showWeekend ? ALL_DAYS : ALL_DAYS.slice(0, 5)), [showWeekend]); const hours = useMemo(() => range(startHour, endHour), [startHour, endHour]);

// ---------- EDITOR STATE ---------- type Draft = { id?: string; title: string; memo?: string; day: number; start: number; duration: number; // hours color: string; emoji?: string; } | null;

const [draft, setDraft] = useState<Draft>(null); const openEditor = (pre: Partial<TimetableEvent>) => { const d: Draft = { id: pre.id, title: pre.title ?? "수업/과목명", memo: pre.memo ?? "", day: pre.day ?? todayIndex, start: clamp(pre.start ?? startHour, startHour, Math.max(startHour, endHour - 1)), duration: Math.max(1, (pre.end ?? (pre.start ?? startHour) + 1) - (pre.start ?? startHour)), color: pre.color ?? defaultColor(themeKey), emoji: pre.emoji ?? (themeKey === "cute" ? "✨" : ""), }; setDraft(d); }; const closeEditor = () => setDraft(null);

const saveDraft = () => { if (!draft) return; const end = Math.min(endHour, draft.start + draft.duration); const e: TimetableEvent = { id: draft.id ?? ev_${Date.now()}_${Math.random().toString(36).slice(2, 7)}, title: draft.title.trim() || "무제", memo: draft.memo?.trim(), day: draft.day, start: draft.start, end, color: draft.color, emoji: draft.emoji?.trim(), }; setEvents((prev) => { const has = prev.some((x) => x.id === e.id); return has ? prev.map((x) => (x.id === e.id ? e : x)) : [...prev, e]; }); closeEditor(); };

const deleteEvent = (id: string) => setEvents((prev) => prev.filter((x) => x.id !== id)); const clearAll = () => { if (confirm("정말 전체 삭제할까요? 되돌릴 수 없습니다.")) setEvents([]); };

// ---------- EXPORT / IMPORT ---------- const exportJSON = () => downloadFile("timetable.json", JSON.stringify({ meta: { version: 1, exportedAt: new Date().toISOString() }, events, settings: { startHour, endHour, showWeekend }, }, null, 2));

const fileInputRef = useRef<HTMLInputElement>(null); const importJSON = () => fileInputRef.current?.click(); const onImportFile = async (e: React.ChangeEvent<HTMLInputElement>) => { const f = e.target.files?.[0]; if (!f) return; try { const text = await f.text(); const parsed = JSON.parse(text); if (Array.isArray(parsed.events)) setEvents(parsed.events); if (parsed.settings) { setStartHourSafe(parsed.settings.startHour ?? startHour); setEndHourSafe(parsed.settings.endHour ?? endHour); setShowWeekend(!!parsed.settings.showWeekend); } alert("가져오기 완료!"); } catch (err) { alert("가져오기 실패: JSON 형식을 확인하세요."); } finally { e.target.value = ""; // allow re-import same file } };

// ---------- HELPERS ---------- function setStartHourSafe(h: number) { const s = clamp(Math.floor(h), 0, 22); const e = Math.max(s + 2, endHour); // keep at least 2h window setStartHour(s); setEndHour(e); } function setEndHourSafe(h: number) { const e = clamp(Math.ceil(h), 2, 24); const s = Math.min(startHour, e - 2); setStartHour(s); setEndHour(e); }

const onCellClick = (dayIdx: number, hour: number) => { openEditor({ day: dayIdx, start: hour, end: hour + 1 }); };

const gridHoursCount = endHour - startHour;

// ---------- RENDER ---------- return ( <div className={${T.bg} ${T.ink} min-h-screen w-full overflow-hidden}> {/* Header */} <div className={${T.headerGradient} ${T.header} px-4 sm:px-6 py-3 sm:py-4 sticky top-0 z-30 shadow}> <div className="max-w-7xl mx-auto flex items-center gap-3 sm:gap-6"> <div className="flex items-center gap-2 sm:gap-3"> <LogoMark theme={themeKey} /> <div className="leading-tight"> <div className="text-lg sm:text-2xl font-bold tracking-tight flex items-center gap-2"> 시간표 <span className={${T.accent} hidden sm:inline}>Timetable</span> </div> <div className={text-xs sm:text-sm ${T.subtext} opacity-90}>클릭으로 수업 추가 · JSON 내보내기/가져오기 · 인쇄</div> </div> </div>

<div className="ml-auto flex items-center gap-2 sm:gap-3">
        {/* Theme Toggle */}
        <div className="flex items-center rounded-xl overflow-hidden border border-white/20">
          {(["sleek", "cute"] as const).map((k) => (
            <button
              key={k}
              onClick={() => setThemeKey(k)}
              className={`px-3 py-1.5 text-sm font-medium ${themeKey === k ? (k === "sleek" ? "bg-white/10 text-white" : "bg-white/60") : "bg-transparent"}`}
              title={`테마: ${THEMES[k].name}`}
            >{THEMES[k].name}</button>
          ))}
        </div>

        {/* Weekend Toggle */}
        <button
          onClick={() => setShowWeekend((v) => !v)}
          className={`px-3 py-1.5 rounded-lg text-sm font-medium border ${T.grid} ${T.panel} hover:opacity-90 transition`}
          title="주말 표시 토글"
        >{showWeekend ? "주말 표시" : "주말 숨김"}</button>

        {/* Time Range */}
        <div className={`hidden sm:flex items-center gap-2 px-2 py-1.5 rounded-lg border ${T.grid} ${T.panel}`}>
          <label className="text-xs opacity-70">시간</label>
          <select value={startHour} onChange={(e) => setStartHourSafe(parseInt(e.target.value))} className="bg-transparent text-sm outline-none">
            {range(5, 20).map((h) => (
              <option key={h} value={h}>{pad2(h)}:00</option>
            ))}
          </select>
          <span className="text-xs">~</span>
          <select value={endHour} onChange={(e) => setEndHourSafe(parseInt(e.target.value))} className="bg-transparent text-sm outline-none">
            {range(7, 24).map((h) => (
              <option key={h} value={h}>{pad2(h)}:00</option>
            ))}
          </select>
        </div>

        {/* Actions */}
        <button onClick={exportJSON} className={`px-3 py-1.5 rounded-lg text-sm font-semibold border ${T.grid} ${T.panel} hover:opacity-90`}>내보내기</button>
        <button onClick={importJSON} className={`px-3 py-1.5 rounded-lg text-sm font-semibold border ${T.grid} ${T.panel} hover:opacity-90`}>가져오기</button>
        <input ref={fileInputRef} type="file" accept="application/json" className="hidden" onChange={onImportFile} />
        <button onClick={() => window.print()} className={`px-3 py-1.5 rounded-lg text-sm font-semibold border ${T.grid} ${T.panel} hover:opacity-90`}>인쇄</button>
        <button onClick={clearAll} className={`px-3 py-1.5 rounded-lg text-sm font-semibold border ${T.grid} ${T.panel} hover:opacity-90`}>전체삭제</button>
      </div>
    </div>
  </div>

  {/* Main Grid */}
  <div className="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-6">
    <div className={`w-full rounded-2xl shadow-sm border ${T.grid} ${T.panel} overflow-hidden`}> 
      {/* Day Header Row */}
      <div className="grid" style={{ gridTemplateColumns: `80px repeat(${visibleDays.length}, minmax(140px, 1fr))` }}>
        {/* time col spacer */}
        <div className={`px-3 py-2 text-xs sm:text-sm ${T.subtext} bg-white sticky top-[52px] sm:top-[64px] z-20`}>시간</div>
        {visibleDays.map((d, idx) => (
          <div key={d} className={`px-3 py-2 text-xs sm:text-sm font-semibold flex items-center justify-between bg-white border-l ${T.grid} sticky top-[52px] sm:top-[64px] z-20`}>
            <span className="flex items-center gap-2">
              <span>{d}</span>
              {todayIndex === idx && (
                <span className={`px-2 py-0.5 text-[10px] rounded-full ${T.chip}`}>오늘</span>
              )}
            </span>
            <span className={`text-[10px] ${T.subtext}`}>{dayEmoji(themeKey, d)}</span>
          </div>
        ))}
      </div>

      {/* Body Grid */}
      <div className="relative w-full overflow-x-auto">
        <div className="min-w-full">
          {/* Columns: time + days */}
          <div className="grid" style={{ gridTemplateColumns: `80px repeat(${visibleDays.length}, minmax(140px, 1fr))` }}>
            {/* Time column */}
            <div className="relative">
              <div className="grid" style={{ gridTemplateRows: `repeat(${gridHoursCount}, 56px)` }}>
                {hours.map((h, i) => (
                  <div key={i} className={`relative border-t ${T.grid} text-xs sm:text-sm pl-2 flex items-start pt-1`}> {pad2(h)}:00 </div>
                ))}
              </div>
            </div>

            {/* Day columns */}
            {visibleDays.map((d, dayIdx) => (
              <div key={d} className="relative border-l" style={{ borderColor: colorFrom(T.grid) }}>
                {/* Hour cells for click */}
                <div className="grid" style={{ gridTemplateRows: `repeat(${gridHoursCount}, 56px)` }}>
                  {hours.map((h) => (
                    <button
                      key={`${dayIdx}-${h}`}
                      onClick={() => onCellClick(dayIdx, h)}
                      className={`w-full h-full border-t ${T.grid} hover:bg-black/5 transition`} aria-label={`${d} ${pad2(h)}:00에 추가`}
                    />
                  ))}
                </div>

                {/* Events layer (absolute on top of the cell grid) */}
                <div className="absolute inset-0 pointer-events-none">
                  <div className="grid h-full" style={{ gridTemplateRows: `repeat(${gridHoursCount}, 56px)` }}>
                    {events.filter((e) => e.day === dayIdx && inRange(e, startHour, endHour)).map((e) => {
                      const startRow = Math.max(1, e.start - startHour + 1);
                      const endRow = Math.max(startRow + 1, Math.min(gridHoursCount + 1, e.end - startHour + 1));
                      return (
                        <div key={e.id} className="relative" style={{ gridRow: `${startRow} / ${endRow}` }}>
                          <EventCard
                            theme={T}
                            event={e}
                            onEdit={() => openEditor(e)}
                            onDelete={() => deleteEvent(e.id)}
                          />
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Current time line (today only) */}
                {todayIndex === dayIdx && nowInRange(now, startHour, endHour) && (
                  <div className="absolute left-0 right-0" style={{ top: `${timeToPercent(now, startHour, endHour)}%` }}>
                    <div className="h-0.5 bg-rose-500/80" />
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>

    {/* Footer Tips */}
    <div className="mt-4 text-xs sm:text-sm opacity-80 flex flex-wrap items-center gap-2">
      <span className={`px-2 py-1 rounded-lg ${T.chip}`}>Tip: 빈 칸을 클릭하여 수업을 추가하세요.</span>
      <span className={`px-2 py-1 rounded-lg ${T.chip}`}>수업 카드를 클릭하면 수정/삭제 가능</span>
      <span className={`px-2 py-1 rounded-lg ${T.chip}`}>테마 전환으로 "세련" vs "귀여움" 즉시 비교</span>
    </div>
  </div>

  {/* Editor Modal */}
  {draft && (
    <div className="fixed inset-0 z-40 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/40" onClick={closeEditor} />
      <div className={`relative w-full max-w-md rounded-2xl shadow-xl ${T.panel} p-4 sm:p-6 border ${T.grid} ${themeKey === "cute" ? "animate-[pop_0.25s_ease]" : ""}`}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-lg font-semibold flex items-center gap-2">
            {themeKey === "cute" && <span>🗓️</span>} 수업 편집
          </h3>
          <button onClick={closeEditor} className="text-sm opacity-70 hover:opacity-100">닫기</button>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <TextField label="제목" value={draft.title} onChange={(v) => setDraft({ ...draft, title: v })} placeholder="예: 피티/영어/수학" />
          <TextField label="메모" value={draft.memo ?? ""} onChange={(v) => setDraft({ ...draft, memo: v })} placeholder="장소/트레이너 등" />

          <SelectField label="요일" value={String(draft.day)} onChange={(v) => setDraft({ ...draft, day: parseInt(v) })} options={ALL_DAYS.map((d, i) => ({ value: String(i), label: d }))} />

          <div className="grid grid-cols-2 gap-2">
            <SelectField label="시작" value={String(draft.start)} onChange={(v) => setDraft({ ...draft, start: parseInt(v) })} options={range(startHour, endHour).map((h) => ({ value: String(h), label: `${pad2(h)}:00` }))} />
            <SelectField label="기간" value={String(draft.duration)} onChange={(v) => setDraft({ ...draft, duration: parseInt(v) })} options={[1,2,3,4,5].filter(n=>draft.start+n<=endHour).map((n) => ({ value: String(n), label: `${n}시간` }))} />
          </div>

          <div className="grid grid-cols-2 gap-2">
            <ColorField label="색상" value={draft.color} onChange={(v) => setDraft({ ...draft, color: v })} palette={paletteFor(themeKey)} />
            <TextField label="이모지" value={draft.emoji ?? ""} onChange={(v) => setDraft({ ...draft, emoji: v })} placeholder="예: ✨🎾📚" />
          </div>
        </div>

        <div className="mt-5 flex items-center justify-between">
          <div className="text-xs opacity-70">시간 범위: {pad2(startHour)}:00 ~ {pad2(endHour)}:00</div>
          <div className="flex gap-2">
            {draft.id && (
              <button onClick={() => { if(confirm("삭제할까요?")) { deleteEvent(draft.id!); closeEditor(); } }} className={`px-3 py-2 rounded-lg border ${T.grid} hover:opacity-90`}>
                삭제
              </button>
            )}
            <button onClick={saveDraft} className={`px-4 py-2 rounded-lg font-semibold ${T.card} shadow`}>저장</button>
          </div>
        </div>
      </div>
    </div>
  )}

  <style>{`
    @keyframes pop { 0%{ transform: scale(.96); opacity:.0 } 100%{ transform: scale(1); opacity:1 } }
  `}</style>
</div>

); }

// ---------- Subcomponents ---------- function LogoMark({ theme }: { theme: "sleek" | "cute" }) { if (theme === "cute") { return ( <div className="w-9 h-9 rounded-2xl bg-white flex items-center justify-center shadow-inner border border-white/50"> <span role="img" aria-label="sparkle" className="text-xl">✨</span> </div> ); } return ( <div className="w-9 h-9 rounded-2xl bg-white/10 flex items-center justify-center ring-1 ring-white/30"> <div className="w-4 h-4 rounded-full bg-[#d4af37]" /> </div> ); }

function TextField({ label, value, onChange, placeholder }: { label: string; value: string; onChange: (v: string) => void; placeholder?: string }) { return ( <label className="flex flex-col gap-1 text-sm"> <span className="opacity-70">{label}</span> <input value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} className="px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white" /> </label> ); }

function SelectField({ label, value, onChange, options }: { label: string; value: string; onChange: (v: string) => void; options: { value: string; label: string }[] }) { return ( <label className="flex flex-col gap-1 text-sm"> <span className="opacity-70">{label}</span> <select value={value} onChange={(e) => onChange(e.target.value)} className="px-3 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white"> {options.map((o) => ( <option key={o.value} value={o.value}>{o.label}</option> ))} </select> </label> ); }

function ColorField({ label, value, onChange, palette }: { label: string; value: string; onChange: (v: string) => void; palette: string[] }) { return ( <label className="flex flex-col gap-1 text-sm"> <span className="opacity-70">{label}</span> <div className="flex items-center gap-2"> <input type="color" value={value} onChange={(e) => onChange(e.target.value)} className="w-12 h-9 p-0 rounded cursor-pointer" /> <div className="flex gap-1 flex-wrap"> {palette.map((c) => ( <button key={c} title={c} onClick={() => onChange(c)} className="w-6 h-6 rounded-full border border-black/10" style={{ background: c }} /> ))} </div> </div> </label> ); }

function EventCard({ theme, event, onEdit, onDelete }: { theme: any; event: { id: string; title: string; memo?: string; start: number; end: number; color?: string; emoji?: string }; onEdit: () => void; onDelete: () => void; }) { const duration = Math.max(1, event.end - event.start); const handleClick = () => onEdit(); return ( <div className="absolute inset-x-1 top-1 bottom-1 pointer-events-auto"> <div onClick={handleClick} className={w-full h-full rounded-xl shadow ${theme.ring} ring-2 flex flex-col justify-between p-2} style={{ background: event.color || "#111827" }} title={${event.title} (${pad2(event.start)}:00~${pad2(event.end)}:00)} > <div className="flex items-start justify-between gap-2"> <div className="text-sm font-semibold leading-tight">{event.emoji ? ${event.emoji}  : ""}{event.title}</div> <div className="text-[10px] opacity-80">{pad2(event.start)}~{pad2(event.end)}</div> </div> {event.memo && <div className="text-[11px] opacity-90 leading-snug line-clamp-2">{event.memo}</div>} <div className="flex items-center justify-end gap-2 text-[10px]"> <button onClick={(e)=>{e.stopPropagation(); onDelete();}} className="px-2 py-0.5 rounded bg-white/30 hover:bg-white/50">삭제</button> <button onClick={(e)=>{e.stopPropagation(); onEdit();}} className="px-2 py-0.5 rounded bg-white/30 hover:bg-white/50">편집</button> </div> </div> </div> ); }

// ---------- Hooks & Utils ---------- function useNowMinuteTick() { const [now, setNow] = useState(new Date()); useEffect(() => { const t = setInterval(() => setNow(new Date()), 60 * 1000); return () => clearInterval(t); }, []); return now; }

function range(a: number, b: number) { // [a..b) return Array.from({ length: Math.max(0, b - a) }, (_, i) => a + i); } function pad2(n: number) { return String(n).padStart(2, "0"); } function clamp(n: number, lo: number, hi: number) { return Math.max(lo, Math.min(hi, n)); } function colorFrom(tailwindBorder: string) { // expects format like "border-[#e5e7eb]"; fallback to #e5e7eb const m = tailwindBorder.match(/]+)]/); return m ? m[1] : "#e5e7eb"; } function inRange(e: { start: number; end: number }, s: number, ed: number) { return e.end > s && e.start < ed; } function nowInRange(now: Date, s: number, e: number) { const h = now.getHours() + now.getMinutes() / 60; return h >= s && h <= e; } function timeToPercent(now: Date, s: number, e: number) { const h = now.getHours() + now.getMinutes() / 60; const ratio = (h - s) / (e - s); return clamp(ratio * 100, 0, 100); } function defaultColor(theme: "sleek" | "cute") { return theme === "sleek" ? "#0d1b2a" : "#ffdfe9"; } function paletteFor(theme: "sleek" | "cute") { return theme === "sleek" ? ["#0d1b2a", "#1b263b", "#415a77", "#778da9", "#d4af37", "#065f46", "#1f2937"] : ["#ffdfe9", "#ffe8bb", "#e6ffcc", "#c7f0ff", "#e8d7ff", "#ff9ec1", "#ffd1dc"]; } function dayEmoji(theme: "sleek" | "cute", d: string) { if (theme === "cute") { const map: Record<string, string> = { 월: "🌸", 화: "🍑", 수: "💧", 목: "🍀", 금: "⭐", 토: "🦄", 일: "🌈" }; return map[d] ?? "✨"; } return ""; } function downloadFile(filename: string, text: string) { const blob = new Blob([text], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }

