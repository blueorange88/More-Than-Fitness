<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>회원 신규 등록</title>
  <style>
    :root{
      --ink:#0d1b2a; --bg:#f5f0e8; --card:#fff; --line:#e5e7eb;
      --brand:#0d1b2a; --brand2:#cfa35e; --danger:#ef4444; --danger-bg:#fee2e2;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:16px}
    .container{max-width:860px;margin:auto;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .title{font-size:18px;font-weight:800}
    /* 촘촘한 그리드: 칸 길이 자동으로 '짧게' 맞춤 */
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:10px}
    label{display:block;font-size:12px;font-weight:700;margin:2px 0 6px}
    input,select,textarea{width:100%;padding:8px 9px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px}
    textarea{resize:vertical}
    .help{font-size:11px;color:#6b7280;margin-top:4px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:#bfc5cc}
    .btn-primary{border-color:var(--brand);color:var(--brand);font-weight:800}
    .btn-primary:hover{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
    .banner{display:none;margin:8px 0;padding:10px 12px;border-radius:10px;font-size:14px}
    .banner.error{background:var(--danger-bg);border:1px solid var(--danger);color:#991b1b}
    .divider{height:1px;background:var(--line);margin:12px 0}
    details.inbody{border:1px dashed var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    details.inbody>summary{cursor:pointer;font-weight:800;color:var(--brand)}
    .muted{color:#6b7280}
    /* 더 작은 모바일 최적화 */
    @media (max-width:420px){
      body{padding:12px}
      .container{padding:12px}
      input,select,textarea{padding:7px 8px;font-size:13px}
      .title{font-size:17px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">회원 신규 등록</div>
      <button class="btn" onclick="location.href='/member-list-edit.html'">목록으로</button>
    </div>

    <div id="banner" class="banner error" role="alert"></div>

    <form id="regForm" autocomplete="off">
      <!-- 등록일을 '맨 위'로 올린 첫 줄 -->
      <div class="row">
        <div>
          <label>이름</label>
          <input type="text" name="name" required />
        </div>
        <div>
          <label>최초 등록일</label>
          <input type="date" name="startDate" />
        </div>
        <div>
          <label>성별</label>
          <select name="gender">
            <option>여성</option><option>남성</option>
          </select>
        </div>
      </div>

      <!-- 기본 연락/생일 -->
      <div class="row">
        <div>
          <label>생년월일</label>
          <input id="birth" type="text" name="birth" inputmode="numeric" maxlength="10" placeholder="YYYY-MM-DD" />
          <div class="help">자동 하이픈 · 유효 범위 검사</div>
        </div>
        <div>
          <label>휴대폰번호 (문서ID)</label>
          <input id="phone" type="tel" name="phone" inputmode="numeric" maxlength="13" placeholder="010-0000-0000" required />
          <div class="help">숫자 10~11자리 · 자동 하이픈</div>
        </div>
      </div>

      <!-- 보호자/가족 -->
      <div class="row">
        <div>
          <label>보호자 성명</label>
          <input type="text" name="guardianName" />
        </div>
        <div>
          <label>가족관계</label>
          <select name="guardianRelation">
            <option value="">선택</option>
            <option>배우자</option><option>부모</option><option>자녀</option>
            <option>형제자매</option><option>보호자</option><option>기타</option>
          </select>
        </div>
        <div>
          <label>보호자 연락처</label>
          <input id="guardianPhone" type="tel" name="guardianPhone" inputmode="numeric" maxlength="13" placeholder="010-0000-0000" />
        </div>
      </div>

      <!-- 이용 정보 -->
      <div class="row">
        <div>
          <label>담당 트레이너</label>
          <input type="text" name="trainer" />
        </div>
        <div>
          <label>레슨 유형</label>
          <select name="lessonType">
            <option value="">선택</option><option>PT</option><option>PILATES</option><option>GOLF</option>
          </select>
        </div>
        <div>
          <label>회원 등급</label>
          <select name="level">
            <option>일반</option><option>VIP</option><option>프로모션</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>주소</label>
          <input type="text" name="address" />
        </div>
        <div>
          <label>메모(특이사항)</label>
          <input type="text" name="memberMemo" placeholder="예: 허리 디스크, 오전 선호 등" />
        </div>
      </div>

      <div class="row">
        <div style="grid-column:1 / -1">
          <label>건강 특이사항</label>
          <textarea name="healthMemo" rows="3" placeholder="알레르기/복용약/주의사항 등"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <!-- 인바디 입력 -->
      <details class="inbody">
        <summary>➕ 인바디 등록하기</summary>
        <p class="muted" style="margin:8px 0 10px">값을 입력하면 최신 인바디로 저장되고, 최초 1건은 inbodyHistory에도 기록됩니다.</p>
        <div class="row">
          <div><label>키(cm)</label><input type="number" step="0.1" name="heightCm" placeholder="170.0" /></div>
          <div><label>몸무게(kg)</label><input type="number" step="0.1" name="weightKg" placeholder="65.5" /></div>
          <div><label>골격근량(kg)</label><input type="number" step="0.1" name="muscleMass" placeholder="29.8" /></div>
          <div><label>체지방률(%)</label><input type="number" step="0.1" name="bodyFatPercent" placeholder="18.5" /></div>
          <div><label>체지방량(kg)</label><input type="number" step="0.1" name="bodyFatMass" placeholder="12.1" /></div>
        </div>
      </details>

      <div class="actions">
        <button type="button" class="btn" onclick="location.href='/member-list-edit.html'">취소</button>
        <button type="submit" class="btn btn-primary">등록</button>
      </div>
    </form>

    <div id="loading" class="muted" style="display:none;margin-top:6px">저장 중…</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
      authDomain: "more-than-fitness-f6adb.firebaseapp.com",
      projectId: "more-than-fitness-f6adb",
      storageBucket: "more-than-fitness-f6adb.appspot.com",
      messagingSenderId: "993248877411",
      appId: "1:993248877411:web:c0e6785162cf252fbcd156",
      measurementId: "G-MK0RVFG296"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const COL = "members";

    /* ===== DOM/UTIL ===== */
    const $ = (s)=>document.querySelector(s);
    const form = $("#regForm");
    const banner = $("#banner");
    const loading = $("#loading");

    const onlyDigits = (s)=> String(s||"").replace(/\D/g,"");
    const fmtPhone = (raw)=>{
      const v = onlyDigits(raw).slice(0,11);
      if (v.length<=3) return v;
      if (v.length<=7) return v.slice(0,3)+"-"+v.slice(3);
      return v.slice(0,3)+"-"+v.slice(3,7)+"-"+v.slice(7);
    };
    const fmtBirth = (raw)=>{
      const v = onlyDigits(raw).slice(0,8);
      if (v.length<=4) return v;
      if (v.length<=6) return v.slice(0,4)+"-"+v.slice(4);
      return v.slice(0,4)+"-"+v.slice(4,6)+"-"+v.slice(6,8);
    };
    const isValidBirth = (birthStr)=>{
      const d = onlyDigits(birthStr);
      if (d.length !== 8) return false;
      const yyyy = +d.slice(0,4), mm = +d.slice(4,6), dd = +d.slice(6,8);
      if (mm<1 || mm>12) return false;
      const mdays=[31,28+(((yyyy%4===0&&yyyy%100!==0)||yyyy%400===0)?1:0),31,30,31,30,31,31,30,31,30,31];
      if (dd<1 || dd>mdays[mm-1]) return false;
      return true;
    };
    const isValidPhone = (p)=> {
      const n = onlyDigits(p);
      return n.length===10 || n.length===11;
    };
    function showBanner(msg){ banner.textContent=msg; banner.style.display="block"; window.scrollTo({top:0,behavior:"smooth"}); }
    function hideBanner(){ banner.style.display="none"; }

    // 입력 중 포맷팅
    $("#phone").addEventListener("input", e=> e.target.value = fmtPhone(e.target.value));
    $("#guardianPhone").addEventListener("input", e=> e.target.value = fmtPhone(e.target.value));
    $("#birth").addEventListener("input", e=> e.target.value = fmtBirth(e.target.value));

    // 페이지 진입 시 등록일 기본값(오늘) 세팅
    (function setDefaultStartDate(){
      const el = form.startDate;
      if (!el.value){
        const today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        el.value = today.toISOString().slice(0,10);
      }
    })();

    /* ===== Submit ===== */
    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); hideBanner();
      loading.style.display = "block";

      try{
        const name = form.name.value.trim();
        const gender = form.gender.value || "여성";
        const phoneDisplay = fmtPhone(form.phone.value);
        const phone = onlyDigits(phoneDisplay);
        const birthDisplay = form.birth.value.trim();
        const birth = onlyDigits(birthDisplay);

        if (!name){ showBanner("이름을 입력하세요."); loading.style.display="none"; return; }
        if (!isValidPhone(phoneDisplay)){ showBanner("휴대폰 번호 형식이 올바르지 않습니다."); loading.style.display="none"; return; }
        if (birthDisplay && !isValidBirth(birthDisplay)){ showBanner("생년월일 형식이 올바르지 않습니다."); loading.style.display="none"; return; }
        if (form.guardianPhone.value && !isValidPhone(form.guardianPhone.value)){ showBanner("보호자 연락처 형식이 올바르지 않습니다."); loading.style.display="none"; return; }

        const docId = phone;
        const ref = doc(db, COL, docId);
        const exists = await getDoc(ref);
        if (exists.exists()){
          showBanner("이미 등록된 휴대폰 번호입니다. 회원 수정 화면에서 변경하세요.");
          loading.style.display="none"; return;
        }

        // 인바디 값
        const heightCm = form.heightCm.value ? Number(form.heightCm.value) : null;
        const weightKg = form.weightKg.value ? Number(form.weightKg.value) : null;
        const muscleMass = form.muscleMass.value ? Number(form.muscleMass.value) : null;
        const bodyFatPercent = form.bodyFatPercent.value ? Number(form.bodyFatPercent.value) : null;
        const bodyFatMass = form.bodyFatMass.value ? Number(form.bodyFatMass.value) : null;

        const basePayload = {
          name, gender,
          phone, phoneDisplay,
          birth: birth || null,
          birthDisplay: birthDisplay || null,

          trainer: form.trainer.value || "",
          lessonType: form.lessonType.value || "",
          level: form.level.value || "일반",
          address: form.address.value || "",

          guardianName: form.guardianName.value || "",
          guardianRelation: form.guardianRelation.value || "",
          emergency: onlyDigits(form.guardianPhone.value) || null,

          memberMemo: form.memberMemo.value || "",
          healthMemo: form.healthMemo.value || "",

          startDate: form.startDate.value || null,

          totalSessionsPurchased: 0,
          remainingSessions: 0,

          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const withInbody = (heightCm||weightKg||muscleMass||bodyFatPercent||bodyFatMass)
          ? {
              heightCm, weightKg, muscleMass, bodyFatPercent, bodyFatMass,
              inbodyHistory: [{
                heightCm, weightKg, muscleMass, bodyFatPercent, bodyFatMass,
                createdAt: serverTimestamp()
              }]
            }
          : {};

        await setDoc(ref, { ...basePayload, ...withInbody });

        alert("등록이 완료되었습니다.");
        location.href="/member-list-edit.html";
      }catch(err){
        console.error(err);
        showBanner("저장 실패: " + err.message);
      }finally{
        loading.style.display = "none";
      }
    });
  </script>
</body>
</html>
