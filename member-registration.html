<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íšŒì› ë“±ë¡/ìˆ˜ì •</title>
  <style>
    :root{
      --ink:#0d1b2a; --bg:#f5f0e8; --card:#fff; --line:#e5e7eb;
      --brand:#0d1b2a; --brand2:#cfa35e; --danger:#ef4444; --danger-bg:#fee2e2;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:16px}
    .container{max-width:920px;margin:auto;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .title{font-size:18px;font-weight:800}
    .navs{display:flex;gap:8px}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:10px}
    label{display:block;font-size:12px;font-weight:700;margin:2px 0 6px}
    input,select,textarea{width:100%;padding:8px 9px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px}
    textarea{resize:vertical}
    .help{font-size:11px;color:#6b7280;margin-top:4px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:#bfc5cc}
    .btn-primary{border-color:var(--brand);color:var(--brand);font-weight:800}
    .btn-primary:hover{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff}
    .banner{display:none;margin:8px 0;padding:10px 12px;border-radius:10px;font-size:14px}
    .banner.error{background:var(--danger-bg);border:1px solid var(--danger);color:#991b1b}
    .divider{height:1px;background:var(--line);margin:12px 0}
    details.inbody{border:1px dashed var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    details.inbody>summary{cursor:pointer;font-weight:800;color:var(--brand)}
    .muted{color:#6b7280}
    .photo-card{display:flex;gap:12px;align-items:center;border:1px dashed var(--line);border-radius:12px;padding:10px}
    .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;background:#f3f4f6;border:1px solid var(--line)}
    .avatar.skeleton{background:linear-gradient(90deg,#f3f4f6 0%,#e5e7eb 50%,#f3f4f6 100%);animation:sh 1.2s infinite}
    @keyframes sh{0%{background-position:-100px}100%{background-position:200px}}
    /* ëª¨ë‹¬ */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000}
    .popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:10px;z-index:1001;width:520px;max-width:94%;max-height:84vh;overflow:auto}
    .popup h3{margin:0 0 8px;font-size:16px}
    .history-item{border-bottom:1px solid #eee;padding:6px 2px}
    .history-item .k{font-weight:700}
    @media (max-width:420px){
      body{padding:12px}
      .container{padding:12px}
      input,select,textarea{padding:7px 8px;font-size:13px}
      .title{font-size:17px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title" id="pageTitle">íšŒì› ì‹ ê·œ ë“±ë¡</div>
      <div class="navs">
        <button class="btn" onclick="location.href='/MTF-F.html'">ë©”ì¸ìœ¼ë¡œ</button>
        <button class="btn" onclick="location.href='/member-list-edit.html'">ëª©ë¡ìœ¼ë¡œ</button>
        <button class="btn" id="btnOpenHistory" style="display:none">ğŸ“œ íˆìŠ¤í† ë¦¬</button>
      </div>
    </div>

    <div id="banner" class="banner error" role="alert"></div>

    <form id="regForm" autocomplete="off">
      <!-- ë“±ë¡ì¼ / ì´ë¦„ / ì„±ë³„ -->
      <div class="row">
        <div>
          <label>ë“±ë¡ì¼</label>
          <input type="date" name="startDate" />
        </div>
        <div>
          <label>ì´ë¦„</label>
          <input type="text" name="name" required />
        </div>
        <div>
          <label>ì„±ë³„</label>
          <select name="gender">
            <option>ì—¬ì„±</option><option>ë‚¨ì„±</option>
          </select>
        </div>
      </div>

      <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
      <div class="row" style="align-items:center">
        <div style="grid-column:1 / -1">
          <div class="photo-card">
            <img id="avatarPreview" class="avatar" alt="profile preview">
            <div class="photo-actions">
              <input type="file" id="photoFile" accept="image/*">
              <button type="button" class="btn" id="btnClearPhoto">ì‚­ì œ</button>
              <div class="help">Storage ê²½ë¡œ: <code>members/{ë¬¸ì„œID}/profile.jpg</code></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê¸°ë³¸ ì—°ë½/ìƒì¼ -->
      <div class="row">
        <div>
          <label>ìƒë…„ì›”ì¼</label>
          <input id="birth" type="text" name="birth" inputmode="numeric" maxlength="10" placeholder="YYYY-MM-DD" />
          <div class="help">ìë™ í•˜ì´í”ˆ Â· ìœ íš¨ ë²”ìœ„ ê²€ì‚¬</div>
        </div>
        <div>
          <label>íœ´ëŒ€í°ë²ˆí˜¸ (ë¬¸ì„œID)</label>
          <input id="phone" type="tel" name="phone" inputmode="numeric" maxlength="13" placeholder="010-0000-0000" required />
          <div class="help">ìˆ«ì 10~11ìë¦¬ Â· ìë™ í•˜ì´í”ˆ Â· ì¤‘ë³µ ì¦‰ì‹œì²´í¬</div>
        </div>
      </div>

      <!-- ì£¼ì†Œ / ì§ì—… / ë©”ëª¨ -->
      <div class="row">
        <div>
          <label>ì£¼ì†Œ</label>
          <input type="text" name="address" />
        </div>
        <div>
          <label>ì§ì—…</label>
          <input type="text" name="job" placeholder="ì˜ˆ: í•™ìƒ / ì‚¬ë¬´ì§" />
        </div>
        <div>
          <label>ë©”ëª¨(íŠ¹ì´ì‚¬í•­)</label>
          <input type="text" name="memberMemo" placeholder="ì˜ˆ: ì˜¤ì „ ì„ í˜¸, í—ˆë¦¬ ì£¼ì˜" />
        </div>
      </div>

      <!-- ë³´í˜¸ì: í† ê¸€ -->
      <div class="row" style="margin-top:2px">
        <div style="grid-column:1 / -1">
          <button type="button" class="btn" id="btnToggleGuardian">â• ë³´í˜¸ì ë“±ë¡</button>
        </div>
      </div>
      <div class="row" id="guardianFields" style="display:none">
        <div>
          <label>ë³´í˜¸ì ì„±ëª…</label>
          <input type="text" name="guardianName" />
        </div>
        <div>
          <label>ê°€ì¡±ê´€ê³„</label>
          <select name="guardianRelation">
            <option value="">ì„ íƒ</option>
            <option>ë°°ìš°ì</option><option>ë¶€ëª¨</option><option>ìë…€</option>
            <option>í˜•ì œìë§¤</option><option>ë³´í˜¸ì</option><option>ê¸°íƒ€</option>
          </select>
        </div>
        <div>
          <label>ë³´í˜¸ì ì—°ë½ì²˜</label>
          <input id="guardianPhone" type="tel" name="guardianPhone" inputmode="numeric" maxlength="13" placeholder="010-0000-0000" />
        </div>
      </div>

      <!-- ì´ìš© ì •ë³´ -->
      <div class="row">
        <div>
          <label>ë‹´ë‹¹ íŠ¸ë ˆì´ë„ˆ</label>
          <input type="text" name="trainer" />
        </div>
        <div>
          <label>ë ˆìŠ¨ ìœ í˜•</label>
          <select name="lessonType">
            <option value="">ì„ íƒ</option><option>PT</option><option>PILATES</option><option>GOLF</option>
          </select>
        </div>
        <div>
          <label>íšŒì› ë“±ê¸‰</label>
          <select name="level">
            <option>ì¼ë°˜</option><option>VIP</option><option>í”„ë¡œëª¨ì…˜</option>
          </select>
        </div>
      </div>

      <!-- ê²°ì œ/íšŒì°¨(ìë™ ë‚¨ì€ íšŸìˆ˜ ê³„ì‚°) -->
      <div class="row">
        <div><label>ë“±ë¡ ê¸ˆì•¡(ì›)</label>
          <input type="number" name="purchaseAmount" min="0" step="1000" placeholder="0">
        </div>
        <div><label>ë“±ë¡ íšŸìˆ˜</label>
          <input type="number" name="totalSessionsPurchased" min="0" step="1" value="0">
        </div>
        <div><label>ì†Œì§„ íšŸìˆ˜</label>
          <input type="number" name="consumedSessions" min="0" step="1" value="0">
        </div>
        <div><label>ë‚¨ì€ íšŸìˆ˜</label>
          <input type="number" name="remainingSessions" value="0" readonly>
        </div>
        <div><label>ì¬ë“±ë¡ íšŸìˆ˜</label>
          <input type="number" name="renewalCount" value="0" readonly>
        </div>
      </div>

      <div class="row">
        <div style="grid-column:1 / -1">
          <label>ê±´ê°• íŠ¹ì´ì‚¬í•­</label>
          <textarea name="healthMemo" rows="3" placeholder="ì•Œë ˆë¥´ê¸°/ë³µìš©ì•½/ì£¼ì˜ì‚¬í•­ ë“±"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <!-- ì¸ë°”ë”” ì…ë ¥ -->
      <details class="inbody">
        <summary>â• ì¸ë°”ë”” ë“±ë¡í•˜ê¸°</summary>
        <p class="muted" style="margin:8px 0 10px">ê°’ì„ ì…ë ¥í•˜ë©´ ìµœì‹  ì¸ë°”ë””ë¡œ ì €ì¥ë˜ê³ , ìµœì´ˆ 1ê±´ì€ inbodyHistoryì—ë„ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
        <div class="row">
          <div><label>í‚¤(cm)</label><input type="number" step="0.1" name="heightCm" placeholder="170.0" /></div>
          <div><label>ëª¸ë¬´ê²Œ(kg)</label><input type="number" step="0.1" name="weightKg" placeholder="65.5" /></div>
          <div><label>ê³¨ê²©ê·¼ëŸ‰(kg)</label><input type="number" step="0.1" name="muscleMass" placeholder="29.8" /></div>
          <div><label>ì²´ì§€ë°©ë¥ (%)</label><input type="number" step="0.1" name="bodyFatPercent" placeholder="18.5" /></div>
          <div><label>ì²´ì§€ë°©ëŸ‰(kg)</label><input type="number" step="0.1" name="bodyFatMass" placeholder="12.1" /></div>
        </div>
      </details>

      <div class="actions">
        <button type="button" class="btn" onclick="location.href='/member-list-edit.html'">ëª©ë¡</button>
        <button type="button" class="btn" id="btnRenewal" style="display:none">â• ì¬ë“±ë¡</button>
        <button type="submit" class="btn btn-primary">ì €ì¥</button>
      </div>
    </form>

    <div id="loading" class="muted" style="display:none;margin-top:6px">ì²˜ë¦¬ ì¤‘â€¦</div>
  </div>

  <!-- overlay & history modal -->
  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popupHistory" role="dialog" aria-modal="true" aria-labelledby="popupHistoryTitle">
    <h3 id="popupHistoryTitle">íˆìŠ¤í† ë¦¬</h3>
    <div id="historyInfo" class="muted" style="margin-bottom:8px"></div>
    <div id="historyList" style="max-height:40vh;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px"></div>
    <div style="margin-top:10px;border-top:1px dashed #e5e7eb;padding-top:10px">
      <div style="font-weight:800;margin-bottom:6px">ì¬ë“±ë¡</div>
      <input type="number" id="reAmount" placeholder="ê¸ˆì•¡(ì›)" />
      <input type="number" id="reSessions" placeholder="íšŒì°¨(+)" />
      <textarea id="reMemo" rows="2" placeholder="ë©”ëª¨(ì„ íƒ)"></textarea>
      <div class="actions" style="justify-content:flex-end">
        <button class="btn" id="btnHistoryClose">ë‹«ê¸°</button>
        <button class="btn btn-primary" id="btnRenewalSave">ì¬ë“±ë¡ ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Firebase (app, firestore, storage) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp,
      collection, addDoc, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";

    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCjdyveDx0qFPUzmaChnEy9Ni0VjTysYnM",
      authDomain: "more-than-fitness-f6adb.firebaseapp.com",
      projectId: "more-than-fitness-f6adb",
      storageBucket: "more-than-fitness-f6adb.appspot.com",
      messagingSenderId: "993248877411",
      appId: "1:993248877411:web:c0e6785162cf252fbcd156",
      measurementId: "G-MK0RVFG296"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const storage = getStorage(app);
    const COL = "members";

    /* ===== DOM/UTIL ===== */
    const $ = (s)=>document.querySelector(s);
    const form = $("#regForm");
    const banner = $("#banner");
    const loading = $("#loading");
    const phoneEl = $("#phone");
    const guardianPhoneEl = $("#guardianPhone");
    const birthEl = $("#birth");

    const photoFile = $("#photoFile");
    const avatarPreview = $("#avatarPreview");
    const btnClearPhoto = $("#btnClearPhoto");

    const overlay = $("#overlay");
    const popupHistory = $("#popupHistory");
    const btnOpenHistory = $("#btnOpenHistory");
    const btnRenewal = $("#btnRenewal");

    const DRAFT_KEY='member_reg_or_edit_v1';

    const onlyDigits = (s)=> String(s||"").replace(/\D/g,"");
    const fmtPhone = (raw)=>{
      const v = onlyDigits(raw).slice(0,11);
      if (v.length<=3) return v;
      if (v.length<=7) return v.slice(0,3)+"-"+v.slice(3);
      return v.slice(0,3)+"-"+v.slice(3,7)+"-"+v.slice(7);
    };
    const fmtBirth = (raw)=>{
      const v = onlyDigits(raw).slice(0,8);
      if (v.length<=4) return v;
      if (v.length<=6) return v.slice(0,4)+"-"+v.slice(4);
      return v.slice(0,4)+"-"+v.slice(4,6)+"-"+v.slice(6,8);
    };
    const isValidBirth = (birthStr)=>{
      const d = onlyDigits(birthStr);
      if (d.length !== 8) return false;
      const yyyy = +d.slice(0,4), mm = +d.slice(4,6), dd = +d.slice(6,8);
      if (mm<1 || mm>12) return false;
      const mdays=[31,28+(((yyyy%4===0&&yyyy%100!==0)||yyyy%400===0)?1:0),31,30,31,30,31,31,30,31,30,31];
      if (dd<1 || dd>mdays[mm-1]) return false;
      return true;
    };
    const isValidPhone = (p)=> {
      const n = onlyDigits(p);
      return n.length===10 || n.length===11;
    };
    function showBanner(msg){ banner.textContent=msg; banner.style.display="block"; window.scrollTo({top:0,behavior:"smooth"}); }
    function hideBanner(){ banner.style.display="none"; }

    function openModal(el){ overlay.style.display='block'; el.style.display='block'; }
    function closeModal(el){ el.style.display='none'; overlay.style.display='none'; }
    overlay.addEventListener('click', ()=> closeModal(popupHistory));
    $("#btnHistoryClose").addEventListener('click', ()=> closeModal(popupHistory));

    // ê¸°ë³¸ê°’: ì˜¤ëŠ˜ ë‚ ì§œ
    (function setDefaultStartDate(){
      const el = form.startDate;
      if (!el.value){
        const today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        el.value = today.toISOString().slice(0,10);
      }
    })();

    // ì…ë ¥ í¬ë§·íŒ…
    phoneEl.addEventListener("input", e=> e.target.value = fmtPhone(e.target.value));
    guardianPhoneEl.addEventListener("input", e=> e.target.value = fmtPhone(e.target.value));
    birthEl.addEventListener("input", e=> e.target.value = fmtBirth(e.target.value));

    // ë‚¨ì€ íšŸìˆ˜ ìë™ ê³„ì‚°
    ['totalSessionsPurchased','consumedSessions'].forEach(n=>{
      form[n].addEventListener('input', ()=>{
        const total = +form.totalSessionsPurchased.value||0;
        const used  = +form.consumedSessions.value||0;
        form.remainingSessions.value = Math.max(0, total - used);
      });
    });

    // ë³´í˜¸ì í† ê¸€
    $("#btnToggleGuardian").addEventListener("click", ()=>{
      const wrap = $("#guardianFields");
      const show = wrap.style.display === 'none';
      wrap.style.display = show ? 'grid' : 'none';
      const name = wrap.querySelector('[name="guardianName"]');
      const phone = wrap.querySelector('[name="guardianPhone"]');
      [name, phone].forEach(el=>{
        if (show) el.required = true;
        else { el.required = false; el.value = ''; }
      });
    });

    // í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸° & ì´ˆê¸° ìƒíƒœ
    const resetAvatar = ()=>{ avatarPreview.src=''; avatarPreview.classList.add('skeleton'); }
    resetAvatar();
    photoFile.addEventListener('change', ()=>{
      const f = photoFile.files?.[0];
      if (!f){ resetAvatar(); return; }
      const url = URL.createObjectURL(f);
      avatarPreview.classList.remove('skeleton');
      avatarPreview.src = url;
    });
    btnClearPhoto.addEventListener('click', ()=>{
      photoFile.value = '';
      resetAvatar();
    });

    // ===== íˆìŠ¤í† ë¦¬ ë¡œê¹… ìœ í‹¸ =====
    async function logMemberUpdate(memberId, { kind='update', note='', meta=null }){
      try{
        await addDoc(collection(db,'members', memberId, 'history'), {
          kind, note, meta, createdAt: serverTimestamp()
        });
      }catch(e){ console.error('history log failed', e); }
    }

    // ===== ëª¨ë“œ íŒì • (ì‹ ê·œ/ìˆ˜ì •) =====
    const params = new URLSearchParams(location.search);
    const editingId = params.get('id') ? onlyDigits(params.get('id')) : null;
    if(editingId){
      $("#pageTitle").textContent = "íšŒì› í”„ë¡œí•„ / ìˆ˜ì •";
      btnOpenHistory.style.display='inline-block';
      btnRenewal.style.display='inline-block';
      // ë¬¸ì„œ ë¡œë“œ
      loadMember(editingId);
    } else {
      // íœ´ëŒ€í° ì¤‘ë³µ ì¦‰ì‹œì²´í¬
      phoneEl.addEventListener('blur', async e=>{
        const id = onlyDigits(e.target.value);
        if (!id) return;
        const s = await getDoc(doc(db, COL, id));
        if (s.exists()){
          showBanner('ì´ë¯¸ ë“±ë¡ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤. ì´ íšŒì›ì„ ìˆ˜ì •í•˜ì‹œê² ì–´ìš”?');
          if (confirm('ê¸°ì¡´ íšŒì›ì…ë‹ˆë‹¤. ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?')){
            location.href = `/member-registration.html?id=${id}`;
          }
        }
      });
    }

    // ===== ë“œë˜í”„íŠ¸ ì €ì¥/ë³µêµ¬ (ì‹ ê·œì¼ ë•Œë§Œ) =====
    function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
    if(!editingId){
      form.addEventListener('input', debounce(()=>{
        const data = Object.fromEntries(new FormData(form).entries());
        // íŒŒì¼ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ
        localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
      },300));
      (function restore(){
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        Object.keys(data).forEach(k=>{ if(form[k] && k!=='photoFile') form[k].value = data[k]; });
      })();
    }
    function clearDraft(){ localStorage.removeItem(DRAFT_KEY); }

    // ===== ì €ì¥(ì‹ ê·œ/ìˆ˜ì •) =====
    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); hideBanner();
      loading.style.display = "block";
      try{
        const name = form.name.value.trim();
        const gender = form.gender.value || "ì—¬ì„±";
        const phoneDisplay = fmtPhone(form.phone.value);
        const phone = onlyDigits(phoneDisplay);
        const birthDisplay = form.birth.value.trim();
        const birth = onlyDigits(birthDisplay);

        if (!name){ showBanner("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); loading.style.display="none"; return; }
        if (!isValidPhone(phoneDisplay)){ showBanner("íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); loading.style.display="none"; return; }
        if (birthDisplay && !isValidBirth(birthDisplay)){ showBanner("ìƒë…„ì›”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); loading.style.display="none"; return; }
        if ($("#guardianFields").style.display!=='none' && form.guardianPhone.value && !isValidPhone(form.guardianPhone.value)){
          showBanner("ë³´í˜¸ì ì—°ë½ì²˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); loading.style.display="none"; return;
        }

        const docId = editingId || phone;
        const ref = doc(db, COL, docId);
        const exists = await getDoc(ref);

        if(!editingId && exists.exists()){
          showBanner("ì´ë¯¸ ë“±ë¡ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤. íšŒì› ìˆ˜ì • í™”ë©´ì—ì„œ ë³€ê²½í•˜ì„¸ìš”.");
          loading.style.display="none"; return;
        }

        // ì¸ë°”ë”” ê°’
        const heightCm = form.heightCm.value ? Number(form.heightCm.value) : null;
        const weightKg = form.weightKg.value ? Number(form.weightKg.value) : null;
        const muscleMass = form.muscleMass.value ? Number(form.muscleMass.value) : null;
        const bodyFatPercent = form.bodyFatPercent.value ? Number(form.bodyFatPercent.value) : null;
        const bodyFatMass = form.bodyFatMass.value ? Number(form.bodyFatMass.value) : null;

        // ê²°ì œ/íšŒì°¨
        const purchaseAmount = Number(form.purchaseAmount.value)||0;
        const totalSessionsPurchased = Number(form.totalSessionsPurchased.value)||0;
        const consumedSessions = Number(form.consumedSessions.value)||0;
        const remainingSessions = Math.max(0, Number(form.remainingSessions.value)||0);

        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ(ìˆìœ¼ë©´)
        let photoURL = exists.exists() ? (exists.data().photoURL || null) : null;
        if (photoFile.files && photoFile.files[0]){
          const file = photoFile.files[0];
          const pRef = sRef(storage, `members/${docId}/profile.jpg`);
          await uploadBytes(pRef, file);
          photoURL = await getDownloadURL(pRef);
        } else if ($("#btnClearPhoto").dataset.cleared === '1') {
          photoURL = null; // ì‚¬ìš©ìê°€ ì‚­ì œ ëˆŒë €ì„ ë•Œ í‘œì‹œë§Œ í•´ì œ (ì‹¤ì œ Storage ì‚­ì œëŠ” ì„ íƒì‚¬í•­)
        }

        const basePayload = {
          memberId: docId,
          name, gender,
          phone, phoneDisplay,
          birth: birth || null,
          birthDisplay: birthDisplay || null,

          trainer: form.trainer.value || "",
          lessonType: form.lessonType.value || "",
          level: form.level.value || "ì¼ë°˜",
          address: form.address.value || "",
          job: form.job.value || "",
          memberMemo: form.memberMemo.value || "",

          guardianName: form.guardianName.value || "",
          guardianRelation: form.guardianRelation.value || "",
          emergency: onlyDigits(form.guardianPhone.value) || null,

          healthMemo: form.healthMemo.value || "",
          startDate: form.startDate.value || null,

          purchaseAmount,
          lastPurchaseAmount: purchaseAmount || (exists.data?.()?.lastPurchaseAmount||0),
          lastPurchaseDate: form.startDate.value || (exists.data?.()?.lastPurchaseDate || null),
          lastPurchaseSessions: totalSessionsPurchased || (exists.data?.()?.lastPurchaseSessions || 0),

          totalSessionsPurchased,
          consumedSessions,
          remainingSessions,
          renewalCount: exists.exists() ? (exists.data().renewalCount || 0) : 0,

          photoURL: photoURL || null,
          autoSpendEnabled: exists.exists() ? (exists.data().autoSpendEnabled ?? true) : true,
          updatedAt: serverTimestamp()
        };
        if(!exists.exists()){
          basePayload.createdAt = serverTimestamp();
        }

        const withInbody = (heightCm||weightKg||muscleMass||bodyFatPercent||bodyFatMass)
          ? {
              heightCm, weightKg, muscleMass, bodyFatPercent, bodyFatMass,
              ...(exists.exists()?{}:{ // ìµœì´ˆ ë“±ë¡ ì‹œì—ë§Œ history ì´ˆê¸°í™” í•­ëª© í¬í•¨ ê°€ëŠ¥
                inbodyHistory: [{
                  heightCm, weightKg, muscleMass, bodyFatPercent, bodyFatMass,
                  createdAt: serverTimestamp()
                }]
              })
            }
          : {};

        await setDoc(ref, { ...basePayload, ...withInbody }, { merge:true });

        // ì‹ ê·œ ë“±ë¡ ì‹œ PT ì¼ì§€ page-1 ìë™ ìƒì„± (ì—†ì„ ë•Œë§Œ)
        if(!exists.exists()){
          const page1Ref = doc(db, 'members', docId, 'ptLogsV1', 'page-1');
          const page1Snap = await getDoc(page1Ref);
          if (!page1Snap.exists()){
            const defaultRows = Array.from({length:30}, (_,i)=>({
              n:String(i+1), date:"", time:"08:00", note:"",
              trainerSigType:"", trainerSigValue:"",
              customerSigType:"", customerSigValue:"",
              locked:false, nsType:""
            }));
            await setDoc(page1Ref, {
              meta: {
                name, birth: birthDisplay||null, phone: phoneDisplay,
                lesson: form.lessonType.value||"", trainer: form.trainer.value||"",
                start: form.startDate.value||null, page:"1"
              },
              rows: defaultRows,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
          }
          await logMemberUpdate(docId, { kind:'register', note:'ì‹ ê·œ ë“±ë¡' });
        } else {
          await logMemberUpdate(docId, { kind:'profile.update', note:'íšŒì› ì •ë³´ ìˆ˜ì •' });
        }

        clearDraft();
        alert("ì €ì¥ ì™„ë£Œ");
        if(!editingId){
          location.href=`/member-registration.html?id=${docId}`;
        }else{
          // ìˆ˜ì • ëª¨ë“œë©´ í™”ë©´ë§Œ ê°±ì‹ 
          await loadMember(docId, true);
        }
      }catch(err){
        console.error(err);
        showBanner("ì €ì¥ ì‹¤íŒ¨: " + (err.message||err));
        form.querySelector(':invalid')?.focus();
      }finally{
        loading.style.display = "none";
      }
    });

    // ===== ë©¤ë²„ ë¡œë“œ(ìˆ˜ì • ëª¨ë“œ) =====
    async function loadMember(id, silent=false){
      try{
        const snap = await getDoc(doc(db,COL,id));
        if(!snap.exists()){ showBanner("í•´ë‹¹ íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        const d = snap.data();
        // íƒ€ì´í‹€/ë²„íŠ¼
        $("#pageTitle").textContent = `íšŒì› í”„ë¡œí•„ / ${d.name||id}`;
        btnOpenHistory.onclick = async ()=>{
          await renderHistory(id);
          openModal(popupHistory);
        };
        btnRenewal.onclick = ()=>{
          // ë°”ë¡œ ëª¨ë‹¬ ì—´ì–´ ì¬ë“±ë¡ ì…ë ¥ ê°€ëŠ¥
          renderHistory(id).then(()=> openModal(popupHistory));
        };

        // ì…ë ¥ ì±„ìš°ê¸°
        form.name.value = d.name || '';
        form.gender.value = d.gender || 'ì—¬ì„±';
        form.phone.value = d.phoneDisplay || fmtPhone(id);
        form.phone.disabled = true; // ë¬¸ì„œID ë³€ê²½ ë°©ì§€
        form.birth.value = d.birthDisplay || '';
        form.address.value = d.address || '';
        form.job.value = d.job || '';
        form.memberMemo.value = d.memberMemo || '';
        form.trainer.value = d.trainer || '';
        form.lessonType.value = d.lessonType || '';
        form.level.value = d.level || 'ì¼ë°˜';
        form.startDate.value = d.startDate || form.startDate.value;

        form.purchaseAmount.value = d.purchaseAmount ?? 0;
        form.totalSessionsPurchased.value = d.totalSessionsPurchased ?? 0;
        form.consumedSessions.value = d.consumedSessions ?? 0;
        form.remainingSessions.value = d.remainingSessions ?? Math.max(0,(d.totalSessionsPurchased||0)-(d.consumedSessions||0));
        form.renewalCount.value = d.renewalCount ?? 0;

        form.guardianName.value = d.guardianName || '';
        form.guardianRelation.value = d.guardianRelation || '';
        form.guardianPhone.value = d.emergency ? fmtPhone(d.emergency) : '';

        form.healthMemo.value = d.healthMemo || '';

        // ì¸ë°”ë””
        form.heightCm.value = d.heightCm ?? '';
        form.weightKg.value = d.weightKg ?? '';
        form.muscleMass.value = d.muscleMass ?? '';
        form.bodyFatPercent.value = d.bodyFatPercent ?? '';
        form.bodyFatMass.value = d.bodyFatMass ?? '';

        // í”„ë¡œí•„ ì´ë¯¸ì§€
        if(d.photoURL){
          avatarPreview.classList.remove('skeleton');
          avatarPreview.src = d.photoURL;
        }else{
          avatarPreview.classList.add('skeleton');
          avatarPreview.src = '';
        }

        if(!silent) hideBanner();
      }catch(e){
        console.error(e);
        if(!silent) showBanner("íšŒì› ë¡œë“œ ì‹¤íŒ¨: "+(e.message||e));
      }
    }

    // ===== íˆìŠ¤í† ë¦¬ ë Œë”ë§ & ì¬ë“±ë¡ ì €ì¥ =====
    async function renderHistory(memberId){
      $("#historyInfo").textContent = `íšŒì›ID: ${memberId}`;
      const box = $("#historyList");
      box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
      try{
        const items = [];

        // 1) members/{id}/history
        const hsnap = await getDocs(collection(db,'members',memberId,'history'));
        hsnap.forEach(d=>{
          const v=d.data(); const ts=v.createdAt?.toDate?.()||new Date();
          items.push({ kind:v.kind||'update', when: ts, note: v.note||'' });
        });

        // 2) renewals
        const rsnap = await getDocs(collection(db,'members',memberId,'renewals'));
        rsnap.forEach(d=>{
          const v=d.data(); const ts=v.createdAt?.toDate?.()||new Date();
          items.push({ kind:'renewal', when: ts, note: `+${v.sessions}íšŒ / ${Number(v.amount||0).toLocaleString()}ì› ${v.memo?'- '+v.memo:''}` });
        });

        // 3) session_ledger (optional)
        const lsnap = await getDocs(query(collection(db,'session_ledger'), where('memberId','==',memberId)));
        lsnap.forEach(d=>{
          const v=d.data(); const ts=v.createdAt?.toDate?.()||new Date();
          items.push({ kind:`ledger.${v.type}`, when: ts, note: `${v.date||''} ${v.time||''}` });
        });

        items.sort((a,b)=> b.when - a.when);
        if(items.length===0){ box.innerHTML = '<div class="muted">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

        box.innerHTML = '';
        items.forEach(it=>{
          const div = document.createElement('div');
          div.className = 'history-item';
          div.innerHTML = `<div class="k">${it.kind}</div><div class="muted">${it.when.toLocaleString()} Â· ${it.note||''}</div>`;
          box.appendChild(div);
        });
      }catch(e){
        console.error(e);
        box.innerHTML = '<div class="muted">íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }

    $("#btnRenewalSave").addEventListener('click', async ()=>{
      const id = editingId || onlyDigits(form.phone.value);
      if(!id){ alert('íšŒì›IDê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
      const amt = +($("#reAmount").value||0);
      const ses = +($("#reSessions").value||0);
      const memo = ($("#reMemo").value||'').trim();
      if(ses<=0){ alert('íšŒì°¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
      loading.style.display = "block";
      try{
        const mref = doc(db,'members',id);
        const now = new Date();
        const p2=n=>String(n).padStart(2,'0');
        const iso = `${now.getFullYear()}-${p2(now.getMonth()+1)}-${p2(now.getDate())}`;

        await updateDoc(mref,{
          totalSessionsPurchased: (window.firebaseIncrement||null) ? firebaseIncrement(ses) : undefined
        }).catch(()=>{}); // í˜¸í™˜ìš©

        // ì•ˆì „í•˜ê²Œ runTransactionìœ¼ë¡œ ì”ì—¬/ëˆ„ì  ì¦ê°€
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(mref);
          if(!snap.exists()) throw new Error('íšŒì› ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
          const d = snap.data();
          const total = (d.totalSessionsPurchased||0) + ses;
          const remain = (d.remainingSessions||0) + ses;
          const renewCnt = (d.renewalCount||0) + 1;
          tx.update(mref,{
            totalSessionsPurchased: total,
            remainingSessions: remain,
            lastPurchaseAmount: amt,
            lastPurchaseSessions: ses,
            lastPurchaseDate: iso,
            renewalCount: renewCnt,
            updatedAt: serverTimestamp()
          });
        });

        await addDoc(collection(db,'members',id,'renewals'),{
          amount: amt, sessions: ses, memo, date: iso, createdAt: serverTimestamp()
        });
        await logMemberUpdate(id,{kind:'renewal',note:`+${ses}íšŒ / ${amt.toLocaleString()}ì› ${memo?'- '+memo:''}`});

        // í¼ë„ ì¦‰ì‹œ ë°˜ì˜
        await loadMember(id, true);
        await renderHistory(id);
        alert('ì¬ë“±ë¡ ì €ì¥ ì™„ë£Œ');
        $("#reAmount").value=''; $("#reSessions").value=''; $("#reMemo").value='';
      }catch(e){
        console.error(e);
        alert('ì¬ë“±ë¡ ì‹¤íŒ¨: '+(e.message||e));
      }finally{
        loading.style.display = "none";
      }
    });

    // ===== ì‚¬ì§„ ì‚­ì œ ìƒíƒœ í† ê¸€ (í‘œì‹œë§Œ) =====
    btnClearPhoto.addEventListener('click', ()=>{
      $("#btnClearPhoto").dataset.cleared = '1';
      photoFile.value = '';
      avatarPreview.src = '';
      avatarPreview.classList.add('skeleton');
    });

    // ===== ì™¸ë¶€ì—ì„œ ì“¸ ìˆ˜ ìˆëŠ” ì†Œì§„ íŠ¸ëœì­ì…˜(ëŒ€ì‹œë³´ë“œ ë“±) =====
    // ì‚¬ìš©ë²•: applyScheduleSpend(memberId, -1)  // 1íšŒ ì†Œì§„
    export async function applyScheduleSpend(memberId, delta){
      const ref = doc(db, COL, memberId);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if (!snap.exists()) throw new Error('íšŒì› ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
        const d = snap.data();
        const consumed = Math.max(0, (d.consumedSessions||0) + Math.abs(delta));
        const remaining = Math.max(0, (d.remainingSessions||0) - Math.abs(delta));
        tx.update(ref, {
          consumedSessions: consumed,
          remainingSessions: remaining,
          updatedAt: serverTimestamp()
        });
      });
      await logMemberUpdate(memberId, { kind:'consume.tx', note:`delta ${delta}` });
    }

  </script>
</body>
</html>
